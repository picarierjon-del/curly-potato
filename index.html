<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SmartBiz Pro ‚Äì Menu unico</title>

<!-- Librerie esterne -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg:#0b0c10;--card:#12141a;--text:#f2f5ff;--accent:#3b82f6;
  --ok:#10b981;--bad:#ef4444;--muted:#a0a7b7;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui}
header{position:sticky;top:0;z-index:30;display:flex;justify-content:space-between;
  padding:10px 14px;background:#0b0c10ee;backdrop-filter:blur(10px)}
header h1{font-size:18px;margin:0}
.btn{padding:8px 14px;border:1px solid #2a2f38;border-radius:12px;background:#0e1117;color:#fff;cursor:pointer}
.btn.primary{background:var(--accent);border:none}
.card{background:var(--card);border-radius:14px;margin:14px;padding:14px}
label{display:block;margin:8px 0 4px;font-size:13px;color:#d7def0}
input,select,textarea{width:100%;padding:8px;border-radius:12px;border:1px solid #333;background:#0f1117;color:var(--text)}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #333}
.kpi{background:#0f1117;border:1px solid #1c2230;border-radius:12px;padding:12px;text-align:center;margin:8px 0}
.kpi h3{margin:0 0 4px;font-size:12px;color:var(--muted)}
.money{font-weight:700}
.ok{color:var(--ok)}.bad{color:var(--bad)}
canvas{width:100%;height:240px;background:#0f1117;border-radius:12px}
.tools-menu{position:absolute;top:58px;right:10px;background:#12141a;border:1px solid #2a3344;border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.45);padding:8px;z-index:60;display:none;width:min(260px,90vw)}
.tools-menu.show{display:block}
.tools-menu button{display:block;width:100%;text-align:left;margin:4px 0;padding:10px;border-radius:10px;
  background:#0f1218;border:1px solid #2a3344;color:#e6ebff;cursor:pointer}
.tools-menu button.primary{background:var(--accent);border:none;color:#fff}
.badge{display:inline-block;background:#1c2230;border:1px solid #2a3346;padding:4px 8px;border-radius:999px;font-size:12px;color:#cbd2e2}
</style>
</head>
<body>

<header>
  <h1>SmartBiz Pro</h1>
  <div>
    <button class="btn" id="menuBtn">‚ãØ</button>
    <span id="ivaReminder" class="badge"></span>
  </div>
  <div id="menuPanel" class="tools-menu">
    <button id="mAdd" class="primary">‚ûï Nuovo movimento</button>
    <button id="mList">üìú Lista movimenti</button>
    <button id="mSummary">üìä Riepilogo</button>
    <button id="mSup">üè∑Ô∏è Fornitori & Categorie</button>
    <button id="mDead">‚è∞ Scadenze</button>
    <button id="mImp">‚¨ÜÔ∏è Importa JSON</button>
    <button id="mExpCsv">‚¨áÔ∏è Export CSV</button>
    <button id="mExpJson">‚¨áÔ∏è Export JSON</button>
    <button id="mPdf">üßæ Report PDF</button>
    <input type="file" id="fileImport" accept="application/json" hidden>
  </div>
</header>

<main id="content"><!-- sezioni generate via JS --></main>

<script>
const cur=new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'});
const $=s=>document.querySelector(s);
const LS='sbp_all';
let store=JSON.parse(localStorage.getItem(LS)||'{"movimenti":[],"fornitori":[],"categorie":["Vendita","Servizi","Affitto","Utenze","Marketing","Spesa","Altro"],"scadenze":[]}');
function save(){localStorage.setItem(LS,JSON.stringify(store));}
function uid(){return crypto.randomUUID?.():Date.now().toString(36)+Math.random().toString(36).slice(2);}

function menu(show){$('#menuPanel').classList.toggle('show',show);}
$('#menuBtn').onclick=e=>{e.stopPropagation();menu(!$('#menuPanel').classList.contains('show'));};
document.addEventListener('click',e=>{if(!$('#menuPanel').contains(e.target)&&e.target.id!=='menuBtn')menu(false);});

function view(html){$('#content').innerHTML=html;}

/* ========== Pagine ========== */
function pageAdd(mov){
  const m=mov||{d:new Date().toISOString().slice(0,10),type:'entrata',method:'Contanti',cat:store.categorie[0]||'Altro',sup:'',desc:'',imp:'',iva:'22',tags:[]};
  view(`<div class="card">
    <h2>${mov?'Modifica':'Nuovo'} movimento</h2>
    <label>Data <input type="date" id="d" value="${m.d}"></label>
    <label>Tipo <select id="t"><option ${m.type==='entrata'?'selected':''}>entrata</option><option ${m.type==='uscita'?'selected':''}>uscita</option></select></label>
    <label>Metodo <input id="me" value="${m.method}"></label>
    <label>Categoria <select id="c">${store.categorie.map(x=>`<option ${x===m.cat?'selected':''}>${x}</option>`).join('')}</select></label>
    <label>Fornitore <select id="s"><option></option>${store.fornitori.map(x=>`<option ${x===m.sup?'selected':''}>${x}</option>`).join('')}</select></label>
    <label>Tag <input id="tg" value="${(m.tags||[]).join(', ')}"></label>
    <label>Descrizione <input id="desc" value="${m.desc}"></label>
    <label>Imponibile (‚Ç¨) <input type="number" id="imp" step="0.01" value="${m.imp}"></label>
    <label>IVA % <select id="iva">${[0,4,5,10,22].map(v=>`<option ${v==m.iva?'selected':''}>${v}</option>`).join('')}</select></label>
    <button class="btn primary" id="saveBtn">üíæ Salva</button>
  </div>`);
  $('#saveBtn').onclick=()=>{
    const rec={id:m.id||uid(),d:$('#d').value,type:$('#t').value,method:$('#me').value,
      cat:$('#c').value,sup:$('#s').value,desc:$('#desc').value,
      imp:parseFloat($('#imp').value)||0,ivaPerc:parseFloat($('#iva').value),
      tags:$('#tg').value.split(',').map(s=>s.trim()).filter(Boolean)};
    rec.iva=rec.imp*rec.ivaPerc/100; rec.tot=rec.imp+rec.iva;
    if(m.id) store.movimenti=store.movimenti.map(x=>x.id===m.id?rec:x); else store.movimenti.push(rec);
    save(); alert('Salvato'); pageList();
  };
}

function pageList(){
  let arr=[...store.movimenti].sort((a,b)=>b.d.localeCompare(a.d));
  view(`<div class="card">
    <h2>Movimenti</h2>
    <label>Da <input type="date" id="fFrom"> a <input type="date" id="fTo">
      <button class="btn" id="fApp">Applica</button></label>
    <table><thead><tr><th>Data</th><th>Tipo</th><th>Totale</th><th></th></tr></thead>
    <tbody>${arr.map(m=>`<tr><td>${m.d}</td><td>${m.type}</td><td>${cur.format(m.tot)}</td>
      <td><button class="btn" data-e="${m.id}">‚úé</button>
          <button class="btn bad" data-d="${m.id}">‚úñ</button></td></tr>`).join('')}</tbody></table>
  </div>`);
  $('#fApp').onclick=()=>{
    const from=$('#fFrom').value,to=$('#fTo').value;
    const filtered=arr.filter(x=>(!from||new Date(x.d)>=new Date(from))&&(!to||new Date(x.d)<=new Date(to)));
    $('#content').querySelector('tbody').innerHTML=
      filtered.map(m=>`<tr><td>${m.d}</td><td>${m.type}</td><td>${cur.format(m.tot)}</td>
      <td><button class="btn" data-e="${m.id}">‚úé</button>
      <button class="btn bad" data-d="${m.id}">‚úñ</button></td></tr>`).join('');
    bindRowBtns();
  };
  bindRowBtns();
  function bindRowBtns(){
    document.querySelectorAll('[data-e]').forEach(b=>b.onclick=()=>pageAdd(store.movimenti.find(x=>x.id===b.dataset.e)));
    document.querySelectorAll('[data-d]').forEach(b=>b.onclick=()=>{if(confirm('Eliminare?')){store.movimenti=store.movimenti.filter(x=>x.id!==b.dataset.d);save();pageList();}});
  }
}

function pageSummary(){
  const e=store.movimenti.filter(m=>m.type==='entrata').reduce((a,b)=>a+b.tot,0);
  const u=store.movimenti.filter(m=>m.type==='uscita').reduce((a,b)=>a+b.tot,0);
  const deb=store.movimenti.filter(m=>m.type==='entrata').reduce((a,b)=>a+b.iva,0);
  const cred=store.movimenti.filter(m=>m.type==='uscita').reduce((a,b)=>a+b.iva,0);
  view(`<div class="card"><h2>Riepilogo</h2>
    <div class="kpi"><h3>Entrate</h3><div class="money ok">${cur.format(e)}</div></div>
    <div class="kpi"><h3>Uscite</h3><div class="money bad">${cur.format(u)}</div></div>
    <div class="kpi"><h3>Œî</h3><div class="money">${cur.format(e-u)}</div></div>
    <div class="kpi"><h3>IVA Debito</h3><div class="money">${cur.format(deb)}</div></div>
    <div class="kpi"><h3>IVA Credito</h3><div class="money">${cur.format(cred)}</div></div>
    <div class="kpi"><h3>Œî IVA</h3><div class="money">${cur.format(deb-cred)}</div></div>
    <canvas id="chart"></canvas>
  </div>`);
  const ctx=document.getElementById('chart').getContext('2d');
  const byMonth={}; store.movimenti.forEach(m=>{
    const k=m.d.slice(0,7); byMonth[k]=(byMonth[k]||0)+(m.type==='entrata'?m.tot:-m.tot);
  });
  const labels=Object.keys(byMonth).sort();
  new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Saldo',data:labels.map(k=>byMonth[k]),backgroundColor:labels.map(k=>byMonth[k]>=0?'#10b981':'#ef4444')}]},options:{plugins:{legend:{display:false}}}});
}

function pageSup(){
  view(`<div class="card"><h2>Fornitori & Categorie</h2>
    <label>Nuovo Fornitore <input id="newSup"><button class="btn primary" id="addSup">Aggiungi</button></label>
    <ul>${store.fornitori.map(x=>`<li>${x} <button data-s="${x}" class="btn bad">‚úñ</button></li>`).join('')}</ul>
    <hr>
    <label>Nuova Categoria <input id="newCat"><button class="btn primary" id="addCat">Aggiungi</button></label>
    <ul>${store.categorie.map(x=>`<li>${x} <button data-c="${x}" class="btn bad">‚úñ</button></li>`).join('')}</ul>
  </div>`);
  $('#addSup').onclick=()=>{const v=$('#newSup').value.trim();if(v&&!store.fornitori.includes(v)){store.fornitori.push(v);save();pageSup();}};
  $('#addCat').onclick=()=>{const v=$('#newCat').value.trim();if(v&&!store.categorie.includes(v)){store.categorie.push(v);save();pageSup();}};
  document.querySelectorAll('[data-s]').forEach(b=>b.onclick=()=>{store.fornitori=store.fornitori.filter(x=>x!==b.dataset.s);save();pageSup();});
  document.querySelectorAll('[data-c]').forEach(b=>b.onclick=()=>{store.categorie=store.categorie.filter(x=>x!==b.dataset.c);save();pageSup();});
}

function pageDead(){
  view(`<div class="card"><h2>Scadenze</h2>
    <label>Titolo <input id="tit"><label>Data <input type="date" id="dat">
      <button class="btn primary" id="addScad">Aggiungi</button></label>
    <ul>${store.scadenze.map(s=>`<li>${s.data} ‚Äì ${s.titolo} <button data-d="${s.id}" class="btn bad">‚úñ</button></li>`).join('')}</ul>
  </div>`);
  $('#addScad').onclick=()=>{const t=$('#tit').value.trim(),d=$('#dat').value;if(t&&d){store.scadenze.push({id:uid(),titolo:t,data:d});save();pageDead();}};
  document.querySelectorAll('[data-d]').forEach(b=>b.onclick=()=>{store.scadenze=store.scadenze.filter(x=>x.id!==b.dataset.d);save();pageDead();});
}

/* ===== Import / Export / PDF ===== */
function exportJSON(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(store,null,2)],{type:'application/json'}));a.download='smartbiz.json';a.click();}
function exportCSV(){const rows=[['Data','Tipo','Metodo','Categoria','Fornitore','Descrizione','Imponibile','IVA','Totale']];
  store.movimenti.forEach(m=>rows.push([m.d,m.type,m.method,m.cat,m.sup,m.desc,m.imp,m.iva,m.tot]));
  const csv=rows.map(r=>r.join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='smartbiz.csv';a.click();}
function importJSON(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{store=JSON.parse(r.result);save();alert('Import OK');pageList();}catch{alert('File non valido');}};r.readAsText(f);}
function reportPDF(){const {jsPDF}=window.jspdf;const doc=new jsPDF({unit:'pt',format:'a4'});
  const e=store.movimenti.filter(m=>m.type==='entrata').reduce((a,b)=>a+b.tot,0);
  const u=store.movimenti.filter(m=>m.type==='uscita').reduce((a,b)=>a+b.tot,0);
  doc.text('Report SmartBiz',40,40);
  doc.autoTable({startY:60,head:[['Voce','Valore']],body:[['Entrate',cur.format(e)],['Uscite',cur.format(u)],['Saldo',cur.format(e-u)]]});
  const rows=store.movimenti.map(m=>[m.d,m.type,m.method,m.cat,m.sup,m.desc,m.imp,m.iva,m.tot]);
  doc.addPage();doc.autoTable({head:[['Data','Tipo','Metodo','Categoria','Fornitore','Descrizione','Imp','IVA','Tot']],body:rows});
  doc.save('report.pdf');
}

/* ===== Menu actions ===== */
$('#mAdd').onclick=()=>{menu(false);pageAdd();};
$('#mList').onclick=()=>{menu(false);pageList();};
$('#mSummary').onclick=()=>{menu(false);pageSummary();};
$('#mSup').onclick=()=>{menu(false);pageSup();};
$('#mDead').onclick=()=>{menu(false);pageDead();};
$('#mExpJson').onclick=()=>{menu(false);exportJSON();};
$('#mExpCsv').onclick=()=>{menu(false);exportCSV();};
$('#mPdf').onclick=()=>{menu(false);reportPDF();};
$('#mImp').onclick=()=>{menu(false);$('#fileImport').click();};
$('#fileImport').onchange=importJSON;

/* IVA reminder */
(function(){
  const now=new Date(), y=now.getFullYear();
  const scad=[new Date(y,4,16),new Date(y,7,20),new Date(y,10,16),new Date(y+1,2,16)];
  let next=scad.find(d=>d>now)||scad[0];
  const diff=Math.ceil((next-now)/86400000);
  $('#ivaReminder').textContent=`IVA: ${next.toLocaleDateString('it-IT')} ‚Ä¢ ${diff}g`;
})();

/* start */
pageList();
</script>
</body>
</html>
