<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Commander Elite Pro - Top Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f1f5f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    .page { display: none; padding-bottom: 120px; }
    .active-page { display: block; animation: fadeIn 0.15s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.25rem; border: 1px solid #e2e8f0; }
    input, select { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 12px; width: 100%; font-size: 16px; transition: border-color 0.2s; }
    input:focus { border-color: #2563eb; outline: none; background-color: #f8fafc; }
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item.active { color: #2563eb; }
    #lock-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    @media print {
      .no-print { display: none !important; }
      .page { display: block !important; }
      table { width: 100% !important; border-collapse: collapse; }
      th, td { border: 1px solid #000; padding: 8px; text-align: right; }
      td:first-child, th:first-child { text-align: left; }
    }
  </style>
</head>
<body>

  <!-- LOCK -->
  <div id="lock-screen">
    <div class="text-center mb-8">
      <i class="fa-solid fa-shield-halved text-5xl text-blue-500 mb-4"></i>
      <h1 class="text-2xl font-black tracking-tighter uppercase">Commander Elite <span class="text-blue-500">PRO</span></h1>
    </div>
    <div class="w-72 bg-slate-800 p-6 rounded-3xl shadow-2xl">
      <input type="password" id="pin-input" class="text-center text-3xl tracking-[0.5em] text-slate-900 mb-4 font-bold" maxlength="4" placeholder="****">
      <button onclick="checkPin()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black uppercase transition-all shadow-lg active:scale-95">Sblocca Sistema</button>
    </div>
  </div>

  <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 p-4 no-print flex justify-between items-center">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black italic">C</div>
      <h1 class="font-black text-slate-800 uppercase tracking-tight text-lg">Commander <span class="text-blue-600">Elite</span></h1>
    </div>
    <button onclick="location.reload()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center"><i class="fa-solid fa-lock"></i></button>
  </header>

  <main class="max-w-2xl mx-auto p-4">

    <!-- PAGINA OGGI -->
    <section id="page-oggi" class="page active-page">
      <div class="card bg-gradient-to-r from-blue-600 to-blue-800 border-none">
        <label class="text-[10px] font-black text-blue-100 uppercase mb-1 block">Data Operativa</label>
        <input type="date" id="data-lavoro" class="bg-white/10 border-none text-white font-bold text-lg cursor-pointer" onchange="calcola()">
      </div>

      <div class="card">
        <div class="flex items-center gap-2 mb-4 border-b pb-2">
          <i class="fa-solid fa-receipt text-blue-600"></i>
          <h3 class="font-black text-slate-700 uppercase text-xs">Incassi e Corrispettivi</h3>
        </div>

        <div class="space-y-4">
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Totale Chiusura Z (Lordo)</label>
            <input type="number" id="inp-tot" placeholder="0.00" class="text-3xl font-black text-slate-800" oninput="calcola()">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="col-span-2">
              <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Aliquota IVA Vendite</label>
              <select id="iva-v-base" onchange="calcola()" class="font-bold bg-slate-50">
                <option value="10">IVA 10% (Ristorazione)</option>
                <option value="22">IVA 22% (Bevande/Servizi)</option>
                <option value="4">IVA 4% (Alimentari)</option>
              </select>
            </div>

            <div>
              <label class="text-[9px] font-bold text-slate-500 uppercase">Bancomat/POS</label>
              <input type="number" class="val-e" id="inp-pos" placeholder="0.00" oninput="calcola()">
            </div>
            <div>
              <label class="text-[9px] font-bold text-slate-500 uppercase">Satispay</label>
              <input type="number" class="val-e" id="inp-sat" placeholder="0.00" oninput="calcola()">
            </div>
            <div>
              <label class="text-[9px] font-bold text-slate-500 uppercase">Just Eat/Glovo</label>
              <input type="number" class="val-e" id="inp-del" placeholder="0.00" oninput="calcola()">
            </div>
            <div>
              <label class="text-[9px] font-bold text-slate-500 uppercase">App/Web</label>
              <input type="number" class="val-e" id="inp-tap" placeholder="0.00" oninput="calcola()">
            </div>
          </div>
        </div>
      </div>

      <div class="card border-l-4 border-red-500">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-2 text-red-600">
            <i class="fa-solid fa-truck-ramp-box"></i>
            <h3 class="font-black uppercase text-xs text-slate-700">Fornitori e Fatture</h3>
          </div>
          <button type="button" onclick="addFornitore()" class="bg-red-500 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-sm">+ AGGIUNGI SPESA</button>
        </div>
        <div id="fornitori-list" class="space-y-4"></div>
      </div>

      <div class="card bg-slate-900 text-white shadow-2xl">
        <div class="grid grid-cols-2 gap-6 text-xs mb-6">
          <div class="border-r border-slate-700">
            <p class="text-slate-500 font-bold uppercase mb-1">Tot. Elettronico</p>
            <p id="res-ele" class="text-xl font-bold">€ 0,00</p>
          </div>
          <div>
            <p class="text-orange-400 font-bold uppercase mb-1">IVA su Vendite</p>
            <p id="res-ivav" class="text-xl font-bold text-orange-400">€ 0,00</p>
          </div>
        </div>

        <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-white/10">
          <span class="font-black text-green-400 uppercase tracking-wider">Netto Contanti</span>
          <span id="res-netto" class="text-3xl font-black text-green-400 tracking-tighter">€ 0,00</span>
        </div>

        <button type="button" onclick="salvaData(this)" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg shadow-blue-900/20 active:scale-95 transition-all">
          Archivia e Salva
        </button>
      </div>
    </section>

    <!-- PAGINA RIEPILOGO -->
    <section id="page-riepilogo" class="page">
      <h2 class="font-black text-2xl text-slate-800 mb-6 flex items-center gap-2">
        <i class="fa-solid fa-chart-pie text-blue-600"></i> Analisi Business
      </h2>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="card border-t-4 border-blue-500">
          <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Ultimi 7gg</p>
          <p id="st-w" class="text-xl font-black text-slate-800">€ 0.00</p>
        </div>
        <div class="card border-t-4 border-blue-500">
          <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Mese Corrente</p>
          <p id="st-m" class="text-xl font-black text-slate-800">€ 0.00</p>
        </div>
        <div class="card col-span-2 bg-slate-800 text-white border-none flex justify-between items-center">
          <div>
            <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Saldo IVA Mese</p>
            <p id="st-iva-saldo" class="text-2xl font-black text-orange-400">€ 0.00</p>
          </div>
          <i class="fa-solid fa-piggy-bank text-4xl opacity-20"></i>
        </div>
      </div>

      <div class="card">
        <h3 class="font-black text-xs uppercase mb-4 text-slate-500 border-b pb-2">Ricerca Storica Periodo</h3>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1">DAL</label>
            <input type="date" id="s-from">
          </div>
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1">AL</label>
            <input type="date" id="s-to">
          </div>
        </div>
        <button type="button" onclick="cercaPeriodo()" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-4 rounded-xl font-black uppercase text-xs transition-all">
          Elabora Analisi
        </button>
        <div id="s-res" class="mt-6 hidden"></div>
      </div>
    </section>

    <!-- PAGINA STAMPA -->
    <section id="page-stampa" class="page">
      <div class="card no-print">
        <h3 class="font-black text-xs uppercase mb-4 text-slate-500 border-b pb-2">Configurazione Export Fiscale</h3>
        <div class="grid grid-cols-2 gap-3 mb-6">
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1">DATA INIZIO</label>
            <input type="date" id="p-from">
          </div>
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1">DATA FINE</label>
            <input type="date" id="p-to">
          </div>
        </div>
        <button type="button" onclick="generaReportProfessionale()" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-5 rounded-2xl font-black uppercase shadow-lg shadow-blue-200 transition-all">
          Genera Documentazione Ragioniere
        </button>
      </div>

      <!-- SETUP: cancellazione range per alleggerire localStorage -->
      <div class="card no-print border-l-4 border-slate-800">
        <div class="flex items-center gap-2 mb-4 border-b pb-2">
          <i class="fa-solid fa-gear text-slate-800"></i>
          <h3 class="font-black text-slate-700 uppercase text-xs">Setup - Pulizia Archivio</h3>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1">CANCELLA DAL</label>
            <input type="date" id="d-from">
          </div>
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1">CANCELLA AL</label>
            <input type="date" id="d-to">
          </div>
        </div>
        <button type="button" onclick="cancellaPeriodo()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-xl font-black uppercase text-xs transition-all">
          Cancella Dati dal/al
        </button>
        <p class="mt-3 text-[11px] text-slate-500 leading-4">
          Elimina dal dispositivo i record compresi tra le due date (inclusi) per ridurre lo spazio occupato.
        </p>
      </div>

      <div id="area-stampa"></div>
    </section>

  </main>

  <nav class="nav-bottom no-print">
    <button type="button" onclick="showPage('oggi')" class="nav-item active" id="btn-oggi"><i class="fa-solid fa-cash-register text-2xl mb-1"></i>Cassa</button>
    <button type="button" onclick="showPage('riepilogo')" class="nav-item" id="btn-riepilogo"><i class="fa-solid fa-chart-line text-2xl mb-1"></i>Analisi</button>
    <button type="button" onclick="showPage('stampa')" class="nav-item" id="btn-stampa"><i class="fa-solid fa-file-invoice-dollar text-2xl mb-1"></i>Fisco</button>
  </nav>

  <script>
    // precisione decimale
    const fix = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;
    const euro = (n) => `€ ${fix(n).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    // DB
    const LS_KEY = 'ce_v3_top';
    let db = JSON.parse(localStorage.getItem(LS_KEY)) || [];

    function persistDB() {
      db.sort((a, b) => (a.data || '').localeCompare(b.data || ''));
      localStorage.setItem(LS_KEY, JSON.stringify(db));
    }

    function checkPin() {
      if (document.getElementById('pin-input').value === "1234") {
        document.getElementById('lock-screen').style.display = 'none';
      }
    }

    function showPage(p) {
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active-page'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById('page-' + p).classList.add('active-page');
      document.getElementById('btn-' + p).classList.add('active');
      if (p === 'riepilogo') aggiornaStatsDash();
    }

    function addFornitore() {
      const container = document.getElementById('fornitori-list');
      const div = document.createElement('div');
      div.className = "bg-slate-50 p-4 rounded-2xl border border-slate-200 forn-block";
      div.innerHTML = `
        <div class="flex gap-2 mb-3">
          <input type="text" placeholder="Ragione Sociale Fornitore..." class="flex-1 font-bold text-sm f-name bg-white border-slate-200">
          <button type="button" onclick="this.parentElement.parentElement.remove(); calcola()" class="w-10 h-10 bg-red-50 text-red-500 rounded-full">✕</button>
        </div>

        <div class="space-y-2 r-cont">
          <div class="grid grid-cols-3 gap-2 r-item">
            <input type="number" placeholder="Valore" class="r-val !p-2 text-sm font-bold" oninput="calcola()">
            <select class="r-iva !p-2 text-[10px] font-bold" onchange="calcola()">
              <option value="22">IVA 22%</option>
              <option value="10" selected>IVA 10%</option>
              <option value="5">IVA 5%</option>
              <option value="4">IVA 4%</option>
              <option value="0">Esente</option>
            </select>
            <select class="r-tipo !p-2 text-[10px] font-bold bg-blue-50 border-blue-100" onchange="calcola()">
              <option value="L">LORDO</option>
              <option value="N">NETTO +</option>
            </select>
          </div>
        </div>

        <div class="mt-3 flex justify-between items-center border-t border-slate-200 pt-3">
          <button type="button" onclick="addRowIVA(this)" class="text-[10px] font-black text-blue-600 hover:underline uppercase tracking-tighter">
            + Aggiungi Riga IVA
          </button>
          <label class="flex items-center gap-2 text-[10px] font-black text-slate-500 uppercase">
            Contanti? <input type="checkbox" class="f-cash w-5 h-5 accent-red-600" onchange="calcola()">
          </label>
        </div>
      `;
      container.appendChild(div);
    }

    function addRowIVA(btn) {
      const row = document.createElement('div');
      row.className = "grid grid-cols-3 gap-2 r-item mt-2";
      row.innerHTML = `
        <input type="number" placeholder="Valore" class="r-val !p-2 text-sm font-bold" oninput="calcola()">
        <select class="r-iva !p-2 text-[10px] font-bold" onchange="calcola()">
          <option value="22">22%</option>
          <option value="10" selected>10%</option>
          <option value="5">5%</option>
          <option value="4">4%</option>
          <option value="0">0%</option>
        </select>
        <button type="button" onclick="this.parentElement.remove(); calcola()" class="text-[8px] text-red-500 font-bold uppercase border border-red-200 rounded">
          Rimuovi
        </button>
      `;
      btn.parentElement.previousElementSibling.appendChild(row);
    }

    function calcola() {
      const lordoZ = fix(parseFloat(document.getElementById('inp-tot').value) || 0);
      const ivaVperc = parseFloat(document.getElementById('iva-v-base').value || "10");

      let totEle = 0;
      document.querySelectorAll('.val-e').forEach(i => totEle += fix(parseFloat(i.value) || 0));

      const impV = fix(lordoZ / (1 + (ivaVperc / 100)));
      const ivaV = fix(lordoZ - impV);

      let uscCash = 0;
      let totIvaA = 0;
      let detFornitori = [];

      document.querySelectorAll('.forn-block').forEach(b => {
        let fLordo = 0;
        let fIva = 0;

        const righe = [];

        b.querySelectorAll('.r-item').forEach(r => {
          const v = fix(parseFloat(r.querySelector('.r-val')?.value) || 0);
          const i = parseFloat(r.querySelector('.r-iva')?.value) || 0;
          const t = r.querySelector('.r-tipo')?.value || 'L';

          if (v > 0) righe.push({ valore: v, ivaPerc: i, tipo: t });

          if (t === 'L') {
            fLordo += v;
            fIva += fix(v - (v / (1 + (i / 100))));
          } else {
            const r_iva = fix(v * (i / 100));
            fIva += r_iva;
            fLordo += (v + r_iva);
          }
        });

        totIvaA += fix(fIva);
        const isCash = !!b.querySelector('.f-cash')?.checked;
        if (isCash) uscCash += fix(fLordo);

        detFornitori.push({
          nome: b.querySelector('.f-name')?.value || "Senza Nome",
          lordo: fix(fLordo),
          iva: fix(fIva),
          cash: isCash,
          righe
        });
      });

      const netto = fix((lordoZ - totEle) - uscCash);

      document.getElementById('res-ele').innerText = euro(totEle);
      document.getElementById('res-ivav').innerText = euro(ivaV);
      document.getElementById('res-netto').innerText = euro(netto);

      return {
        lordoZ, ivaV, impV,
        totEle, uscCash, totIvaA, detFornitori,
        pos: fix(parseFloat(document.getElementById('inp-pos').value) || 0),
        sat: fix(parseFloat(document.getElementById('inp-sat').value) || 0),
        del: fix(parseFloat(document.getElementById('inp-del').value) || 0),
        tap: fix(parseFloat(document.getElementById('inp-tap').value) || 0)
      };
    }

    function salvaData(btnEl) {
      const data = document.getElementById('data-lavoro').value;
      if (!data) return alert("⚠️ Seleziona la data prima di salvare!");

      const dati = calcola();
      const haSpese = (dati.detFornitori || []).some(f => (f.lordo || 0) > 0 || (f.iva || 0) > 0);
      if (dati.lordoZ === 0 && !haSpese) return alert("⚠️ Non ci sono dati da salvare.");

      const rec = {
        data,
        ...dati,
        lordoZ: fix(dati.lordoZ),
        ivaV: fix(dati.ivaV),
        impV: fix(dati.impV),
        totEle: fix(dati.totEle),
        uscCash: fix(dati.uscCash),
        totIvaA: fix(dati.totIvaA),
        pos: fix(dati.pos),
        sat: fix(dati.sat),
        del: fix(dati.del),
        tap: fix(dati.tap),
        detFornitori: (dati.detFornitori || []).map(x => ({
          nome: x.nome || "Senza Nome",
          lordo: fix(x.lordo || 0),
          iva: fix(x.iva || 0),
          cash: !!x.cash,
          righe: Array.isArray(x.righe) ? x.righe.map(rr => ({
            valore: fix(rr.valore || 0),
            ivaPerc: Number(rr.ivaPerc || 0),
            tipo: rr.tipo === 'N' ? 'N' : 'L'
          })) : []
        }))
      };

      db = db.filter(r => r.data !== data);
      db.push(rec);
      persistDB();

      if (btnEl) {
        btnEl.innerText = "✅ GIORNATA SALVATA";
        btnEl.classList.remove('bg-blue-600');
        btnEl.classList.add('bg-green-600');
        setTimeout(() => {
          btnEl.innerText = "ARCHIVIA E SALVA";
          btnEl.classList.remove('bg-green-600');
          btnEl.classList.add('bg-blue-600');
        }, 2000);
      }
    }

    function aggiornaStatsDash() {
      const now = new Date();
      const m = now.toISOString().substring(0, 7);
      let tW = 0, tM = 0, tIV = 0, tIA = 0;
      const weekAgo = new Date();
      weekAgo.setDate(now.getDate() - 7);

      db.forEach(r => {
        const rd = new Date(r.data);
        if (rd >= weekAgo) tW += (r.lordoZ || 0);
        if ((r.data || "").startsWith(m)) {
          tM += (r.lordoZ || 0);
          tIV += (r.ivaV || 0);
          tIA += (r.totIvaA || 0);
        }
      });

      document.getElementById('st-w').innerText = euro(tW);
      document.getElementById('st-m').innerText = euro(tM);
      document.getElementById('st-iva-saldo').innerText = euro(fix(tIV - tIA));
    }

    function cercaPeriodo() {
      const f = document.getElementById('s-from').value;
      const t = document.getElementById('s-to').value;
      if (!f || !t) return alert("Scegli le date!");
      if (f > t) return alert("⚠️ Intervallo non valido: DAL è dopo AL.");

      const fil = db
        .filter(r => r.data >= f && r.data <= t)
        .sort((a, b) => a.data.localeCompare(b.data));

      let totL = 0, totE = 0, totC = 0, tIvaD = 0, tIvaC = 0;
      let entCash = 0, diffCash = 0;

      fil.forEach(r => {
        totL += (r.lordoZ || 0);
        totE += (r.totEle || 0);
        totC += (r.uscCash || 0);
        tIvaD += (r.ivaV || 0);
        tIvaC += (r.totIvaA || 0);

        // Entrate contanti (lordo - elettronico)
        entCash += (r.lordoZ || 0) - (r.totEle || 0);
      });

      diffCash = entCash - totC;

      const res = document.getElementById('s-res');
      res.classList.remove('hidden');

      res.innerHTML = `
        <div class="p-5 bg-slate-900 text-white rounded-3xl space-y-3 shadow-xl">
          <h4 class="text-center font-black text-blue-400 text-xs uppercase mb-2">Risultati Intervallo</h4>

          <div class="flex justify-between border-b border-white/10 pb-2">
            <span>Entrate (Lordo Z)</span>
            <strong class="text-lg">${euro(totL)}</strong>
          </div>

          <div class="flex justify-between text-slate-200">
            <span>Entrate Contanti (Lordo - Elettronico)</span>
            <span>${euro(entCash)}</span>
          </div>

          <div class="flex justify-between text-red-400">
            <span>Uscite Contanti</span>
            <span>${euro(totC)}</span>
          </div>

          <div class="flex justify-between font-black text-green-300">
            <span>Differenza Contanti</span>
            <span>${euro(diffCash)}</span>
          </div>

          <div class="pt-3 flex justify-between font-black text-orange-400 border-t border-white/20">
            <span>IVA DA VERSARE</span>
            <span>${euro(fix(tIvaD - tIvaC))}</span>
          </div>
        </div>`;
    }

    function generaReportProfessionale() {
      const f = document.getElementById('p-from').value;
      const t = document.getElementById('p-to').value;
      if (!f || !t) return alert("Seleziona il periodo fiscale!");
      if (f > t) return alert("⚠️ Intervallo non valido: DATA INIZIO è dopo DATA FINE.");

      const dataFil = db
        .filter(r => r.data >= f && r.data <= t)
        .sort((a, b) => a.data.localeCompare(b.data));

      const mesi = ["GENNAIO","FEBBRAIO","MARZO","APRILE","MAGGIO","GIUGNO","LUGLIO","AGOSTO","SETTEMBRE","OTTOBRE","NOVEMBRE","DICEMBRE"];
      let titolo = `REPORT FISCALE DAL ${f} AL ${t}`;
      if (f.substring(0, 7) === t.substring(0, 7) && f.endsWith("-01")) {
        titolo = `REGISTRO CORRISPETTIVI E ACQUISTI - ${mesi[new Date(f).getMonth()]} ${new Date(f).getFullYear()}`;
      }

      let h = `<div class="bg-white p-8 text-slate-900 printable-content">
        <div class="flex justify-between items-start border-b-2 border-slate-900 pb-4 mb-8">
          <div>
            <h1 class="font-black text-3xl italic tracking-tighter uppercase">Commander <span class="text-blue-600">Elite</span></h1>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Sistemi di Controllo Fiscale v3.0</p>
          </div>
          <div class="text-right">
            <p class="font-black text-sm uppercase">${titolo}</p>
            <p class="text-[10px] text-slate-400 uppercase">Documento generato il: ${new Date().toLocaleDateString('it-IT')}</p>
          </div>
        </div>`;

      // VENDITE
      h += `<div class="mb-10">
        <h3 class="bg-slate-900 text-white text-[10px] px-3 py-1 font-black uppercase mb-3 inline-block">1. Registro Corrispettivi</h3>
        <table class="w-full text-[11px]">
          <thead class="bg-slate-100">
            <tr>
              <th class="border p-2">Data</th>
              <th class="border p-2">Lordo Z</th>
              <th class="border p-2">Scorporo IVA</th>
              <th class="border p-2">Elettronico</th>
              <th class="border p-2">Netto Cash (prima spese)</th>
            </tr>
          </thead>
          <tbody>`;

      let sZ = 0, sIV = 0, sE = 0;
      dataFil.forEach(r => {
        sZ += (r.lordoZ || 0);
        sIV += (r.ivaV || 0);
        sE += (r.totEle || 0);
        h += `<tr>
          <td class="border p-2 font-bold">${r.data}</td>
          <td class="border p-2 font-black">€${(r.lordoZ||0).toFixed(2)}</td>
          <td class="border p-2 text-red-600">€${(r.ivaV||0).toFixed(2)}</td>
          <td class="border p-2">€${(r.totEle||0).toFixed(2)}</td>
          <td class="border p-2 font-bold">€${((r.lordoZ||0) - (r.totEle||0)).toFixed(2)}</td>
        </tr>`;
      });

      h += `<tr class="bg-slate-50 font-black italic">
        <td class="border p-2 uppercase">TOTALI PERIODO</td>
        <td class="border p-2">€${sZ.toFixed(2)}</td>
        <td class="border p-2 text-red-600">€${sIV.toFixed(2)}</td>
        <td class="border p-2">€${sE.toFixed(2)}</td>
        <td class="border p-2">€${(sZ - sE).toFixed(2)}</td>
      </tr></tbody></table></div>`;

      // ACQUISTI DETTAGLIATI
      h += `<div class="mb-10">
        <h3 class="bg-slate-900 text-white text-[10px] px-3 py-1 font-black uppercase mb-3 inline-block">2. Registro Acquisti e Fornitori (Dettaglio)</h3>
        <table class="w-full text-[11px]">
          <thead class="bg-slate-100">
            <tr>
              <th class="border p-2">Fornitore</th>
              <th class="border p-2">Data</th>
              <th class="border p-2 text-right">IVA Credito</th>
              <th class="border p-2 text-right">Totale</th>
              <th class="border p-2">Metodo</th>
            </tr>
          </thead>
          <tbody>`;

      let sIA = 0, sAL = 0;
      dataFil.forEach(r => {
        (r.detFornitori || []).forEach(fx => {
          sIA += (fx.iva || 0);
          sAL += (fx.lordo || 0);
          h += `<tr>
            <td class="border p-2 font-bold">${fx.nome || "Senza Nome"}</td>
            <td class="border p-2 text-center">${r.data}</td>
            <td class="border p-2 text-green-600 text-right">€${(fx.iva||0).toFixed(2)}</td>
            <td class="border p-2 text-right">€${(fx.lordo||0).toFixed(2)}</td>
            <td class="border p-2 text-center text-[9px] font-bold">${fx.cash ? 'CONTANTI' : 'TRACCIABILE'}</td>
          </tr>`;

          if (Array.isArray(fx.righe) && fx.righe.length) {
            h += `<tr>
              <td class="border p-2" colspan="5" style="text-align:left;">
                <span style="font-weight:700;">Righe IVA:</span>
                ${fx.righe.map(rr => ` [${rr.tipo === 'N' ? 'NETTO+' : 'LORDO'} ${rr.ivaPerc}%: €${Number(rr.valore||0).toFixed(2)}]`).join(' ')}
              </td>
            </tr>`;
          }
        });
      });

      h += `<tr class="bg-slate-50 font-black italic">
        <td colspan="2" class="border p-2 uppercase">TOTALE IVA DETRAIBILE</td>
        <td class="border p-2 text-green-600 text-right">€${sIA.toFixed(2)}</td>
        <td class="border p-2 text-right">€${sAL.toFixed(2)}</td>
        <td class="border p-2"></td>
      </tr></tbody></table></div>`;

      // SINTESI
      h += `<div class="grid grid-cols-2 gap-8 items-center border-t-2 border-slate-900 pt-8 mt-12">
        <div>
          <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Dichiarazione Liquidazione IVA</p>
          <p class="text-xs italic text-slate-600">Si dichiara che i dati sopra esposti corrispondono alle chiusure dei registratori di cassa e ai documenti di spesa archiviati.</p>
        </div>
        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
          <div class="flex justify-between text-xs mb-1"><span>IVA a Debito (Vendite):</span> <span class="font-bold">+ €${sIV.toFixed(2)}</span></div>
          <div class="flex justify-between text-xs mb-4"><span>IVA a Credito (Acquisti):</span> <span class="font-bold">- €${sIA.toFixed(2)}</span></div>
          <div class="flex justify-between font-black text-xl border-t border-slate-300 pt-3">
            <span class="text-slate-800 tracking-tighter uppercase text-sm">SALDO IVA:</span>
            <span class="text-blue-700 font-black">€${fix(sIV - sIA).toFixed(2)}</span>
          </div>
        </div>
      </div>

      <button onclick="window.print()" class="no-print w-full bg-slate-900 text-white py-5 mt-12 rounded-2xl font-black uppercase text-sm tracking-widest shadow-xl">
        Invia alla Stampa / PDF
      </button>
      </div>`;

      document.getElementById('area-stampa').innerHTML = h;
    }

    // Setup: cancella record dal/al
    function cancellaPeriodo() {
      const f = document.getElementById('d-from').value;
      const t = document.getElementById('d-to').value;
      if (!f || !t) return alert("Seleziona le date DAL/AL per cancellare.");
      if (f > t) return alert("⚠️ Intervallo non valido: DAL è dopo AL.");

      const prima = db.length;
      const rimossi = db.filter(r => (r.data >= f && r.data <= t)).length;
      if (rimossi === 0) return alert("Nessun dato da cancellare nel periodo selezionato.");

      const ok = confirm(`Confermi la cancellazione di ${rimossi} record dal ${f} al ${t}?`);
      if (!ok) return;

      db = db.filter(r => !(r.data >= f && r.data <= t));
      persistDB();

      // aggiorna dashboard se aperta e svuota eventuali report in analisi
      aggiornaStatsDash();
      const sr = document.getElementById('s-res');
      if (sr) { sr.classList.add('hidden'); sr.innerHTML = ""; }

      alert(`Cancellazione completata. Rimasti ${db.length} record (prima: ${prima}).`);
    }

    // init data default
    document.getElementById('data-lavoro').valueAsDate = new Date();
  </script>
</body>
</html>
