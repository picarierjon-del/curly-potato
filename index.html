<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestione Finanziaria Unificata Smart PRO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root { color-scheme: light dark; }
    body { font-family:'Inter',sans-serif; background-color:#f7f9fc; color:#1e293b; }
    .card { box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.06); }
    .tab-active { border-bottom:3px solid #10b981; color:#10b981; }
    .cta-button { transition:all .2s; box-shadow:0 4px 6px -1px rgba(16,185,129,.4),0 2px 4px -2px rgba(16,185,129,.06); }
    .bar-container { height:20px; border-radius:9999px; overflow:hidden; display:flex; }
    .bar-income{background-color:#10b981}.bar-expense{background-color:#ef4444}
    .bar-addebito{background-color:#fb923c}.bar-credito{background-color:#3b82f6}
    #quick-actions{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(to top,#fff, #fff8);padding:10px;box-shadow:0 -2px 10px rgba(0,0,0,.1);z-index:40;}
    /* Dark mode */
    .dark body, body.dark { background-color:#0f172a; color:#f1f5f9; }
    body.dark .card { background-color:#111827; color:#e5e7eb; }
    body.dark .tab-active { color:#10b981; border-bottom-color:#10b981; }
    body.dark input, body.dark select, body.dark textarea { background:#111827; color:#e5e7eb; border-color:#374151; }
    body.dark .bg-white { background-color:#111827 !important; }
    body.dark .text-gray-700 { color:#e5e7eb !important; }
    body.dark .text-gray-800 { color:#f9fafb !important; }
    body.dark .text-gray-500 { color:#9ca3af !important; }
    
    /* PIN Lock Specific Styles */
    #pin-lock-modal {
      position: fixed;
      inset: 0;
      background-color: #0f172a; 
      z-index: 100; 
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: #f1f5f9;
      text-align: center;
    }
    .pin-input {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .pin-input input {
      width: 40px;
      height: 40px;
      text-align: center;
      font-size: 1.5rem;
      border: 2px solid #374151;
      border-radius: 8px;
      background-color: #111827;
      color: #10b981;
      caret-color: transparent; 
    }
    
    /* Stili semaforo per Budgeting Pro */
    .budget-green { background-color: #ecfdf5; border-left-color: #10b981; }
    .budget-yellow { background-color: #fffbeb; border-left-color: #f59e0b; }
    .budget-red { background-color: #fef2f2; border-left-color: #ef4444; }
    .dark .budget-green { background-color: #064e3b; border-left-color: #10b981; }
    .dark .budget-yellow { background-color: #78350f; border-left-color: #f59e0b; }
    .dark .budget-red { background-color: #7f1d1d; border-left-color: #ef4444; }
    
    /* Stili Raggruppamento (Nuovo) */
    .group-header { cursor: pointer; }
    
    /* Stili solo per la stampa PDF, nasconde elementi non necessari */
    @media print {
        #navbar, #quick-actions, #transaction-form-modal, #modal, #toast, #pin-lock-modal, 
        .cta-button, #search, #filter-category, #filter-tag, #sort-key, #sort-direction,
        .flex-row-reverse, #report-type, #filter-type, #filter-date,
        .md\\:col-span-1, .md\\:col-span-3,
        #transactions-detail .flex-grow + div {
            display: none !important;
        }
        
        /* Forza la visualizzazione di alcuni dettagli nella stampa */
        #transactions-detail {
            display: block !important;
            page-break-inside: avoid;
        }
    }
  </style>
  <link id="dynamic-manifest" rel="manifest">
</head>
<body class="min-h-screen">

  <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
    <header class="mb-6 flex items-center justify-between">
      <div class="flex-1 text-center">
        <h1 class="text-3xl font-bold text-gray-800">Finanza Smart PRO üöÄ</h1>
        <p class="text-center text-sm text-gray-500" id="header-subtitle">Caricamento...</p>
      </div>
      <button id="theme-toggle"
        class="ml-4 px-3 py-2 rounded-lg border text-sm hover:bg-gray-100 dark:hover:bg-gray-800">
        üåô Dark
      </button>
    </header>

    <nav id="navbar" class="flex justify-around bg-white p-2 rounded-xl shadow-lg card"></nav>

    <div id="content-area" class="mt-4"></div>

    <div id="quick-actions" class="md:hidden"> 
      <div class="flex space-x-3 max-w-lg mx-auto">
        <button onclick="openTransactionForm('true')"
          class="flex-1 bg-emerald-500 text-white p-3 rounded-xl font-bold hover:bg-emerald-600 shadow-xl transition transform hover:scale-[1.02] text-lg">
          üí∞ Registra Entrata (I)
        </button>
        <button onclick="openTransactionForm('false')"
          class="flex-1 bg-red-500 text-white p-3 rounded-xl font-bold hover:bg-red-600 shadow-xl transition transform hover:scale-[1.02] text-lg">
          üí∏ Registra Uscita (E)
        </button>
      </div>
    </div>
    
    <div id="transaction-form-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 justify-center items-start p-4 overflow-y-auto">
        <div id="transaction-form-content" class="bg-white p-6 rounded-xl w-full max-w-lg card mt-10 mb-10">
            </div>
    </div>


    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
      <div class="bg-white p-6 rounded-xl w-full max-w-sm card">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Attenzione</h3>
        <p id="modal-message" class="text-gray-700 mb-4">Messaggio di esempio.</p>
        <div class="flex justify-end space-x-3">
          <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Annulla</button>
          <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 cta-button">Conferma</button>
        </div>
      </div>
    </div>

    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 bg-green-500 text-white rounded-xl shadow-lg transition-opacity duration-300 opacity-0" role="alert">
      Azione completata con successo!
    </div>
  </div>
  
  <div id="pin-lock-modal">
    <h2 class="text-3xl font-bold mb-3">Finanza Smart PRO</h2>
    <div id="login-form-wrapper">
        <p class="text-lg mb-4 text-gray-400">Seleziona o crea il tuo Profilo</p>
        
        <select id="user-select" class="p-2 border rounded-lg w-64 text-gray-800 mb-4"></select>
        <input type="text" id="new-user-input" placeholder="Nuovo Profilo (es. Nome)" class="p-2 border rounded-lg w-64 text-gray-800 mb-2 hidden">
        <button id="new-user-btn" onclick="toggleNewUserMode()" class="px-3 py-1 bg-indigo-500 text-white rounded-lg text-sm mb-6">Nuovo Utente</button>
        <button id="confirm-new-user-btn" onclick="createNewUser()" class="px-3 py-1 bg-emerald-500 text-white rounded-lg text-sm mb-6 hidden">Crea e Accedi</button>

        <p class="text-lg mb-6 text-gray-400" id="pin-prompt">Inserisci il PIN per sbloccare</p>
        <div class="pin-input">
          <input type="password" maxlength="1" id="pin-1" class="pin-digit" pattern="[0-9]" inputmode="numeric" />
          <input type="password" maxlength="1" id="pin-2" class="pin-digit" pattern="[0-9]" inputmode="numeric" />
          <input type="password" maxlength="1" id="pin-3" class="pin-digit" pattern="[0-9]" inputmode="numeric" />
          <input type="password" maxlength="1" id="pin-4" class="pin-digit" pattern="[0-9]" inputmode="numeric" />
        </div>
        <p id="pin-error" class="text-red-500 mt-4 text-sm hidden">PIN errato. Riprova.</p>
        <p class="text-sm text-gray-500 mt-8" id="default-pin-note">PIN di default: 1234</p>
    </div>
  </div>
  <script>
    // --- CONFIG/GLOBAL ---
    const GLOBAL_KEY = 'smartFinApp_global_users_v5';
    const SESSION_STORAGE_PIN_KEY = 'smartFinApp_unlocked';
    const SESSION_STORAGE_REPORT_KEY = 'smartFinApp_report_filters'; 
    const IVA_RATES = [0,4,5,10,22];
    const MAX_RECENT_TRANSACTIONS = 10;
    const DEFAULT_CATEGORIES = ['Affitto','Bollette','Spesa','Marketing','Servizi','Stipendi','Carburante','Ristoranti','Abbonamenti','Altro'];
    const FISCAL_REMINDER_TYPES = ['IVA Trimestrale','IVA Saldo/Acconto','IMU','TARI','Tasse/Acconto','Assicurazione','Bollo Auto','Altri Costi Personali','Altri Costi Attivit√†'];
    const MAX_FORFETTARIO_REVENUE = 85000;
    
    const DEFAULT_FISCAL_PARAMS = {
        regime: 'forfettario',
        profitRate: 0.40, 
        taxRate: 0.15,    
        inpsRate: 0.26    
    };
    
    const CATEGORY_ICONS = {
        'Affitto': 'üè†', 'Bollette': 'üí°', 'Spesa': 'üõí', 'Marketing': 'üì¢', 'Servizi': 'üõ†Ô∏è', 
        'Stipendi': 'üßë‚Äçüíº', 'Carburante': '‚õΩ', 'Ristoranti': 'üçΩÔ∏è', 'Abbonamenti': 'üîó', 'Altro': 'üì¶'
    };
    
    const COMMON_FREQUENCIES = {
        'affitto': 'monthly', 'stipendio': 'monthly', 'bollette': 'monthly', 'abbonamento': 'monthly',
        'assicurazione': 'annual', 'tasse': 'quarterly', 'imu': 'annual', 'mensile': 'monthly', 
        'trimestrale': 'quarterly', 'annuale': 'annual'
    };
    
    const DASHBOARD_WIDGETS = [
        { id: 'fhs', title: 'Salute Finanziaria', component: 'renderFHSWidget', default: true },
        { id: 'liquidity', title: 'Liquidit√†/Stress Test', component: 'renderLiquidityWidget', default: true },
        { id: 'focus_today', title: 'Focus Oggi', component: 'renderFocusTodayWidget', default: true },
        { id: 'weekly_chart', title: 'Grafico 7 Giorni', component: 'renderWeeklyChartWidget', default: true },
        { id: 'advice', title: 'Consigli Intelligenti', component: 'renderAdviceWidget', default: true },
    ];


    // Stato globale
    let globalState = {
        currentUser: null,
        users: [] 
    };

    let appData = { 
        invoices:[], expenses:[], reminders:[], contacts:[], birthdays: [],
        recurringExpenses: [], lastId:0, categories: DEFAULT_CATEGORIES.slice(), 
        pinHash: '', currencySymbol: '‚Ç¨', monthlySavingsTarget: 0, categoryBudgets: {},
        fiscalParams: DEFAULT_FISCAL_PARAMS, currentBankBalance: 0, 
        taxCashReserve: 0, dashboardLayout: DASHBOARD_WIDGETS.filter(w => w.default).map(w => w.id),
        // *** RESILIENZA: Checksum per l'auto-riparazione ***
        dataChecksum: ''
    };
    let currentPage = 'activity';
    let reportFilters = { 
        type: 'global', filterType: 'year', filterDateStr: String(new Date().getFullYear()),
        categoryFilter: 'all', tagFilter: 'all', sortKey: 'date', sortDirection: 'desc', searchQuery: ''
    };
    
    // Variabili per Memoization KPI & Summary
    let calculatedResultsCache = {};
    const CACHE_DURATION = 60000;
    let lastCacheUpdateTime = 0;


    let simulationState = {
        additionalRevenue: 0, additionalExpense: 0, taxRateOverride: null, 
        profitRateOverride: null, targetNetIncome: null
    };

    // --- UTILITY ---
    
    // *** RESILIENZA: Calcolo Checksum CRC Semplice ***
    function calculateDataChecksum(dataToHash) {
        // Usa una funzione hash non crittografica ma veloce per rilevare alterazioni
        const jsonStr = JSON.stringify({
            invoices: dataToHash.invoices,
            expenses: dataToHash.expenses,
            reminders: dataToHash.reminders,
            lastId: dataToHash.lastId 
        });
        let hash = 0;
        for (let i = 0; i < jsonStr.length; i++) {
            const char = jsonStr.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash |= 0; // Convert to 32bit integer
        }
        return hash.toString();
    }
    
    let simulationTimer = null;
    const SIMULATION_DELAY = 500; 

    function debounceSimulationUpdate() {
        if (simulationTimer) {
            clearTimeout(simulationTimer);
        }
        simulationTimer = setTimeout(() => {
            updateFiscalSimulationUI();
        }, SIMULATION_DELAY);
    }
    
    function updateFiscalSimulationUI() {
        if (currentPage !== 'activity') return;
        // ... (Logica UI Simulatore - omessa per brevit√†) ...
        const fiscalSim = calculateFiscalSimulation(new Date().getFullYear());
        const reverseSim = calculateReverseFiscalProjection();
        const symbol = getCurrencySymbol();
        
        const simCard = document.querySelector('.fiscal-simulation-card');
        if (simCard) {
            simCard.classList.remove('border-red-500', 'border-indigo-500');
            simCard.classList.add(fiscalSim.projectionIsActive ? 'border-indigo-500' : 'border-red-500');
            
            const titleEl = simCard.querySelector('h3');
            if (titleEl) {
                const fiscalTypeLabel = fiscalSim.fiscalParamsUsed.regime === 'forfettario' ? 'Forfettario' : 'Ordinario';
                titleEl.innerHTML = `Simulazione Fiscale (${fiscalTypeLabel} Proiezione ${new Date().getFullYear()}) ${fiscalSim.projectionIsActive ? '‚ú® WHAT-IF' : ''}`;
                titleEl.classList.toggle('text-indigo-600', fiscalSim.projectionIsActive);
                titleEl.classList.toggle('text-red-600', !fiscalSim.projectionIsActive);
            }
        }

        const elementsToUpdate = {
            'sim-ricavi': fiscalSim.totalRicavi.toFixed(2), 'sim-costi': fiscalSim.totalCosti.toFixed(2),
            'sim-base-imponibile': fiscalSim.baseImponibile.toFixed(2), 'sim-imposta': fiscalSim.impostaSostitutiva.toFixed(2),
            'sim-inps': fiscalSim.contributiINPS.toFixed(2), 'sim-totale-tasse': fiscalSim.totaleTasse.toFixed(2),
            'sim-netta-rimanente': fiscalSim.nettaRimanente.toFixed(2), 'sim-note': fiscalSim.note
        };

        for (const [id, value] of Object.entries(elementsToUpdate)) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value + (['sim-ricavi','sim-costi','sim-base-imponibile','sim-imposta','sim-inps','sim-totale-tasse','sim-netta-rimanente'].includes(id) ? ` ${symbol}` : '');
            }
        }
        
        const netRimanenteEl = document.getElementById('sim-netta-rimanente');
        if (netRimanenteEl) {
            netRimanenteEl.classList.toggle('text-emerald-600', fiscalSim.nettaRimanente >= 0);
            netRimanenteEl.classList.toggle('text-red-600', fiscalSim.nettaRimanente < 0);
        }

        document.getElementById('sim-note').innerHTML = fiscalSim.note.replace(/‚Ç¨/g, symbol);
        
        const reverseOutput = document.getElementById('reverse-output');
        
        if (reverseOutput) {
            reverseOutput.textContent = reverseSim.ricavoAggiuntivoNecessario > 0 
                ? reverseSim.ricavoAggiuntivoNecessario.toFixed(2) + ' ' + symbol
                : (reverseSim.obiettivoRaggiunto ? 'Raggiunto!' : 'Non calcolato');
            reverseOutput.classList.toggle('text-red-600', reverseSim.ricavoAggiuntivoNecessario > 0);
            reverseOutput.classList.toggle('text-emerald-600', reverseSim.obiettivoRaggiunto);
        }

        const taxReserveElement = document.getElementById('tax-reserve-amount');
        const taxReserveContainer = document.getElementById('tax-reserve-container');
        
        if (taxReserveElement && taxReserveContainer) {
            const currentReserve = appData.taxCashReserve || 0;
            taxReserveElement.textContent = currentReserve.toFixed(2) + ' ' + symbol;
            
            taxReserveContainer.classList.remove('border-red-500', 'border-emerald-500');
            taxReserveContainer.classList.add(currentReserve < 0 ? 'border-red-500' : 'border-emerald-500');
        }
    }
    
    function getCurrencySymbol() { return appData.currencySymbol || '‚Ç¨'; }
    function getCategoryIcon(category) {
        const cat = category || 'Altro';
        const key = Object.keys(CATEGORY_ICONS).find(k => k.toLowerCase() === cat.toLowerCase());
        return CATEGORY_ICONS[key] || CATEGORY_ICONS['Altro'];
    }
    function saveReportFilters() { sessionStorage.setItem(SESSION_STORAGE_REPORT_KEY, JSON.stringify(reportFilters)); }
    function loadReportFilters() {
        try {
            const saved = sessionStorage.getItem(SESSION_STORAGE_REPORT_KEY);
            if (saved) {
                const loadedFilters = JSON.parse(saved);
                reportFilters = { ...reportFilters, ...loadedFilters };
                if (!loadedFilters.searchQuery) reportFilters.searchQuery = '';
            }
        } catch(e) { console.error('Errore caricamento filtri report', e); }
    }

    // --- HASHING e SICUREZZA ---
    function hashPin(pin) {
        let hash = 0;
        if (pin.length === 0) return hash;
        for (let i = 0; i < pin.length; i++) {
            const char = pin.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; 
        }
        return String(hash);
    }
    
    // --- THEME ---
    function applySavedTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.body.classList.toggle('dark', saved === 'dark');
      document.getElementById('theme-toggle')?.classList.toggle('dark', saved === 'dark');
      const btn = document.getElementById('theme-toggle');
      if (btn) btn.textContent = saved === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
    }
    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark':'light');
      applySavedTheme();
    }

    // --- STORAGE ---
    function loadGlobalState() {
        try {
            const raw = localStorage.getItem(GLOBAL_KEY);
            if (raw) {
                globalState = JSON.parse(raw);
            }
            if (globalState.users.length === 0) {
                const defaultPinHash = hashPin('1234');
                globalState.users = [{
                    id: 1, name: 'Principale', dataKey: 'smartFinApp_data_1', pinHash: defaultPinHash
                }];
                globalState.currentUser = globalState.users[0];
                saveGlobalState();
            } else if (!globalState.currentUser) {
                globalState.currentUser = globalState.users[0];
            }
        } catch(e) { 
            console.error('Errore nel caricamento stato globale', e); 
            globalState = { currentUser: null, users: [] };
        }
    }

    function saveGlobalState() {
        try {
            localStorage.setItem(GLOBAL_KEY, JSON.stringify(globalState));
        } catch(e) { console.error('Errore salvataggio stato globale', e); }
    }
    
    function loadData() {
        loadGlobalState();
        const user = globalState.currentUser;
        if (!user) return; 

        try {
            const raw = localStorage.getItem(user.dataKey);
            const savedChecksum = localStorage.getItem(`${user.dataKey}_checksum`);
            
            if (raw) {
                const parsed = JSON.parse(raw);
                
                // *** RESILIENZA: Verifica Checksum ***
                const calculated = calculateDataChecksum(parsed);

                if (savedChecksum && savedChecksum !== calculated) {
                    // Segnala corruzione critica
                    showModal('üö® Dati Corrotti Rilevati!', 'Il backup locale non √® congruo. Si prega di esportare i dati IMMEDIATAMENTE e pulire la cache (Settings > Pulizia Dati). Ricaricando, l\'app potrebbe caricare solo un set di dati parziale/danneggiato.', false);
                }
                
                appData = { ...appData, ...parsed };
            }
            
            // Inizializza o correggi la struttura di appData
            appData.invoices ||= []; appData.expenses ||= []; appData.reminders ||= []; 
            appData.contacts ||= []; appData.birthdays ||= []; appData.recurringExpenses ||= []; 
            appData.categories ||= DEFAULT_CATEGORIES.slice(); 
            appData.lastId = parseInt(appData.lastId) || 0; // Garantisce che sia un numero
            appData.pinHash = user.pinHash; appData.currencySymbol ||= '‚Ç¨'; appData.monthlySavingsTarget ||= 0;
            appData.categoryBudgets ||= {}; 
            appData.fiscalParams = { ...DEFAULT_FISCAL_PARAMS, ...appData.fiscalParams };
            appData.fiscalParams.regime = appData.fiscalParams.regime || 'forfettario'; 
            appData.taxCashReserve ||= 0; appData.currentBankBalance ||= 0; 
            appData.dashboardLayout ||= DASHBOARD_WIDGETS.filter(w => w.default).map(w => w.id);
            
            // *** RESILIENZA: Check ID di Congruit√† ***
            const maxIdInRecords = [...appData.invoices, ...appData.expenses, ...appData.reminders, ...appData.contacts, ...appData.birthdays].reduce((max, item) => Math.max(max, item.id || 0), 0);
            if (appData.lastId < maxIdInRecords) {
                console.warn(`Last ID (${appData.lastId}) non congruo. Auto-correzione a ${maxIdInRecords}.`);
                appData.lastId = maxIdInRecords;
                saveData(); // Forza un salvataggio con il nuovo ID
            }
            
            document.getElementById('header-subtitle').textContent = `Profilo: ${user.name}`;
            
            // Svuota la cache ad ogni ricaricamento completo dei dati
            calculatedResultsCache = {};
            lastCacheUpdateTime = 0;
            
        } catch(e){ 
            console.error('Errore nel caricamento dati utente', e); 
            showToast('Errore nel caricamento dati utente','red'); 
            saveData();
        }
    }
    function saveData(){ 
        const user = globalState.currentUser;
        if (!user) return;
        try{ 
            const userIndex = globalState.users.findIndex(u => u.dataKey === user.dataKey);
            if (userIndex > -1) {
                // *** SICUREZZA: Aggiorna l'hash PIN nel Global State prima del salvataggio. ***
                globalState.users[userIndex].pinHash = appData.pinHash;
                saveGlobalState();
            }
            
            const dataToSave = { ...appData };
            delete dataToSave.pinHash; 
            
            // *** RESILIENZA: Calcola e salva il nuovo checksum ***
            dataToSave.dataChecksum = calculateDataChecksum(dataToSave);
            localStorage.setItem(`${user.dataKey}_checksum`, dataToSave.dataChecksum);
            
            localStorage.setItem(user.dataKey, JSON.stringify(dataToSave)); 
            
            // Svuota la cache ad ogni salvataggio dati
            calculatedResultsCache = {};
            lastCacheUpdateTime = 0;
            
        }catch(e){ 
            console.error('Errore salvataggio', e); 
            // *** RESILIENZA: Gestione specifica per problemi di I/O / Quota Exceeded (tipico iOS) ***
            if (e.name === 'QuotaExceededError' || e.name === 'SecurityError') {
                 showModal('üö® ERRORE CRITICO DI SALVATAGGIO', 'Spazio di archiviazione esaurito o accesso negato dal browser. I dati NON sono stati salvati. Esegui subito un Export (JSON) e pulisci i dati vecchi.', false);
            } else {
                 showToast('Errore salvataggio','red'); 
            }
        } 
    }
    function getNextId(){ appData.lastId++; saveData(); return appData.lastId; }

    // --- PIN LOCK LOGIC ---
    function setupPinLock() {
        loadGlobalState();
        const pinDigits = document.querySelectorAll('.pin-digit');
        const pinModal = document.getElementById('pin-lock-modal');
        const isUnlocked = sessionStorage.getItem(SESSION_STORAGE_PIN_KEY) === 'true';

        if (!isUnlocked) {
            pinModal.style.display = 'flex';
            setupUserSelector();
            
            pinDigits.forEach((input, index) => {
                input.value = '';
                input.removeEventListener('input', handlePinInputListener);
                input.removeEventListener('keydown', handlePinKeyDownListener);
                input.addEventListener('input', (e) => handlePinInput(e, index));
                input.addEventListener('keydown', (e) => handlePinKeyDown(e, index));
            });
            document.getElementById('new-user-input').classList.add('hidden');
            document.getElementById('new-user-btn').classList.remove('hidden');
            document.getElementById('confirm-new-user-btn').classList.add('hidden');
            document.getElementById('pin-prompt').textContent = `Inserisci il PIN per sbloccare il profilo: ${globalState.currentUser.name}`;
            document.getElementById('default-pin-note').classList.toggle('hidden', globalState.users.length > 1);
            
            setTimeout(() => { document.getElementById('pin-1')?.focus(); }, 100); 
        } else {
            pinModal.style.display = 'none';
            const initialPage = appData.invoices.length>0 || appData.expenses.length>0 ? 'report':'activity';
            initializeFiscalReminders(); 
            renderPage(initialPage);
        }
    }
    
    function setupUserSelector() {
        const select = document.getElementById('user-select');
        select.innerHTML = globalState.users.map(u => 
            `<option value="${u.dataKey}" ${u.dataKey === globalState.currentUser.dataKey ? 'selected' : ''}>${u.name}</option>`
        ).join('');
        
        select.onchange = () => {
            const selectedKey = select.value;
            globalState.currentUser = globalState.users.find(u => u.dataKey === selectedKey);
            loadData(); 
            setupPinLock(); 
        };
    }
    
    function toggleNewUserMode() {
        const isNewUserMode = document.getElementById('new-user-input').classList.contains('hidden');
        document.getElementById('user-select').classList.toggle('hidden', !isNewUserMode);
        document.getElementById('new-user-input').classList.toggle('hidden', isNewUserMode);
        document.getElementById('new-user-btn').classList.toggle('hidden', !isNewUserMode);
        document.getElementById('confirm-new-user-btn').classList.toggle('hidden', isNewUserMode);
        document.getElementById('pin-prompt').textContent = isNewUserMode ? "Imposta il PIN per il nuovo profilo (4 cifre)" : `Inserisci il PIN per sbloccare il profilo: ${globalState.currentUser.name}`;
        document.getElementById('default-pin-note').classList.add('hidden');
        if (isNewUserMode) document.getElementById('new-user-input').focus();
    }
    
    function createNewUser() {
        const newName = document.getElementById('new-user-input').value.trim();
        const enteredPin = Array.from(document.querySelectorAll('.pin-digit')).map(input => input.value).join('');
        
        if (!newName) { showToast('Inserisci un nome per il nuovo profilo.', 'red'); return; }
        if (globalState.users.some(u => u.name.toLowerCase() === newName.toLowerCase())) { showToast('Nome profilo gi√† esistente.', 'red'); return; }
        if (enteredPin.length !== 4 || isNaN(enteredPin)) { showToast('Il PIN deve essere di 4 cifre.', 'red'); return; }
        
        const newUserId = Math.max(...globalState.users.map(u => u.id)) + 1;
        const newPinHash = hashPin(enteredPin);

        const newUser = {
            id: newUserId, name: newName, dataKey: `smartFinApp_data_${newUserId}`, pinHash: newPinHash
        };
        
        globalState.users.push(newUser);
        globalState.currentUser = newUser;
        
        appData = { ...appData, ...{ 
            invoices:[], expenses:[], reminders:[], contacts:[], birthdays: [],
            recurringExpenses: [], lastId:0, categories: DEFAULT_CATEGORIES.slice(), 
            pinHash: newPinHash, currencySymbol: '‚Ç¨', monthlySavingsTarget: 0,
            categoryBudgets: {}, fiscalParams: DEFAULT_FISCAL_PARAMS, currentBankBalance: 0,
            taxCashReserve: 0, dashboardLayout: DASHBOARD_WIDGETS.filter(w => w.default).map(w => w.id),
            dataChecksum: ''
        }};
        saveData(); 
        saveGlobalState(); 

        sessionStorage.setItem(SESSION_STORAGE_PIN_KEY, 'true');
        document.getElementById('pin-lock-modal').style.display = 'none';
        initializeFiscalReminders(); 
        renderPage('activity');
        showToast(`Profilo "${newName}" creato e sbloccato!`);
    }

    const handlePinInputListener = (e, index) => handlePinInput(e, index);
    const handlePinKeyDownListener = (e, index) => handlePinKeyDown(e, index);

    function handlePinInput(e, index) {
      const pinDigits = document.querySelectorAll('.pin-digit');
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 1);
      
      if (e.target.value.length === 1 && index < pinDigits.length - 1) {
        pinDigits[index + 1].focus();
      }

      if (Array.from(pinDigits).every(input => input.value.length === 1)) {
        checkPin();
      }
    }

    function handlePinKeyDown(e, index) {
      const pinDigits = document.querySelectorAll('.pin-digit');
      if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
        pinDigits[index - 1].focus();
      }
    }

    function checkPin() {
      const pinDigits = document.querySelectorAll('.pin-digit');
      const enteredPin = Array.from(pinDigits).map(input => input.value).join('');
      const pinError = document.getElementById('pin-error');
      
      if (enteredPin.length < 4) return;
      
      const expectedHash = globalState.currentUser ? globalState.currentUser.pinHash : appData.pinHash;
      const enteredHash = hashPin(enteredPin);
      
      if (enteredHash === expectedHash) {
        pinError.classList.add('hidden');
        sessionStorage.setItem(SESSION_STORAGE_PIN_KEY, 'true');
        document.getElementById('pin-lock-modal').style.display = 'none';
        
        loadData(); 
        
        const initialPage = appData.invoices.length>0 || appData.expenses.length>0 ? 'report':'activity';
        initializeFiscalReminders(); 
        renderPage(initialPage);
        showToast(`Accesso sbloccato! Benvenuto, ${globalState.currentUser.name}!`);
      } else {
        pinError.classList.remove('hidden');
        pinDigits.forEach(input => input.value = '');
        document.getElementById('pin-1').focus();
      }
    }
    
    // --- UI helpers ---
    function showModal(title,message,isConfirmation,onConfirm,onCancel=null){
      const modal = document.getElementById('modal');
      const t = document.getElementById('modal-title'); const m = document.getElementById('modal-message');
      const ok = document.getElementById('modal-confirm-btn'); const cancel = document.getElementById('modal-cancel-btn');
      t.textContent = title; m.textContent = message;
      if (isConfirmation){
        ok.textContent = 'Conferma'; ok.classList.remove('bg-gray-500','hover:bg-gray-600'); ok.classList.add('bg-red-600','hover:bg-red-700');
        ok.onclick = ()=>{ modal.classList.add('hidden'); onConfirm&&onConfirm(); };
        cancel.classList.remove('hidden'); cancel.onclick = ()=>{ modal.classList.add('hidden'); onCancel&&onCancel(); };
      } else {
        ok.textContent='OK'; ok.classList.remove('bg-red-600','hover:bg-red-700'); ok.classList.add('bg-gray-500','hover:bg-gray-600');
        ok.onclick = ()=> modal.classList.add('hidden'); cancel.classList.add('hidden');
      }
      modal.classList.remove('hidden');
    }
    function showToast(message,type='green'){
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-xl shadow-lg transition-opacity duration-300 opacity-100 ${type==='red'?'bg-red-500':'bg-green-500'}`;
      setTimeout(()=>{ toast.classList.remove('opacity-100'); toast.classList.add('opacity-0'); }, 2500);
    }

    // Gestione form in modale
    function openTransactionForm(isIncomeString, transactionId = null, transactionType = currentPage) {
        const isIncome = isIncomeString === 'true';
        const modal = document.getElementById('transaction-form-modal');
        const content = document.getElementById('transaction-form-content');

        content.innerHTML = renderTransactionForm(isIncome, transactionType); 
        modal.style.display = 'flex';
        
        document.getElementById('isIncome').value = isIncomeString;
        
        setupActivityIncomeTypeListeners(transactionType);
        setupContactAutocomplete(transactionType); 
        setupCategoryAutocomplete();
        calculateGross();

        if (transactionId !== null) {
            editTransaction(isIncome, transactionId, transactionType, true); // true per modal-edit
        } else {
            // Quick registration setup
            document.getElementById('date').value = new Date().toISOString().slice(0,10);
            document.getElementById('net-amount').value = '0.00';
            calculateGross();
            
            const incomeTypeSelect = document.getElementById('incomeType');
            if (incomeTypeSelect && isIncome && transactionType === 'activity'){ 
                incomeTypeSelect.value='Fattura (Cliente)'; 
                incomeTypeSelect.dispatchEvent(new Event('change')); 
            }
            showToast(isIncome?'Modulo pronto per Entrata!':'Modulo pronto per Uscita!','green');
        }
    }
    
    function closeTransactionForm() {
        document.getElementById('transaction-form-modal').style.display = 'none';
        document.getElementById('transaction-form-content').innerHTML = '';
        renderPage(currentPage); // Refresh page per aggiornare la lista transazioni
    }
    
    function quickRegister(isIncomeString) {
        openTransactionForm(isIncomeString);
    }


    // --- Filters/period helpers ---
    function filterByPeriod(itemDateStr, filterType, filterValue){
      if (filterType==='all'||!filterValue||filterValue==='all') return true;
      const itemDate = new Date(itemDateStr); if (isNaN(itemDate)) return false;
      const y=itemDate.getFullYear(), m=itemDate.getMonth();
      
      if (filterType==='year'){ return y===parseInt(filterValue); }
      if (filterType==='month'){ const [fy,fm]=filterValue.split('-').map(Number); return y===fy && m===(fm-1); }
      if (filterType==='quarter'){ 
        // Quarter value is in YYYY-MM format, e.g., '2025-01' for Q1, '2025-04' for Q2
        const year = parseInt(filterValue.substring(0, 4));
        const monthStart = parseInt(filterValue.substring(5, 7));
        if (y !== year) return false;
        
        const itemQuarter = Math.ceil((m + 1) / 3);
        const filterQuarter = Math.ceil(monthStart / 3);
        
        return itemQuarter === filterQuarter;
      }
      if (filterType==='day'){ return itemDateStr===filterValue; }
      
      if (filterType==='week'){ 
        const d = new Date(filterValue); 
        let dayOfWeek = d.getDay(); 
        const diff = d.getDate() - ((dayOfWeek + 6) % 7);
        const start = new Date(d);
        start.setDate(diff); 
        start.setHours(0,0,0,0); 
        const end = new Date(start); 
        end.setDate(start.getDate()+6); 
        end.setHours(23,59,59,999); 
        return itemDate>=start && itemDate<=end; 
      }
      return false;
    }
    
    // --- Filters for Report page ---
    function filterTransactionsByCriteria(transactions, categoryFilter, tagFilter) {
        if (!categoryFilter && !tagFilter) return transactions;
        
        const cat = categoryFilter ? categoryFilter.toLowerCase() : null;
        const tag = tagFilter ? tagFilter.toLowerCase() : null;

        return transactions.filter(t => {
            const matchesCategory = !cat || (t.category || 'altro').toLowerCase() === cat;
            const matchesTag = !tag || (t.tags || []).map(tg => tg.toLowerCase()).includes(tag);
            return matchesCategory && matchesTag;
        });
    }
    
    // Funzione di ordinamento centralizzata
    function sortTransactions(transactions) {
        const { sortKey, sortDirection } = reportFilters;
        if (!sortKey || sortKey === 'none') return transactions;

        const dir = sortDirection === 'asc' ? 1 : -1;

        return transactions.sort((a, b) => {
            let valA, valB;

            if (sortKey === 'date') {
                valA = new Date(a.date).getTime();
                valB = new Date(b.date).getTime();
            } else if (sortKey === 'gross') {
                valA = a.gross;
                valB = b.gross;
            } else {
                valA = String(a[sortKey] || '').toLowerCase();
                valB = String(b[sortKey] || '').toLowerCase();
            }

            if (valA < valB) return -1 * dir;
            if (valA > valB) return 1 * dir;
            return 0;
        });
    }
    
    // --- Core calculations (START) ---
    function calculateDailyNetBalance(type) {
        const days = 7;
        const today = new Date();
        const dates = [];
        for (let i = 0; i < days; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() - (days - 1 - i));
            dates.push(d.toISOString().slice(0, 10));
        }

        const dailyData = dates.map(dateStr => {
            // Usa la funzione ottimizzata con cache
            const summary = calculateFinancialSummary(type, 'day', dateStr);
            return summary.netBalance;
        });

        return { labels: dates.map(d => d.slice(5)), data: dailyData };
    }

    function renderWeeklyBalanceChart(type) {
        const chartId = `weeklyBalanceChart-${type}`;
        const ctx = document.getElementById(chartId)?.getContext('2d');
        if (!ctx) return;
        
        const { labels, data } = calculateDailyNetBalance(type);
        
        if (ctx.chart) ctx.chart.destroy();

        ctx.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Saldo Netto (${getCurrencySymbol()})`,
                    data: data,
                    borderColor: data[data.length - 1] >= 0 ? '#10b981' : '#ef4444',
                    backgroundColor: data[data.length - 1] >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Saldo Netto Ultimi 7 Giorni', color: document.body.classList.contains('dark') ? '#f1f5f9' : '#1e293b' }
                },
                scales: {
                    x: { ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' } },
                    y: { 
                        beginAtZero: false,
                        ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' }
                    }
                }
            }
        });
    }

    // *** MIGLIORAMENTO PERFORMANCE: Funzione centrale con Caching ***
    function calculateFinancialSummary(type, filterType, filterDateStr) {
      const cacheKey = `${type}:${filterType}:${filterDateStr}`;
      const now = Date.now();
      
      // Controlla la cache solo se il periodo di validit√† √® ancora attivo
      if (calculatedResultsCache[cacheKey] && (now - lastCacheUpdateTime < CACHE_DURATION)) {
        return calculatedResultsCache[cacheKey];
      }

      let totalIncomes=0, totalExpenses=0, ivaAddebito=0, ivaCredito=0;
      const types = type==='global' ? ['activity','personal'] : [type];
      const all = [
        ...appData.invoices.map(t=>({...t,isIncome:true,key:'inv'})),
        ...appData.expenses.map(t=>({...t,isIncome:false,key:'exp'}))
      ];
      
      // Filtra una sola volta per tipo e periodo
      const filtered = all.filter(i=>types.includes(i.type)).filter(i=>filterByPeriod(i.date,filterType,filterDateStr));
      
      // Calcolo ottimizzato: itera sulla lista filtrata
      filtered.forEach(i=>{
        const gross = parseFloat(i.gross) || 0;
        const vatAmount = parseFloat(i.vatAmount) || 0;
        
        if (i.isIncome){ 
          totalIncomes += gross; 
          if (i.type==='activity') ivaAddebito += vatAmount; 
        }
        else { 
          totalExpenses += gross; 
          if (i.type==='activity') ivaCredito += vatAmount; 
        }
      });
      
      const netBalance = totalIncomes - totalExpenses;
      const ivaBalance = ivaAddebito - ivaCredito;
      
      const result = { 
        totalIncomes,
        totalExpenses,
        netBalance,
        ivaAddebito,
        ivaCredito,
        ivaBalance, 
        // La lista transazioni √® solo filtrata (non ordinata), sar√† ordinata nel Report per performance
        transactions: filtered.slice() 
      };
      
      // Salva nella cache solo se il ricalcolo √® avvenuto
      calculatedResultsCache[cacheKey] = result;
      // Aggiorna il timestamp della cache
      lastCacheUpdateTime = now; 

      return result;
    }
    
    // Calcolo Proiezione Fiscale Annuale Dinamica (Baseline)
    function calculateAnnualFiscalProjection() {
        const today = new Date();
        const currentYear = today.getFullYear();
        const monthsPassed = today.getMonth() + 1;
        
        // Usa la summary che beneficia della cache
        const yearSummary = calculateFinancialSummary('activity', 'year', String(currentYear));
        
        // Calcola i mesi in cui ci sono state transazioni (pi√π preciso del semplice `monthsPassed`)
        const historicalMonths = Object.keys(yearSummary.transactions.reduce((acc, t) => {
            acc[t.date.slice(0, 7)] = true;
            return acc;
        }, {})).length || 1; 

        const monthsRemaining = 12 - monthsPassed;

        // Proiezione su 12 mesi
        const projectedRevenue = yearSummary.totalIncomes / historicalMonths * 12;
        const projectedExpenses = yearSummary.totalExpenses / historicalMonths * 12;
        
        // Se non ci sono ricavi nel database, la proiezione √® zero
        const totalRicavi = historicalMonths === 0 ? 0 : projectedRevenue;
        const totalCosti = historicalMonths === 0 ? 0 : projectedExpenses;

        return { projectedRevenue: totalRicavi, projectedExpenses: totalCosti };
    }

    // --- Calcolo IRPEF a Scaglioni (Per Regime Ordinario) ---
    function calculateIRPEF(baseImponibile) {
        let irpef = 0;
        let residuo = baseImponibile;

        const scaglioni = [
            { limite: 28000, aliquota: 0.23 },
            { limite: 50000, aliquota: 0.35 },
            { limite: Infinity, aliquota: 0.43 }
        ];
        
        let scaglionePrecedenteLimite = 0;

        for (const scaglione of scaglioni) {
            
            let imponibileInScaglione = 0;
            if (scaglione.limite === Infinity) {
                imponibileInScaglione = residuo;
            } else {
                const rangeSize = scaglione.limite - scaglionePrecedenteLimite;
                imponibileInScaglione = Math.min(residuo, rangeSize);
            }
            
            if (imponibileInScaglione > 0) {
                irpef += imponibileInScaglione * scaglione.aliquota;
                residuo -= imponibileInScaglione;
            } else if (residuo <= 0) {
                break; 
            }
            scaglionePrecedenteLimite = scaglione.limite;
        }
        
        return irpef;
    }


    // Calcolo Simulazione Fiscale
    function calculateFiscalSimulation(currentYear, customRevenue = null, customExpense = null) {
        const projection = calculateAnnualFiscalProjection();
        
        const params = { 
            regime: appData.fiscalParams.regime,
            // Priorit√†: Override Simulazione > Parametri Salvati
            profitRate: simulationState.profitRateOverride !== null ? simulationState.profitRateOverride : appData.fiscalParams.profitRate,
            taxRate: simulationState.taxRateOverride !== null ? simulationState.taxRateOverride : appData.fiscalParams.taxRate,
            inpsRate: appData.fiscalParams.inpsRate 
        };

        const totalRicaviBase = projection.projectedRevenue;
        const totalCostiBase = projection.projectedExpenses;
        
        let totalRicaviSimulated = (customRevenue !== null) 
            ? customRevenue 
            : totalRicaviBase + simulationState.additionalRevenue;
            
        let totalCostiSimulated = (customExpense !== null)
            ? customExpense
            : totalCostiBase + simulationState.additionalExpense;
        
        let baseImponibileFiscale = 0;
        let impostaTotale = 0;
        let contributiINPS = 0;
        let note = '';
        
        // --- Logica Regime ---
        if (params.regime === 'forfettario') {
            baseImponibileFiscale = totalRicaviSimulated * params.profitRate;
            const aliquotaFiscaleUsata = params.taxRate;
            
            impostaTotale = baseImponibileFiscale * aliquotaFiscaleUsata;
            contributiINPS = baseImponibileFiscale * appData.fiscalParams.inpsRate; 

            note = `Regime Forfettario - Coeff. di Redditivit√†: ${(params.profitRate * 100).toFixed(0)}%.`;
            if (totalRicaviSimulated > MAX_FORFETTARIO_REVENUE) {
                 note += ` ‚ö†Ô∏è Attenzione: Ricavi simulati sopra il massimale Forfettario (${MAX_FORFETTARIO_REVENUE.toFixed(0)}${getCurrencySymbol()}).`;
            }

        } else if (params.regime === 'ordinario') {
            
            baseImponibileFiscale = Math.max(0, totalRicaviSimulated - totalCostiSimulated); 
            contributiINPS = baseImponibileFiscale * appData.fiscalParams.inpsRate; 
            
            const baseImponibileIRPEF = Math.max(0, baseImponibileFiscale - contributiINPS);
            impostaTotale = calculateIRPEF(baseImponibileIRPEF);
            
            note = `Regime Ordinario - Aliquote IRPEF a Scaglioni. I costi e i contributi INPS sono DEDUCIBILI.`;
        }

        // Calcolo del Saldo Netto Rimanente
        const projectedNetBalance = totalRicaviSimulated - totalCostiSimulated;
        const nettaRimanente = projectedNetBalance - impostaTotale - contributiINPS;

        const isSimulating = simulationState.additionalRevenue !== 0 || simulationState.additionalExpense !== 0 || simulationState.taxRateOverride !== null || simulationState.profitRateOverride !== null;
        
        if (isSimulating) {
            note = `‚ú® Scenario What-If Attivo. Ricavi Add: ${simulationState.additionalRevenue.toFixed(2)}${getCurrencySymbol()}. Costi Add: ${simulationState.additionalExpense.toFixed(2)}${getCurrencySymbol()}. ` + note;
        }

        return {
            totalRicavi: +totalRicaviSimulated.toFixed(2),
            totalCosti: +totalCostiSimulated.toFixed(2),
            baseImponibile: +baseImponibileFiscale.toFixed(2),
            impostaSostitutiva: +impostaTotale.toFixed(2),
            contributiINPS: +contributiINPS.toFixed(2),
            totaleTasse: +(impostaTotale + contributiINPS).toFixed(2),
            nettaRimanente: +nettaRimanente.toFixed(2),
            note: note,
            projectionIsActive: isSimulating,
            fiscalParamsUsed: params
        };
    }
    
    // Simulatore a Ritroso (Obiettivo Netto)
    function calculateReverseFiscalProjection() {
        const targetNet = simulationState.targetNetIncome;
        if (targetNet === null || isNaN(targetNet)) {
            return { ricavoAggiuntivoNecessario: 0, obiettivoRaggiunto: false };
        }
        
        const currentYear = new Date().getFullYear();
        const projection = calculateAnnualFiscalProjection();
        // Calcola la simulazione con gli override attuali
        const currentSim = calculateFiscalSimulation(currentYear);
        
        const params = currentSim.fiscalParamsUsed;
        let ricavoAggiuntivoNecessario = 0;

        if (currentSim.nettaRimanente >= targetNet) {
            return { ricavoAggiuntivoNecessario: 0, obiettivoRaggiunto: true };
        }

        const deficit = targetNet - currentSim.nettaRimanente; 

        if (params.regime === 'forfettario') {
            
            // Formula Forfettario: Netto = Ricavo * (1 - (ProfitRate * TaxRate) - (ProfitRate * InpsRate))
            const totalTaxRateOnRevenue = (params.profitRate * params.taxRate) + (params.profitRate * params.inpsRate);
            const netRetentionRate = 1 - totalTaxRateOnRevenue;
            
            if (netRetentionRate <= 0) {
                return { ricavoAggiuntivoNecessario: Infinity, obiettivoRaggiunto: false };
            }
            
            ricavoAggiuntivoNecessario = deficit / netRetentionRate;
            
        } else if (params.regime === 'ordinario') {
            
            const currentImponibile = currentSim.baseImponibile;
            let marginalTaxRate = 0;
            
            if (currentImponibile <= 28000) marginalTaxRate = 0.23;
            else if (currentImponibile <= 50000) marginalTaxRate = 0.35;
            else marginalTaxRate = 0.43;

            // In Ordinario: Netto = Ricavo - Costi - INPS(deducibile) - IRPEF(su Netto-INPS)
            // Semplificando per un incremento marginale di Ricavo (dR), l'aumento netto √®:
            // dR - (dR * INPS) - (dR * (1-INPS) * AliquotaMarginale)
            
            const effectiveMarginalTax = marginalTaxRate * (1 - params.inpsRate);
            const netRetentionRateSimple = 1 - params.inpsRate - effectiveMarginalTax;

            if (netRetentionRateSimple <= 0) {
                 return { ricavoAggiuntivoNecessario: Infinity, obiettivoRaggiunto: false };
            }

            ricavoAggiuntivoNecessario = deficit / netRetentionRateSimple;
        }

        return {
            ricavoAggiuntivoNecessario: +Math.max(0, ricavoAggiuntivoNecessario).toFixed(2),
            obiettivoRaggiunto: ricavoAggiuntivoNecessario <= 0
        };
    }

    function calculateIvaQuarterly(year, quarter) {
        // ... Logica IVA esistente
        const startMonth = (quarter - 1) * 3;
        const endMonth = startMonth + 2; 

        let ivaAddebito = 0;
        let ivaCredito = 0;

        const activityTransactions = [
            ...appData.invoices.map(t=>({...t,isIncome:true})),
            ...appData.expenses.map(t=>({...t,isIncome:false}))
        ].filter(t => t.type === 'activity');

        activityTransactions.forEach(t => {
            const date = new Date(t.date);
            if (date.getFullYear() === year && date.getMonth() >= startMonth && date.getMonth() <= endMonth) {
                const vatAmount = parseFloat(t.vatAmount) || 0;
                if (t.isIncome) {
                    ivaAddebito += vatAmount;
                } else {
                    ivaCredito += vatAmount;
                }
            }
        });

        const ivaBalance = ivaAddebito - ivaCredito;
        return { ivaAddebito, ivaCredito, ivaBalance: +ivaBalance.toFixed(2) };
    }
    
    // Calcolo Proiezione Saldo Conto a 6 Mesi
    function calculateSixMonthBalanceProjection() {
        // Usa KPI dalla cache
        const kpis = computeKPIs(); 
        
        const monthsToProject = 6;
        const today = new Date();
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // Calcola il saldo corrente (Saldo Base + Netto transazioni dall'inizio)
        const summarySinceStart = calculateFinancialSummary('global', 'all', 'all');
        let currentBalance = (parseFloat(appData.currentBankBalance) || 0);
        currentBalance += summarySinceStart.transactions.reduce((acc, t) => acc + (t.gross * (t.isIncome ? 1 : -1)), 0);
        
        const monthlyProjection = [];

        // Usa la media mobile mensile (meno volatile)
        const avgMonthlyNet = (kpis.avgIncome || 0) - (kpis.avgExpense || 0);
        
        for (let m = 0; m < monthsToProject; m++) {
            const date = new Date(startOfMonth.getFullYear(), startOfMonth.getMonth() + m, 1);
            const monthLabel = date.toLocaleDateString('it-IT', { month: 'short', year: '2-digit' });
            
            let monthFlow = avgMonthlyNet; 

            // Aggiungi ricorrenze previste
            appData.recurringExpenses.forEach(r => {
                const nextDateStr = calculateNextRecurrence(r.lastDate, r.frequency);
                if (nextDateStr) {
                    const nextDate = new Date(nextDateStr);
                    if (nextDate.getMonth() === date.getMonth() && nextDate.getFullYear() === date.getFullYear()) {
                        const isIncome = r.isIncome || appData.invoices.some(i => i.description === r.description);
                        monthFlow += isIncome ? r.lastAmount : -r.lastAmount;
                    }
                }
            });

            // Sottrai promemoria di spesa (pagamento)
            appData.reminders.forEach(r => {
                const rDate = new Date(r.date);
                if (!r.paid && rDate.getFullYear() === date.getFullYear() && rDate.getMonth() === date.getMonth() && r.amount > 0) {
                    monthFlow -= r.amount;
                }
            });
            
            currentBalance += monthFlow;
            
            monthlyProjection.push({
                label: monthLabel, flow: monthFlow, balance: +currentBalance.toFixed(2)
            });
        }

        return {
            projection: monthlyProjection[monthsToProject - 1]?.balance || currentBalance,
            details: monthlyProjection
        };
    }
    
    // Calcolo Punteggio di Salute Finanziaria (FHS)
    function calculateFinancialHealthScore() {
        const cacheKey = 'fhs_score';
        const now = Date.now();
        if (calculatedResultsCache[cacheKey] && (now - lastCacheUpdateTime < CACHE_DURATION)) {
            return calculatedResultsCache[cacheKey];
        }
        
        const kpis = computeKPIs();
        const monthsAutonomy = calculateLiquidityBuffer();
        
        let score = 0;
        let maxScore = 100;
        
        // 1. Tasso di Risparmio (Max 30 punti)
        const savingRateScore = Math.min(Math.max(kpis.savingRate, 0), 30); 
        score += savingRateScore;
        
        // 2. Buffer di Liquidit√† (Max 30 punti)
        let liquidityScore = 0;
        if (monthsAutonomy >= 6) liquidityScore = 30;
        else if (monthsAutonomy >= 3) liquidityScore = 20;
        else if (monthsAutonomy >= 1) liquidityScore = 10;
        score += liquidityScore;
        
        // 3. Rispetto del Budget (Max 20 punti)
        let budgetScore = 20;
        const currentMonth = new Date().toISOString().slice(0, 7);
        const monthSummary = calculateFinancialSummary('personal', 'month', currentMonth);
        const budgetItems = Object.keys(appData.categoryBudgets);
        
        let budgetAlerts = 0;
        budgetItems.forEach(cat => {
            const budget = appData.categoryBudgets[cat] || 0;
            const spent = monthSummary.transactions.filter(t => !t.isIncome && t.type === 'personal' && t.category === cat).reduce((s, t) => s + t.gross, 0);
            if (budget > 0 && spent > budget) {
                budgetAlerts++;
            }
        });
        if (budgetItems.length > 0) {
            const deductionPerAlert = 20 / budgetItems.length;
            budgetScore -= budgetAlerts * deductionPerAlert;
        }
        score += Math.max(0, budgetScore);
        
        // 4. Proiezione Saldo a 6 mesi (Max 20 punti)
        const sixMonthProj = calculateSixMonthBalanceProjection().projection;
        let projScore = 0;
        if (sixMonthProj >= 1000) projScore = 20;
        else if (sixMonthProj >= 0) projScore = 10;
        else projScore = 0;
        score += projScore;

        const result = { score: Math.round(Math.min(score, maxScore)), max: maxScore };
        calculatedResultsCache[cacheKey] = result;
        return result;
    }
    
    // Calcolo Buffer Liquidit√† (Mesi di autonomia)
    function calculateLiquidityBuffer() {
        const kpis = computeKPIs();
        const avgMonthlyExpense = kpis.avgExpense; 
        
        const summarySinceStart = calculateFinancialSummary('global', 'all', 'all');
        let currentLiquidita = (parseFloat(appData.currentBankBalance) || 0);
        currentLiquidita += summarySinceStart.transactions.reduce((acc, t) => acc + (t.gross * (t.isIncome ? 1 : -1)), 0);
        
        if (avgMonthlyExpense <= 0) return 99; 
        
        const months = currentLiquidita / avgMonthlyExpense;
        return +months.toFixed(1);
    }
    
    // Analisi Picchi di Spesa (Media Mobile)
    function analyzeExpenseSpikes() {
        const expenses = appData.expenses.filter(e => e.type === 'personal');
        const monthlyExpenses = {};
        
        expenses.forEach(e => {
            const ym = e.date.slice(0, 7);
            const cat = e.category || 'Altro';
            monthlyExpenses[ym] = monthlyExpenses[ym] || {};
            monthlyExpenses[ym][cat] = (monthlyExpenses[ym][cat] || 0) + e.gross;
        });

        const months = Object.keys(monthlyExpenses).sort();
        const currentMonth = new Date().toISOString().slice(0, 7);
        const alerts = [];

        if (months.length < 3) return []; 

        for (const cat of appData.categories) {
            if (!monthlyExpenses[currentMonth]?.[cat]) continue; 
            
            const currentSpent = monthlyExpenses[currentMonth][cat];
            
            const pastMonths = months.filter(m => m < currentMonth).slice(-3);
            if (pastMonths.length < 3) continue; 

            let sumPastExpenses = 0;
            pastMonths.forEach(m => {
                sumPastExpenses += monthlyExpenses[m][cat] || 0;
            });

            const avgMobile3M = sumPastExpenses / pastMonths.length;
            
            // Allerta se spesa > 25% rispetto alla media mobile degli ultimi 3 mesi
            if (avgMobile3M > 0 && currentSpent > avgMobile3M * 1.25) {
                const diff = (currentSpent - avgMobile3M).toFixed(2);
                alerts.push({
                    category: cat, currentSpent: currentSpent.toFixed(2), avg: avgMobile3M.toFixed(2),
                    message: `Spesa in ${cat} (+${diff} ${getCurrencySymbol()}) √® il ${(currentSpent / avgMobile3M * 100).toFixed(0)}% della media mobile. Rivedi il budget!`
                });
            }
        }
        return alerts;
    }
    // --- Fine Core Calculations ---

    // --- NUOVA FUNZIONE: AutoFill / Smart Data ---
    function autoFillSmartData(description) {
        const type = document.getElementById('transaction-type-hidden')?.value || currentPage; 
        const isIncome = document.getElementById('isIncome')?.value === 'true';

        if (!description || !type || type === 'report' || type === 'reminders' || type === 'settings') return;
        
        const desc = description.toLowerCase().trim();

        const allTransactions = [...appData.invoices, ...appData.expenses];
        const lastSimilarTransaction = allTransactions
            .filter(t => t.description?.toLowerCase() === desc && (t.isIncome === isIncome) && t.type === type)
            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

        if (lastSimilarTransaction) {
            document.getElementById('category').value = lastSimilarTransaction.category || 'Altro';
            document.getElementById('vat-rate').value = lastSimilarTransaction.vatRate.toFixed(0);
            if (isIncome && type === 'activity') {
                document.getElementById('incomeType').value = lastSimilarTransaction.incomeType || 'Fattura (Cliente)';
                document.getElementById('incomeType').dispatchEvent(new Event('change'));
            }
            calculateGross();
            showToast(`Dati suggeriti in base a "${lastSimilarTransaction.description}".`);
            return;
        }

        let suggestedCategory = null;
        let suggestedVatRate = 0; 
        
        if (type === 'personal') {
            if (desc.includes('affitto') || desc.includes('mutuo')) suggestedCategory = 'Affitto';
            else if (desc.includes('bolletta') || desc.includes('luce') || desc.includes('gas') || desc.includes('acqua')) suggestedCategory = 'Bollette';
            else if (desc.includes('supermercato') || desc.includes('spesa') || desc.includes('alimentari')) suggestedCategory = 'Spesa';
            else if (desc.includes('ristorante') || desc.includes('pizzeria')) suggestedCategory = 'Ristoranti';
            else if (desc.includes('abbonamento') || desc.includes('netflix') || desc.includes('spotify')) suggestedCategory = 'Abbonamenti';
            
            suggestedVatRate = 0; 
        } 
        
        if (type === 'activity') {
            suggestedVatRate = 22; 
            if (desc.includes('carburante') || desc.includes('benzina') || desc.includes('diesel')) suggestedCategory = 'Carburante';
            else if (desc.includes('marketing') || desc.includes('ads') || desc.includes('pubblicit')) suggestedCategory = 'Marketing';
            else if (desc.includes('consulenza') || desc.includes('servizi') || desc.includes('cloud')) suggestedCategory = 'Servizi';
            else if (desc.includes('stipendio') || desc.includes('pagamento fornitore') || desc.includes('dipendente')) suggestedCategory = 'Stipendi';
        }

        if (suggestedCategory) {
            document.getElementById('category').value = suggestedCategory;
            document.getElementById('vat-rate').value = suggestedVatRate.toFixed(0);
            calculateGross();
            showToast(`Suggerimento: categoria impostata su "${suggestedCategory}".`);
        }
    }
    // --- Fine NUOVA FUNZIONE: AutoFill / Smart Data ---


    // --- Contacts / Categories helpers ---
    function addContact(name, scope, relation){
      const clean = (name||'').trim(); if (!clean) return;
      const exists = appData.contacts.find(c=> c.name.toLowerCase()===clean.toLowerCase() && c.scope===scope );
      if (!exists){ appData.contacts.push({ id:getNextId(), name:clean, scope, relation }); saveData(); }
    }
    
    function ensureCategory(cat){
      const c=(cat||'').trim(); if (c.length<1) return;
      if (!appData.categories.map(s=>s.toLowerCase()).includes(c.toLowerCase())) { 
        appData.categories.push(c); 
        appData.categories.sort((a,b)=>a.localeCompare(b)); 
        saveData(); 
      }
    }
    
    function getAverageMonthlyExpense(category) {
        const target = (category || 'Altro').toLowerCase();
        const relevantExpenses = appData.expenses.filter(e => 
            (e.category || 'Altro').toLowerCase() === target
        );
        const monthlyTotals = {};
        relevantExpenses.forEach(e => {
            const ym = e.date.slice(0, 7);
            monthlyTotals[ym] = (monthlyTotals[ym] || 0) + e.gross;
        });
        const totalMonths = Object.keys(monthlyTotals).length;
        if (totalMonths === 0) return 0;
        const totalExpense = Object.values(monthlyTotals).reduce((sum, current) => sum + current, 0);
        return totalExpense / totalMonths;
    }

    // Logica per generare transazioni future in appData.reminders
    function trackRecurringExpense(description, gross, date, isIncome) {
        const desc = description.toLowerCase();
        
        const inferredFrequency = Object.keys(COMMON_FREQUENCIES).find(key => desc.includes(key)) 
                                    ? COMMON_FREQUENCIES[Object.keys(COMMON_FREQUENCIES).find(key => desc.includes(key))]
                                    : null;

        if (!inferredFrequency) return;
        
        const recurringKey = `${inferredFrequency}:${desc.replace(/[^a-z0-9]/g, '-').slice(0, 20)}`;
        const existing = appData.recurringExpenses.find(r => r.key === recurringKey);
        
        const newRecord = {
            key: recurringKey, description: description, lastDate: date,
            lastAmount: +gross.toFixed(2), frequency: inferredFrequency, isIncome: isIncome
        };

        if (existing) {
            Object.assign(existing, newRecord);
        } else {
            appData.recurringExpenses.push(newRecord);
        }
        
        addFutureRecurrenceReminders(newRecord);
    }
    
    function addFutureRecurrenceReminders(rec) {
        const reminderList = appData.reminders;
        const today = new Date();
        today.setHours(0,0,0,0);
        let lastDate = new Date(rec.lastDate);
        let nextDate = calculateNextRecurrence(rec.lastDate, rec.frequency);
        
        // Rimuovi vecchi promemoria ricorrenti per questo record (per evitare duplicati)
        appData.reminders = appData.reminders.filter(r => !r.recurringKey || r.recurringKey !== rec.key || new Date(r.date) < today);

        for (let i = 0; i < 12; i++) {
            if (!nextDate) break;

            const nextDateObj = new Date(nextDate);
            if (nextDateObj < today) {
                lastDate = nextDateObj;
                nextDate = calculateNextRecurrence(lastDate.toISOString().slice(0, 10), rec.frequency);
                continue;
            }

            const exists = reminderList.some(r => r.date === nextDate && r.description === rec.description);
            
            if (!exists) {
                appData.reminders.push({
                    id: getNextId(), type: rec.isIncome ? 'Entrata Ricorrente' : 'Uscita Ricorrente',
                    description: rec.description, date: nextDate,
                    // Promemoria spesa ha un importo positivo. Promemoria entrata negativo (perch√© riduce il saldo totale dei promemoria)
                    amount: rec.isIncome ? -rec.lastAmount : rec.lastAmount,
                    paid: false, isFiscal: false, recurringKey: rec.key
                });
            }
            
            lastDate = nextDateObj;
            nextDate = calculateNextRecurrence(lastDate.toISOString().slice(0, 10), rec.frequency);
        }
    }


    // --- Transactions CRUD (START) ---
    function getTransactionById(isIncome, id) {
        const list = isIncome ? appData.invoices : appData.expenses;
        return list.find(t => t.id === id);
    }
    
    function saveTransaction(isIncome, data){
      const list = isIncome ? appData.invoices : appData.expenses; // List dove inserire la transazione
      
      const net = parseFloat(data.net)||0;
      const vatRate = parseFloat(data.vatRate)||0;
      
      if (net < 0) { showToast('L\'importo Netto non pu√≤ essere negativo.','red'); return; }

      const vatAmount = (net*vatRate/100);
      const gross = net+vatAmount;
      const tags = (data.tags||'').split(',').map(s=>s.trim()).filter(Boolean);

      const updatedItem = {
        id: data.id || getNextId(), type: data.dataType, date: data.date, description: data.description,
        category: (data.category||'Altro').trim(), tags, net: +net.toFixed(2), vatRate: +vatRate,
        vatAmount: +vatAmount.toFixed(2), gross: +gross.toFixed(2), isIncome: isIncome,
        incomeType: data.incomeType || (isIncome && data.dataType==='activity' ? 'Fattura (Cliente)' : null)
      };
      
      // *** LOGICA DI ACCANTONAMENTO FISCALE (Forfettario) ***
      if (updatedItem.type === 'activity' && updatedItem.isIncome && appData.fiscalParams.regime === 'forfettario') {
          const params = appData.fiscalParams;
          // Calcola l'accantonamento solo sul netto (i forfettari non hanno IVA)
          const taxableAmount = updatedItem.net * params.profitRate; 
          const taxesToAccrue = taxableAmount * (params.taxRate + params.inpsRate);
          
          appData.taxCashReserve += taxesToAccrue;
          showToast(`Accantonati ${taxesToAccrue.toFixed(2)} ${getCurrencySymbol()} per tasse/INPS. Saldo cassa: ${appData.taxCashReserve.toFixed(2)} ${getCurrencySymbol()}.`);
      }


      if (updatedItem.description) {
          trackRecurringExpense(updatedItem.description, updatedItem.gross, updatedItem.date, isIncome);
      }
      
      const isActivityExpense = !isIncome && data.dataType === 'activity';
      const isPersonalTx = data.dataType === 'personal';
      const isActivityIncomeFattura = isIncome && data.dataType === 'activity' && data.incomeType !== 'Incasso/Corrispettivo';

      const shouldSaveContact = (isActivityExpense || isPersonalTx || isActivityIncomeFattura) && 
                                updatedItem.description?.trim() && 
                                updatedItem.description.trim() !== 'Corrispettivi/Incasso Giornaliero';


      if (shouldSaveContact){
        const contactName = updatedItem.description.trim(); 
        const relation = isIncome ? 'client':'supplier';
        
        if (!data.id || (list.find(it=>it.id===data.id)?.description !== contactName)){
          addContact(contactName, data.dataType, relation);
        }
      }
      
      ensureCategory(updatedItem.category);

      if (isIncome && data.dataType==='activity' && data.incomeType==='Incasso/Corrispettivo'){
        updatedItem.description = updatedItem.description || "Corrispettivi/Incasso Giornaliero";
      }

      if (data.id){
        const idx = list.findIndex(i=>i.id===data.id);
        if (idx>-1){ 
            list[idx]=updatedItem; 
            showToast(`Transazione ID ${data.id} aggiornata!`); 
        }
      } else { 
          // FIX: Utilizzare la lista corretta (invoices o expenses)
          if (isIncome) {
              appData.invoices.push(updatedItem);
          } else {
              appData.expenses.push(updatedItem);
          }
          showToast(`"${updatedItem.description}" registrato!`); 
      }

      saveData(); 
      closeTransactionForm(); 
    }
    
    function handleTransactionSubmit(type){
      const form = document.getElementById('transaction-form');
      const data = new FormData(form);
      const isIncome = data.get('isIncome')==='true';
      const transactionId = form.getAttribute('data-transaction-id');

      const payload = {
        id: transactionId ? parseInt(transactionId) : null, dataType: type, isIncome,
        date: data.get('date'), description: data.get('description'), net: data.get('net'),
        vatRate: data.get('vatRate'), incomeType: data.get('incomeType'),
        category: data.get('category') || 'Altro', tags: data.get('tags') || ''
      };

      const isCorrisp = type==='activity' && isIncome && payload.incomeType==='Incasso/Corrispettivo';
      if (payload.net && payload.date && (isCorrisp || (payload.description && payload.description.trim()))){
          
          const grossAmount = parseFloat(payload.net) * (1 + (parseFloat(payload.vatRate) / 100)) || 0;
          
          if (!payload.id && !isIncome && type === 'personal') {
              const monthlyAvg = getAverageMonthlyExpense(payload.category);
              if (monthlyAvg > 0 && grossAmount > monthlyAvg * 1.20) {
                  const percentDifference = ((grossAmount / monthlyAvg) * 100).toFixed(0);
                  showModal(
                      'üö® Allerta Spesa Anomala',
                      `Questa spesa (${grossAmount.toFixed(2)}${getCurrencySymbol()}) √® circa ${percentDifference}% superiore alla tua media mensile (${monthlyAvg.toFixed(2)}${getCurrencySymbol()}) per la categoria "${payload.category}". Continuare?`,
                      true,
                      () => saveTransaction(isIncome, payload), 
                      () => showToast('Registrazione annullata.','red') 
                  );
                  return; 
              }
          }
          
          saveTransaction(isIncome, payload);
      } else {
        showToast('Compila tutti i campi richiesti.','red');
      }
    }
    
    function deleteTransaction(isIncome,id){
      const listName = isIncome ? 'invoices':'expenses';
      const idx = appData[listName].findIndex(i=>i.id===id);
      if (idx>-1){
        showModal('Conferma Eliminazione','Eliminare definitivamente questa transazione?',true,()=>{
          appData[listName].splice(idx,1); saveData(); showToast('Transazione eliminata.','red'); renderPage(currentPage);
        });
      }
    }
    
    function editTransaction(isIncome, id, type, inModal = false) {
        const transaction = getTransactionById(isIncome, id);
        if (!transaction) { showToast('Transazione non trovata.', 'red'); return; }

        if (!inModal) {
            openTransactionForm(isIncome ? 'true' : 'false', id, type);
            return;
        }

        const form = document.getElementById('transaction-form');
        form.reset(); 
        form.setAttribute('data-transaction-id', transaction.id);
        
        document.getElementById('isIncome').value = isIncome ? 'true' : 'false';
        document.getElementById('isIncome').dispatchEvent(new Event('change'));

        if (type === 'activity' && isIncome && document.getElementById('incomeType')) {
            document.getElementById('incomeType').value = transaction.incomeType || 'Fattura (Cliente)';
            document.getElementById('incomeType').dispatchEvent(new Event('change'));
        }

        document.getElementById('date').value = transaction.date;
        document.getElementById('description').value = transaction.description || '';
        document.getElementById('category').value = transaction.category || 'Altro';
        document.getElementById('tags').value = (transaction.tags || []).join(', ');
        document.getElementById('net-amount').value = transaction.net.toFixed(2);
        document.getElementById('vat-rate').value = transaction.vatRate.toFixed(0);
        
        autoFillSmartData(transaction.description || '');

        calculateGross();
        
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Aggiorna Transazione';
            submitBtn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
            submitBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }
        showToast(`Modalit√† Modifica (ID: ${id})`);
    }

    function duplicateTransaction(isIncome, id, type) {
        const transaction = getTransactionById(isIncome, id);
        if (!transaction) { showToast('Transazione non trovata.', 'red'); return; }

        openTransactionForm(isIncome ? 'true' : 'false', null, type); 
        
        editTransaction(isIncome, id, type, true); 
        
        const form = document.getElementById('transaction-form');
        form.removeAttribute('data-transaction-id');

        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Registra Movimento (Duplicato)';
            submitBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            submitBtn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
        }
        showToast(`Dati caricati per Duplicazione (Modifica data e importo).`);
    }
    // --- Transactions CRUD (END) ---

    function markTaxPaid(reminderId, amountPaid) {
        if (!appData.fiscalParams.regime === 'forfettario') {
            showToast('Funzione accantonamenti attiva solo per Forfettario.', 'red');
            return;
        }

        showModal('Registra Pagamento Fiscale', 
            `Confermi di aver pagato ${amountPaid.toFixed(2)}${getCurrencySymbol()} di tasse/INPS? Il saldo accantonato sar√† ridotto.`, 
            true, 
            () => {
                appData.taxCashReserve -= amountPaid;
                const reminder = appData.reminders.find(r => r.id === reminderId);
                if (reminder) {
                    reminder.paid = true;
                }
                saveData();
                showToast(`Pagamento fiscale registrato. Saldo cassa: ${appData.taxCashReserve.toFixed(2)} ${getCurrencySymbol()}.`);
                renderPage('reminders');
            },
            () => showToast('Pagamento annullato.')
        );
    }


    // --- Fiscal Reminders ---
    function initializeFiscalReminders() {
        const currentYear = new Date().getFullYear();
        // Genera i promemoria fiscali per l'anno corrente e il prossimo
        const yearsToGenerate = [currentYear, currentYear + 1];
        
        yearsToGenerate.forEach(year => {
            const fiscalReminders = [
                { type: 'IVA Trimestrale', description: `IVA 1T ${year} (Gen-Mar)`, month: 5, day: 16, year: year, quarter: 1 },
                { type: 'IVA Trimestrale', description: `IVA 2T ${year} (Apr-Giu)`, month: 8, day: 20, year: year, quarter: 2 },
                { type: 'IVA Trimestrale', description: `IVA 3T ${year} (Lug-Set)`, month: 11, day: 16, year: year, quarter: 3 },
                // IVA 4T viene pagata l'anno successivo
                { type: 'IVA Trimestrale', description: `IVA 4T ${year} (Ott-Dic)`, month: 3, day: 16, year: year + 1, quarter: 4 }, 
                { type: 'IVA Saldo/Acconto', description: `Saldo IVA ${year - 1}`, month: 3, day: 16, year: year, quarter: null },
                { type: 'IVA Saldo/Acconto', description: `Acconto IVA ${year}`, month: 12, day: 27, year: year, quarter: null }
            ].filter(fr => fr.year >= currentYear); // Filtra promemoria passati

            // Rimuovi i promemoria IVA non pagati solo per l'anno in corso (lascia i passati pagati)
            appData.reminders = appData.reminders.filter(r => 
                !r.type.startsWith('IVA') || new Date(r.date).getFullYear() < currentYear || r.paid 
            );

            fiscalReminders.forEach(fr => {
                const date = new Date(fr.year, fr.month - 1, fr.day);
                const dateStr = date.toISOString().slice(0, 10);
                
                const exists = appData.reminders.some(r => r.description === fr.description && r.date === dateStr);
                
                if (!exists) {
                    let estimatedAmount = 0;
                    if (fr.quarter && fr.year <= currentYear) {
                        const result = calculateIvaQuarterly(fr.year, fr.quarter);
                        estimatedAmount = result.ivaBalance; 
                    }
                    
                    appData.reminders.push({
                        id: getNextId(), type: fr.type, description: fr.description, date: dateStr,
                        // Per i promemoria di versamento, l'importo deve essere positivo
                        amount: Math.max(0, estimatedAmount), paid: false, isFiscal: true
                    });
                }
            });
        });

        saveData(); 
    }

    // --- Reminders CRUD ---
    function saveReminder(data){
      appData.reminders ||= [];
      if (data.id){ const i=appData.reminders.findIndex(r=>r.id===data.id); if(i>-1){ appData.reminders[i]={...appData.reminders[i],...data}; } }
      else { appData.reminders.push({ id:getNextId(), ...data, paid:false }); }
      saveData(); showToast('Promemoria salvato!'); renderPage('reminders');
    }
    function toggleReminderPaid(id){ const r=appData.reminders.find(x=>x.id===id); if(r){ r.paid=!r.paid; saveData(); showToast(r.paid?'Pagamento registrato!':'Pagamento annullato.'); renderPage('reminders'); } }
    function deleteReminder(id){
      const i=(appData.reminders||[]).findIndex(r=>r.id===id);
      if (i>-1){
        showModal('Eliminare promemoria?','Operazione irreversibile.',true,()=>{
          appData.reminders.splice(i,1); saveData(); showToast('Promemoria eliminato.','red'); renderPage('reminders');
        });
      }
    }
    function handleReminderSubmit(){
      const f=document.getElementById('reminder-form'); const d=new FormData(f);
      const payload={ type:d.get('type'), description:d.get('description'), date:d.get('date'), amount: parseFloat(d.get('amount'))||0 };
      if (payload.description && payload.date && payload.amount!==0){ 
        saveReminder(payload); 
        f.reset(); 
        document.getElementById('reminder-date').value = new Date().toISOString().slice(0,10); 
      }
      else showToast('Compila tutti i campi validi.','red');
    }
    
    // --- Compleanni CRUD ---
    function saveBirthday(data){
      appData.birthdays ||= [];
      
      const dateStr = data.date;
      const recurringDate = dateStr.slice(5); 

      if (data.id){ 
          const i=appData.birthdays.findIndex(r=>r.id===data.id); 
          if(i>-1){ appData.birthdays[i]={...appData.birthdays[i],...data, recurringDate}; } 
      }
      else { 
          appData.birthdays.push({ id:getNextId(), ...data, recurringDate }); 
      }
      saveData(); showToast('Compleanno salvato!'); renderPage('reminders');
    }
    function deleteBirthday(id){
      const i=(appData.birthdays||[]).findIndex(r=>r.id===id);
      if (i>-1){
        showModal('Eliminare compleanno?','Operazione irreversibile.',true,()=>{
          appData.birthdays.splice(i,1); saveData(); showToast('Compleanno eliminato.','red'); renderPage('reminders');
        });
      }
    }
    function handleBirthdaySubmit(){
        const f=document.getElementById('birthday-form'); const d=new FormData(f);
        const dateStr = d.get('date');
        
        const payload={ 
            name: d.get('name').trim(), date: dateStr, 
        };
        
        if (payload.name && payload.date){ 
            saveBirthday(payload); 
            f.reset(); 
            document.getElementById('birthday-date').value = new Date().toISOString().slice(0,10); 
        }
        else showToast('Compila tutti i campi validi.','red');
    }


    // --- Import/Export/Clean ---
    function exportDataJSON(){
      const dataStr = JSON.stringify(appData,null,2);
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`finanza_backup_${globalState.currentUser.name}_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('Backup JSON esportato!');
    }

    function exportCSV(typeFilter = 'all'){
      const tx = [...appData.invoices.map(t=>({...t,isIncome:true})), ...appData.expenses.map(t=>({...t,isIncome:false}))].sort((a,b)=> new Date(a.date)-new Date(b.date));
      
      const filteredTx = tx.filter(t => {
          if (typeFilter === 'income') return t.isIncome;
          if (typeFilter === 'expense') return !t.isIncome;
          return true;
      });
      
      const esc = (s)=> `"${String(s??'').replace(/"/g,'""')}"`;
      
      const sumInc = filteredTx.filter(t => t.isIncome).reduce((s,t)=>s+t.gross,0);
      const sumExp = filteredTx.filter(t => !t.isIncome).reduce((s,t)=>s+t.gross,0);
      const netBalance = sumInc - sumExp;
      const filterLabel = typeFilter === 'income' ? 'SOLO ENTRATE' : (typeFilter === 'expense' ? 'SOLO USCITE' : 'ENTRATE & USCITE');
      
      const summaryRow = ['---RIEPILOGO TRANS.---', `Filtro: ${filterLabel}`, `Saldo Netto: ${netBalance.toFixed(2)}${getCurrencySymbol()}`, `Entrate Totali: ${sumInc.toFixed(2)}${getCurrencySymbol()}`, `Uscite Totali: ${sumExp.toFixed(2)}${getCurrencySymbol()}`].map(esc).join(',');
      
      const headerTx = ['ID','Tipo','Scope','Data','Descrizione','Categoria','Tag','AliquotaIVA','Netto','IVA','Lordo','Entrata?','Sottotipo'].join(',');
      const rowsTx = filteredTx.map(t => [
        t.id, (t.isIncome?'Entrata':'Uscita'), t.type, t.date, t.description||'', t.category||'',
        (t.tags||[]).join('|'), t.vatRate, t.net, t.vatAmount, t.gross, t.isIncome, t.incomeType||''
      ].map(esc).join(','));
      const csvTx = `\n[TRANSAZIONI - ${filterLabel}]\n${summaryRow}\n${headerTx}\n${rowsTx.join('\n')}`;
      
      const headerRm = ['ID','Tipo','Descrizione','Data','Importo','Pagato?'].join(',');
      const rowsRm = (appData.reminders||[]).map(r => [r.id,r.type,r.description,r.date,r.amount,r.paid].map(esc).join(','));
      const csvRm = `\n\n[PROMEMORIA SCADENZE]\n${headerRm}\n${rowsRm.join('\n')}`;
      
      const headerBd = ['ID','Nome','DataNascita','RicorrenzaMD'].join(',');
      const rowsBd = (appData.birthdays||[]).map(r => [r.id,r.name,r.date,r.recurringDate].map(esc).join(','));
      const csvBd = `\n\n[COMPLEANNI]\n${headerBd}\n${rowsBd.join('\n')}`;

      const zipContent = `${csvTx}${csvRm}${csvBd}\n\n### Creato con Finanza Smart PRO`;
      const blob = new Blob([zipContent], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`finanza_export_${typeFilter}_${new Date().toISOString().slice(0,10)}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('Export CSV pronto (testo con 3 sezioni).');
    }

    // *** NUOVA FUNZIONE: Esportazione PDF Avanzata (Categoria/Mese) ***
    function exportPDF() {
        // Usa i filtri correnti salvati in reportFilters
        const currentType = reportFilters.type;
        const filterType = reportFilters.filterType;
        const filterDateStr = reportFilters.filterDateStr;
        const categoryFilter = reportFilters.categoryFilter;
        const tagFilter = reportFilters.tagFilter;
        const searchQuery = reportFilters.searchQuery;

        // 1. Prepara la transazione da esportare (usa la logica di filtro esistente)
        let transactionsToExport = calculateFinancialSummary(currentType, filterType, filterDateStr).transactions.slice();
        transactionsToExport = filterTransactionsByCriteria(transactionsToExport, categoryFilter === 'all' ? null : categoryFilter, tagFilter === 'all' ? null : tagFilter);
        transactionsToExport = filterTransactions(searchQuery, transactionsToExport);
        transactionsToExport = sortTransactions(transactionsToExport);

        if (transactionsToExport.length === 0) {
            showToast('Nessuna transazione da esportare con i filtri attuali.', 'red');
            return;
        }

        const doc = new window.jspdf.jsPDF();
        let y = 10;
        const margin = 10;
        const pageHeight = doc.internal.pageSize.height;
        const lineHeight = 6; // Ridotto per far stare pi√π righe
        const symbol = getCurrencySymbol();

        // --- Intestazioni ---
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(`Report Finanziario - ${globalState.currentUser.name}`, margin, y);
        y += lineHeight * 1.5;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        let title = `TIPO: ${currentType.toUpperCase()} | PERIODO: ${filterType.toUpperCase()} (${filterDateStr})`;
        title += ` | CAT: ${categoryFilter} | TAG: ${tagFilter}`;
        doc.text(title, margin, y);
        y += lineHeight;
        doc.text(`Query Ricerca: ${searchQuery || 'Nessuna'} | Data Export: ${new Date().toLocaleDateString('it-IT')}`, margin, y);
        y += lineHeight * 1.5;

        // --- Riepilogo Aggregato (KPI) ---
        const summary = calculateFinancialSummary(currentType, filterType, filterDateStr);
        const kpiText = [
            `Entrate Totali: ${summary.totalIncomes.toFixed(2)} ${symbol}`,
            `Uscite Totali: ${summary.totalExpenses.toFixed(2)} ${symbol}`,
            `Saldo Netto: ${summary.netBalance.toFixed(2)} ${symbol}`
        ].join(' | ');

        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('RIEPILOGO AGGREGATO DEL PERIODO', margin, y);
        y += lineHeight;
        doc.setFont(undefined, 'normal');
        doc.text(kpiText, margin, y);
        y += lineHeight * 1.5;

        doc.setLineWidth(0.3);
        doc.line(margin, y, doc.internal.pageSize.width - margin, y);
        y += lineHeight;


        // --- Dati Dettagliati (Tabella) ---
        const headers = ["Data", "Tipo", "Categoria", "Descrizione", "Netto", "IVA", "Lordo"];
        const colWidths = [20, 15, 20, 50, 20, 15, 20];
        let x = margin;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(50, 50, 50);

        headers.forEach((header, index) => {
            doc.text(header, x, y);
            x += colWidths[index];
        });
        y += 1;
        doc.setLineWidth(0.1);
        doc.line(margin, y, doc.internal.pageSize.width - margin, y);
        y += 3;

        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        
        // --- Loop Dati ---
        transactionsToExport.forEach(t => {
            if (y > pageHeight - margin * 2) {
                doc.addPage();
                y = margin;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Dettaglio Movimenti (continua)', margin, y);
                y += lineHeight;
                
                x = margin;
                headers.forEach((header, index) => {
                    doc.text(header, x, y);
                    x += colWidths[index];
                });
                y += 1;
                doc.setLineWidth(0.1);
                doc.line(margin, y, doc.internal.pageSize.width - margin, y);
                y += 3;
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
            }

            const type = t.isIncome ? 'E' : 'U';
            const description = t.description ? (t.description.length > 28 ? t.description.substring(0, 25) + '...' : t.description) : 'N/A';
            const cat = t.category || 'Altro';
            
            // Colore testo
            const color = t.isIncome ? [16, 185, 129] : [239, 68, 68];
            doc.setTextColor(color[0], color[1], color[2]);

            x = margin;
            doc.text(new Date(t.date).toLocaleDateString('it-IT'), x, y); x += colWidths[0];
            doc.text(type, x, y); x += colWidths[1];
            doc.text(cat, x, y); x += colWidths[2];
            doc.text(description, x, y); x += colWidths[3];
            
            // Importi allineati a destra
            doc.text(t.net.toFixed(2), x + colWidths[4] - 1, y, { align: "right" }); x += colWidths[4];
            doc.text(t.vatAmount.toFixed(2), x + colWidths[5] - 1, y, { align: "right" }); x += colWidths[5];
            doc.text(t.gross.toFixed(2) + symbol, x + colWidths[6] - 1, y, { align: "right" }); x += colWidths[6];
            
            y += lineHeight;
        });

        // --- Pie di pagina e Salvataggio ---
        doc.setLineWidth(0.5);
        doc.line(margin, y, doc.internal.pageSize.width - margin, y);
        y += lineHeight;
        
        doc.setTextColor(0, 0, 0); 
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        
        // Calcola i totali finali
        const totalGross = transactionsToExport.reduce((sum, t) => sum + (t.gross * (t.isIncome ? 1 : -1)), 0);
        const totalNet = transactionsToExport.reduce((sum, t) => sum + (t.net * (t.isIncome ? 1 : -1)), 0);
        const totalVat = transactionsToExport.reduce((sum, t) => sum + (t.vatAmount * (t.isIncome ? 1 : -1)), 0);

        doc.text(`Netto Totale: ${totalNet.toFixed(2)} ${symbol}`, margin, y);
        y += lineHeight;
        doc.text(`IVA Totale: ${totalVat.toFixed(2)} ${symbol}`, margin, y);
        y += lineHeight;
        
        const grossColor = totalGross >= 0 ? 16 : 239; 
        doc.setTextColor(grossColor, grossColor === 16 ? 185 : 68, grossColor === 16 ? 129 : 68);
        doc.text(`SALDO LORDO: ${totalGross.toFixed(2)} ${symbol}`, margin, y);
        doc.setFont(undefined, 'normal');


        const filename = `Report_FinanzaPRO_${currentType}_${filterDateStr}_${new Date().toISOString().slice(0, 10)}.pdf`;
        doc.save(filename);
        showToast('Report PDF (categoria/mese) generato e scaricato!');
    }


    function importDataFile(ev){
      const file = ev.target.files[0]; if(!file) return;
      const r = new FileReader();
      r.onload = (e)=>{
        try{
          const imported = JSON.parse(e.target.result);
          if (imported.invoices && imported.expenses && imported.reminders){
            showModal('Conferma Importazione', `Sovrascrivere i dati attuali del profilo "${globalState.currentUser.name}"? (Consigliato backup prima)`, true, ()=>{
              const all = [...imported.invoices, ...imported.expenses, ...imported.reminders, ...(imported.contacts||[]), ...(imported.birthdays||[])];
              const maxId = all.length>0 ? Math.max(...all.map(x=>x.id||0)) : 0;
              
              const currentPinHash = appData.pinHash; 
              
              appData = { 
                  ...appData, ...imported, 
                  lastId: Math.max(maxId, appData.lastId), pinHash: currentPinHash 
              };
              
              appData.categories ||= DEFAULT_CATEGORIES.slice(); appData.birthdays ||= []; 
              appData.recurringExpenses ||= []; appData.categoryBudgets ||= {}; 
              appData.fiscalParams = { ...DEFAULT_FISCAL_PARAMS, ...appData.fiscalParams }; 
              appData.currentBankBalance ||= 0; appData.taxCashReserve ||= 0;

              appData.birthdays = appData.birthdays.map(bd => ({
                  ...bd, recurringDate: (bd.date || bd.recurringDate).slice(5) 
              }));
              appData.monthlySavingsTarget ||= 0;
              saveData(); 
              showToast('Dati importati!'); 
              renderPage(currentPage);
            });
          } else { showToast('Backup JSON non valido.','red'); }
        } catch(err){ console.error(err); showToast('Errore lettura file JSON.','red'); }
      };
      r.readAsText(file);
    }

    function cleanDataByYear(year){
      const target = parseInt(year); if (isNaN(target)||target===0){ showToast('Seleziona un anno valido.','red'); return; }
      showModal('Conferma Pulizia Dati', `Eliminare TUTTO prima del 1 Gennaio ${target}?`, true, ()=>{
        const before = (it)=> new Date(it.date).getFullYear() < target;
        const i0=appData.invoices.length, e0=appData.expenses.length, r0=appData.reminders.length;
        
        appData.invoices = appData.invoices.filter(x=>!before(x));
        appData.expenses = appData.expenses.filter(x=>!before(x));
        appData.reminders = appData.reminders.filter(x=>!before(x));
        
        if (appData.invoices.length === 0 && appData.expenses.length === 0 && appData.reminders.length === 0) {
            appData.lastId = 0;
        }
        
        saveData();
        showToast(`Pulizia ok. Rimossi ${(i0 - appData.invoices.length)+(e0 - appData.expenses.length)} movimenti e ${(r0 - appData.reminders.length)} promemoria.`);
        renderPage('settings');
      });
    }
    
    function deleteContact(id){
      const i=appData.contacts.findIndex(c=>c.id===id);
      if (i>-1){
        showModal('Conferma Eliminazione Contatto','Le transazioni non verranno cancellate.',true,()=>{
          appData.contacts.splice(i,1); saveData(); showToast('Contatto eliminato.','red'); renderPage('settings');
        });
      }
    }
    
    function deleteUnusedContacts() {
        const usedDescriptions = new Set();
        [...appData.invoices, ...appData.expenses].forEach(t => {
            if (t.description && t.description.trim() !== 'Corrispettivi/Incasso Giornaliero') {
                usedDescriptions.add(t.description.trim().toLowerCase());
            }
        });

        const initialLength = appData.contacts.length;
        appData.contacts = appData.contacts.filter(c => usedDescriptions.has(c.name.toLowerCase()));
        const removedCount = initialLength - appData.contacts.length;

        saveData();
        showToast(`${removedCount} contatti non usati eliminati.`);
        renderPage('settings');
    }
    
    function deleteUnusedCategories() {
        const usedCategories = new Set(DEFAULT_CATEGORIES.map(c => c.toLowerCase()));
        [...appData.invoices, ...appData.expenses].forEach(t => {
            if (t.category) {
                usedCategories.add(t.category.trim().toLowerCase());
            }
        });
        
        const initialLength = appData.categories.length;
        appData.categories = appData.categories.filter(c => usedCategories.has(c.toLowerCase()));
        appData.categories.sort((a,b)=>a.localeCompare(b));
        const removedCount = initialLength - appData.categories.length;

        saveData();
        showToast(`${removedCount} categorie non usate (non di default) eliminate.`);
        renderPage('settings');
    }
    // --- Import/Export/Clean (END) ---


    // --- UI wiring (MODULO TRANSAZIONE) ---
    function renderTransactionForm(isIncome, type) {
        const isActivity = type === 'activity';
        const isIncomeString = isIncome ? 'true' : 'false';
        const symbol = getCurrencySymbol();

        return `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-medium ${isIncome ? 'text-emerald-600' : 'text-red-600'}">
                    Registra ${isIncome ? 'Entrata' : 'Uscita'} (${isActivity ? 'Attivit√†' : 'Personale'})
                </h3>
                <button onclick="closeTransactionForm()" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300 font-bold text-2xl">
                    &times;
                </button>
            </div>
            <form id="transaction-form" onsubmit="event.preventDefault(); handleTransactionSubmit('${type}');" class="space-y-4">
              <input type="hidden" id="transaction-type-hidden" name="dataType" value="${type}">
              <input type="hidden" id="isIncome" name="isIncome" value="${isIncomeString}">

              <div class="grid grid-cols-1 ${isActivity?'md:grid-cols-2':''} gap-4">
                <div>
                  <label for="date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data</label>
                  <input type="date" id="date" name="date" required class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                </div>
                ${isActivity?`
                <div id="income-type-control" class="${isIncome ? '' : 'hidden'}">
                  <label for="incomeType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sottotipo Entrata</label>
                  <select id="incomeType" name="incomeType" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                    <option value="Fattura (Cliente)">Fattura (Cliente)</option>
                    <option value="Incasso/Corrispettivo">Incasso/Corrispettivo (POS/Contanti)</option>
                  </select>
                </div>`:''}
              </div>

              <div id="description-div">
                <label id="description-label" for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">${isIncome ? 'Cliente / Descrizione' : 'Fornitore / Descrizione'}</label>
                <input type="text" id="description" name="description" required placeholder="Seleziona o digita" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                <datalist id="contact-list"></datalist>
                <p class="text-xs text-gray-500 mt-1">Suggerimento: i nomi digitati vengono salvati nei contatti. <span class="text-indigo-500 font-semibold">‚ö° Smart-fill attivo.</span></p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoria</label>
                  <input id="category" name="category" list="category-list" required placeholder="Es. Affitto / Marketing" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700"/>
                  <datalist id="category-list"></datalist>
                </div>
                <div>
                  <label for="tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tag (separati da virgola)</label>
                  <input id="tags" name="tags" placeholder="es. Q3, fattura-ricorrente" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700"/>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="net-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Importo Netto (${symbol})</label>
                  <input type="number" id="net-amount" name="net" step="0.01" min="0" required placeholder="100.00" 
                         class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700" 
                         inputmode="decimal">
                </div>
                <div>
                  <label for="vat-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Aliquota IVA (%)</label>
                  <select id="vat-rate" name="vatRate" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                    ${IVA_RATES.map(r=>`<option value="${r}">${r}%</option>`).join('')}
                  </select>
                </div>
              </div>

              <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm">
                <p class="flex justify-between"><span>IVA Calcolata:</span> <span id="vat-amount-display" class="font-bold text-blue-600">0.00 ${symbol}</span></p>
                <p class="flex justify-between border-t mt-1 pt-1 font-bold"><span>Importo Lordo Totale:</span> <span id="gross-amount-display" class="text-lg ${isIncome ? 'text-emerald-600' : 'text-red-600'}">0.00 ${symbol}</span></p>
              </div>

              <button type="submit" class="cta-button w-full ${isIncome ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-red-500 hover:bg-red-600'} text-white p-3 rounded-lg font-bold">
                Registra Movimento
              </button>
            </form>
        `;
    }
    
    function setupActivityIncomeTypeListeners(scope){
      if (scope!=='activity') return;
      const incomeTypeSelect = document.getElementById('incomeType');
      const isIncomeSelect = document.getElementById('isIncome');
      const descriptionDiv = document.getElementById('description-div');

      const updateVisibility = ()=>{
        const isIncome = isIncomeSelect.value==='true';
        const incomeType = incomeTypeSelect?.value || 'Fattura (Cliente)';
        if (isIncome && incomeType==='Incasso/Corrispettivo'){
          descriptionDiv.classList.add('hidden');
          const desc = document.getElementById('description');
          desc.removeAttribute('required'); 
          if (document.getElementById('transaction-form').getAttribute('data-transaction-id')===null) {
             desc.value = 'Corrispettivi/Incasso Giornaliero';
          }
          document.getElementById('description-label').textContent = 'Descrizione Incasso (Opzionale)';
        } else {
          descriptionDiv.classList.remove('hidden');
          const desc = document.getElementById('description');
          desc.setAttribute('required','required');
          if (document.getElementById('transaction-form').getAttribute('data-transaction-id')===null){ desc.value=''; }
          document.getElementById('description-label').textContent = isIncome ? 'Cliente / Descrizione' : 'Fornitore / Descrizione';
          setupContactAutocomplete(scope);
        }
      };

      incomeTypeSelect?.removeEventListener('change', updateVisibility);
      incomeTypeSelect?.addEventListener('change', updateVisibility);
      
      updateVisibility();
    }

    function setupContactAutocomplete(scope){
      const isIncome = document.getElementById('isIncome').value==='true';
      const incomeType = document.getElementById('incomeType')?.value;
      const input = document.getElementById('description');
      const datalist = document.getElementById('contact-list');
      if (!input || !datalist) return;

      if (scope==='activity' && isIncome && incomeType==='Incasso/Corrispettivo'){ datalist.innerHTML=''; return; }
      const relation = isIncome ? 'client':'supplier';
      const contacts = appData.contacts
        .filter(c=> c.scope===scope && (c.relation===relation || c.relation==='both'))
        .sort((a,b)=> a.name.localeCompare(b.name));
      datalist.innerHTML = contacts.map(c=> `<option value="${c.name}"></option>`).join('');
      input.setAttribute('list','contact-list');
      
      input.removeEventListener('input', handleDescriptionChange);
      input.addEventListener('input', handleDescriptionChange);
    }
    
    function handleDescriptionChange() {
        const desc = document.getElementById('description').value;
        if (!document.getElementById('transaction-form').getAttribute('data-transaction-id')) {
            autoFillSmartData(desc);
        }
    }


    function setupCategoryAutocomplete(){
      const dl = document.getElementById('category-list');
      if (!dl) return;
      const all = (appData.categories||DEFAULT_CATEGORIES).slice().sort((a,b)=>a.localeCompare(b));
      dl.innerHTML = all.map(c=> `<option value="${c}"></option>`).join('');
    }
    
    function getAllTags() {
        const allTags = new Set();
        [...appData.invoices, ...appData.expenses].forEach(t => {
            (t.tags || []).forEach(tag => allTags.add(tag));
        });
        return Array.from(allTags).sort();
    }

    function calculateGross(){
      const netInput=document.getElementById('net-amount');
      const vatSelect=document.getElementById('vat-rate');
      const vatAmountDisplay=document.getElementById('vat-amount-display');
      const grossAmountDisplay=document.getElementById('gross-amount-display');
      
      let net = parseFloat(netInput?.value)||0; 
      const rate=parseFloat(vatSelect?.value)||0;
      
      const vatAmt=net*rate/100; 
      const gross=net+vatAmt;
      
      if (vatAmountDisplay) vatAmountDisplay.textContent = vatAmt.toFixed(2)+' '+getCurrencySymbol();
      if (grossAmountDisplay) grossAmountDisplay.textContent = gross.toFixed(2)+' '+getCurrencySymbol();
    }
    
    function getTodayFocusData(type) {
        const todayStr = new Date().toISOString().slice(0, 10);
        
        const summary = calculateFinancialSummary(type, 'day', todayStr);
        
        const todayDate = new Date(todayStr);

        const upcomingReminders = appData.reminders.filter(r => !r.paid && r.date === todayStr);
        const upcomingBirthdays = appData.birthdays.filter(b => {
            const bdRecurrence = new Date(`${todayDate.getFullYear()}-${b.recurringDate}`);
            return bdRecurrence.toISOString().slice(0, 10) === todayStr;
        });
        
        const expenseSpikes = type === 'personal' ? analyzeExpenseSpikes() : [];
        
        return { summary, upcomingReminders, upcomingBirthdays, expenseSpikes };
    }
    // --- Page router ---
    function renderNavbar(){
      const navbar=document.getElementById('navbar');
      const navItems=[
        {id:'activity',label:'Attivit√†',icon:'üíº'},
        {id:'personal',label:'Personale',icon:'üè†'},
        {id:'report',label:'Riepilogo',icon:'üìä'},
        {id:'reminders',label:'Scadenze',icon:'üîî'},
        {id:'settings',label:'Gestione Dati',icon:'‚öôÔ∏è'}
      ];
      navbar.innerHTML = navItems.map(it=>`
        <button onclick="renderPage('${it.id}')" class="p-2 text-sm font-medium rounded-lg transition hover:bg-gray-100 dark:hover:bg-gray-800 ${currentPage===it.id?'tab-active':'text-gray-500'}">
          ${it.icon} <span class="hidden sm:inline">${it.label}</span>
        </button>
      `).join('');
    }

    function renderSummaryCard(summary,label){
      const symbol = getCurrencySymbol();
      const ivaStatus = summary.ivaBalance>=0?'IVA da Versare':'IVA a Credito';
      const ivaColor = summary.ivaBalance>=0?'text-red-600':'text-blue-600';
      
      const summarySinceStart = calculateFinancialSummary('global', 'all', 'all');
      let totalBalance = (parseFloat(appData.currentBankBalance) || 0); // Saldo base
      // Applica la variazione di saldo dovuta a tutte le transazioni registrate
      totalBalance += summarySinceStart.transactions.reduce((acc, t) => acc + (t.gross * (t.isIncome ? 1 : -1)), 0);

      const freeBalance = totalBalance - (appData.taxCashReserve || 0);

      return `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
            <p class="text-sm text-gray-500">Entrate Totali (${label})</p>
            <p class="text-xl font-bold text-emerald-600">${summary.totalIncomes.toFixed(2)} ${symbol}</p>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
            <p class="text-sm text-gray-500">Uscite Totali (${label})</p>
            <p class="text-xl font-bold text-red-600">${summary.totalExpenses.toFixed(2)} ${symbol}</p>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center col-span-2 md:col-span-1 border-l-4 ${freeBalance>=0?'border-emerald-500':'border-red-500'}">
            <p class="text-sm text-gray-500">Saldo Libero Reale</p>
            <p class="text-2xl font-extrabold ${freeBalance>=0?'text-emerald-600':'text-red-600'}">${freeBalance.toFixed(2)} ${symbol}</p>
             <p class="text-xs text-gray-400">Totale Cassa: ${totalBalance.toFixed(2)}</p>
          </div>
          <div id="tax-reserve-container" class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center col-span-2 md:col-span-1 border-l-4 ${appData.taxCashReserve>=0?'border-emerald-500':'border-red-500'}">
            <p class="text-sm text-gray-500">Cassa Accantonamenti (Tasse/INPS)</p>
            <p id="tax-reserve-amount" class="text-xl font-bold ${appData.taxCashReserve>=0?'text-emerald-600':'text-red-600'}">${appData.taxCashReserve.toFixed(2)} ${symbol}</p>
            <p class="text-xs text-gray-400">IVA Saldo: ${summary.ivaBalance.toFixed(2)}</p>
          </div>
        </div>
      `;
    }

    // NUOVO: Funzione per resettare lo stato della simulazione
    function resetSimulationState() {
        simulationState = {
            additionalRevenue: 0, additionalExpense: 0, taxRateOverride: null,
            profitRateOverride: null, targetNetIncome: null
        };
        renderPage('activity'); 
    }

    function renderActivityOrPersonalPage(type){
      const isActivity = type==='activity';
      const symbol = getCurrencySymbol();
      const title = isActivity?'Gestione Attivit√† (Partita IVA)':'Gestione Personale (Casa)';
      const listTitle = isActivity?`Ultime ${MAX_RECENT_TRANSACTIONS} Transazioni Attivit√†`:`Ultime ${MAX_RECENT_TRANSACTIONS} Transazioni Personali`;
      const year = new Date().getFullYear();
      const summary = calculateFinancialSummary(type,'year', String(year));
      const tx = summary.transactions.filter(t=>t.type===type).slice(0,MAX_RECENT_TRANSACTIONS);
      
      const todayData = getTodayFocusData(type);
      const todayBalanceColor = todayData.summary.netBalance >= 0 ? 'text-emerald-500' : 'text-red-500';
      const todaySummaryMessage = todayData.summary.netBalance.toFixed(2) + ' ' + symbol;
      
      const liquidityBuffer = calculateLiquidityBuffer();
      const fhs = calculateFinancialHealthScore();
      const FHSColor = fhs.score > 80 ? 'text-emerald-600' : (fhs.score > 60 ? 'text-orange-600' : 'text-red-600');
      
      const whatIfRevenue = simulationState.additionalRevenue;
      const whatIfExpense = simulationState.additionalExpense;
      const taxRateOverride = simulationState.taxRateOverride;
      const profitRateOverride = simulationState.profitRateOverride;
      const targetNet = simulationState.targetNetIncome;

      const fiscalSim = isActivity ? calculateFiscalSimulation(year) : null;
      const reverseSim = isActivity ? calculateReverseFiscalProjection() : null;
      const currentFiscal = fiscalSim?.fiscalParamsUsed || appData.fiscalParams;

      let fiscalAdvice = '';
      if (isActivity && fiscalSim) {
          const projection = calculateAnnualFiscalProjection();
          
          if (appData.fiscalParams.regime === 'forfettario') {
               if (projection.projectedRevenue > MAX_FORFETTARIO_REVENUE * 0.75) {
                   const diff = (MAX_FORFETTARIO_REVENUE - projection.projectedRevenue).toFixed(0);
                   fiscalAdvice += `<p class="p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg text-sm border-l-4 border-yellow-500 mt-3"><span class="font-bold">‚ö†Ô∏è Allerta Ricavi:</span> Sei al ${(projection.projectedRevenue / MAX_FORFETTARIO_REVENUE * 100).toFixed(0)}% del massimale Forfettario (${MAX_FORFETTARIO_REVENUE}${symbol}). Rimangono circa ${diff}${symbol} di margine.</p>`;
               }
               // Questo controllo √® pi√π accurato se basato sul ricavo netto, non lordo per forfettario.
               if (fiscalSim.totalCosti > projection.projectedRevenue * (1 - appData.fiscalParams.profitRate) * 1.5) {
                    fiscalAdvice += '<p class="p-3 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg text-sm border-l-4 border-indigo-500 mt-3"><span class="font-bold">üí° Suggerimento Fiscale:</span> Le tue spese (non inerenti al coefficiente) sembrano molto alte. Valuta il Regime Ordinario per l\'anno prossimo, potresti risparmiare sulle tasse.</p>';
               }
          } else if (appData.fiscalParams.regime === 'ordinario' && fiscalSim.baseImponibile < 28000 && fiscalSim.totalRicavi < MAX_FORFETTARIO_REVENUE * 0.9) {
               fiscalAdvice += '<p class="p-3 bg-orange-100 dark:bg-orange-900/50 rounded-lg text-sm border-l-4 border-orange-500 mt-3"><span class="font-bold">üí° Suggerimento Fiscale:</span> Il tuo reddito imponibile √® nel primo scaglione IRPEF e i ricavi sono sotto il limite forfettario. Considera l\'opzione Forfettaria il prossimo anno per una gestione semplificata e un\'aliquota fiscale (eventualmente) inferiore.</p>';
          }

      }
      
      let personalAdvice = '';
      if (type === 'personal') {
          const spikes = todayData.expenseSpikes;
          if (spikes.length > 0) {
              personalAdvice = spikes.map(s => `
                  <div class="p-3 bg-red-100 dark:bg-red-900/50 rounded-lg text-sm border-l-4 border-red-500 mt-2">
                      <span class="font-bold">‚ö†Ô∏è Picco Spesa:</span> ${s.message}
                  </div>
              `).join('');
          }
      }
      
      const adviceSection = (fiscalAdvice || personalAdvice) ? `
          <div class="space-y-4">
              <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Consigli Intelligenti</h3>
              ${fiscalAdvice}
              ${personalAdvice}
          </div>
      ` : '';
      
      const fiscalTypeLabel = currentFiscal.regime === 'forfettario' ? 'Forfettario' : 'Ordinario';
      const fiscalTaxLabel = currentFiscal.regime === 'forfettario' ? 'Aliquota Fiscale Simulato' : 'IRPEF Max Simulato (43%)';
      const profitRateLabel = currentFiscal.regime === 'forfettario' ? 'Coeff. Redditivit√† Simulato' : 'Imponibile Base (Ricavi - Costi)';
      const baseImponibileLabel = currentFiscal.regime === 'forfettario' ? `Base Imponibile (${(currentFiscal.profitRate * 100).toFixed(0)}%)` : `Base Imponibile Netta (IRPEF)`;


      const fiscalSection = isActivity && fiscalSim ? `
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card border-l-4 ${fiscalSim.projectionIsActive ? 'border-indigo-500' : 'border-red-500'} space-y-4 fiscal-simulation-card">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold ${fiscalSim.projectionIsActive ? 'text-indigo-600' : 'text-red-600'}">
                    Simulazione Fiscale (${fiscalTypeLabel} Proiezione ${year}) ${fiscalSim.projectionIsActive ? '‚ú® WHAT-IF' : ''}
                </h3>
                ${fiscalSim.projectionIsActive ? `<button onclick="resetSimulationState()" class="text-sm px-2 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300">Reset Simulatore</button>` : ''}
            </div>
            
            <div class="border p-3 rounded-lg dark:border-gray-700 space-y-3 bg-gray-50 dark:bg-gray-900">
                <h4 class="text-lg font-bold text-purple-600">üéØ Obiettivo Netto Annuale</h4>
                <div>
                    <label for="target-net-income" class="text-sm text-gray-500 block mb-1">Reddito Netto Obiettivo (dopo tasse/INPS) ${symbol}</label>
                    <div class="flex items-center">
                        <input type="number" id="target-net-income" value="${targetNet !== null ? targetNet.toFixed(2) : ''}" step="1000" 
                               oninput="simulationState.targetNetIncome = this.value ? parseFloat(this.value) : null; debounceSimulationUpdate();" 
                               class="w-full p-2 border rounded-l-lg text-right dark:bg-gray-900 dark:border-gray-700 font-bold text-purple-500" inputmode="decimal" placeholder="Es. 40000.00">
                        <span class="px-3 py-2 border rounded-r-lg dark:border-gray-700">${symbol}</span>
                    </div>
                </div>
                <div class="flex justify-between text-base font-extrabold pt-2 border-t dark:border-gray-600">
                    <span>Ricavo Aggiuntivo Necessario:</span>
                    <span id="reverse-output" class="${reverseSim.ricavoAggiuntivoNecessario > 0 ? 'text-red-600' : 'text-emerald-600'}">
                        ${reverseSim.ricavoAggiuntivoNecessario > 0 ? reverseSim.ricavoAggiuntivoNecessario.toFixed(2) + ' ' + symbol : (targetNet !== null ? 'Raggiunto!' : 'N/A')}
                    </span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Stima approssimativa per la pianificazione.</p>
            </div>


            <div class="grid grid-cols-2 gap-4 pb-3 border-b dark:border-gray-700">
                <div>
                    <label for="additional-revenue" class="text-sm text-gray-500 block mb-1">Ricavo Aggiuntivo (Simula)</label>
                    <div class="flex items-center">
                        <input type="number" id="additional-revenue" value="${whatIfRevenue.toFixed(2)}" step="100" min="0" 
                               oninput="simulationState.additionalRevenue = parseFloat(this.value) || 0; debounceSimulationUpdate();" 
                               class="w-full p-2 border rounded-l-lg text-right dark:bg-gray-900 dark:border-gray-700 font-bold text-emerald-500" inputmode="decimal">
                        <span class="px-3 py-2 border rounded-r-lg dark:border-gray-700">${symbol}</span>
                    </div>
                </div>
                <div>
                    <label for="additional-expense" class="text-sm text-gray-500 block mb-1">Costo Aggiuntivo (Simula)</label>
                    <div class="flex items-center">
                        <input type="number" id="additional-expense" value="${whatIfExpense.toFixed(2)}" step="100" min="0" 
                               oninput="simulationState.additionalExpense = parseFloat(this.value) || 0; debounceSimulationUpdate();" 
                               class="w-full p-2 border rounded-l-lg text-right dark:bg-gray-900 dark:border-gray-700 font-bold text-red-500" inputmode="decimal">
                        <span class="px-3 py-2 border rounded-r-lg dark:border-gray-700">${symbol}</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="profit-rate-override" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">${profitRateLabel}</label>
                    <div class="flex items-center">
                        <input type="number" id="profit-rate-override" step="1" min="1" max="100" 
                            value="${currentFiscal.regime === 'forfettario' ? (profitRateOverride !== null ? (profitRateOverride * 100).toFixed(0) : '') : ''}" 
                            placeholder="${currentFiscal.regime === 'forfettario' ? (appData.fiscalParams.profitRate * 100).toFixed(0) : 'N/A'}"
                            ${currentFiscal.regime === 'ordinario' ? 'disabled' : ''}
                            oninput="simulationState.profitRateOverride = this.value ? parseFloat(this.value) / 100 : null; debounceSimulationUpdate();"
                            class="w-full p-2 border rounded-l-lg text-right dark:bg-gray-900 dark:border-gray-700 font-bold text-orange-500" inputmode="numeric">
                        <span class="px-3 py-2 border rounded-r-lg dark:border-gray-700">%</span>
                    </div>
                </div>
                <div>
                    <label for="tax-rate-override" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">${fiscalTaxLabel}</label>
                    <div class="flex items-center">
                        <input type="number" id="tax-rate-override" step="0.1" min="0" max="50" 
                            value="${currentFiscal.regime === 'forfettario' ? (taxRateOverride !== null ? (taxRateOverride * 100).toFixed(1) : '') : ''}" 
                            placeholder="${currentFiscal.regime === 'forfettario' ? (appData.fiscalParams.taxRate * 100).toFixed(1) : 'Vedi Scaglioni'}"
                            ${currentFiscal.regime === 'ordinario' ? 'disabled' : ''}
                            oninput="simulationState.taxRateOverride = this.value ? parseFloat(this.value) / 100 : null; debounceSimulationUpdate();"
                            class="w-full p-2 border rounded-l-lg text-right dark:bg-gray-900 dark:border-gray-700 font-bold text-orange-500" inputmode="decimal">
                        <span class="px-3 py-2 border rounded-r-lg dark:border-gray-700">%</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-2 border-t dark:border-gray-700">
                <div class="flex justify-between text-sm">
                    <span>Ricavi Proiettati:</span>
                    <span id="sim-ricavi" class="font-bold text-emerald-600">${fiscalSim.totalRicavi.toFixed(2)} ${symbol}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span>Costi Deducibili Proiettati:</span>
                    <span id="sim-costi" class="font-bold text-red-600">${fiscalSim.totalCosti.toFixed(2)} ${symbol}</span>
                </div>
                <div class="flex justify-between text-sm border-t pt-2 mt-2">
                    <span class="base-imponibile-label">${baseImponibileLabel}:</span>
                    <span id="sim-base-imponibile" class="font-bold">${fiscalSim.baseImponibile.toFixed(2)} ${symbol}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span>Imposta (IRPEF/Sostitutiva):</span>
                    <span id="sim-imposta" class="font-bold text-red-600">${fiscalSim.impostaSostitutiva.toFixed(2)} ${symbol}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span>Contributi INPS Stimati:</span>
                    <span id="sim-inps" class="font-bold text-red-600">${fiscalSim.contributiINPS.toFixed(2)} ${symbol}</span>
                </div>
                <div class="flex justify-between text-base font-extrabold border-t border-red-300 pt-2">
                    <span>TOTALE TASSE E CONTRIBUTI STIMATE:</span>
                    <span id="sim-totale-tasse" class="text-red-600">${fiscalSim.totaleTasse.toFixed(2)} ${symbol}</span>
                </div>
                <div class="flex justify-between text-lg font-extrabold pt-2 mt-2 border-t border-indigo-300">
                    <span>LIQUIDIT√Ä NETTA RIMANENTE PROIETTATA:</span>
                    <span id="sim-netta-rimanente" class="${fiscalSim.nettaRimanente >= 0 ? 'text-emerald-600' : 'text-red-600'}">${fiscalSim.nettaRimanente.toFixed(2)} ${symbol}</span>
                </div>
            </div>
            <p id="sim-note" class="text-xs text-gray-500 mt-2">${fiscalSim.note}</p>
        </div>
      ` : '';


      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-semibold border-b pb-2 text-gray-700 dark:text-gray-300">${title}</h2>
          ${renderSummaryCard(summary,year)}
          
          ${fiscalSection}
          
          ${adviceSection}

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center border-l-4 border-indigo-500">
                <p class="text-sm text-gray-500">Punteggio Salute Finanziaria</p>
                <p class="text-2xl font-extrabold ${FHSColor}">${fhs.score}/${fhs.max}</p>
                <p class="text-xs text-gray-400">Basato su Risparmio, Liquidit√† & Budget</p>
            </div>
             <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center border-l-4 border-purple-500">
                <p class="text-sm text-gray-500">Liquidit√† (Stress Test)</p>
                <p class="text-2xl font-extrabold ${liquidityBuffer >= 3 ? 'text-emerald-600' : (liquidityBuffer >= 1 ? 'text-orange-600' : 'text-red-600')}">
                    ${liquidityBuffer > 0 ? liquidityBuffer.toFixed(1) : '0.0'} Mesi
                </p>
                <p class="text-xs text-gray-400">Autonomia con spese medie attuali</p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card border-l-4 border-blue-500">
                <h3 class="text-xl font-bold mb-2">Focus Oggi (${new Date().toLocaleDateString('it-IT')})</h3>
                <p class="text-sm text-gray-500">Saldo Netto del Giorno: <span class="font-extrabold ${todayBalanceColor}">${todaySummaryMessage}</span></p>
                
                <p class="text-xs text-gray-500">
                    ${todayData.upcomingReminders.length > 0 ? `üîî ${todayData.upcomingReminders.length} scadenza/e oggi. ` : ''}
                    ${todayData.upcomingBirthdays.length > 0 ? `üéÇ ${todayData.upcomingBirthdays.length} compleanno/i oggi!` : ''}
                    ${todayData.upcomingReminders.length === 0 && todayData.upcomingBirthdays.length === 0 ? 'Nessun evento o scadenza urgente.' : ''}
                </p>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card" style="height: 200px;">
                <canvas id="weeklyBalanceChart-${type}"></canvas>
            </div>
          
          <div id="transaction-form-anchor" class="pt-4"></div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card">
            <h3 class="text-xl font-medium mb-4 text-gray-700 dark:text-gray-300">Registra Movimento</h3>
            <button onclick="openTransactionForm('false')" class="cta-button w-full bg-indigo-500 text-white p-3 rounded-lg font-bold hover:bg-indigo-600">
                Apri Modulo Registrazione Rapida
            </button>
            <p class="text-xs text-gray-500 mt-2 text-center">Oppure usa i pulsanti flottanti in basso su mobile.</p>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card mb-20">
            <h3 class="text-xl font-medium mb-4">${listTitle} (${year})</h3>
            <div id="transactions-list" class="space-y-3">
              ${tx.length? tx.map(t=>{
                const isIncomeTx = appData.invoices.some(i=>i.id===t.id);
                const colorClass = isIncomeTx?'bg-emerald-50 dark:bg-emerald-900/50':'bg-red-50 dark:bg-red-900/50';
                const incomeTag = isActivity && isIncomeTx && t.incomeType==='Incasso/Corrispettivo' ? '<span class="text-xs text-orange-600 dark:text-orange-300 font-semibold">(Corrispettivo)</span>':'';
                return `
                  <div class="flex justify-between items-center p-3 border-b border-gray-100 dark:border-gray-700 last:border-b-0 ${colorClass} rounded-lg">
                    <div class="flex-grow">
                      <p class="font-semibold text-sm">
                        ${getCategoryIcon(t.category)} ${t.description||''} ${incomeTag}
                      </p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">
                        ${new Date(t.date).toLocaleDateString('it-IT')} | Cat: ${t.category||'-'} 
                        ${(t.tags||[]).length > 0 ? '| Tag: '+(t.tags||[]).join(', ') : ''}
                      </p>
                    </div>
                    <div class="text-right ml-4 flex items-center space-x-3">
                      <div>
                        <p class="font-bold ${isIncomeTx?'text-emerald-700 dark:text-emerald-300':'text-red-700 dark:text-red-300'}">${t.gross.toFixed(2)} ${symbol}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Netto: ${t.net.toFixed(2)}</p>
                      </div>
                      <button onclick="duplicateTransaction(${isIncomeTx},${t.id},'${type}')" class="text-orange-500 hover:text-orange-700" title="Duplica Transazione">üìã</button>
                      <button onclick="editTransaction(${isIncomeTx},${t.id},'${type}')" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-200">‚úèÔ∏è</button>
                      <button onclick="deleteTransaction(${isIncomeTx},${t.id})" class="text-red-400 hover:text-red-600">üóëÔ∏è</button>
                    </div>
                  </div>
                `;
              }).join('') : '<p class="text-gray-500 text-center">Nessuna transazione nell\'anno.</p>'}
            </div>
          </div>
        </div>
      `;
    }

    // --- Report page (KPI + Trend + Ricerca + IVA/Cash bars + Dettaglio) ---
    function filterTransactions(query, transactions){
      const q=(query||'').toLowerCase();
      if (!q) return transactions;
      return transactions.filter(t =>
        (t.description||'').toLowerCase().includes(q) ||
        (t.category||'').toLowerCase().includes(q) ||
        (t.tags||[]).some(tag => tag.toLowerCase().includes(q)) ||
        String(t.gross).includes(q)
      );
    }

    function computeKPIs(){
      const cacheKey = 'global_kpis';
      const now = Date.now();
      if (calculatedResultsCache[cacheKey] && (now - lastCacheUpdateTime < CACHE_DURATION)) {
          return calculatedResultsCache[cacheKey];
      }
        
      const all = [...appData.invoices.map(t=>({...t,isIncome:true})), ...appData.expenses.map(t=>({...t,isIncome:false}))];
      if (all.length===0) return {savingRate:0, avgExpense:0, avgIncome:0, topClients:[], topSuppliers:[], topCategories:[]};

      const byMonth = {};
      all.forEach(t=>{
        const ym=t.date?.slice(0,7)||'';
        if (!byMonth[ym]) byMonth[ym] = {inc:0, exp:0};
        const gross = parseFloat(t.gross) || 0;
        if (t.isIncome) byMonth[ym].inc += gross; else byMonth[ym].exp += gross;
      });
      const months = Object.keys(byMonth);
      const sumInc = months.reduce((s,m)=>s+byMonth[m].inc,0);
      const sumExp = months.reduce((s,m)=>s+byMonth[m].exp,0);
      const avgIncome = months.length? sumInc/months.length : 0;
      const avgExpense = months.length? sumExp/months.length : 0;
      const net = sumInc - sumExp;
      const savingRate = sumInc > 0 ? (net/sumInc*100) : (net > 0 ? 100 : (net < 0 ? -100 : 0)); 

      const sumByDesc = {};
      all.forEach(t=>{
        const key=(t.description||'?').trim();
        sumByDesc[key] ||= {inc:0,exp:0};
        const gross = parseFloat(t.gross) || 0;
        if (t.isIncome) sumByDesc[key].inc += gross; else sumByDesc[key].exp += gross;
      });
      const topClients = Object.entries(sumByDesc).filter(([k,v])=>v.inc>0).sort((a,b)=>b[1].inc - a[1].inc).slice(0,3).map(([name,v])=>({name, amount:v.inc}));
      const topSuppliers = Object.entries(sumByDesc).filter(([k,v])=>v.exp>0).sort((a,b)=>b[1].exp - a[1].exp).slice(0,3).map(([name,v])=>({name, amount:v.exp}));

      const byCat = {};
      all.forEach(t=>{
        const cat=(t.category||'Altro').trim();
        byCat[cat] ||= {inc:0,exp:0};
        const gross = parseFloat(t.gross) || 0;
        if (t.isIncome) byCat[cat].inc += gross; else byCat[cat].exp += gross;
      });
      const topCategories = Object.entries(byCat).sort((a,b)=>b[1].exp - a[1].exp).slice(0,3).map(([cat,v])=>({cat, amount:v.exp}));

      const result = {savingRate, avgExpense, avgIncome, topClients, topSuppliers, topCategories};
      calculatedResultsCache[cacheKey] = result;
      return result;
    }
    
    function calculateCashFlowProjection() {
        const today = new Date();
        const futureDate = new Date();
        futureDate.setDate(today.getDate() + 90);
        
        const summarySinceStart = calculateFinancialSummary('global', 'all', 'all');
        let netProjection = (parseFloat(appData.currentBankBalance) || 0);
        netProjection += summarySinceStart.transactions.reduce((acc, t) => acc + (t.gross * (t.isIncome ? 1 : -1)), 0);

        appData.recurringExpenses.forEach(r => {
            const nextDateStr = calculateNextRecurrence(r.lastDate, r.frequency);
            if (nextDateStr) {
                const nextDate = new Date(nextDateStr);
                if (nextDate >= today && nextDate <= futureDate) {
                    const isIncome = r.isIncome || appData.invoices.some(i => i.description === r.description);
                    netProjection += isIncome ? r.lastAmount : -r.lastAmount;
                }
            }
        });
        
        appData.reminders.forEach(r => {
            const rDate = new Date(r.date);
            // Solo promemoria che sono pagamenti (amount > 0)
            if (!r.paid && rDate >= today && rDate <= futureDate && r.amount > 0) { 
                netProjection -= r.amount;
            }
        });

        return {
            projection: +netProjection.toFixed(2), days: 90
        };
    }

    function renderTrendChart(){
      const canvas = document.getElementById('trendChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d'); 
      
      if (canvas.chart) { canvas.chart.destroy(); }
      
      const allTransactions = [
        ...appData.invoices.map(t=>({...t,isIncome:true})), 
        ...appData.expenses.map(t=>({...t,isIncome:false}))
      ];

      const grouped={};
      allTransactions.forEach(t=>{
        const ym=t.date?.slice(0,7); if(!ym) return;
        if (!grouped[ym]) grouped[ym]={income:0,expense:0};
        const gross = parseFloat(t.gross) || 0;
        if (t.isIncome) grouped[ym].income += gross; else grouped[ym].expense += gross;
      });
      const labels=Object.keys(grouped).sort();
      const incomes=labels.map(l=>grouped[l].income);
      const expenses=labels.map(l=>grouped[l].expense);
      
      canvas.chart = new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[
          { label:'Entrate', data:incomes, borderColor:'#10b981', backgroundColor:'#10b981', tension: 0.1, fill:false },
          { label:'Uscite', data:expenses, borderColor:'#ef4444', backgroundColor:'#ef4444', tension: 0.1, fill:false }
        ]},
        options:{ 
          responsive:true, 
          maintainAspectRatio:false,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: {
              labels: {
                color: document.body.classList.contains('dark') ? '#f1f5f9' : '#1e293b' 
              }
            }
          }
        }
      });
    }
    
    // Raggruppamento per Mese
    function groupTransactionsByMonth(transactions) {
        const grouped = {};
        transactions.forEach(t => {
            const date = new Date(t.date);
            const monthYear = date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long' });
            grouped[monthYear] = grouped[monthYear] || [];
            grouped[monthYear].push(t);
        });
        
        const sortedKeys = Object.keys(grouped).sort((a, b) => {
            // Estrae Anno e Mese per un ordinamento corretto
            const getDateKey = (key) => {
                const parts = key.split(' ');
                const year = parseInt(parts[1]);
                const monthName = parts[0];
                const date = new Date(year, new Date(Date.parse(monthName + " 1, 2012")).getMonth(), 1);
                return date.getTime();
            };
            return getDateKey(b) - getDateKey(a); // Ordine Decrescente
        });
        
        const sortedGrouped = {};
        sortedKeys.forEach(key => {
            // Riordina le transazioni all'interno del mese per data
            grouped[key].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedGrouped[key] = grouped[key];
        });
        
        return sortedGrouped;
    }
    
    // *** NUOVA FUNZIONE: Aggiorna solo il dettaglio transazioni del report ***
    function updateReportDetail(query) {
        // Prende i filtri direttamente dalla variabile di stato
        const { type: currentReportType, filterType, filterDateStr, categoryFilter, tagFilter } = reportFilters;
        
        let results = calculateFinancialSummary(currentReportType, filterType, filterDateStr).transactions.slice(); 
        
        results = filterTransactionsByCriteria(results, categoryFilter === 'all' ? null : categoryFilter, tagFilter === 'all' ? null : tagFilter);
        results = filterTransactions(query, results); 
        results = sortTransactions(results); 
        
        const symbol = getCurrencySymbol();
        const searchGrouped = groupTransactionsByMonth(results);
        
        let searchHtml = '';
        if (Object.keys(searchGrouped).length > 0) {
            searchHtml = Object.keys(searchGrouped).map(month => {
                const monthlyTx = searchGrouped[month];
                const totalMonth = monthlyTx.reduce((sum, t) => sum + (t.gross * (t.isIncome ? 1 : -1)), 0);
                const monthColor = totalMonth >= 0 ? 'text-emerald-500' : 'text-red-500';
                
                return `
                    <details class="bg-gray-50 dark:bg-gray-900 rounded-lg shadow-sm" open>
                        <summary class="p-3 font-bold group-header flex justify-between items-center bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <span>${month} (${monthlyTx.length} movimenti)</span>
                            <span class="${monthColor}">${totalMonth.toFixed(2)} ${symbol}</span>
                        </summary>
                        <div class="space-y-3 p-3">
                            ${monthlyTx.map(t=>`
                                <div class="flex justify-between items-center p-3 border-l-4 ${t.isIncome?'bg-emerald-50 border-emerald-300 dark:bg-emerald-900/50 dark:border-emerald-700':'bg-red-50 border-red-300 dark:bg-red-900/50 dark:border-red-700'} rounded-lg">
                                  <div class="flex-grow">
                                    <p class="font-semibold text-sm">${getCategoryIcon(t.category)} ${new Date(t.date).toLocaleDateString('it-IT')}: ${t.description||''}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                      ${t.type==='activity'?'Attivit√†':'Personale'} | IVA ${t.vatRate}% | Cat: ${t.category||'-'} 
                                      ${(t.tags||[]).length > 0 ? '| Tag: '+(t.tags||[]).join(', ') : ''}
                                    </p>
                                  </div>
                                  <div class="text-right ml-4">
                                    <p class="font-bold ${t.isIncome?'text-emerald-700 dark:text-emerald-300':'text-red-700 dark:text-red-300'}">${t.gross.toFixed(2)} ${symbol}</p>
                                  </div>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `;
            }).join('');
        } else {
            searchHtml = '<p class="text-gray-500">Nessuna transazione trovata con i filtri attuali.</p>';
        }
        
        document.getElementById('transactions-detail').innerHTML = searchHtml;
        
        // Aggiorna anche il contatore di transazioni se l'elemento esiste
        const detailHeader = document.querySelector('.report-detail-header');
        if (detailHeader) {
             const totalCount = results.length;
             detailHeader.innerHTML = `Dettaglio Movimenti (${totalCount})`;
        }
      }
    
    function renderReportPage(){
      const symbol = getCurrencySymbol();
      
      loadReportFilters();
      
      // I valori initiali sono presi dai filtri salvati
      const currentType = reportFilters.type;
      const filterType = reportFilters.filterType;
      const filterDateStr = reportFilters.filterDateStr;
      const categoryFilter = reportFilters.categoryFilter;
      const tagFilter = reportFilters.tagFilter;
      const sortKey = reportFilters.sortKey;
      const sortDirection = reportFilters.sortDirection;
      const searchQuery = reportFilters.searchQuery;
      
      // Aggiorna reportFilters con i valori degli input se sono stati cambiati
      const currentReportType = document.getElementById('report-type')?.value || currentType;
      const currentFilterType = document.getElementById('filter-type')?.value || filterType;
      const currentFilterDateStr = document.getElementById('filter-date')?.value || filterDateStr;
      const currentCategoryFilter = document.getElementById('filter-category')?.value || categoryFilter;
      const currentTagFilter = document.getElementById('filter-tag')?.value || tagFilter;
      const currentSortKey = document.getElementById('sort-key')?.value || sortKey;
      const currentSortDirection = document.getElementById('sort-direction')?.value || sortDirection;
      const currentSearchQuery = document.getElementById('search')?.value || searchQuery;
      
      reportFilters = { 
          type: currentReportType, filterType: currentFilterType, filterDateStr: currentFilterDateStr, 
          categoryFilter: currentCategoryFilter, tagFilter: currentTagFilter, 
          sortKey: currentSortKey, sortDirection: currentSortDirection, searchQuery: currentSearchQuery 
      };
      saveReportFilters(); 

      const summary = calculateFinancialSummary(currentReportType, currentFilterType, currentFilterDateStr);
      const cashSummary = calculateFinancialSummary('global', currentFilterType, currentFilterDateStr);
      const ivaSummary = calculateFinancialSummary('activity', currentFilterType, currentFilterDateStr);
      
      let transactionsList = filterTransactionsByCriteria(summary.transactions, currentCategoryFilter === 'all' ? null : currentCategoryFilter, currentTagFilter === 'all' ? null : currentTagFilter);
      
      if (currentSearchQuery) {
          transactionsList = filterTransactions(currentSearchQuery, transactionsList);
      }
      
      transactionsList = sortTransactions(transactionsList);
      
      const groupedTransactions = groupTransactionsByMonth(transactionsList);

      const totalCash = cashSummary.totalIncomes + cashSummary.totalExpenses;
      const cashIncomePercent = totalCash>0 ? (cashSummary.totalIncomes/totalCash)*100 : 50;
      const cashExpensePercent = 100 - cashIncomePercent;

      const totalIva = ivaSummary.ivaAddebito + ivaSummary.ivaCredito;
      const ivaAddebitoPercent = totalIva>0 ? (ivaSummary.ivaAddebito/totalIva)*100 : 50;
      const ivaCreditoPercent = 100 - ivaAddebitoPercent;

      const KPIs = computeKPIs();
      
      const sixMonthProjection = calculateSixMonthBalanceProjection();
      const proj6MColor = sixMonthProjection.projection >= 0 ? 'text-emerald-600' : 'text-red-600';
      
      const liquidityBuffer = calculateLiquidityBuffer();
      
      const summarySinceStart = calculateFinancialSummary('global', 'all', 'all');
      let totalBalance = (parseFloat(appData.currentBankBalance) || 0);
      totalBalance += summarySinceStart.transactions.reduce((acc, t) => acc + (t.gross * (t.isIncome ? 1 : -1)), 0);
      const freeBalance = totalBalance - (appData.taxCashReserve || 0);

      const averageMonthlyNet = (KPIs.avgIncome || 0) - (KPIs.avgExpense || 0);
      const targetDelta = averageMonthlyNet - (appData.monthlySavingsTarget || 0);
      const targetColor = targetDelta >= 0 ? 'text-emerald-600' : 'text-red-600';

      let periodLabel='Periodo Selezionato';
      if (currentFilterType==='all') periodLabel='Tutti i Dati';
      else if (currentFilterType==='year') periodLabel=currentFilterDateStr;
      else if (currentFilterType==='month'){ const [y,m]=currentFilterDateStr.split('-').map(Number); const d=new Date(y,m-1,1); periodLabel=d.toLocaleDateString('it-IT',{year:'numeric',month:'long'}); }
      else if (currentFilterType==='quarter'){ const [y,m]=currentFilterDateStr.split('-').map(Number); periodLabel=`Trimestre Q${Math.ceil(m/3)}/${y}`; }
      else if (currentFilterType==='week'){ periodLabel=`Settimana di ${new Date(currentFilterDateStr).toLocaleDateString('it-IT')}`; }
      else if (currentFilterType==='day') periodLabel=new Date(currentFilterDateStr).toLocaleDateString('it-IT',{day:'numeric',month:'long',year:'numeric'});
      
      const allCategories = appData.categories || DEFAULT_CATEGORIES.slice();
      const allTags = getAllTags();

      const currentMonth = new Date().toISOString().slice(0, 7);
      const monthSummary = calculateFinancialSummary('personal', 'month', currentMonth);
      const categoryExpenseMap = {};
      monthSummary.transactions.filter(t => !t.isIncome && t.type === 'personal').forEach(t => {
          const cat = t.category || 'Altro';
          categoryExpenseMap[cat] = (categoryExpenseMap[cat] || 0) + t.gross;
      });

      const budgetAnalysis = allCategories
          .filter(cat => appData.categoryBudgets[cat] > 0 || categoryExpenseMap[cat] > 0)
          .map(cat => {
              const budget = appData.categoryBudgets[cat] || 0;
              const spent = categoryExpenseMap[cat] || 0;
              const remaining = budget - spent;
              let colorClass = '';
              if (budget === 0) { colorClass = spent > 0 ? 'budget-yellow' : ''; } 
              else if (remaining < 0) { colorClass = 'budget-red'; } 
              else if (remaining < budget * 0.20) { colorClass = 'budget-yellow'; } 
              else { colorClass = 'budget-green'; }
              return { cat, budget, spent, remaining, colorClass };
          }).sort((a, b) => b.spent - a.spent);
          
      const fhs = calculateFinancialHealthScore();
      const FHSColor = fhs.score > 80 ? 'text-emerald-600' : (fhs.score > 60 ? 'text-orange-600' : 'text-red-600');


      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-semibold border-b pb-2 text-gray-700 dark:text-gray-300">Riepilogo Finanziario Globale</h2>

          <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="md:col-span-1">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo</label>
              <select id="report-type" onchange="renderPage('report')" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                <option value="global" ${currentReportType==='global'?'selected':''}>Totale</option>
                <option value="activity" ${currentReportType==='activity'?'selected':''}>Attivit√†</option>
                <option value="personal" ${currentReportType==='personal'?'selected':''}>Personale</option>
              </select>
            </div>
            <div class="md:col-span-1">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Periodo</label>
              <select id="filter-type" onchange="updateReportDateInput()" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700" value="${currentFilterType}">
                <option value="day" ${currentFilterType==='day'?'selected':''}>Giorno</option>
                <option value="week" ${currentFilterType==='week'?'selected':''}>Settimana</option>
                <option value="month" ${currentFilterType==='month'?'selected':''}>Mese</option>
                <option value="quarter" ${currentFilterType==='quarter'?'selected':''}>Trimestre</option>
                <option value="year" ${currentFilterType==='year'?'selected':''}>Anno</option>
                <option value="all" ${currentFilterType==='all'?'selected':''}>Tutti</option>
              </select>
            </div>
            <div class="md:col-span-1">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data/Anno</label>
              <input type="${currentFilterType==='year'?'number':(currentFilterType==='month'||currentFilterType==='quarter')?'month':'date'}" id="filter-date" value="${currentFilterDateStr==='all'?'':currentFilterDateStr}" onchange="renderPage('report')" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 ${currentFilterType==='all'?'hidden':''}">
            </div>
            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoria</label>
                <select id="filter-category" onchange="renderPage('report')" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                    <option value="all">Tutte le Categorie</option>
                    ${allCategories.map(c => `<option value="${c}" ${currentCategoryFilter === c ? 'selected' : ''}>${getCategoryIcon(c)} ${c}</option>`).join('')}
                </select>
            </div>
            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tag</label>
                <select id="filter-tag" onchange="renderPage('report')" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                    <option value="all">Tutti i Tag</option>
                    ${allTags.map(t => `<option value="${t}" ${currentTagFilter === t ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center border-l-4 border-indigo-500">
                  <p class="text-sm text-gray-500">Punteggio Salute Finanziaria</p>
                  <p class="text-2xl font-extrabold ${FHSColor}">${fhs.score}/${fhs.max}</p>
              </div>
              <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center border-l-4 border-dashed border-purple-500">
                  <p class="text-sm text-gray-500">Obiettivo Saldo Netto Mensile: ${appData.monthlySavingsTarget.toFixed(2)} ${symbol}</p>
                  <p class="text-xl font-bold ${targetColor}">
                      Proiezione Media Mensile: ${targetDelta.toFixed(2)} ${symbol} 
                  </p>
              </div>
              <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center border-l-4 border-dashed border-indigo-500">
                  <p class="text-sm text-gray-500">Proiezione Saldo cassa (90 Giorni)</p>
                  <p class="text-xl font-bold ${calculateCashFlowProjection().projection >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                      ${calculateCashFlowProjection().projection.toFixed(2)} ${symbol}
                  </p>
              </div>
              <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center border-l-4 border-dashed border-pink-500">
                  <p class="text-sm text-gray-500">Stress Test Liquidit√†</p>
                  <p class="text-xl font-bold ${liquidityBuffer >= 3 ? 'text-emerald-600' : (liquidityBuffer >= 1 ? 'text-orange-600' : 'text-red-600')}">
                      ${liquidityBuffer.toFixed(1)} Mesi
                  </p>
              </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
              <p class="text-sm text-gray-500">Tasso di Risparmio</p>
              <p class="text-2xl font-extrabold ${KPIs.savingRate>=0?'text-emerald-600':'text-red-600'}">${(KPIs.savingRate||0).toFixed(1)}%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
              <p class="text-sm text-gray-500">Media Mensile Entrate</p>
              <p class="text-2xl font-extrabold text-emerald-600">${(KPIs.avgIncome||0).toFixed(2)} ${symbol}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
              <p class="text-sm text-gray-500">Media Mensile Uscite</p>
              <p class="text-2xl font-extrabold text-red-600">${(KPIs.avgExpense||0).toFixed(2)} ${symbol}</p>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card">
            <h3 class="text-xl font-extrabold mb-3 text-gray-800 dark:text-gray-200">Totale Globale: ${periodLabel}</h3>
            ${renderSummaryCard(summary, periodLabel)}
          </div>

          ${currentReportType!=='personal'?`
          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-3">
              <h3 class="text-xl font-medium mb-3 text-gray-800 dark:text-gray-200">Analisi Budget (Personale - ${currentMonth})</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">Verifica i limiti di spesa impostati in Gestione Dati. Se Budget √® 0, monitora solo le spese.</p>
              <div class="space-y-2">
                  ${budgetAnalysis.map(b => `
                      <div class="p-3 rounded-lg border-l-4 ${b.colorClass} flex justify-between items-center text-sm">
                          <span class="font-semibold">${getCategoryIcon(b.cat)} ${b.cat}</span>
                          <div class="text-right">
                              ${b.budget > 0 ? `<p class="text-xs text-gray-600 dark:text-gray-300">Budget: ${b.budget.toFixed(2)} ${symbol}</p>` : ''}
                              <p class="font-bold">Speso: ${b.spent.toFixed(2)} ${symbol}</p>
                              ${b.budget > 0 ? `<p class="${b.remaining < 0 ? 'text-red-700 dark:text-red-300' : 'text-emerald-700 dark:text-emerald-300'} text-xs">Rimanente: ${b.remaining.toFixed(2)} ${symbol}</p>` : ''}
                          </div>
                      </div>
                  `).join('') || '<p class="text-gray-500 text-center">Nessun budget definito o spesa nel mese.</p>'}
              </div>
          </div>`:''}

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card" style="height: 280px;">
            <h3 class="text-xl font-medium mb-3 text-gray-800 dark:text-gray-200">Andamento Mensile Entrate/Uscite</h3>
            <canvas id="trendChart"></canvas>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card">
            <h3 class="text-xl font-medium mb-3 text-gray-800 dark:text-gray-200">Analisi Cash Flow (${periodLabel})</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 font-semibold">Distribuzione Entrate vs Uscite</p>
            <div class="bar-container">
              <div class="bar-income h-full" style="width:${cashIncomePercent.toFixed(1)}%"></div>
              <div class="bar-expense h-full" style="width:${cashExpensePercent.toFixed(1)}%"></div>
            </div>
            <div class="flex justify-between text-xs mt-1">
              <span class="text-emerald-700 dark:text-emerald-300">${cashIncomePercent.toFixed(1)}% Entrate</span>
              <span class="text-red-700 dark:text-red-300">${cashExpensePercent.toFixed(1)}% Uscite</span>
            </div>
          </div>

          ${currentReportType!=='personal'?`
          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card">
            <h3 class="text-xl font-medium mb-3 text-gray-800 dark:text-gray-200">Analisi IVA (Attivit√† - ${periodLabel})</h3>
            <div class="bar-container">
              <div class="bar-addebito h-full" style="width:${ivaAddebitoPercent.toFixed(1)}%"></div>
              <div class="bar-credito h-full" style="width:${ivaCreditoPercent.toFixed(1)}%"></div>
            </div>
            <div class="flex justify-between text-xs mt-1">
              <span class="text-orange-700 dark:text-orange-300">${ivaAddebitoPercent.toFixed(1)}% Addebito</span>
              <span class="text-indigo-700 dark:text-indigo-300">${ivaCreditoPercent.toFixed(1)}% Credito</span>
            </div>
          </div>`:''}

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card">
              <h4 class="font-semibold mb-2">Top 3 Clienti</h4>
              <ul class="text-sm">${KPIs.topClients.map(c=>`<li class="flex justify-between"><span>${c.name}</span><span class="font-bold text-emerald-600 dark:text-emerald-300">${c.amount.toFixed(2)} ${symbol}</span></li>`).join('') || '<li class="text-gray-500">-</li>'}</ul>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card">
              <h4 class="font-semibold mb-2">Top 3 Fornitori</h4>
              <ul class="text-sm">${KPIs.topSuppliers.map(c=>`<li class="flex justify-between"><span>${c.name}</span><span class="font-bold text-red-600 dark:text-red-300">${c.amount.toFixed(2)} ${symbol}</span></li>`).join('') || '<li class="text-gray-500">-</li>'}</ul>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card">
              <h4 class="font-semibold mb-2">Top 3 Categorie (Uscite)</h4>
              <ul class="text-sm">${KPIs.topCategories.map(c=>`<li class="flex justify-between"><span>${getCategoryIcon(c.cat)} ${c.cat}</span><span class="font-bold text-red-600 dark:text-red-300">${c.amount.toFixed(2)} ${symbol}</span></li>`).join('') || '<li class="text-gray-500">-</li>'}</ul>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card mb-20">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
              <h3 class="text-xl font-medium text-gray-800 dark:text-gray-200 report-detail-header">Dettaglio Movimenti (${transactionsList.length})</h3>
              
              <button onclick="exportPDF()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 text-sm">
                Esporta PDF üìÑ
              </button>
            </div>
            
            <input type="text" id="search" value="${currentSearchQuery}" placeholder="üîç Cerca (descrizione, categoria, tag, importo)" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 mb-4">
            
            <div class="flex space-x-4 mb-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ordina per</label>
                    <select id="sort-key" onchange="renderPage('report')" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                        <option value="date" ${currentSortKey === 'date' ? 'selected' : ''}>Data</option>
                        <option value="gross" ${currentSortKey === 'gross' ? 'selected' : ''}>Importo</option>
                        <option value="category" ${currentSortKey === 'category' ? 'selected' : ''}>Categoria</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Direzione</label>
                    <select id="sort-direction" onchange="renderPage('report')" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                        <option value="desc" ${currentSortDirection === 'desc' ? 'selected' : ''}>Decrescente</option>
                        <option value="asc" ${currentSortDirection === 'asc' ? 'selected' : ''}>Crescente</option>
                    </select>
                </div>
            </div>

            <div id="transactions-detail" class="space-y-4">
              ${Object.keys(groupedTransactions).length > 0 ? Object.keys(groupedTransactions).map(month => {
                  const monthlyTx = groupedTransactions[month];
                  const totalMonth = monthlyTx.reduce((sum, t) => sum + (t.gross * (t.isIncome ? 1 : -1)), 0);
                  const monthColor = totalMonth >= 0 ? 'text-emerald-500' : 'text-red-500';

                  return `
                      <details class="bg-gray-50 dark:bg-gray-900 rounded-lg shadow-sm" open>
                          <summary class="p-3 font-bold group-header flex justify-between items-center bg-gray-100 dark:bg-gray-700 rounded-lg">
                              <span>${month} (${monthlyTx.length} movimenti)</span>
                              <span class="${monthColor}">${totalMonth.toFixed(2)} ${symbol}</span>
                          </summary>
                          <div class="space-y-3 p-3">
                              ${monthlyTx.map(t=>`
                                <div class="flex justify-between items-center p-3 border-l-4 ${t.isIncome?'bg-emerald-50 border-emerald-300 dark:bg-emerald-900/50 dark:border-emerald-700':'bg-red-50 border-red-300 dark:bg-red-900/50 dark:border-red-700'} rounded-lg">
                                  <div class="flex-grow">
                                    <p class="font-semibold text-sm">${getCategoryIcon(t.category)} ${new Date(t.date).toLocaleDateString('it-IT')}: ${t.description||''}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                      ${t.type==='activity'?'Attivit√†':'Personale'} | IVA ${t.vatRate}% | Cat: ${t.category||'-'} 
                                      ${(t.tags||[]).length > 0 ? '| Tag: '+(t.tags||[]).join(', ') : ''}
                                    </p>
                                  </div>
                                  <div class="text-right ml-4">
                                    <p class="font-bold ${t.isIncome?'text-emerald-700 dark:text-emerald-300':'text-red-700 dark:text-red-300'}">${t.gross.toFixed(2)} ${symbol}</p>
                                  </div>
                                </div>
                              `).join('')}
                          </div>
                      </details>
                  `;
              }).join('') : '<p class="text-gray-500">Nessuna transazione nel periodo.</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function updateReportDateInput(){
      const filterType = document.getElementById('filter-type')?.value;
      const input = document.getElementById('filter-date');
      if (!input) return;

      let type='date', visible=true, def=new Date().toISOString().slice(0,10);
      switch(filterType){
        case 'year': 
          type='number'; input.min=2000; input.max=new Date().getFullYear(); def=new Date().getFullYear(); 
          break;
        case 'month': 
        case 'quarter': 
          type='month'; def=new Date().toISOString().slice(0,7); 
          break;
        case 'week': 
        case 'day': 
          type='date'; def=new Date().toISOString().slice(0,10); 
          break;
        default: 
          type='hidden'; visible=false; def='all';
      }
      
      input.type=type; 
      input.classList.toggle('hidden',!visible);
      
      if (visible && filterType!=='all') {
          // Mantieni il valore se il tipo di filtro non √® cambiato, altrimenti usa il default
          input.value = filterType === reportFilters.filterType ? reportFilters.filterDateStr : def;
      } else {
          // Se il filtro √® 'all', lo stato deve rifletterlo
          reportFilters.filterDateStr = 'all';
      }
      
      renderPage('report');
    }
    
    function calculateNextRecurrence(lastDateStr, frequency, targetDate = new Date()) {
        let dateToStartFrom = new Date(lastDateStr);
        const originalDay = dateToStartFrom.getDate();
        const today = new Date(); 
        today.setHours(0,0,0,0);

        let currentMonth = dateToStartFrom.getMonth();
        let currentYear = dateToStartFrom.getFullYear();
        
        let nextRecurrence = new Date(currentYear, currentMonth, originalDay); 

        // Se l'ultima data registrata √® oggi o √® gi√† passata, passa al ciclo successivo
        while (nextRecurrence <= dateToStartFrom) {
            if (frequency === 'monthly') {
                currentMonth += 1;
            } else if (frequency === 'quarterly') {
                currentMonth += 3;
            } else if (frequency === 'annual') {
                currentYear += 1;
            } else {
                return null; // Frequenza non riconosciuta
            }
            nextRecurrence = new Date(currentYear, currentMonth, originalDay);
        }
        
        // Regola il giorno se il mese non lo supporta (es. 31/02)
        if (nextRecurrence.getDate() !== originalDay) {
            nextRecurrence = new Date(nextRecurrence.getFullYear(), nextRecurrence.getMonth(), 0); 
        }

        // Simula la ricorrenza in avanti fino a raggiungere o superare la data odierna
        // e comunque non pi√π di un anno nel futuro
        let counter = 0;
        const limitDate = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());

        while (nextRecurrence < today || nextRecurrence >= limitDate) {
            if (nextRecurrence >= limitDate) return null; // Troppo lontano nel futuro

            if (nextRecurrence < today) {
                if (frequency === 'monthly') currentMonth += 1;
                else if (frequency === 'quarterly') currentMonth += 3;
                else if (frequency === 'annual') currentYear += 1;
                
                nextRecurrence = new Date(currentYear, currentMonth, originalDay);
                 if (nextRecurrence.getDate() !== originalDay) {
                    nextRecurrence = new Date(nextRecurrence.getFullYear(), nextRecurrence.getMonth(), 0);
                }
            }
            counter++;
            if (counter > 15) return null; // Evita loop infiniti
        }
        
        return nextRecurrence.toISOString().slice(0, 10);
    }


    function renderRemindersPage(){
      const symbol = getCurrencySymbol();
      const list = appData.reminders||[];
      const birthdays = appData.birthdays||[];
      const recurring = appData.recurringExpenses||[];
      const today = new Date(); today.setHours(0,0,0,0);
      
      const sortedReminders = list.slice().sort((a,b)=> new Date(a.date)-new Date(b.date));
      const upcomingReminders = sortedReminders.filter(r=> !r.paid && new Date(r.date)>=today);
      const paidReminders = sortedReminders.filter(r=> r.paid);
      const overdueReminders = sortedReminders.filter(r=> {
        const rDate = new Date(r.date); rDate.setHours(0,0,0,0);
        return !r.paid && rDate < today;
      });
      
      const predictedRecurrences = recurring
          .map(r => {
              const nextDateStr = calculateNextRecurrence(r.lastDate, r.frequency);
              if (!nextDateStr) return null;
              
              const nextDate = new Date(nextDateStr);
              const diffDays = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
              
              if (diffDays > 90 || diffDays < 0) return null; 
              
              return {
                  ...r, nextDate: nextDateStr, status: `Previsto in ${diffDays} giorni`, amount: r.lastAmount
              };
          })
          .filter(r => r !== null)
          .sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));
      
      const types = FISCAL_REMINDER_TYPES;
      
      const getBirthdayInfo = (bd) => {
        const bdDate = new Date(bd.date);
        const currentYear = new Date().getFullYear();
        
        let recurrence = new Date(`${currentYear}-${bd.recurringDate}`);
        if (recurrence < today) {
            recurrence = new Date(`${currentYear + 1}-${bd.recurringDate}`);
        }
        
        let age = currentYear - bdDate.getFullYear();
        if (new Date(`${currentYear}-${bd.recurringDate}`).getTime() > today.getTime()) {
            age -= 1; 
        }
        
        const diffDays = Math.ceil((recurrence - today) / (1000 * 60 * 60 * 24));
        const status = diffDays === 0 ? 'Oggi!' : (diffDays > 0 && diffDays <= 7 ? `In ${diffDays} giorni` : `Mancano ${diffDays} giorni`);

        return {
            ...bd, recurrenceDate: recurrence,
            displayDate: new Date(`${bd.date}`).toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' }),
            annualDate: new Date(`${bd.date}`).toLocaleDateString('it-IT', { day: 'numeric', month: 'long' }),
            age: age >= 0 ? age : 'N/A', status: status
        };
      };

      const sortedBirthdays = birthdays.map(getBirthdayInfo).sort((a, b) => a.recurrenceDate - b.recurrenceDate);
      
      const pill = (r)=>{
        if (r.paid) return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300';
        const rDate = new Date(r.date); rDate.setHours(0,0,0,0);
        const diff = (rDate-today)/(1000*60*60*24);
        if (diff<0) return 'bg-red-100 text-red-700 font-bold dark:bg-red-900 dark:text-red-300';
        if (diff<=30) return 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300';
        return 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300';
      };
      
      const reminderSection = (list,title, type='payment')=>`
        <h3 class="text-xl font-medium mb-3 border-b pb-1 text-gray-700 dark:text-gray-300 mt-6">${title} (${list.length})</h3>
        <div class="space-y-3">
          ${list.length? list.map(r=>`
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card flex justify-between items-center">
              <div class="flex-grow">
                ${type === 'payment' ? `<span class="text-xs font-semibold px-2 py-1 rounded-full ${pill(r)}">${r.paid?'PAGATO':r.type}</span>` : type === 'recurring' ? `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300">PREVISTO (${r.frequency.toUpperCase().slice(0,1)})</span>` : ''}
                
                <p class="font-bold mt-1 ${r.paid?'line-through text-gray-500':'text-gray-800 dark:text-gray-200'}">${type === 'payment' ? r.description : r.name || r.description}</p>
                
                ${type === 'payment' ? 
                    `<p class="text-sm text-gray-600 dark:text-gray-400">Scadenza: ${new Date(r.date).toLocaleDateString('it-IT')} | Importo: ${r.amount.toFixed(2)} ${symbol}</p>` :
                type === 'recurring' ?
                    `<p class="text-sm text-gray-600 dark:text-gray-400">Previsto il: ${new Date(r.nextDate).toLocaleDateString('it-IT')} | Est: ${r.amount.toFixed(2)} ${symbol} | ${r.status}</p>` :
                    `<p class="text-sm text-gray-600 dark:text-gray-400">Ricorre il: ${r.annualDate} | Et√† Proiettata: ${r.age} | ${r.status}</p>`}
              </div>
              <div class="flex space-x-2">
                ${r.isFiscal && !r.paid && r.type.startsWith('IVA') && appData.fiscalParams.regime === 'forfettario' ? 
                    `<button onclick="markTaxPaid(${r.id}, ${Math.abs(r.amount)})" class="text-sm px-3 py-1 rounded-lg bg-red-600 hover:bg-red-700 text-white">Paga (Accant.)</button>` : 
                    (type === 'payment' && !r.isFiscal ? 
                    `<button onclick="toggleReminderPaid(${r.id})" class="text-sm px-3 py-1 rounded-lg ${r.paid?'bg-orange-500 hover:bg-orange-600':'bg-emerald-500 hover:bg-emerald-600'} text-white">${r.paid?'Annulla Pag.':'Paga'}</button>` : '')}
                <button onclick="${type === 'payment' ? `deleteReminder(${r.id})` : (type === 'birthday' ? `deleteBirthday(${r.id})` : `showToast('Non eliminabile da qui.', 'red')`)}" class="text-red-400 hover:text-red-600">üóëÔ∏è</button>
              </div>
            </div>
          `).join(''):'<p class="text-gray-500">Nessun promemoria in questa categoria.</p>'}
        </div>
      `;
      
      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-semibold border-b pb-2 text-gray-700 dark:text-gray-300">Promemoria Scadenze & Eventi</h2>
          
          ${reminderSection(sortedBirthdays, 'Compleanni in Arrivo üéÇ', 'birthday')}
          
          ${reminderSection(predictedRecurrences, 'Spese Ricorrenti Previste (90gg) üîÆ', 'recurring')}

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card mt-6">
              <h3 class="text-xl font-medium mb-4 text-pink-600">Aggiungi Compleanno üéÇ</h3>
              <form id="birthday-form" onsubmit="event.preventDefault(); handleBirthdaySubmit();" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome</label>
                  <input id="birthday-name" name="name" required placeholder="Es. Mario Rossi" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data di Nascita (Anno opzionale)</label>
                  <input type="date" id="birthday-date" name="date" value="${new Date().toISOString().slice(0,10)}" required class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                </div>
                <button type="submit" class="cta-button w-full bg-pink-500 text-white p-3 rounded-lg font-bold hover:bg-pink-600">Aggiungi Compleanno</button>
              </form>
            </div>

            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card mt-6">
              <h3 class="text-xl font-medium mb-4 text-emerald-600">Aggiungi Nuovo Promemoria (Pagamento)</h3>
              <form id="reminder-form" onsubmit="event.preventDefault(); handleReminderSubmit();" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo Scadenza</label>
                  <select id="reminder-type" name="type" required class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                    ${types.map(t=>`<option value="${t}">${t}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrizione</label>
                  <input id="reminder-description" name="description" required placeholder="Es. TARI 2¬∞ Rata" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Scadenza</label>
                    <input type="date" id="reminder-date" name="date" value="${new Date().toISOString().slice(0,10)}" required class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Importo (${symbol})</label>
                    <input type="number" id="reminder-amount" name="amount" step="0.01" placeholder="500.00" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700" required>
                  </div>
                </div>
                <button type="submit" class="cta-button w-full bg-emerald-500 text-white p-3 rounded-lg font-bold hover:bg-emerald-600">Aggiungi Promemoria</button>
              </form>
            </div>
          </div>


          ${reminderSection(overdueReminders,'Scaduti (Urgenti) üö®', 'payment')}
          ${reminderSection(upcomingReminders,'In Arrivo üìÖ', 'payment')}
          ${reminderSection(paidReminders,'Pagati ‚úÖ', 'payment')}
        </div>
      `;
    }

    function getLocalStorageSize() {
        let total = 0;
        for(let i=0; i<localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            total += key.length + value.length;
        }
        // Converti in MB e arrotonda
        return (total / (1024 * 1024)).toFixed(2);
    }


    function renderSettingsPage(){
      const currentYear=new Date().getFullYear();
      const years=[...new Set([...appData.invoices,...appData.expenses].map(t=> new Date(t.date).getFullYear()))].sort((a,b)=>b-a).filter(y=>y<currentYear);
      const allContacts = appData.contacts.slice().sort((a,b)=>a.name.localeCompare(b.name));
      const cats = (appData.categories||DEFAULT_CATEGORIES).slice().sort((a,b)=>a.localeCompare(b));
      const symbol = getCurrencySymbol();
      const currentFiscal = appData.fiscalParams;
      const currentBankBalance = appData.currentBankBalance || 0;
      
      // *** RESILIENZA: Dati di Diagnostica ***
      const storageSize = getLocalStorageSize();
      const storageColor = storageSize > 4 ? 'text-red-500' : (storageSize > 2 ? 'text-orange-500' : 'text-emerald-500');
      const dataChecksumStatus = localStorage.getItem(`${globalState.currentUser.dataKey}_checksum`) === appData.dataChecksum ? '‚úÖ Congruo' : '‚ö†Ô∏è Non Congruo (Rischio)';


      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-semibold border-b pb-2 text-gray-700 dark:text-gray-300">Gestione e Manutenzione Dati (${globalState.currentUser.name})</h2>
          
          <div class="bg-yellow-50 dark:bg-yellow-900/50 p-5 rounded-xl card space-y-3 border-l-4 border-yellow-600">
            <h3 class="text-xl font-medium text-yellow-700 dark:text-yellow-300">Diagnostica Dati (Stabilit√†)</h3>
            <p class="text-sm text-gray-700 dark:text-gray-300">
                **Archiviazione Locale:** <span class="${storageColor}">${storageSize} MB</span>. (Limite iOS/Browser ~5-10MB. >4MB = Rischio)
            </p>
            <p class="text-sm text-gray-700 dark:text-gray-300">
                **Integrit√† Dati (Checksum):** <span class="font-bold">${dataChecksumStatus}</span>
            </p>
            <p class="text-xs text-gray-500">Se il valore di Archiviazione √® in rosso, esegui subito un backup JSON e la pulizia dei dati vecchi.</p>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-4">
            <h3 class="text-xl font-medium text-orange-600">Parametri Fiscali (Simulazione)</h3>
            <p class="text-sm text-gray-700 dark:text-gray-300">Questi parametri influenzano il calcolo delle Tasse in Attivit√†. I valori sono in percentuali (%).</p>

            <div>
                <label for="fiscal-regime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Regime Fiscale</label>
                <select id="fiscal-regime" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
                    <option value="forfettario" ${currentFiscal.regime==='forfettario'?'selected':''}>Forfettario (Flat Tax / Coeff. Redditivit√†)</option>
                    <option value="ordinario" ${currentFiscal.regime==='ordinario'?'selected':''}>Ordinario (IRPEF a Scaglioni / Costi Deducibili)</option>
                </select>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label for="fiscal-profit-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Coeff. Redditivit√† (%)</label>
                    <input type="number" id="fiscal-profit-rate" step="1" min="1" max="100" value="${(currentFiscal.profitRate * 100).toFixed(0)}" 
                           class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 text-right"/>
                </div>
                <div>
                    <label for="fiscal-tax-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Aliquota Fiscale (%)</label>
                    <input type="number" id="fiscal-tax-rate" step="0.1" min="0" max="50" value="${(currentFiscal.taxRate * 100).toFixed(1)}" 
                           class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 text-right"/>
                </div>
                <div>
                    <label for="fiscal-inps-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Aliquota INPS (%)</label>
                    <input type="number" id="fiscal-inps-rate" step="0.1" min="0" max="50" value="${(currentFiscal.inpsRate * 100).toFixed(1)}" 
                           class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 text-right"/>
                </div>
            </div>
            <button onclick="saveFiscalParams()" class="cta-button w-full bg-orange-500 text-white p-3 rounded-lg font-bold hover:bg-orange-600">Salva Parametri Fiscali</button>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-4">
              <h3 class="text-xl font-medium text-blue-600">Configurazione Liquidit√† & Valuta</h3>
              
              <div class="border-b pb-4 mb-4">
                  <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">Simbolo Valuta Attuale: <span class="font-bold text-lg">${symbol}</span></p>
                  <div>
                      <label for="currency-symbol-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Imposta Simbolo Valuta (es. ‚Ç¨, $, ¬£)</label>
                      <input type="text" id="currency-symbol-input" maxlength="2" value="${symbol}" placeholder="‚Ç¨" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700"/>
                  </div>
                  <button onclick="changeCurrencySymbol()" class="cta-button w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 mt-3">Salva Valuta</button>
              </div>

              <div>
                  <label for="current-bank-balance" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Saldo Conto Iniziale (Bank Balance Base, ${symbol})</label>
                  <p class="text-xs text-gray-500 mb-1">Questo √® il saldo base all'inizio delle registrazioni. Le transazioni si sommano a questo.</p>
                  <input type="number" id="current-bank-balance" step="0.01" value="${currentBankBalance.toFixed(2)}"
                         class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700" 
                         inputmode="decimal"/>
              </div>
              <button onclick="saveBankBalance()" class="cta-button w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">Aggiorna Saldo Base</button>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-4">
            <h3 class="text-xl font-medium text-purple-600">Pianificazione (Obiettivi/Budgeting)</h3>
            
            <div>
              <label for="monthly-target" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Obiettivo Saldo Netto Mensile (${symbol})</label>
              <input type="number" id="monthly-target" step="0.01" min="0" value="${appData.monthlySavingsTarget.toFixed(2)}"
                     class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700" 
                     inputmode="decimal"/>
            </div>
            <button onclick="saveMonthlyTarget()" class="cta-button w-full bg-purple-500 text-white p-3 rounded-lg font-bold hover:bg-purple-600">Salva Obiettivo Netto</button>
            
            <h4 class="text-lg font-semibold border-t pt-3 mt-3 text-gray-700 dark:text-gray-300">Budget Spesa per Categoria (Mensile)</h4>
            <div class="space-y-2">
                ${cats.map(cat => {
                    const currentBudget = (appData.categoryBudgets[cat] || 0).toFixed(2);
                    const inputId = `budget-${cat.replace(/\s/g, '_').replace(/[^\w-]/g, '')}_input`;
                    return `
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium w-28">${getCategoryIcon(cat)} ${cat}</span>
                            <input type="number" id="${inputId}" step="0.01" min="0" placeholder="0.00" value="${currentBudget}"
                                   class="p-2 border rounded-lg flex-1 dark:bg-gray-900 dark:border-gray-700 text-right" inputmode="decimal"/>
                            <button class="px-3 py-2 bg-emerald-500 text-white rounded-lg text-sm" 
                                    onclick="saveCategoryBudget('${cat}', document.getElementById('${inputId}').value)">
                                Imposta
                            </button>
                        </div>
                    `;
                }).join('')}
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-4">
            <h3 class="text-xl font-medium text-emerald-600">Fornitori / Clienti Salvati (${allContacts.length})</h3>
            <div class="max-h-60 overflow-y-auto border dark:border-gray-700 p-3 rounded-lg bg-gray-50 dark:bg-gray-900">
              ${allContacts.length? allContacts.map(c=>`
                <div class="flex justify-between items-center py-2 border-b dark:border-gray-700 last:border-b-0">
                  <div class="flex-grow">
                    <span class="font-semibold text-sm">${c.name}</span>
                    <span class="text-xs ml-2 px-2 py-0.5 rounded-full ${c.scope==='activity'?'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300':'bg-pink-100 text-pink-700 dark:bg-pink-900 dark:text-pink-300'}">
                      ${c.scope==='activity'?'Attivit√†':'Personale'}
                    </span>
                  </div>
                  <button onclick="deleteContact(${c.id})" class="text-red-400 hover:text-red-600">üóëÔ∏è</button>
                </div>
              `).join('') : '<p class="text-gray-500 text-sm">Nessun contatto salvato.</p>'}
            </div>
             <button onclick="deleteUnusedContacts()" class="cta-button w-full bg-gray-400 text-white p-3 rounded-lg font-bold hover:bg-gray-500">Pulisci Contatti Non Usati</button>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-3">
            <h3 class="text-lg font-semibold">Categorie (${cats.length})</h3>
            <div class="flex items-center space-x-2">
              <input id="new-cat" placeholder="Nuova categoria" class="p-2 border rounded-lg flex-1 dark:bg-gray-900 dark:border-gray-700">
              <button class="px-3 py-2 bg-emerald-500 text-white rounded-lg" onclick="(function(){const v=document.getElementById('new-cat').value.trim(); if(!v) return; ensureCategory(v); showToast('Categoria aggiunta!'); renderPage('settings');})()">Aggiungi</button>
            </div>
            <div class="text-sm text-gray-500">Usate nell‚Äôautocomplete del form. Icona: ${getCategoryIcon('Altro')}</div>
            <div class="flex flex-wrap gap-2 mt-2">
              ${cats.map(c=>`<span class="px-2 py-1 rounded-full bg-gray-100 text-gray-700 border dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">${getCategoryIcon(c)} ${c}</span>`).join('')}
            </div>
             <button onclick="deleteUnusedCategories()" class="cta-button w-full bg-gray-400 text-white p-3 rounded-lg font-bold hover:bg-gray-500">Pulisci Categorie Non Usate</button>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-4">
            <h3 class="text-xl font-medium text-purple-600">Gestione Sicurezza (PIN)</h3>
            <p class="text-sm text-gray-700 dark:text-gray-300">PIN Attuale HASH: <span class="font-bold">${appData.pinHash.slice(0, 8)}...</span></p>
            <div>
              <label for="current-pin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">PIN Attuale (Conferma)</label>
              <input type="password" id="current-pin" maxlength="4" placeholder="Inserisci PIN Attuale" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 mb-2"/>
            </div>
            <div>
              <label for="new-pin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Imposta Nuovo PIN (4 cifre)</label>
              <input type="password" id="new-pin" maxlength="4" placeholder="Nuovo PIN (4 cifre)" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700"/>
            </div>
            <button onclick="changePin()" class="cta-button w-full bg-purple-500 text-white p-3 rounded-lg font-bold hover:bg-purple-600">Cambia PIN</button>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-4">
            <h3 class="text-xl font-medium text-indigo-600">Importa / Esporta Dati</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <button onclick="exportCSV('income')" class="cta-button w-full bg-emerald-500 text-white p-3 rounded-lg font-bold hover:bg-emerald-600">Esporta SOLO Entrate</button>
              <button onclick="exportCSV('expense')" class="cta-button w-full bg-red-500 text-white p-3 rounded-lg font-bold hover:bg-red-600">Esporta SOLO Uscite</button>
              <button onclick="exportCSV('all')" class="cta-button w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">Esporta TUTTO (CSV)</button>
            </div>
            <button onclick="exportDataJSON()" class="cta-button w-full bg-indigo-500 text-white p-3 rounded-lg font-bold hover:bg-indigo-600">Esporta Backup (JSON Completo)</button>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-2">Importa Backup (.json)</label>
            <input type="file" id="import-file" accept=".json" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-indigo-900 dark:file:text-indigo-300 dark:hover:file:bg-indigo-800"/>
            <p class="text-xs text-red-500 mt-1">Attenzione: sovrascrive i dati attuali.</p>
          </div>

          <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-4">
            <h3 class="text-xl font-medium text-red-600">Pulisci Dati Vecchi</h3>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Elimina i dati precedenti al:</label>
            <select id="clean-year" class="w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700">
              <option value="0">-- Seleziona Anno --</option>
              ${years.map(y=>`<option value="${y+1}">1 Gennaio ${y+1} (Elimina ${y} e precedenti)</option>`).join('')}
            </select>
            <button id="clean-btn" class="cta-button w-full bg-red-500 text-white p-3 rounded-lg font-bold hover:bg-red-600">Conferma Pulizia</button>
          </div>

          <div class="bg-red-50 dark:bg-red-900/50 p-5 rounded-xl card space-y-4 border-l-4 border-red-600">
            <h3 class="text-xl font-medium text-red-600">Gestione Profilo Corrente</h3>
            <p class="text-sm text-red-700 dark:text-red-300">ATTENZIONE: Questa azione eliminer√† permanentemente l'intero profilo "${globalState.currentUser.name}" e i suoi dati dal dispositivo.</p>
            <button onclick="deleteCurrentUserProfile()" class="cta-button w-full bg-red-500 text-white p-3 rounded-lg font-bold hover:bg-red-600">Elimina Profilo "${globalState.currentUser.name}"</button>
          </div>
        </div>
      `;
    }

    function updateReportDateInput(){
      const filterType = document.getElementById('filter-type')?.value;
      const input = document.getElementById('filter-date');
      if (!input) return;

      let type='date', visible=true, def=new Date().toISOString().slice(0,10);
      switch(filterType){
        case 'year': 
          type='number'; input.min=2000; input.max=new Date().getFullYear(); def=new Date().getFullYear(); 
          break;
        case 'month': 
        case 'quarter': 
          type='month'; def=new Date().toISOString().slice(0,7); 
          break;
        case 'week': 
        case 'day': 
          type='date'; def=new Date().toISOString().slice(0,10); 
          break;
        default: 
          type='hidden'; visible=false; def='all';
      }
      
      input.type=type; 
      input.classList.toggle('hidden',!visible);
      
      if (visible && filterType!=='all') {
          // Mantieni il valore se il tipo di filtro non √® cambiato, altrimenti usa il default
          input.value = filterType === reportFilters.filterType ? reportFilters.filterDateStr : def;
      } else {
          // Se il filtro √® 'all', lo stato deve riflettere la data stringa corretta
          reportFilters.filterDateStr = 'all';
      }
      
      renderPage('report');
    }
    
    // Funzioni di supporto di Settings e Reminders (omesse qui per brevit√†, sono nella Parte 2 e Parte 3)
    // ...
    function saveMonthlyTarget() {
        const input = document.getElementById('monthly-target');
        const target = parseFloat(input?.value) || 0;

        showModal('Conferma Obiettivo', `Impostare l'obiettivo di risparmio su: ${target.toFixed(2)} ${getCurrencySymbol()}?`, true, () => {
            appData.monthlySavingsTarget = target;
            saveData();
            showToast('Obiettivo risparmio salvato!');
            renderPage('settings');
        });
    }

    function changeCurrencySymbol() {
        const symbolInput = document.getElementById('currency-symbol-input');
        const newSymbol = symbolInput?.value.trim() || '‚Ç¨';

        if (newSymbol.length > 2) {
            showToast('Il simbolo valuta dovrebbe essere al massimo di 2 caratteri.', 'red');
            return;
        }

        showModal('Conferma Valuta', `Impostare il simbolo valuta su: ${newSymbol}?`, true, () => {
            appData.currencySymbol = newSymbol;
            saveData();
            renderPage('settings');
            showToast('Simbolo Valuta aggiornato!');
        });
    }

    function saveBankBalance() {
        const balanceInput = document.getElementById('current-bank-balance');
        const newBalance = parseFloat(balanceInput?.value) || 0;

        showModal('Conferma Saldo Base', `Aggiornare il saldo base di cassa a: ${newBalance.toFixed(2)} ${getCurrencySymbol()}?`, true, () => {
            appData.currentBankBalance = newBalance;
            appData.taxCashReserve = 0; // Reset della cassa accantonamenti (misura di sicurezza)
            saveData();
            showToast('Saldo Base aggiornato! (Cassa Accantonamenti azzerata).');
            renderPage('settings');
        });
    }

    function saveFiscalParams() {
        const regime = document.getElementById('fiscal-regime').value;
        const profitRate = parseFloat(document.getElementById('fiscal-profit-rate').value) / 100;
        const taxRate = parseFloat(document.getElementById('fiscal-tax-rate').value) / 100;
        const inpsRate = parseFloat(document.getElementById('fiscal-inps-rate').value) / 100;

        if (regime === 'forfettario' && (profitRate <= 0 || profitRate > 1 || taxRate < 0 || taxRate > 0.5)) {
            showToast('Valori per Forfettario non validi (Profit 1-100%, Tax 0-50%).', 'red');
            return;
        }
        
        showModal('Conferma Parametri Fiscali', `Sei sicuro di voler aggiornare i parametri fiscali? Questo influenzer√† le future simulazioni.`, true, () => {
            appData.fiscalParams = {
                regime,
                profitRate: regime === 'forfettario' ? profitRate : DEFAULT_FISCAL_PARAMS.profitRate,
                taxRate: regime === 'forfettario' ? taxRate : DEFAULT_FISCAL_PARAMS.taxRate,
                inpsRate
            };
            saveData();
            showToast('Parametri Fiscali salvati!');
            renderPage('settings');
        });
    }

    function saveCategoryBudget(category, amountStr) {
        const amount = parseFloat(amountStr) || 0;

        showModal('Conferma Budget', `Impostare il budget per "${category}" a ${amount.toFixed(2)} ${getCurrencySymbol()}?`, true, () => {
            appData.categoryBudgets[category] = amount;
            saveData();
            showToast(`Budget per ${category} salvato!`);
            renderPage('settings');
        });
    }


    function changePin() {
      const currentPinInput = document.getElementById('current-pin');
      const newPinInput = document.getElementById('new-pin');
      
      const currentPin = currentPinInput?.value.trim();
      const newPin = newPinInput?.value.trim();
      
      const expectedHash = appData.pinHash;
      const enteredHash = hashPin(currentPin);
      
      if (enteredHash !== expectedHash) {
        showToast('Il PIN attuale non √® corretto.','red');
        currentPinInput.value = '';
        return;
      }

      if (!newPin || newPin.length !== 4 || isNaN(newPin)) {
        showToast('Il nuovo PIN deve essere esattamente di 4 cifre.','red');
        return;
      }
      
      const newPinHash = hashPin(newPin);

      showModal('Conferma Cambio PIN', `Sei sicuro di voler cambiare il PIN?`, true, () => {
        appData.pinHash = newPinHash;
        
        // Aggiorna l'hash PIN anche nel Global State
        const user = globalState.currentUser;
        if (user) {
             const userIndex = globalState.users.findIndex(u => u.dataKey === user.dataKey);
             if (userIndex > -1) {
                globalState.users[userIndex].pinHash = newPinHash;
                saveGlobalState(); 
             }
        }

        saveData();
        currentPinInput.value = '';
        newPinInput.value = '';
        showToast('PIN modificato con successo! Sar√† richiesto al prossimo riavvio.');
        renderPage('settings');
      });
    }
    
    function deleteCurrentUserProfile() {
        showModal('üö® ELIMINAZIONE PROFILO CRITICA', 
            `Sei assolutamente sicuro di voler eliminare il profilo "${globalState.currentUser.name}"? Tutti i dati (transazioni, promemoria, impostazioni) saranno persi permanentemente dal dispositivo.`, 
            true, 
            () => {
                const userKey = globalState.currentUser.dataKey;
                const userIndex = globalState.users.findIndex(u => u.dataKey === userKey);
                
                // 1. Rimuovi i dati locali
                localStorage.removeItem(userKey);
                localStorage.removeItem(`${userKey}_checksum`);
                
                // 2. Rimuovi l'utente dal Global State
                if (userIndex > -1) {
                    globalState.users.splice(userIndex, 1);
                }
                
                // 3. Imposta un nuovo utente corrente (il primo rimasto)
                if (globalState.users.length > 0) {
                    globalState.currentUser = globalState.users[0];
                    sessionStorage.removeItem(SESSION_STORAGE_PIN_KEY);
                    saveGlobalState();
                    loadData();
                    setupPinLock();
                    showToast(`Profilo "${userKey.replace('smartFinApp_data_', '')}" eliminato. Caricato il prossimo profilo.`, 'red');
                } else {
                    // Se non ci sono pi√π utenti, resetta tutto
                    localStorage.removeItem(GLOBAL_KEY);
                    window.location.reload(); 
                }
            }, 
            () => showToast('Eliminazione annullata.')
        );
    }
    

    function checkReminders(){
      const today=new Date();
      
      (appData.reminders||[]).forEach(r=>{
        const diff=(new Date(r.date)-today)/(1000*60*60*24);
        if (!r.paid && diff>=0 && diff<=3){
          if (Notification.permission==='granted'){
            new Notification(`üîî Scadenza: ${r.type}`, { body:`${r.description} - Scade il ${new Date(r.date).toLocaleDateString('it-IT')}` });
          }
        }
      });
      
      const currentMonthDay = today.toISOString().slice(5, 10);
      (appData.birthdays||[]).forEach(bd => {
        const bdMonthDay = bd.recurringDate; 
        const bdDate = new Date(bd.date);
        
        let recurrence = new Date(`${today.getFullYear()}-${bdMonthDay}`);
        
        const diffDays = Math.ceil((recurrence - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays >= 0 && diffDays <= 7) {
            let age = today.getFullYear() - bdDate.getFullYear();
            if (new Date(`${today.getFullYear()}-${bdMonthDay}`) > today) age -= 1;
            
            if (Notification.permission === 'granted') {
                new Notification(`üéÇ Compleanno di ${bd.name}`, { body: diffDays === 0 ? `Compie ${age} anni oggi!` : `Compie ${age} anni in ${diffDays} giorni.` });
            }
        }
      });
      
      // *** RESILIENZA: Check Saldo Cassa Accantonamenti ***
      if (appData.taxCashReserve < 0) {
           showToast(`ATTENZIONE: Cassa Tasse/INPS √® in deficit di ${Math.abs(appData.taxCashReserve).toFixed(2)} ${getCurrencySymbol()}. Rivedi gli accantonamenti fiscali!`, 'red');
      }
    }


    // --- Page router ---
    function renderPage(pageId){
      currentPage = pageId;
      renderNavbar();
      const area=document.getElementById('content-area');
      const qa=document.getElementById('quick-actions');

      if (pageId==='activity'||pageId==='personal'){ 
        qa.classList.remove('hidden'); 
        qa.classList.add('flex','justify-center'); 
      }
      else { 
        qa.classList.add('hidden'); 
        qa.classList.remove('flex','justify-center'); 
      }

      document.getElementById('transaction-form')?.removeAttribute('data-transaction-id');
      
      if (!sessionStorage.getItem(SESSION_STORAGE_PIN_KEY)) {
          setupPinLock();
          return;
      }
      
      // Ricalcola i KPI che non dipendono da filtri di periodo (usa la cache)
      computeKPIs(); 
      calculateFinancialHealthScore();

      switch(pageId){
        case 'activity':
        case 'personal':
          area.innerHTML = renderActivityOrPersonalPage(pageId);
          renderWeeklyBalanceChart(pageId);
          clearTimeout(simulationTimer);
          break;
        case 'report':
          loadReportFilters();
          area.innerHTML = renderReportPage();
          updateReportDateInput(); 
          
          renderTrendChart();
          // Correzione Filtro Ricerca
          const searchInput = document.getElementById('search');
          if (searchInput) searchInput.value = reportFilters.searchQuery;
          searchInput?.removeEventListener('input', handleReportSearchInput);
          searchInput?.addEventListener('input', handleReportSearchInput);
          
          // Esegue un update iniziale del dettaglio per assicurarsi che i dati visualizzati siano aggiornati
          updateReportDetail(reportFilters.searchQuery);
          break;
        case 'reminders':
          area.innerHTML = renderRemindersPage();
          break;
        case 'settings':
          area.innerHTML = renderSettingsPage();
          document.getElementById('import-file')?.addEventListener('change', importDataFile);
          document.getElementById('clean-btn')?.addEventListener('click', ()=> cleanDataByYear(document.getElementById('clean-year').value));
          break;
      }
    }
    
    // *** CORREZIONE PERF. FILTRO: Funzione per gestire l'input di ricerca in Report ***
    function handleReportSearchInput(e) {
        const query = e.target.value;
        reportFilters.searchQuery = query; 
        // Invece di chiamare renderPage (che √® pesante), aggiorniamo solo il Dettaglio
        updateReportDetail(query);
        // Salviamo lo stato subito dopo l'aggiornamento
        saveReportFilters();
    }
    
    // --- PWA ---
    function installManifest(){
      const manifest = {
        name: "Finanza Smart PRO",
        short_name: "FinanzaPRO",
        start_url: ".",
        display: "standalone",
        background_color: "#0f172a",
        theme_color: "#10b981",
        icons: [
          { src:"https://fav.farm/‚úÖ", sizes:"192x192", type:"image/png" },
          { src:"https://fav.farm/üí∂", sizes:"512x512", type:"image/png" }
        ],
        shortcuts: [
            {
                name: "Registra Entrata", short_name: "Entrata",
                description: "Apri il modulo rapido per registrare un'entrata.", url: "/?shortcut=income"
            },
            {
                name: "Registra Uscita", short_name: "Uscita",
                description: "Apri il modulo rapido per registrare un'uscita.", url: "/?shortcut=expense"
            },
            {
                name: "Riepilogo", short_name: "Riepilogo",
                description: "Visualizza il report finanziario.", url: "/?shortcut=report"
            }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      document.getElementById('dynamic-manifest').setAttribute('href', url);
    }

    async function installServiceWorker(){
      if (!('serviceWorker' in navigator)) return;
      // Aggiornamento della cache per Enterprise-Level
      const SW_CACHE_NAME = 'finanza-smart-v7-enterprise'; 
      const swCode = `
        const CACHE = '${SW_CACHE_NAME}'; 
        self.addEventListener('install', e=>{
          // Pre-cache l'index
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
          self.skipWaiting();
        });
        self.addEventListener('activate', e=>{
          // Pulisce le vecchie cache
          e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=> k===CACHE?null:caches.delete(k)))));
          self.clients.claim();
        });
        self.addEventListener('fetch', e=>{
          const req = e.request;
          // Strategia Cache-First, con fallback a Network, poi aggiornamento della cache
          e.respondWith(
            caches.match(req).then(res=> res || fetch(req).then(fr=>{
              const copy = fr.clone();
              // Non cacheare file esterni o API di terze parti
              if (req.url.startsWith(self.location.origin)) {
                caches.open(CACHE).then(c=> c.put(req, copy)).catch(()=>{});
              }
              return fr;
            }).catch(()=>res)) // Se la rete fallisce, restituisci comunque la cache se presente
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      try{ await navigator.serviceWorker.register(url); }catch(e){ console.warn('SW register failed',e); }
    }

    // --- Init ---
    window.onload = function(){
      applySavedTheme();
      document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);

      loadData();
      
      setupPinLock();

      // --- PERMANENT LISTENERS (Event Delegation) ---

      document.getElementById('app')?.addEventListener('input', (e)=>{
        if (e.target && (e.target.id==='net-amount' || e.target.id==='vat-rate') && document.getElementById('transaction-form-modal').style.display === 'flex') calculateGross();
        
      });
      document.getElementById('app')?.addEventListener('change', (e)=>{
        if (e.target && e.target.id==='vat-rate' && document.getElementById('transaction-form-modal').style.display === 'flex') calculateGross();
      });

      const appContainer = document.getElementById('app');
      appContainer?.addEventListener('change', (e) => {
          if (currentPage === 'report') {
              // Quando cambiano i filtri principali (che richiedono un ricaricamento totale della pagina)
              if (e.target.id === 'report-type' || e.target.id === 'filter-category' || e.target.id === 'filter-tag' || e.target.id === 'sort-key' || e.target.id === 'sort-direction') {
                  const searchInput = document.getElementById('search');
                  if (searchInput) reportFilters.searchQuery = searchInput.value;
                  renderPage('report');
              }
          }
      });
      appContainer?.addEventListener('input', (e) => {
          if (currentPage === 'report') {
              if (e.target.id === 'filter-date') {
                  // Salviamo la data e ricarichiamo (perch√© i tipi di input sono diversi: date/month/number)
                  reportFilters.filterDateStr = e.target.value;
                  if (e.target.type === 'number' || e.target.type === 'month' || e.target.type === 'date') renderPage('report');
              }
          }
      });
      
      document.addEventListener('keydown', (e) => {
          if (document.getElementById('pin-lock-modal').style.display !== 'none') return;
          
          if (currentPage === 'activity' || currentPage === 'personal') {
              
              if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && document.getElementById('transaction-form-modal').style.display === 'flex') {
                  const form = document.getElementById('transaction-form');
                  if (form && form.querySelector('button[type="submit"]') && e.target.id!=='description') {
                      e.preventDefault();
                      form.querySelector('button[type="submit"]').click();
                      return;
                  }
              }
              
              // Evita di attivare scorciatoie se siamo in un campo di input
              if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                  return;
              }

              if (e.key === 'i' || e.key === 'I') {
                  e.preventDefault();
                  openTransactionForm('true');
              } else if (e.key === 'e' || e.key === 'E') {
                  e.preventDefault();
                  openTransactionForm('false');
              }
          }
      });
      
      // Chiede il permesso per le notifiche (per i promemoria fiscali)
      if (Notification.permission!=='granted') Notification.requestPermission();
      // Controlla i promemoria ogni ora
      setInterval(checkReminders, 60*60*1000); 
      
      installManifest();
      installServiceWorker();
      
      // Gestione degli Shortcut PWA
      const urlParams = new URLSearchParams(window.location.search);
      const shortcut = urlParams.get('shortcut');
      if (shortcut) {
          if (shortcut === 'income') openTransactionForm('true');
          else if (shortcut === 'expense') openTransactionForm('false');
          else if (shortcut === 'report') renderPage('report');
      }
    };
  </script>
</body>
</html>
