<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Contabilità - Dark + CSV + PDF</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- html2canvas + jsPDF per Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root { --bg:#0E1320; --card:#1E253B; --muted:#94a3b8; }
    body { background-color: var(--bg); color:#fff; }
    .card { background-color: var(--card); border-radius: 12px; padding: 16px; }
    .btn { background:#6366f1; padding:10px 14px; border-radius:8px; font-size:14px; }
    .btn:hover { background:#818cf8; }
    .btn-ghost { background:transparent; border:1px solid #475569; padding:10px 14px; border-radius:8px; }
    .ringCanvas { width:86px; height:86px; }
    /* KPI in orizzontale scrollabile su mobile */
    .kpi-scroll { display:flex; gap:12px; overflow-x:auto; padding-bottom:4px; }
    .kpi-scroll::-webkit-scrollbar { height:6px; }
    .kpi-scroll::-webkit-scrollbar-thumb { background:#334155; border-radius:6px; }
    /* Miglioramenti stampa per PDF */
    @media print { .no-print { display:none !important; } }
  </style>
</head>
<body class="p-4 md:p-6">

  <!-- Alert “spese > entrate” -->
  <div id="alertBox" class="hidden mb-4 p-3 rounded-lg border border-rose-500/30 bg-rose-500/10 text-rose-200">
    🔔 Attenzione: in questo periodo le <b>spese superano le entrate</b>. Valuta di ridurre i costi o rivedere il budget.
  </div>

  <!-- Barra superiore -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div>
      <h1 class="text-xl md:text-2xl font-bold text-indigo-300">📊 Dashboard Contabilità</h1>
      <p class="text-sm text-slate-400">Tema scuro • CSV locale • PDF export • Alert automatici</p>
    </div>
    <div class="flex flex-wrap items-center gap-2 no-print">
      <input type="file" id="fileInput" accept=".csv" class="hidden" />
      <button class="btn" onclick="document.getElementById('fileInput').click()">📂 Carica CSV</button>
      <button class="btn-ghost" onclick="clearSaved()">🧹 Svuota salvataggio</button>
      <button class="btn" onclick="exportPDF()">📄 Esporta PDF</button>
    </div>
  </div>

  <!-- Filtri -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
    <select id="yearSel" class="bg-[#1E253B] text-white px-3 py-2 rounded">
      <option>2024</option><option selected>2025</option><option>2026</option>
    </select>
    <select id="monthSel" class="bg-[#1E253B] text-white px-3 py-2 rounded">
      <option value="0">Gennaio</option><option value="1">Febbraio</option><option value="2">Marzo</option>
      <option value="3">Aprile</option><option value="4">Maggio</option><option value="5">Giugno</option>
      <option value="6">Luglio</option><option value="7" selected>Agosto</option><option value="8">Settembre</option>
      <option value="9">Ottobre</option><option value="10">Novembre</option><option value="11">Dicembre</option>
    </select>
    <select id="attivitaSel" class="bg-[#1E253B] text-white px-3 py-2 rounded">
      <option>Tutte</option><option>Negozio 1</option><option>Negozio 2</option><option>Negozio 3</option><option>Negozio 4</option>
    </select>
    <select id="contoSel" class="bg-[#1E253B] text-white px-3 py-2 rounded">
      <option>Tutti</option><option>Contanti</option><option>POS</option><option>Unicredit</option><option>Online</option>
    </select>
  </div>

  <!-- Contenitore da “fotografare” per il PDF -->
  <div id="report" class="space-y-4">

    <!-- KPI -->
    <div class="kpi-scroll">
      <div class="card min-w-[180px] text-center">
        <h3 class="text-green-400 font-bold text-sm mb-2">ENTRATE</h3>
        <canvas id="kpiEntrate" class="ringCanvas"></canvas>
        <div id="entrateVal" class="mt-2 text-lg font-bold">€0</div>
      </div>
      <div class="card min-w-[180px] text-center">
        <h3 class="text-red-400 font-bold text-sm mb-2">SPESE</h3>
        <canvas id="kpiSpese" class="ringCanvas"></canvas>
        <div id="speseVal" class="mt-2 text-lg font-bold">€0</div>
      </div>
      <div class="card min-w-[180px] text-center">
        <h3 class="text-yellow-400 font-bold text-sm mb-2">IVA</h3>
        <canvas id="kpiIva" class="ringCanvas"></canvas>
        <div id="ivaVal" class="mt-2 text-lg font-bold">€0</div>
      </div>
      <div class="card min-w-[180px] text-center">
        <h3 class="text-purple-400 font-bold text-sm mb-2">PROFITTO</h3>
        <canvas id="kpiProfitto" class="ringCanvas"></canvas>
        <div id="profittoVal" class="mt-2 text-lg font-bold">€0</div>
      </div>
      <div class="card min-w-[180px] text-center">
        <h3 class="text-cyan-400 font-bold text-sm mb-2">LIQUIDITÀ</h3>
        <div id="liquiditaVal" class="mt-10 text-lg font-bold">€0</div>
      </div>
    </div>

    <!-- Grafici -->
    <div class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold mb-3 text-indigo-300">Ripartizione mensile</h3>
        <canvas id="donutRip"></canvas>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-3 text-indigo-300">Entrate nette (trend)</h3>
        <canvas id="barEntrate"></canvas>
      </div>
    </div>

    <!-- Tabella -->
    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-indigo-300">Fatture programmate</h3>
        <span id="rowsCount" class="text-xs text-slate-400"></span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-indigo-300 border-b border-indigo-500/40">
              <th class="text-left py-2 pr-3">Data</th>
              <th class="text-left py-2 pr-3">Categoria</th>
              <th class="text-left py-2 pr-3">Conto</th>
              <th class="text-left py-2 pr-3">Attività</th>
              <th class="text-left py-2 pr-0">Importo</th>
            </tr>
          </thead>
          <tbody id="fattureTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer azioni -->
  <div class="mt-5 flex flex-wrap gap-2 no-print">
    <span class="text-xs text-slate-400">Suggerimento: su mobile scorri i KPI in orizzontale →</span>
  </div>

  <!-- SCRIPT -->
  <script>
    // ======== Stato / storage ========
    const STORAGE_KEY = 'sb_csv_data_v1';
    let data = [];               // dati grezzi (righe CSV)
    let donutChart, barChart;    // istanze Chart.js
    let ringCharts = {};         // { id: chartInstance }

    // ======== Utility ========
    const formatEUR = n => (isFinite(n) ? n : 0).toLocaleString('it-IT', { style:'currency', currency:'EUR' });
    const parseCSV = (text) => {
      // Parser semplice: split su righe e virgole; richiede CSV pulito (no virgolette con virgole interne)
      return text.trim().split('\n').slice(1).filter(Boolean).map(line => {
        const [Data, Tipo, Importo, IVA, Categoria, Conto, Attivita] = line.split(',');
        return { Data, Tipo, Importo: +Importo, IVA: +IVA, Categoria, Conto, Attivita };
      });
    };

    // ======== File handling / LocalStorage ========
    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const text = ev.target.result;
        localStorage.setItem(STORAGE_KEY, text);   // Salvataggio locale dell'intero CSV
        data = parseCSV(text);
        render();
      };
      reader.readAsText(file);
    });

    function clearSaved() {
      localStorage.removeItem(STORAGE_KEY);
      // ripristina dataset demo e ricarica
      loadInitialData();
    }

    // ======== Charts helpers ========
    function makeRing(id, value, max, color) {
      const el = document.getElementById(id).getContext('2d');
      if (ringCharts[id]) ringCharts[id].destroy();
      ringCharts[id] = new Chart(el, {
        type: 'doughnut',
        data: { datasets: [{ data: [Math.max(0,value), Math.max(0, max - value)], backgroundColor: [color, '#334155'] }] },
        options: { cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
      });
    }

    function drawDonut(vals) {
      const ctx = document.getElementById('donutRip');
      if (donutChart) donutChart.destroy();
      donutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Entrate', 'Spese', 'Profitto'],
          datasets: [{ data: vals, backgroundColor: ['#22c55e','#ef4444','#a855f7'] }]
        },
        options: {
          cutout: '60%',
          plugins: {
            legend: { labels: { color:'#e2e8f0' } },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatEUR(ctx.parsed)}` } }
          }
        }
      });
    }

    function drawBars(series) {
      const ctx = document.getElementById('barEntrate');
      if (barChart) barChart.destroy();
      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'],
          datasets: [{ data: series, backgroundColor:'#22c55e' }]
        },
        options: {
          plugins: { legend: { display:false } },
          scales: {
            x: { ticks: { color:'#e2e8f0' }, grid: { color:'#1f2937' } },
            y: { ticks: { color:'#e2e8f0' }, grid: { color:'#1f2937' } }
          }
        }
      });
    }

    // ======== Rendering principale ========
    function render() {
      const year = +document.getElementById('yearSel').value;
      const month = +document.getElementById('monthSel').value;
      const att = document.getElementById('attivitaSel').value;
      const conto = document.getElementById('contoSel').value;

      const filtered = data.filter(d => {
        const dt = new Date(d.Data);
        return dt.getFullYear() === year &&
               dt.getMonth() === month &&
               (att === 'Tutte' || d.Attivita === att) &&
               (conto === 'Tutti' || d.Conto === conto);
      });

      const entrate = filtered.filter(x => x.Tipo === 'entrata');
      const spese   = filtered.filter(x => x.Tipo === 'spesa');

      const totEntrate = entrate.reduce((s,x)=>s+x.Importo,0);
      const totSpese   = spese.reduce((s,x)=>s+x.Importo,0);
      const profitto   = totEntrate - totSpese;

      const ivaVendite  = entrate.reduce((s,d)=> s + (d.Importo - d.Importo/(1+d.IVA/100)), 0);
      const ivaAcquisti = spese.reduce((s,d)=> s + (d.Importo - d.Importo/(1+d.IVA/100)), 0);
      const ivaDaVersare= ivaVendite - ivaAcquisti;
      const liquidita   = profitto * 0.1;

      // KPI numbers
      document.getElementById('entrateVal').textContent  = formatEUR(totEntrate);
      document.getElementById('speseVal').textContent    = formatEUR(totSpese);
      document.getElementById('ivaVal').textContent      = formatEUR(ivaDaVersare);
      document.getElementById('profittoVal').textContent = formatEUR(profitto);
      document.getElementById('liquiditaVal').textContent= formatEUR(liquidita);

      // KPI rings (target fittizi per progress)
      makeRing('kpiEntrate',  totEntrate, 20000, '#22c55e');
      makeRing('kpiSpese',    totSpese,  15000, '#ef4444');
      makeRing('kpiIva',      Math.max(ivaDaVersare,0), 3000,  '#facc15');
      makeRing('kpiProfitto', Math.max(profitto,0),      6000,  '#a855f7');

      // Donut ripartizione + trend (trend: esempio 12 mesi sintetico basato sul mese corrente)
      drawDonut([totEntrate, totSpese, Math.max(profitto,0)]);
      const trend = Array.from({length:12}, (_,i)=> (totEntrate - totSpese) * Math.max(0.2, (i+4)/16));
      drawBars(trend);

      // Tabella fatture (qui mostriamo le spese come “uscite pianificate”)
      const tbody = document.getElementById('fattureTable');
      tbody.innerHTML = spese.map(d => `
        <tr class="border-t border-slate-600/40">
          <td class="py-2 pr-3">${new Date(d.Data).toLocaleDateString('it-IT')}</td>
          <td class="py-2 pr-3">${d.Categoria}</td>
          <td class="py-2 pr-3">${d.Conto}</td>
          <td class="py-2 pr-3">${d.Attivita}</td>
          <td class="py-2 pr-0 text-right">${formatEUR(d.Importo)}</td>
        </tr>
      `).join('') || `<tr><td class="py-2 text-slate-400" colspan="5">Nessuna voce</td></tr>`;
      document.getElementById('rowsCount').textContent = spese.length ? `${spese.length} righe` : '';

      // Alert automatico se spese > entrate
      const showAlert = totSpese > totEntrate;
      document.getElementById('alertBox').classList.toggle('hidden', !showAlert);
    }

    // ======== Export PDF ========
    async function exportPDF() {
      // Screenshot dell'area report (KPI + grafici + tabella) e impaginazione su A4
      const reportEl = document.getElementById('report');
      const canvas = await html2canvas(reportEl, { backgroundColor: null, scale: 2 });
      const imgData = canvas.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'p', unit:'pt', format:'a4' });
      const pageWidth  = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // Calcola altezza immagine ridimensionata per stare in larghezza
      const ratio = canvas.height / canvas.width;
      let imgWidth = pageWidth - 40;          // margini
      let imgHeight = imgWidth * ratio;

      let y = 20;
      if (imgHeight <= pageHeight - 40) {
        pdf.addImage(imgData, 'PNG', 20, y, imgWidth, imgHeight, undefined, 'FAST');
      } else {
        // Se l'immagine è più lunga di una pagina, “srotola” su più pagine
        let leftHeight = imgHeight;
        let position = 20;
        let pageCanvas = document.createElement('canvas');
        let pageCtx = pageCanvas.getContext('2d');
        const a4ratio = (pageHeight - 40) / (pageWidth - 40);
        const pageImgHeight = (pageWidth - 40) * a4ratio;

        let sX = 0, sY = 0, sWidth = canvas.width, sHeight = canvas.width * a4ratio;

        while (leftHeight > 0) {
          pageCanvas.width = canvas.width;
          pageCanvas.height = sHeight;
          pageCtx.fillStyle = '#0E1320';
          pageCtx.fillRect(0,0,pageCanvas.width,pageCanvas.height);
          pageCtx.drawImage(canvas, sX, sY, sWidth, sHeight, 0, 0, pageCanvas.width, pageCanvas.height);
          const pageData = pageCanvas.toDataURL('image/png');

          pdf.addImage(pageData, 'PNG', 20, 20, imgWidth, pageImgHeight, undefined, 'FAST');
          leftHeight -= sHeight;
          sY += sHeight;

          if (leftHeight > 0) pdf.addPage();
        }
      }
      pdf.save('report-dashboard.pdf');
    }

    // ======== Inizializzazione / demo ========
    function loadInitialData() {
      const savedCSV = localStorage.getItem(STORAGE_KEY);
      if (savedCSV) {
        data = parseCSV(savedCSV);
        render();
      } else {
        // Dataset di esempio (così funziona subito)
        const demo = `Data,Tipo,Importo,IVA,Categoria,Conto,Attivita
2025-08-02,entrata,2300,22,PRODOTTO X,POS,Negozio 4
2025-08-03,entrata,1900,22,PRODOTTO Z,Contanti,Negozio 1
2025-08-04,entrata,9397.85,10,ONLINE,Online,Negozio 4
2025-08-05,entrata,7054.31,10,CONTANTI,Contanti,Negozio 2
2025-08-06,spesa,1280,22,Affitto,Unicredit,Negozio 4
2025-08-07,spesa,560,10,Utenze,Unicredit,Negozio 4
2025-08-08,spesa,2300,22,Marketing / Pubblicità,Online,Negozio 4
2025-08-09,spesa,190,22,Manutenzione,POS,Negozio 1`;
        data = parseCSV(demo);
        render();
      }
    }

    // Eventi filtri
    document.querySelectorAll('#yearSel,#monthSel,#attivitaSel,#contoSel').forEach(sel => {
      sel.addEventListener('change', render);
    });

    // Avvio
    loadInitialData();
  </script>
</body>
</html>
