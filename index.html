<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Commander Elite Pro - Top Edition</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Commander%20Elite%20Pro%22,%22short_name%22:%22Commander%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#0f172a%22,%22theme_color%22:%22#0f172a%22}">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f1f5f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    .page { display: none; padding-bottom: 120px; }
    .active-page { display: block; animation: fadeIn 0.15s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.25rem; border: 1px solid #e2e8f0; }
    input, select, textarea { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 12px; width: 100%; font-size: 16px; transition: border-color 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: #2563eb; outline: none; background-color: #f8fafc; }
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item.active { color: #2563eb; }
    #lock-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    @media print {
      .no-print { display: none !important; }
      .page { display: block !important; }
      table { width: 100% !important; border-collapse: collapse; }
      th, td { border: 1px solid #000; padding: 8px; text-align: right; }
      td:first-child, th:first-child { text-align: left; }
    }
  </style>
</head>
<body>

  <div id="lock-screen">
    <div class="text-center mb-8">
      <i class="fa-solid fa-shield-halved text-5xl text-blue-500 mb-4"></i>
      <h1 class="text-2xl font-black tracking-tighter uppercase">Commander Elite <span class="text-blue-500">PRO</span></h1>
    </div>
    <div class="w-72 bg-slate-800 p-6 rounded-3xl shadow-2xl">
      <input type="password" id="pin-input" class="text-center text-3xl tracking-[0.5em] text-slate-900 mb-4 font-bold" maxlength="4" placeholder="****">
      <button type="button" onclick="checkPin()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black uppercase transition-all shadow-lg active:scale-95">Sblocca Sistema</button>
    </div>
  </div>

  <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 p-4 no-print flex justify-between items-center">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black italic">C</div>
      <h1 class="font-black text-slate-800 uppercase tracking-tight text-lg">Commander <span class="text-blue-600">Elite</span></h1>
    </div>
    <button type="button" onclick="location.reload()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center">
      <i class="fa-solid fa-lock"></i>
    </button>
  </header>

  <main class="max-w-2xl mx-auto p-4">

    <section id="page-oggi" class="page active-page">
      <div class="card bg-gradient-to-r from-blue-600 to-blue-800 border-none">
        <label class="text-[10px] font-black text-blue-100 uppercase mb-1 block">Data Operativa</label>
        <input type="date" id="data-lavoro" class="bg-white/10 border-none text-white font-bold text-lg cursor-pointer" onchange="onChangeData()">
        <p id="badge-loaded" class="mt-2 text-[10px] font-black uppercase tracking-widest text-blue-100 hidden">Giornata caricata</p>
      </div>

      <div class="card">
        <div class="flex items-center gap-2 mb-4 border-b pb-2">
          <i class="fa-solid fa-receipt text-blue-600"></i>
          <h3 class="font-black text-slate-700 uppercase text-xs">Incassi e Corrispettivi</h3>
        </div>
        <div class="space-y-4">
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Totale Chiusura Z (Lordo)</label>
            <input type="number" id="inp-tot" placeholder="0.00" class="text-3xl font-black text-slate-800" oninput="calcola()" inputmode="decimal" step="0.01">
          </div>
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Aliquota IVA Vendite</label>
            <select id="iva-v-base" onchange="calcola()" class="font-bold bg-slate-50">
              <option value="10">IVA 10% (Ristorazione)</option>
              <option value="22">IVA 22% (Bevande/Servizi)</option>
              <option value="4">IVA 4% (Alimentari)</option>
            </select>
          </div>
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-credit-card text-slate-700"></i>
                <h4 class="font-black text-slate-700 uppercase text-[11px]">Pagamenti Elettronici</h4>
              </div>
              <button type="button" onclick="addPayRow()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-sm">+ AGGIUNGI</button>
            </div>
            <div id="pay-list" class="space-y-2"></div>
            <div class="mt-3 text-[10px] font-bold uppercase text-slate-500 flex justify-between border-t border-slate-200 pt-3">
              <span>Totale elettronico</span>
              <span id="pay-total">€ 0,00</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-l-4 border-red-500">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-2 text-red-600">
            <i class="fa-solid fa-truck-ramp-box"></i>
            <h3 class="font-black uppercase text-xs text-slate-700">Fornitori e Fatture</h3>
          </div>
          <button type="button" onclick="addFornitore()" class="bg-red-500 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-sm">+ AGGIUNGI SPESA</button>
        </div>
        <div id="fornitori-list" class="space-y-4"></div>
      </div>

      <div class="card bg-slate-900 text-white shadow-2xl">
        <div class="grid grid-cols-2 gap-6 text-xs mb-6">
          <div class="border-r border-slate-700">
            <p class="text-slate-500 font-bold uppercase mb-1">Tot. Elettronico</p>
            <p id="res-ele" class="text-xl font-bold">€ 0,00</p>
          </div>
          <div>
            <p class="text-orange-400 font-bold uppercase mb-1">IVA su Vendite</p>
            <p id="res-ivav" class="text-xl font-bold text-orange-400">€ 0,00</p>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-white/10">
          <span class="font-black text-green-400 uppercase tracking-wider">Netto Contanti</span>
          <span id="res-netto" class="text-3xl font-black text-green-400 tracking-tighter">€ 0,00</span>
        </div>
        <button type="button" onclick="salvaData(this)" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg shadow-blue-900/20 active:scale-95 transition-all">
          Archivia e Salva
        </button>
      </div>
    </section>

    <section id="page-riepilogo" class="page">
        <h2 class="font-black text-2xl text-slate-800 mb-6 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-blue-600"></i> Analisi Business
        </h2>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="card border-t-4 border-blue-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Ultimi 7gg</p>
                <p id="st-w" class="text-xl font-black text-slate-800">€ 0.00</p>
                <p class="text-[10px] font-bold text-slate-400 mt-1">Prec. 7gg: <span id="st-w-prev">€ 0.00</span> • Δ <span id="st-w-delta">0%</span></p>
            </div>
            <div class="card border-t-4 border-blue-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Mese Corrente</p>
                <p id="st-m" class="text-xl font-black text-slate-800">€ 0.00</p>
                <p class="text-[10px] font-bold text-slate-400 mt-1">Media/giorno: <span id="st-avg-day">€ 0.00</span></p>
            </div>
            <div class="card col-span-2 bg-slate-800 text-white border-none flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Saldo IVA Mese</p>
                    <p id="st-iva-saldo" class="text-2xl font-black text-orange-400">€ 0.00</p>
                    <p class="text-[10px] font-bold text-slate-300 mt-1">Spese/Incasso: <span id="st-spese-inc">0%</span></p>
                </div>
                <i class="fa-solid fa-piggy-bank text-4xl opacity-20"></i>
            </div>
            <div class="card col-span-2 border-t-4 border-blue-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Filtri rapidi</p>
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" onclick="setQuickRange('thisWeek')" class="bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-[10px]">Questa settimana</button>
                    <button type="button" onclick="setQuickRange('lastWeek')" class="bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-[10px]">Settimana scorsa</button>
                    <button type="button" onclick="setQuickRange('month')" class="bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-[10px]">Questo mese</button>
                    <button type="button" onclick="setQuickRange('lastMonth')" class="bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-[10px]">Mese scorso</button>
                </div>
            </div>
            <div class="card col-span-2 border-t-4 border-blue-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Top fornitori (mese)</p>
                <div id="st-top-sup" class="text-[11px] text-slate-700 font-bold leading-5">Nessun dato</div>
            </div>
        </div>

        <div class="card">
            <h3 class="font-black text-xs uppercase mb-4 text-slate-500 border-b pb-2">Ricerca Storica Periodo</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input type="date" id="s-from">
                <input type="date" id="s-to">
            </div>
            <button type="button" onclick="cercaPeriodo()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-black uppercase text-xs">Elabora Analisi</button>
            <div id="s-res" class="mt-6 hidden"></div>
        </div>
    </section>

    <section id="page-stampa" class="page">
      <div class="card no-print border-l-4 border-slate-800">
        <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Setup - Sicurezza PIN</h3>
        <div class="space-y-3">
            <input type="password" id="pin-current" maxlength="4" placeholder="PIN ATTUALE">
            <div class="grid grid-cols-2 gap-3">
                <input type="password" id="pin-new" maxlength="4" placeholder="NUOVO PIN">
                <input type="password" id="pin-new2" maxlength="4" placeholder="CONFERMA">
            </div>
            <button onclick="changePin()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-xs">Cambia PIN</button>
        </div>
      </div>

      <div class="card no-print">
        <h3 class="font-black text-xs uppercase mb-4 text-slate-500 border-b pb-2">Configurazione Export Fiscale</h3>
        <div class="grid grid-cols-2 gap-3 mb-6">
          <input type="date" id="p-from">
          <input type="date" id="p-to">
        </div>
        <button onclick="generaReportProfessionale()" class="w-full bg-blue-700 text-white py-5 rounded-2xl font-black uppercase">Genera Documentazione Ragioniere</button>
      </div>

      <div class="card no-print border-l-4 border-blue-700">
        <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Backup & Import Dati</h3>
        <div class="space-y-3">
          <button onclick="exportBackupFile()" class="w-full bg-blue-700 text-white py-4 rounded-xl font-black text-xs">Esporta Backup (JSON)</button>
          <input type="file" id="import-file" class="hidden" onchange="handleImportFile(this.files[0])">
          <button onclick="document.getElementById('import-file').click()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-xs">Importa Backup (JSON)</button>
        </div>
      </div>
      <div id="area-stampa"></div>
    </section>
  </main>

  <nav class="nav-bottom no-print">
    <button onclick="showPage('oggi')" class="nav-item active" id="btn-oggi"><i class="fa-solid fa-cash-register text-2xl mb-1"></i>Cassa</button>
    <button onclick="showPage('riepilogo')" class="nav-item" id="btn-riepilogo"><i class="fa-solid fa-chart-line text-2xl mb-1"></i>Analisi</button>
    <button onclick="showPage('stampa')" class="nav-item" id="btn-stampa"><i class="fa-solid fa-file-invoice-dollar text-2xl mb-1"></i>Fisco</button>
  </nav>

  <datalist id="dl-fornitori"></datalist>

  <script>
    // --- UTILS & STORAGE KEYS ---
    const fix = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;
    const euro = (n) => `€ ${fix(n).toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
    const LS_DB_SNAPSHOT = 'ce_v3_snapshot'; // Fallback per localStorage

    // --- DOPPIA PERSISTENZA: INDEXEDDB + LOCALSTORAGE ---
    let db = [];
    const DB_NAME = 'CommanderEliteDB';
    const DB_VERSION = 1;
    let indexedDBInstance;

    function initDB() {
        return new Promise((resolve) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
                const idb = e.target.result;
                if (!idb.objectStoreNames.contains('records')) {
                    idb.createObjectStore('records', { keyPath: 'data' });
                }
            };
            request.onsuccess = (e) => {
                indexedDBInstance = e.target.result;
                loadAllData().then(resolve);
            };
            request.onerror = () => {
                console.error("IndexedDB error, falling back to LocalStorage");
                db = JSON.parse(localStorage.getItem(LS_DB_SNAPSHOT)) || [];
                resolve();
            };
        });
    }

    async function loadAllData() {
        return new Promise((resolve) => {
            const transaction = indexedDBInstance.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.getAll();
            request.onsuccess = () => {
                db = request.result || [];
                // Sincronizza snapshot LocalStorage
                localStorage.setItem(LS_DB_SNAPSHOT, JSON.stringify(db));
                resolve();
            };
        });
    }

    async function persistDB(record) {
        // 1. Update array in memoria
        db = db.filter(r => r.data !== record.data);
        db.push(record);
        db.sort((a, b) => a.data.localeCompare(b.data));

        // 2. Persistenza Primaria: IndexedDB
        const transaction = indexedDBInstance.transaction(['records'], 'readwrite');
        const store = transaction.objectStore('records');
        store.put(record);

        // 3. Fallback/Snapshot: LocalStorage
        localStorage.setItem(LS_DB_SNAPSHOT, JSON.stringify(db));
    }

    // --- PWA OFFLINE SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const swCode = `
                const CACHE_NAME = 'commander-v1';
                self.addEventListener('install', e => {
                    e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./'])));
                });
                self.addEventListener('fetch', e => {
                    e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
                });
            `;
            const blob = new Blob([swCode], { type: 'text/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        });
    }

    // --- LOGICA PIN & SICUREZZA ---
    const LS_PIN = 'ce_pin_v1';
    const DEFAULT_PIN = "1234";
    const IDLE_LOCK_MS = 5 * 60 * 1000;
    let _idleTimer;

    function getPin() { return localStorage.getItem(LS_PIN) || DEFAULT_PIN; }
    function checkPin() {
        const val = document.getElementById('pin-input').value;
        if (val === getPin()) {
            document.getElementById('lock-screen').style.display = 'none';
            resetIdleTimer();
        } else {
            alert("PIN ERRATO");
            document.getElementById('pin-input').value = "";
        }
    }

    function resetIdleTimer() {
        clearTimeout(_idleTimer);
        _idleTimer = setTimeout(() => {
            document.getElementById('lock-screen').style.display = 'flex';
        }, IDLE_LOCK_MS);
    }
    ['mousedown','keydown','touchstart'].forEach(ev => window.addEventListener(ev, resetIdleTimer));

    // --- LOGICA CORE ---
    function showPage(p) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active-page'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active-page');
        document.getElementById('btn-' + p).classList.add('active');
        if (p === 'riepilogo') aggiornaStatsDash();
    }

    function addPayRow(name = "", value = "") {
        const container = document.getElementById('pay-list');
        const div = document.createElement('div');
        div.className = "bg-white p-3 rounded-2xl border border-slate-200 pay-row";
        div.innerHTML = `
            <div class="grid grid-cols-12 gap-2 items-center">
                <div class="col-span-7"><input type="text" class="pay-name font-bold text-sm" value="${name}" placeholder="Metodo..."></div>
                <div class="col-span-4"><input type="number" class="pay-val font-bold text-sm" value="${value}" oninput="calcola()" step="0.01"></div>
                <div class="col-span-1"><button onclick="this.closest('.pay-row').remove(); calcola()">✕</button></div>
            </div>`;
        container.appendChild(div);
    }

    function addFornitore(prefill = null) {
        const container = document.getElementById('fornitori-list');
        const div = document.createElement('div');
        div.className = "bg-slate-50 p-4 rounded-2xl border border-slate-200 forn-block";
        div.innerHTML = `
            <input type="text" placeholder="Fornitore..." class="f-name font-bold mb-2" value="${prefill?.nome || ''}">
            <div class="r-cont space-y-2">
                <div class="grid grid-cols-3 gap-2 r-item">
                    <input type="number" class="r-val" placeholder="Valore" oninput="calcola()" value="${prefill?.righe?.[0]?.valore || ''}">
                    <select class="r-iva" onchange="calcola()"><option value="10">10%</option><option value="22">22%</option></select>
                    <button class="text-red-500" onclick="this.closest('.forn-block').remove(); calcola()">Elimina</button>
                </div>
            </div>
            <div class="mt-2 flex items-center gap-2">
                <label class="text-[10px] font-bold">CONTANTI?</label>
                <input type="checkbox" class="f-cash" ${prefill?.cash ? 'checked' : ''} onchange="calcola()">
            </div>`;
        container.appendChild(div);
    }

    function calcola() {
        const lordoZ = fix(document.getElementById('inp-tot').value || 0);
        const ivaVperc = parseFloat(document.getElementById('iva-v-base').value);
        
        let totEle = 0;
        document.querySelectorAll('.pay-row').forEach(r => {
            totEle += fix(r.querySelector('.pay-val').value || 0);
        });

        let uscCash = 0;
        let totIvaA = 0;
        document.querySelectorAll('.forn-block').forEach(b => {
            const v = fix(b.querySelector('.r-val').value || 0);
            const iva = parseFloat(b.querySelector('.r-iva').value);
            const lordoF = v; 
            const ivaF = fix(lordoF - (lordoF / (1 + iva/100)));
            totIvaA += ivaF;
            if (b.querySelector('.f-cash').checked) uscCash += lordoF;
        });

        const impV = fix(lordoZ / (1 + ivaVperc/100));
        const ivaV = fix(lordoZ - impV);
        const netto = fix((lordoZ - totEle) - uscCash);

        document.getElementById('pay-total').innerText = euro(totEle);
        document.getElementById('res-ele').innerText = euro(totEle);
        document.getElementById('res-ivav').innerText = euro(ivaV);
        document.getElementById('res-netto').innerText = euro(netto);

        return { lordoZ, ivaV, impV, totEle, uscCash, totIvaA };
    }

    function salvaData(btn) {
        const data = document.getElementById('data-lavoro').value;
        if(!data) return alert("Scegli data");
        const c = calcola();
        
        const payDet = [];
        document.querySelectorAll('.pay-row').forEach(r => {
            payDet.push({ nome: r.querySelector('.pay-name').value, valore: fix(r.querySelector('.pay-val').value) });
        });

        const detFornitori = [];
        document.querySelectorAll('.forn-block').forEach(b => {
            detFornitori.push({
                nome: b.querySelector('.f-name').value,
                lordo: fix(b.querySelector('.r-val').value),
                iva: fix(b.querySelector('.r-val').value * 0.1), // Semplificato per spazio
                cash: b.querySelector('.f-cash').checked
            });
        });

        const rec = { data, lordoZ: c.lordoZ, ivaV: c.ivaV, totEle: c.totEle, uscCash: c.uscCash, totIvaA: c.totIvaA, payDet, detFornitori };
        persistDB(rec);
        
        btn.innerText = "SALVATO!";
        setTimeout(() => btn.innerText = "ARCHIVIA E SALVA", 2000);
    }

    function onChangeData() {
        const data = document.getElementById('data-lavoro').value;
        const rec = db.find(r => r.data === data);
        document.getElementById('pay-list').innerHTML = "";
        document.getElementById('fornitori-list').innerHTML = "";
        
        if (rec) {
            document.getElementById('badge-loaded').classList.remove('hidden');
            document.getElementById('inp-tot').value = rec.lordoZ;
            rec.payDet.forEach(p => addPayRow(p.nome, p.valore));
            rec.detFornitori.forEach(f => addFornitore({ nome: f.nome, cash: f.cash, righe: [{valore: f.lordo}] }));
        } else {
            document.getElementById('badge-loaded').classList.add('hidden');
            document.getElementById('inp-tot').value = "";
            addPayRow("POS", "");
        }
        calcola();
    }

    // --- INIT ---
    initDB().then(() => {
        document.getElementById('data-lavoro').valueAsDate = new Date();
        onChangeData();
    });

    // --- FUNZIONI BACKUP & ANALISI (Semplificate per compattezza) ---
    function exportBackupFile() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "commander_backup.json");
        downloadAnchorNode.click();
    }

    function handleImportFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const imported = JSON.parse(e.target.result);
            imported.forEach(r => persistDB(r));
            alert("Dati importati");
            location.reload();
        };
        reader.readAsText(file);
    }
  </script>
</body>
</html>
