<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commander Elite Pro - Super Top</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; color: #f1f5f9; }
        .page { display: none; padding-bottom: 120px; }
        .active-page { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); padding: 1.5rem; margin-bottom: 1.25rem; }
        input, select { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; width: 100%; color: white; font-size: 16px; transition: all 0.3s; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); outline: none; }
        .nav-bottom { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 12px; z-index: 1000; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); }
        .nav-item { color: #64748b; font-size: 10px; font-weight: 800; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
        .nav-item.active { color: #3b82f6; transform: translateY(-5px); }
        .stat-val { font-family: 'JetBrains Mono', monospace; }
        @media print { .no-print { display: none !important; } .page { display: block !important; color: black; } .glass-card { border: 1px solid #eee; background: white; } }
    </style>
</head>
<body>

    <div id="lock-screen" class="fixed inset-0 bg-slate-950 z-[9999] flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto flex items-center justify-center mb-4 shadow-2xl shadow-blue-500/20">
                <i class="fa-solid fa-bolt-lightning text-3xl text-white"></i>
            </div>
            <h1 class="text-3xl font-black tracking-tighter uppercase italic">Commander <span class="text-blue-500 font-normal">Elite</span></h1>
            <p class="text-slate-500 text-xs font-bold tracking-widest mt-2 uppercase">Financial Intelligence System</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <input type="password" id="pin-input" class="text-center text-4xl font-black tracking-[0.4em]" maxlength="4" placeholder="••••">
            <button onclick="checkPin()" class="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition">Sblocca Accesso</button>
        </div>
    </div>

    <header class="p-6 flex justify-between items-center no-print">
        <div>
            <p id="header-date" class="text-[10px] font-black text-blue-500 uppercase tracking-widest"></p>
            <h2 class="text-xl font-black uppercase italic">Dashboard</h2>
        </div>
        <button onclick="location.reload()" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-white/5"><i class="fa-solid fa-user-shield text-blue-500"></i></button>
    </header>

    <main class="max-w-2xl mx-auto p-4">

        <section id="page-oggi" class="page active-page">
            <div class="glass-card bg-gradient-to-br from-blue-600/20 to-transparent">
                <label class="text-[10px] font-black text-blue-400 uppercase mb-2 block">Seleziona Giorno Lavorativo</label>
                <input type="date" id="data-lavoro" class="font-bold border-none" onchange="calcola()">
            </div>

            <div class="glass-card">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-cash-register text-blue-500"></i> Gestione Incassi (Chiusura Z)
                </h3>
                <div class="space-y-6">
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-black opacity-30">€</span>
                        <input type="number" id="inp-tot" placeholder="0.00" class="pl-12 text-4xl font-black py-6 bg-slate-900/50" oninput="calcola()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="text-[9px] font-bold text-slate-500 uppercase mb-1 block px-2">Aliquota Prevalente</label>
                            <select id="iva-v-base" onchange="calcola()" class="font-bold text-blue-400">
                                <option value="10">ALIMENTI & BEVANDE (10%)</option>
                                <option value="22">ALCOLICI & ACCESSORI (22%)</option>
                                <option value="4">BENI DI PRIMA NECESSITÀ (4%)</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-500 uppercase px-2">Bancomat/POS</label>
                            <input type="number" class="val-e" id="inp-pos" placeholder="0.00" oninput="calcola()">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-500 uppercase px-2">Satispay</label>
                            <input type="number" class="val-e" id="inp-sat" placeholder="0.00" oninput="calcola()">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-500 uppercase px-2">Delivery App</label>
                            <input type="number" class="val-e" id="inp-del" placeholder="0.00" oninput="calcola()">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-500 uppercase px-2">Web/TapPay</label>
                            <input type="number" class="val-e" id="inp-tap" placeholder="0.00" oninput="calcola()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card border-l-4 border-red-500">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xs font-black uppercase text-slate-400 flex items-center gap-2">
                        <i class="fa-solid fa-file-invoice text-red-500"></i> Uscite e Fatture
                    </h3>
                    <button onclick="addFornitore()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-[10px] font-black transition">+ SPESA</button>
                </div>
                <div id="fornitori-list" class="space-y-4"></div>
            </div>

            <div class="glass-card bg-white text-slate-900 shadow-2xl shadow-blue-500/10">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase">Cash Netto Versabile</p>
                        <h2 id="res-netto" class="text-5xl font-black tracking-tighter stat-val text-blue-600">€ 0.00</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-black text-slate-400 uppercase">Debito IVA Z</p>
                        <p id="res-ivav" class="text-xl font-black text-orange-500 stat-val">€ 0.00</p>
                    </div>
                </div>
                <button onclick="salvaData()" id="btn-salva" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-sm tracking-widest hover:bg-black active:scale-95 transition-all">Archivia Sessione</button>
            </div>
        </section>

        <section id="page-riepilogo" class="page">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic uppercase">Financial Intelligence</h2>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card border-t-2 border-blue-500">
                    <p class="text-[9px] font-black text-slate-500 uppercase">Entrate 7gg</p>
                    <p id="st-w" class="text-xl font-black text-blue-400 stat-val">€ 0.00</p>
                </div>
                <div class="glass-card border-t-2 border-green-500">
                    <p class="text-[9px] font-black text-slate-500 uppercase">Entrate Mese</p>
                    <p id="st-m" class="text-xl font-black text-green-400 stat-val">€ 0.00</p>
                </div>
                <div class="glass-card col-span-2 flex justify-between items-center">
                    <div>
                        <p class="text-[9px] font-black text-slate-500 uppercase">Accantonamento IVA Mese</p>
                        <p id="st-iva-saldo" class="text-2xl font-black text-orange-500 stat-val">€ 0.00</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-orange-500/10 flex items-center justify-center">
                        <i class="fa-solid fa-piggy-bank text-orange-500"></i>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-6 border-b border-white/5 pb-2">Ricerca Avanzata Flussi</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="space-y-1"><label class="text-[9px] font-bold text-slate-500 px-2 uppercase">Dal</label><input type="date" id="s-from"></div>
                    <div class="space-y-1"><label class="text-[9px] font-bold text-slate-500 px-2 uppercase">Al</label><input type="date" id="s-to"></div>
                </div>
                <button onclick="cercaPeriodo()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase text-xs tracking-widest shadow-lg shadow-blue-500/20">Analizza Periodo</button>
                
                <div id="s-res" class="mt-8 hidden space-y-4 animate-fadeIn">
                    </div>
            </div>
        </section>

        <section id="page-stampa" class="page">
            <div class="glass-card no-print">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-6 border-b border-white/5 pb-2">Export Fiscale Ragioniere</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <input type="date" id="p-from">
                    <input type="date" id="p-to">
                </div>
                <button onclick="generaReportProfessionale()" class="w-full bg-white text-slate-900 py-5 rounded-2xl font-black uppercase text-sm shadow-xl">Genera PDF Professionale</button>
            </div>
            <div id="area-stampa"></div>
        </section>

    </main>

    <nav class="nav-bottom no-print">
        <button onclick="showPage('oggi')" class="nav-item active" id="btn-oggi"><i class="fa-solid fa-house-chimney text-xl mb-1"></i>Cassa</button>
        <button onclick="showPage('riepilogo')" class="nav-item" id="btn-riepilogo"><i class="fa-solid fa-chart-line text-xl mb-1"></i>Analisi</button>
        <button onclick="showPage('stampa')" class="nav-item" id="btn-stampa"><i class="fa-solid fa-file-contract text-xl mb-1"></i>Fisco</button>
    </nav>

    <script>
        // Utility per precisione decimale contabile
        const fix = (n) => Math.round((n + Number.EPSILON) * 100) / 100;
        
        let db = JSON.parse(localStorage.getItem('ce_v3_supertop')) || [];

        function checkPin() {
            if(document.getElementById('pin-input').value === "1234") {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('header-date').innerText = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active-page'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active-page');
            document.getElementById('btn-'+p).classList.add('active');
            if(p === 'riepilogo') aggiornaStatsDash();
        }

        function addFornitore() {
            const container = document.getElementById('fornitori-list');
            const div = document.createElement('div');
            div.className = "bg-slate-900/50 p-4 rounded-2xl border border-white/5 animate-fadeIn";
            div.innerHTML = `
                <div class="flex gap-2 mb-3">
                    <input type="text" placeholder="Fornitore..." class="flex-1 font-black text-sm f-name uppercase border-none">
                    <button onclick="this.parentElement.parentElement.remove(); calcola()" class="w-10 h-10 text-red-500 rounded-full bg-red-500/10">✕</button>
                </div>
                <div class="space-y-2 r-cont">
                    <div class="grid grid-cols-3 gap-2 r-item">
                        <input type="number" placeholder="€" class="r-val !p-3 font-black text-blue-400" oninput="calcola()">
                        <select class="r-iva !p-3 text-[10px] font-bold uppercase" onchange="calcola()">
                            <option value="22">IVA 22%</option>
                            <option value="10" selected>IVA 10%</option>
                            <option value="4">IVA 4%</option>
                            <option value="0">Esente</option>
                        </select>
                        <select class="r-tipo !p-3 text-[10px] font-bold uppercase bg-slate-800" onchange="calcola()">
                            <option value="L">LORDO</option>
                            <option value="N">NETTO</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center opacity-60">
                    <button onclick="addRowIVA(this)" class="text-[10px] font-black uppercase">+ IVA Differenziata</button>
                    <label class="flex items-center gap-2 text-[10px] font-black uppercase">Contanti? <input type="checkbox" class="f-cash w-5 h-5 accent-blue-600" onchange="calcola()"></label>
                </div>
            `;
            container.appendChild(div);
        }

        function addRowIVA(btn) {
            const row = document.createElement('div');
            row.className = "grid grid-cols-3 gap-2 r-item mt-2";
            row.innerHTML = `<input type="number" placeholder="€" class="r-val !p-2 font-bold" oninput="calcola()">
                <select class="r-iva !p-2 text-[10px] font-bold" onchange="calcola()"><option value="22">22%</option><option value="10" selected>10%</option><option value="4">4%</option></select>
                <button onclick="this.parentElement.remove(); calcola()" class="text-[8px] text-red-500 font-black uppercase">✕</button>`;
            btn.parentElement.previousElementSibling.appendChild(row);
        }

        function calcola() {
            const lordoZ = fix(parseFloat(document.getElementById('inp-tot').value) || 0);
            const ivaVperc = parseFloat(document.getElementById('iva-v-base').value);
            
            let totEle = 0;
            document.querySelectorAll('.val-e').forEach(i => totEle += fix(parseFloat(i.value) || 0));

            const impV = fix(lordoZ / (1 + (ivaVperc / 100)));
            const ivaV = fix(lordoZ - impV);

            let uscCash = 0;
            let totIvaA = 0;
            let detFornitori = [];

            document.querySelectorAll('.forn-block').forEach(b => {
                let fLordo = 0;
                let fIva = 0;
                b.querySelectorAll('.r-item').forEach(r => {
                    const v = fix(parseFloat(r.querySelector('.r-val').value) || 0);
                    const i = parseFloat(r.querySelector('.r-iva').value) || 0;
                    const t = r.querySelector('.r-tipo')?.value || 'L';
                    if(t === 'L') {
                        fLordo += v;
                        fIva += fix(v - (v / (1 + (i / 100))));
                    } else {
                        const r_iva = fix(v * (i / 100));
                        fIva += r_iva;
                        fLordo += (v + r_iva);
                    }
                });
                totIvaA += fix(fIva);
                if(b.querySelector('.f-cash').checked) uscCash += fix(fLordo);
                detFornitori.push({ nome: b.querySelector('.f-name').value || "Senza Nome", lordo: fix(fLordo), iva: fix(fIva), cash: b.querySelector('.f-cash').checked });
            });

            const netto = fix((lordoZ - totEle) - uscCash);

            document.getElementById('res-ivav').innerText = `€ ${ivaV.toFixed(2)}`;
            document.getElementById('res-netto').innerText = `€ ${netto.toFixed(2)}`;

            return { lordoZ, ivaV, impV, totEle, uscCash, totIvaA, detFornitori, 
                     pos: fix(parseFloat(document.getElementById('inp-pos').value)||0),
                     sat: fix(parseFloat(document.getElementById('inp-sat').value)||0),
                     del: fix(parseFloat(document.getElementById('inp-del').value)||0),
                     tap: fix(parseFloat(document.getElementById('inp-tap').value)||0) 
                   };
        }

        function salvaData() {
            const data = document.getElementById('data-lavoro').value;
            if(!data) return alert("Scegli una data.");
            const dati = calcola();
            db = db.filter(r => r.data !== data);
            db.push({ data, ...dati });
            localStorage.setItem('ce_v3_supertop', JSON.stringify(db));
            
            const btn = document.getElementById('btn-salva');
            btn.innerText = "✓ ARCHIVIATO";
            btn.classList.replace('bg-slate-900', 'bg-green-600');
            setTimeout(() => {
                btn.innerText = "ARCHIVIA SESSIONE";
                btn.classList.replace('bg-green-600', 'bg-slate-900');
            }, 1500);
        }

        function aggiornaStatsDash() {
            const now = new Date();
            const m = now.toISOString().substring(0, 7);
            const w = new Date(); w.setDate(now.getDate() - 7);
            let tW=0, tM=0, tIV=0, tIA=0;

            db.forEach(r => {
                const rd = new Date(r.data);
                if(rd >= w) tW += r.lordoZ;
                if(r.data.startsWith(m)) {
                    tM += r.lordoZ; tIV += r.ivaV; tIA += r.totIvaA;
                }
            });
            document.getElementById('st-w').innerText = `€ ${tW.toLocaleString()}`;
            document.getElementById('st-m').innerText = `€ ${tM.toLocaleString()}`;
            document.getElementById('st-iva-saldo').innerText = `€ ${fix(tIV - tIA).toFixed(2)}`;
        }

        function cercaPeriodo() {
            const f = document.getElementById('s-from').value;
            const t = document.getElementById('s-to').value;
            if(!f || !t) return alert("Inserisci il periodo.");

            const fil = db.filter(r => r.data >= f && r.data <= t);
            let totL=0, totE=0, totC=0, tIV=0, tIA=0;
            
            fil.forEach(r => {
                totL += r.lordoZ; totE += r.totEle; totC += r.uscCash; tIV += r.ivaV; tIA += r.totIvaA;
            });

            const res = document.getElementById('s-res');
            res.classList.remove('hidden');
            res.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-600 p-4 rounded-2xl col-span-2 shadow-lg">
                        <p class="text-[10px] font-black uppercase opacity-60">Lordo Totale Periodo</p>
                        <p class="text-3xl font-black stat-val">€ ${totL.toLocaleString()}</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-2xl">
                        <p class="text-[9px] font-black uppercase text-slate-500 mb-1">Entrate Elettroniche</p>
                        <p class="text-lg font-bold text-blue-400 stat-val">€ ${totE.toLocaleString()}</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-2xl">
                        <p class="text-[9px] font-black uppercase text-slate-500 mb-1">Uscite Contanti</p>
                        <p class="text-lg font-bold text-red-500 stat-val">€ ${totC.toLocaleString()}</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-2xl col-span-2 flex justify-between items-center border border-white/10">
                        <div>
                            <p class="text-[9px] font-black uppercase text-slate-500">Netto da Versare (Totale Periodo)</p>
                            <p class="text-2xl font-black text-green-400 stat-val">€ ${fix((totL - totE) - totC).toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                             <p class="text-[9px] font-black uppercase text-slate-500">Saldo IVA</p>
                            <p class="text-lg font-black text-orange-500 stat-val">€ ${fix(tIV - tIA).toLocaleString()}</p>
                        </div>
                    </div>
                </div>`;
        }

        function generaReportProfessionale() {
            const f = document.getElementById('p-from').value;
            const t = document.getElementById('p-to').value;
            if(!f || !t) return alert("Seleziona date.");
            
            let dataFil = db.filter(r => r.data >= f && r.data <= t).sort((a,b) => a.data.localeCompare(b.data));
            let sL=0, sIV=0, sIA=0, sE=0, sC=0;
            
            dataFil.forEach(r => { sL+=r.lordoZ; sIV+=r.ivaV; sIA+=r.totIvaA; sE+=r.totEle; sC+=r.uscCash; });

            let h = `<div class="bg-white p-8 text-slate-900 border-2 border-slate-900 rounded-3xl mt-6">
                <h1 class="text-3xl font-black italic mb-1 uppercase tracking-tighter text-center">Commander <span class="text-blue-600">Elite</span> PRO</h1>
                <p class="text-center font-bold text-[10px] uppercase text-slate-400 mb-8 border-b pb-4">Prospetto Finanziario e Fiscale</p>
                
                <div class="grid grid-cols-2 gap-6 mb-10">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <p class="text-[9px] font-black text-slate-400 uppercase">Volume Affari (Z)</p>
                        <p class="text-2xl font-black">€ ${sL.toFixed(2)}</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <p class="text-[9px] font-black text-slate-400 uppercase">Debito IVA</p>
                        <p class="text-2xl font-black text-orange-600">€ ${fix(sIV - sIA).toFixed(2)}</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <h4 class="text-xs font-black uppercase mb-3 border-l-4 border-blue-600 pl-2">Riepilogo Flussi di Cassa</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span>Totale Incassi (Lordo):</span> <strong>€ ${sL.toFixed(2)}</strong></div>
                            <div class="flex justify-between"><span>Di cui Elettronici:</span> <strong>- € ${sE.toFixed(2)}</strong></div>
                            <div class="flex justify-between"><span>Spese Sostenute (Cash):</span> <strong>- € ${sC.toFixed(2)}</strong></div>
                            <div class="flex justify-between border-t-2 border-slate-900 pt-2 text-lg font-black">
                                <span>NETTO CONTANTI DA VERSARE:</span>
                                <span class="text-blue-600">€ ${fix((sL-sE)-sC).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="window.print()" class="no-print w-full bg-slate-900 text-white py-4 mt-10 rounded-xl font-black uppercase">Esporta o Stampa</button>
            </div>`;
            document.getElementById('area-stampa').innerHTML = h;
        }

        document.getElementById('data-lavoro').valueAsDate = new Date();
    </script>
</body>
</html>
