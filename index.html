<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COMMANDER V8 - SEAL EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 24px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        .input-commander { background: #070b14; border: 1px solid #1e293b; color: #fff; border-radius: 14px; padding: 12px; width: 100%; outline: none; font-weight: 700; transition: all 0.2s; }
        .input-commander:focus { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        .tab-btn { flex: 1; padding: 12px 5px; font-size: 9px; font-weight: 800; border-radius: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        .tab-btn.active { background: #3b82f6; color: white; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5); }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .scanline { width: 100%; height: 2px; background: rgba(59, 130, 246, 0.1); position: absolute; top: 0; animation: scan 4s linear infinite; pointer-events: none; }
        @keyframes scan { from { top: 0; } to { top: 100%; } }
        .glow-text { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .hidden { display: none !important; }
        
        /* Stili specifici per il report commercialista */
        @media print { 
            .no-print { display: none !important; } 
            body { background: white !important; color: black !important; padding: 0 !important; }
            .glass-card { border: none !important; box-shadow: none !important; background: white !important; color: black !important; }
            #fiscalReportTable { color: black !important; width: 100%; border-collapse: collapse; }
            #fiscalReportTable td, #fiscalReportTable th { border: 1px solid #ddd; padding: 8px; }
        }
    </style>
</head>
<body class="pb-56">
    <div class="scanline"></div>

    <div id="authScreen" class="fixed inset-0 z-[10000] bg-[#020617] flex items-center justify-center p-6">
        <div class="text-center space-y-8 p-10 glass-card w-full max-w-sm border-t-4 border-blue-600">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-4 shadow-[0_0_20px_#3b82f6]">
                    <span class="text-3xl">üî±</span>
                </div>
                <h1 class="text-3xl font-black italic text-white uppercase tracking-tighter">Commander <span class="text-blue-500">Seal</span></h1>
                <p class="text-[9px] text-slate-500 font-bold tracking-[0.3em] uppercase mt-2">Restricted Access</p>
            </div>
            <input type="password" id="pinInput" class="input-commander text-4xl text-center tracking-[0.5em]" placeholder="****" maxlength="4">
            <button onclick="checkAuth()" class="w-full bg-blue-600 py-5 rounded-2xl font-black hover:bg-blue-500 transition-all uppercase text-sm tracking-widest">Inizia Operazione</button>
        </div>
    </div>

    <div id="mainUI" class="hidden">
        <nav class="sticky top-0 z-50 bg-[#020617]/95 border-b border-slate-800 p-4 backdrop-blur-xl no-print">
            <div class="flex justify-between items-center max-w-4xl mx-auto">
                <div>
                    <div class="flex items-center gap-2">
                        <span id="opStatus" class="text-[9px] font-black text-blue-500 uppercase tracking-tighter">UNIT√Ä ATTIVA</span>
                        <div class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-ping"></div>
                    </div>
                    <p id="topDate" class="text-[10px] font-bold text-slate-400 uppercase mono"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="shareWhatsApp()" class="bg-green-600/10 text-green-500 px-4 py-2 rounded-xl border border-green-500/30 font-black text-[10px] uppercase">WhatsApp</button>
                    <button onclick="window.print()" class="bg-slate-800 text-slate-300 px-4 py-2 rounded-xl border border-slate-700 font-black text-[10px] uppercase">Print</button>
                </div>
            </div>
        </nav>

        <div class="p-4 space-y-4 max-w-4xl mx-auto">
            <div class="glass-card p-6 border-l-4 border-blue-500 relative overflow-hidden no-print">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Liquidit√† in Cassetta</p>
                        <h3 id="walletToDeposit" class="text-5xl font-black text-white mono glow-text italic">‚Ç¨ 0</h3>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-8 pt-6 border-t border-slate-800/50">
                    <div>
                        <p class="text-[9px] font-bold text-slate-500 uppercase italic">Netto Odierno</p>
                        <p id="netCashDisplay" class="text-2xl font-black text-green-400 mono">‚Ç¨ 0.00</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-1 p-1.5 bg-slate-900/50 rounded-2xl border border-slate-800 no-print">
                <button onclick="showTab('day')" id="btn-day" class="tab-btn active italic">Tactical</button>
                <button onclick="showTab('bank')" id="btn-bank" class="tab-btn italic">Banca</button>
                <button onclick="showTab('fiscal')" id="btn-fiscal" class="tab-btn italic text-amber-400">Report Fiscale</button>
                <button onclick="showTab('config')" id="btn-config" class="tab-btn italic text-blue-400">Settings</button>
            </div>

            <div id="sec-fiscal" class="hidden space-y-4">
                <div class="glass-card p-6 border-t-4 border-amber-600">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-black text-amber-500 uppercase italic">Archivio Fiscale Mensile</h3>
                        <div class="flex gap-2 no-print">
                            <select id="reportMonth" class="bg-slate-800 text-white text-[10px] px-3 py-2 rounded-lg font-bold outline-none border border-slate-700"></select>
                            <button onclick="generateFiscalReport()" class="bg-amber-600 text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase">Genera</button>
                        </div>
                    </div>

                    <div id="fiscalReportArea" class="space-y-6">
                        <div class="text-center py-10 text-slate-500 text-xs italic">
                            Seleziona un mese per generare il report per il commercialista.
                        </div>
                    </div>
                    
                    <div id="fiscalActions" class="hidden flex gap-2 mt-6 pt-6 border-t border-slate-800 no-print">
                        <button onclick="window.print()" class="flex-1 bg-slate-800 py-3 rounded-xl font-black text-[10px] uppercase text-white">üñ®Ô∏è Stampa PDF</button>
                        <button onclick="exportFiscalCSV()" class="flex-1 bg-slate-800 py-3 rounded-xl font-black text-[10px] uppercase text-white">üìä Esporta CSV</button>
                    </div>
                </div>
            </div>

            <div id="sec-day" class="space-y-4">
                <div class="glass-card p-6">
                    <div class="flex gap-2 mb-8 no-print justify-center">
                        <button onclick="changeDate(-1)" class="bg-slate-800 w-12 h-12 rounded-xl flex items-center justify-center font-bold text-blue-500 hover:bg-slate-700 transition">‚óÄ</button>
                        <input type="date" id="datePicker" class="input-commander text-center text-xs flex-1 border-none bg-slate-800/50" onchange="setDateFromPicker()">
                        <button onclick="changeDate(1)" class="bg-slate-800 w-12 h-12 rounded-xl flex items-center justify-center font-bold text-blue-500 hover:bg-slate-700 transition">‚ñ∂</button>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-[10px] font-black text-blue-500 uppercase tracking-[0.4em] mb-2 italic">Ingresso Fiscale (Z)</p>
                        <input type="number" id="total_sales" class="bg-transparent text-7xl font-black text-white w-full text-center outline-none mono mb-4" placeholder="0.00" oninput="runLogic()">
                        <div id="digitalInputs" class="grid grid-cols-2 gap-4 mt-4"></div>
                        <input type="number" id="acconti" placeholder="Acconti ‚Ç¨" class="hidden"> </div>
                </div>
                <div class="glass-card p-6 border-l-4 border-red-900">
                    <h4 class="text-[10px] font-black text-red-500 uppercase mb-6 tracking-widest flex items-center gap-2">üì¶ Logistica Uscite (Cash)</h4>
                    <div id="supList" class="space-y-3"></div>
                </div>
            </div>

            <div id="sec-bank" class="hidden space-y-4">
                <div class="glass-card p-4">
                    <p class="text-xs text-slate-500 font-bold uppercase mb-4">Storico per Versamenti</p>
                    <table class="w-full text-left text-[11px]" id="accountingTable">
                        <tbody id="accountingTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-config" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <button onclick="backupAndReset()" class="w-full bg-red-900/30 text-red-500 py-4 rounded-xl font-bold uppercase text-[10px]">Wipe All Data</button>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-6 bg-[#020617]/95 border-t border-slate-800 backdrop-blur-xl z-[100] no-print">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div id="theoCash" class="text-4xl font-black text-white mono italic glow-text">‚Ç¨ 0.00</div>
                <button onclick="saveData()" class="bg-blue-600 text-white font-black px-12 py-5 rounded-3xl shadow-[0_0_30px_rgba(59,130,246,0.5)] uppercase text-xs tracking-widest">Salva</button>
            </div>
        </div>
    </div>

    <script>
        let activeDate = new Date();
        const pin = "1234";
        let suppliers = JSON.parse(localStorage.getItem('om_suppliers_v8')) || ["Fornitore 1", "Spese Varie"];
        let digitalMethods = JSON.parse(localStorage.getItem('om_digital_v8')) || [{name:"POS", fee:1.2}, {name:"Satispay", fee:0.5}];

        // --- AUTH & CORE ---
        function checkAuth() {
            if(document.getElementById('pinInput').value === pin) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainUI').classList.remove('hidden');
                init();
            } else { alert("ACCESSO NEGATO."); }
        }

        function init() {
            populateMonthSelector();
            updateDateUI();
            renderDigitalInputs();
            renderSuppliers();
            loadDateData();
        }

        // --- LOGICA DI CALCOLO ---
        function runLogic() {
            const total = parseFloat(document.getElementById('total_sales').value) || 0;
            let totalDig = 0;
            document.querySelectorAll('.dig-amt').forEach(el => totalDig += parseFloat(el.value) || 0);
            
            let cashExp = 0;
            document.querySelectorAll('.sup-amt').forEach((el, i) => { 
                if(document.querySelectorAll('.sup-check')[i].checked) cashExp += parseFloat(el.value) || 0; 
            });

            const netCash = (total - totalDig - cashExp);
            document.getElementById('theoCash').innerText = `‚Ç¨ ${netCash.toFixed(2)}`;
            document.getElementById('netCashDisplay').innerText = `‚Ç¨ ${netCash.toFixed(2)}`;
            calculateGlobalCash();
        }

        function calculateGlobalCash() {
            let totalWallet = 0;
            for (let i = 0; i < localStorage.length; i++){
                let key = localStorage.key(i);
                if(key.startsWith('om_v8_')) {
                    let d = JSON.parse(localStorage.getItem(key));
                    let dig = (d.digitalVals || []).reduce((a,b)=>parseFloat(a||0)+parseFloat(b||0),0);
                    let exp = (d.supAmts || []).reduce((acc, v, idx) => acc + (d.supChecks[idx] ? parseFloat(v||0) : 0), 0);
                    totalWallet += (parseFloat(d.total)||0) - dig - exp;
                }
            }
            document.getElementById('walletToDeposit').innerText = `‚Ç¨ ${totalWallet.toFixed(0)}`;
        }

        // --- GESTIONE DATI ---
        function saveData() {
            const key = 'om_v8_' + activeDate.toISOString().split('T')[0];
            const data = {
                total: document.getElementById('total_sales').value,
                digitalVals: Array.from(document.querySelectorAll('.dig-amt')).map(e => e.value),
                supAmts: Array.from(document.querySelectorAll('.sup-amt')).map(e => e.value),
                supChecks: Array.from(document.querySelectorAll('.sup-check')).map(e => e.checked)
            };
            localStorage.setItem(key, JSON.stringify(data));
            alert("DATI ARCHIVIATI.");
            runLogic();
        }

        function loadDateData() {
            const key = 'om_v8_' + activeDate.toISOString().split('T')[0];
            const s = JSON.parse(localStorage.getItem(key));
            document.getElementById('total_sales').value = s ? s.total : "";
            document.querySelectorAll('.dig-amt').forEach((el, i) => el.value = (s && s.digitalVals) ? s.digitalVals[i] : "");
            document.querySelectorAll('.sup-amt').forEach((el, i) => el.value = (s && s.supAmts) ? s.supAmts[i] : "");
            document.querySelectorAll('.sup-check').forEach((el, i) => el.checked = (s && s.supChecks) ? s.supChecks[i] : false);
            runLogic();
        }

        // --- REPORT COMMERCIALISTA (LOGICA DEDICATA) ---
        function populateMonthSelector() {
            const sel = document.getElementById('reportMonth');
            const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
            const currentMonth = new Date().getMonth();
            months.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = m;
                if(i === currentMonth) opt.selected = true;
                sel.add(opt);
            });
        }

        function generateFiscalReport() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = new Date().getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let totalMonthZ = 0;
            let totalMonthCash = 0;
            let totalMonthElec = 0;
            let opDays = 0;

            let tableHtml = `
                <div class="bg-white text-black p-8 rounded-xl" id="printableReport">
                    <div class="border-b-2 border-black pb-4 mb-6">
                        <h2 class="text-2xl font-black uppercase">Report Corrispettivi</h2>
                        <p class="text-sm font-bold">Periodo: ${document.getElementById('reportMonth').options[month].text} ${year}</p>
                    </div>
                    <table class="w-full text-left mb-8" id="fiscalReportTable">
                        <thead>
                            <tr class="bg-gray-100"><th class="p-2">Data</th><th class="p-2">Tot. Z (Lordo)</th><th class="p-2">Elettronico</th><th class="p-2">Cash</th></tr>
                        </thead>
                        <tbody>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayData = JSON.parse(localStorage.getItem('om_v8_' + dateKey));
                
                if (dayData && parseFloat(dayData.total) > 0) {
                    opDays++;
                    const z = parseFloat(dayData.total) || 0;
                    const elec = (dayData.digitalVals || []).reduce((acc, v) => acc + (parseFloat(v) || 0), 0);
                    const cash = z - elec;
                    
                    totalMonthZ += z;
                    totalMonthElec += elec;
                    totalMonthCash += cash;

                    tableHtml += `<tr><td class="p-2 border-b">${d}/${month+1}</td><td class="p-2 border-b">‚Ç¨ ${z.toFixed(2)}</td><td class="p-2 border-b">‚Ç¨ ${elec.toFixed(2)}</td><td class="p-2 border-b">‚Ç¨ ${cash.toFixed(2)}</td></tr>`;
                }
            }

            tableHtml += `</tbody></table>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 border">
                        <p class="text-[10px] uppercase font-bold text-gray-500">Totale Corrispettivi</p>
                        <p class="text-xl font-black">‚Ç¨ ${totalMonthZ.toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-gray-50 border">
                        <p class="text-[10px] uppercase font-bold text-gray-500">Giorni Operativi</p>
                        <p class="text-xl font-black">${opDays}</p>
                    </div>
                    <div class="p-4 bg-gray-50 border">
                        <p class="text-[10px] uppercase font-bold text-gray-500">Totale Elettronico</p>
                        <p class="text-xl font-black text-blue-700">‚Ç¨ ${totalMonthElec.toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-gray-50 border">
                        <p class="text-[10px] uppercase font-bold text-gray-500">Totale Cash</p>
                        <p class="text-xl font-black text-green-700">‚Ç¨ ${totalMonthCash.toFixed(2)}</p>
                    </div>
                </div>
                <p class="mt-8 text-[9px] text-gray-400 italic font-mono uppercase">Generato da Commander V8 - Documento ad uso contabile interno</p>
            </div>`;

            document.getElementById('fiscalReportArea').innerHTML = tableHtml;
            document.getElementById('fiscalActions').classList.remove('hidden');
        }

        function exportFiscalCSV() {
            const rows = [["Data", "Corrispettivo Z", "Elettronico", "Cash"]];
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = new Date().getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const data = JSON.parse(localStorage.getItem('om_v8_' + dateKey));
                if(data) {
                    const z = parseFloat(data.total) || 0;
                    const elec = (data.digitalVals || []).reduce((acc, v) => acc + (parseFloat(v) || 0), 0);
                    rows.push([`${d}/${month+1}/${year}`, z, elec, z-elec]);
                }
            }

            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `Report_Fiscale_${month+1}_${year}.csv`);
            document.body.appendChild(link);
            link.click();
        }

        // --- NAVIGAZIONE ---
        function showTab(t) { 
            ['day','bank','fiscal','config'].forEach(s => {
                document.getElementById('sec-'+s).classList.add('hidden'); 
                document.getElementById('btn-'+s).classList.remove('active');
            }); 
            document.getElementById('sec-'+t).classList.remove('hidden'); 
            document.getElementById('btn-'+t).classList.add('active'); 
        }

        function updateDateUI() { 
            document.getElementById('datePicker').value = activeDate.toISOString().split('T')[0]; 
            document.getElementById('topDate').innerText = activeDate.toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long' }); 
        }

        function changeDate(v) { activeDate.setDate(activeDate.getDate()+v); updateDateUI(); loadDateData(); }
        function setDateFromPicker() { activeDate = new Date(document.getElementById('datePicker').value); updateDateUI(); loadDateData(); }

        function renderDigitalInputs() { 
            document.getElementById('digitalInputs').innerHTML = digitalMethods.map(m => `<div class="space-y-1"><label class="text-[8px] text-slate-500 uppercase font-black">${m.name}</label><input type="number" class="dig-amt input-commander text-center text-sm" oninput="runLogic()"></div>`).join(''); 
        }

        function renderSuppliers() { 
            document.getElementById('supList').innerHTML = suppliers.map(s => `<div class="flex items-center gap-3 bg-slate-800/20 p-4 rounded-2xl border border-slate-800/50"><span class="text-[10px] font-black text-slate-400 flex-1 uppercase">${s}</span><input type="number" class="sup-amt bg-transparent text-right text-sm font-black text-white w-20 outline-none" placeholder="0.00" oninput="runLogic()"><input type="checkbox" class="sup-check w-6 h-6 accent-blue-600 rounded" onchange="runLogic()"></div>`).join(''); 
        }

        function shareWhatsApp() { 
            const t = `*REPORT ${document.getElementById('topDate').innerText}*\nüí∞ Cash: ${document.getElementById('netCashDisplay').innerText}`; 
            window.open(`https://wa.me/?text=${encodeURIComponent(t)}`); 
        }
    </script>
</body>
</html>
