<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COMMANDER ELITE V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass-card { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 24px; }
        .input-commander { background: #0f172a; border: 1px solid #1e293b; color: #fff; border-radius: 14px; padding: 12px; width: 100%; outline: none; font-weight: 700; }
        .tab-btn { flex: 1; padding: 12px 5px; font-size: 8px; font-weight: 800; border-radius: 14px; color: #94a3b8; text-transform: uppercase; }
        .tab-btn.active { background: #3b82f6; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .mono { font-family: 'JetBrains Mono', monospace; }
        @media print { body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; color: black !important; background: white !important; } .no-print { display: none !important; } }
        .hidden { display: none !important; }
        .alert-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="pb-52">

    <div id="authScreen" class="fixed inset-0 z-[10000] bg-[#020617] flex items-center justify-center p-6">
        <div class="text-center space-y-8 p-10 glass-card w-full max-w-sm border-t-4 border-blue-600">
            <h1 class="text-4xl font-black italic text-white uppercase tracking-tighter">Commander <span class="text-blue-500">Elite</span></h1>
            <input type="password" id="pinInput" class="input-commander text-4xl text-center tracking-[0.5em]" placeholder="****" maxlength="4">
            <button onclick="checkAuth()" class="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase text-sm">Inizializza Terminale</button>
        </div>
    </div>

    <div id="mainUI" class="hidden">
        <nav class="sticky top-0 z-50 bg-[#020617]/90 border-b border-slate-800 p-5 flex justify-between items-center backdrop-blur-xl">
            <div>
                <p id="topDate" class="text-[10px] font-black text-blue-500 uppercase"></p>
                <div class="flex items-center gap-2">
                    <span id="deadlineAlert" class="hidden text-red-500 text-[10px] font-black uppercase alert-pulse">‚ö†Ô∏è Scadenze Oggi</span>
                    <h1 class="text-xl font-black italic text-white tracking-tighter uppercase">Financial Intelligence</h1>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="shareWhatsApp()" class="bg-green-600/20 text-green-500 p-2 rounded-xl border border-green-500/30">WA</button>
                <button onclick="window.print()" class="bg-blue-600/20 text-blue-500 p-2 rounded-xl border border-blue-500/30">PRINT</button>
            </div>
        </nav>

        <div class="p-4 space-y-4">
            <div class="glass-card p-6 bg-gradient-to-br from-slate-900 via-slate-900 to-blue-900/30">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-[10px] font-black text-slate-500 uppercase">Margine Netto Reale</p>
                    <div id="forecastTag" class="text-[9px] font-black bg-blue-500/20 text-blue-400 px-2 py-1 rounded">PROIEZIONE MESE: ‚Ç¨ 0</div>
                </div>
                <h3 id="netProfit" class="text-5xl font-black text-white mono">‚Ç¨ 0</h3>
                
                <div class="grid grid-cols-3 gap-2 mt-6 pt-6 border-t border-slate-800">
                    <div>
                        <p class="text-[8px] font-bold text-slate-500 uppercase">In Cassa</p>
                        <p id="netCashDisplay" class="text-sm font-black text-green-400 mono">‚Ç¨ 0.00</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Tasse Accr.</p>
                        <p id="taxReserve" class="text-sm font-black text-red-500 mono">‚Ç¨ 0</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Margine %</p>
                        <p id="marginPerc" class="text-sm font-black text-blue-400 mono">0%</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex gap-1 p-1 bg-slate-900 mx-4 rounded-2xl border border-slate-800">
            <button onclick="showTab('day')" id="btn-day" class="tab-btn active">Cassa</button>
            <button onclick="showTab('deadlines')" id="btn-deadlines" class="tab-btn">Scadenze</button>
            <button onclick="showTab('accounting')" id="btn-accounting" class="tab-btn">Bilancio</button>
            <button onclick="showTab('config')" id="btn-config" class="tab-btn">Setup</button>
        </div>

        <div id="sec-day" class="p-4 space-y-4">
            <div id="printArea">
                <div class="glass-card p-6 mb-4">
                    <div class="flex gap-2 mb-6 no-print">
                        <button onclick="changeDate(-1)" class="bg-slate-800 p-3 rounded-xl text-blue-500">‚óÄ</button>
                        <input type="date" id="datePicker" class="input-commander text-center text-xs flex-1 bg-transparent border-none" onchange="setDateFromPicker()">
                        <button onclick="changeDate(1)" class="bg-slate-800 p-3 rounded-xl text-blue-500">‚ñ∂</button>
                    </div>
                    
                    <div class="text-center mb-6">
                        <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Totale Corrispettivi (Z)</p>
                        <input type="number" id="total_sales" class="bg-transparent text-6xl font-black text-white w-full text-center outline-none mt-2" placeholder="0.00" oninput="runLogic()">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 no-print">
                        <input type="number" id="n_clients" placeholder="Clienti" class="input-commander text-center" oninput="runLogic()">
                        <input type="number" id="acconti" placeholder="Acconti +" class="input-commander text-center border-orange-900/30" oninput="runLogic()">
                    </div>
                </div>

                <div class="glass-card p-5 mb-4">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Digitali & App</h4>
                    <div id="digitalInputs" class="grid grid-cols-2 gap-4"></div>
                </div>

                <div class="glass-card p-5">
                    <h4 class="text-[10px] font-black text-red-400 uppercase mb-4 tracking-widest italic">Uscite Fornitori / Spese Oggi</h4>
                    <div id="supList" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <div id="sec-deadlines" class="p-4 hidden space-y-4">
            <div class="glass-card p-6">
                <h3 class="text-xs font-black text-blue-500 uppercase mb-4">Pianificazione Scadenze</h3>
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <input type="text" id="deadName" class="input-commander text-xs flex-1" placeholder="Es: F24 Tasse">
                        <input type="number" id="deadDay" class="input-commander text-xs w-16" placeholder="GG">
                    </div>
                    <input type="number" id="deadAmt" class="input-commander text-xs" placeholder="Importo Previsto ‚Ç¨">
                    <button onclick="addDeadline()" class="w-full bg-blue-600 py-3 rounded-xl font-bold uppercase text-xs">Salva Scadenza Ciclica</button>
                </div>
                <div id="deadlineList" class="mt-6 space-y-2"></div>
            </div>
        </div>

        <div id="sec-accounting" class="p-4 hidden space-y-4">
            <div class="glass-card overflow-hidden">
                <table class="w-full text-[10px] text-left">
                    <thead class="bg-slate-900 text-slate-400">
                        <tr><th class="p-3">Data</th><th class="p-3">Ricavo</th><th class="p-3">Spese</th><th class="p-3 text-right">Utile</th></tr>
                    </thead>
                    <tbody id="accountingTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-config" class="p-4 hidden space-y-4">
            <div class="glass-card p-6">
                <h3 class="text-xs font-black text-blue-500 uppercase mb-4">Parametri Master</h3>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="fixed_costs" class="input-commander text-xs" placeholder="Costi Fissi ‚Ç¨">
                    <input type="number" id="tax_rate" class="input-commander text-xs" placeholder="Tasse %">
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-xs font-black text-blue-500 uppercase mb-4">Gestione Metodi Digitali</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newDigitalName" class="input-commander text-xs flex-1" placeholder="Nome">
                    <input type="number" id="newDigitalFee" class="input-commander text-xs w-20" placeholder="%">
                    <button onclick="addDigitalMethod()" class="bg-blue-600 px-4 rounded-xl font-bold">+</button>
                </div>
                <div id="digitalMethodsList" class="space-y-2"></div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-xs font-black text-blue-500 uppercase mb-4">Anagrafica Fornitori</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newSupName" class="input-commander text-xs flex-1" placeholder="Nome Fornitore">
                    <button onclick="addSupplier()" class="bg-blue-600 px-4 rounded-xl font-bold">+</button>
                </div>
                <div id="manageSuppliers" class="space-y-2"></div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-6 bg-[#020617]/95 border-t border-slate-800 backdrop-blur-xl flex justify-between items-center z-[100] no-print">
            <div class="space-y-1">
                <p class="text-[9px] font-black text-slate-500 uppercase">Da versare stasera</p>
                <div id="theoCash" class="text-4xl font-black text-white mono">‚Ç¨ 0.00</div>
            </div>
            <button onclick="saveData()" class="bg-blue-600 text-white font-black px-12 py-5 rounded-3xl shadow-xl uppercase text-xs transition-transform active:scale-95">Archivia</button>
        </div>
    </div>

    <script>
        let activeDate = new Date();
        const commanderPin = "1234";

        let suppliers = JSON.parse(localStorage.getItem('om_suppliers_v4')) || ["Pane", "Beverage", "Cassa"];
        let digitalMethods = JSON.parse(localStorage.getItem('om_digital_v4')) || [
            { name: "Bancomat", fee: 1.2 },
            { name: "Satispay", fee: 0.5 },
            { name: "Delivery", fee: 30 }
        ];
        let deadlines = JSON.parse(localStorage.getItem('om_deadlines_v4')) || [];

        function checkAuth() {
            if(document.getElementById('pinInput').value === commanderPin) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainUI').classList.remove('hidden');
                init();
            } else { alert("PIN ERRATO"); }
        }

        function init() {
            updateDateUI();
            loadSettings();
            renderSuppliers();
            renderDigitalInputs();
            renderDeadlines();
            loadDateData();
            updateSetupLists();
            checkTodayDeadlines();
        }

        function loadSettings() {
            ['fixed_costs', 'tax_rate'].forEach(k => {
                if(localStorage.getItem('set_'+k)) document.getElementById(k).value = localStorage.getItem('set_'+k);
            });
        }

        function renderDigitalInputs() {
            const container = document.getElementById('digitalInputs');
            container.innerHTML = digitalMethods.map(m => `
                <div class="space-y-1">
                    <label class="text-[8px] text-slate-500 uppercase ml-1">${m.name}</label>
                    <input type="number" class="dig-amt input-commander text-sm" data-name="${m.name}" data-fee="${m.fee}" oninput="runLogic()">
                </div>
            `).join('');
        }

        function renderSuppliers() {
            const container = document.getElementById('supList');
            container.innerHTML = suppliers.map(s => `
                <div class="flex items-center gap-3 bg-slate-800/20 p-4 rounded-2xl border border-slate-800/50">
                    <span class="text-[11px] font-black text-slate-400 flex-1 uppercase">${s}</span>
                    <input type="number" class="sup-amt bg-transparent text-right text-sm font-black outline-none text-white w-24" placeholder="0.00" oninput="runLogic()">
                    <input type="checkbox" class="sup-check w-6 h-6 accent-blue-600" onchange="runLogic()">
                </div>
            `).join('');
        }

        function runLogic() {
            localStorage.setItem('set_fixed_costs', document.getElementById('fixed_costs').value);
            localStorage.setItem('set_tax_rate', document.getElementById('tax_rate').value);

            const total = parseFloat(document.getElementById('total_sales').value) || 0;
            const taxR = parseFloat(document.getElementById('tax_rate').value) || 0;
            const fCosts = parseFloat(document.getElementById('fixed_costs').value) || 0;

            let totalDig = 0; let totalFees = 0;
            document.querySelectorAll('.dig-amt').forEach(el => {
                const val = parseFloat(el.value) || 0;
                const fee = parseFloat(el.dataset.fee) || 0;
                totalDig += val;
                totalFees += (val * (fee/100));
            });

            let cashExp = 0;
            document.querySelectorAll('.sup-amt').forEach((el, i) => {
                if(document.querySelectorAll('.sup-check')[i].checked) cashExp += parseFloat(el.value) || 0;
            });

            const acconti = parseFloat(document.getElementById('acconti').value) || 0;
            const netCash = (total - totalDig - cashExp) + acconti;
            const taxAmt = total * (taxR / 100);
            
            // Margine Netto Operativo Giornaliero
            const netProfitVal = total - taxAmt - totalFees - cashExp - (fCosts/30);
            const marginPerc = total > 0 ? (netProfitVal / total * 100) : 0;

            document.getElementById('theoCash').innerText = `‚Ç¨ ${netCash.toFixed(2)}`;
            document.getElementById('netCashDisplay').innerText = `‚Ç¨ ${netCash.toFixed(2)}`;
            document.getElementById('taxReserve').innerText = `‚Ç¨ ${taxAmt.toFixed(0)}`;
            document.getElementById('netProfit').innerText = `‚Ç¨ ${Math.round(netProfitVal)}`;
            document.getElementById('marginPerc').innerText = `${marginPerc.toFixed(1)}%`;

            calculateForecasting(total);
        }

        function calculateForecasting(currentTotal) {
            let totalMonthSoFar = 0;
            let daysActive = 0;
            const curMonth = activeDate.getMonth();
            for(let i=1; i<=31; i++) {
                let k = 'om_v4_' + `${activeDate.getFullYear()}-${String(curMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                let val = parseFloat(JSON.parse(localStorage.getItem(k) || '{"total":0}').total) || 0;
                if(val > 0) { totalMonthSoFar += val; daysActive++; }
            }
            const avg = daysActive > 0 ? (totalMonthSoFar / daysActive) : currentTotal;
            const forecast = avg * 30;
            document.getElementById('forecastTag').innerText = `PROIEZIONE MESE: ‚Ç¨ ${forecast.toFixed(0)}`;
        }

        function checkTodayDeadlines() {
            const today = activeDate.getDate();
            const alertTag = document.getElementById('deadlineAlert');
            const match = deadlines.filter(d => parseInt(d.day) === today);
            if(match.length > 0) {
                alertTag.classList.remove('hidden');
                alertTag.innerText = `‚ö†Ô∏è ${match[0].name} (‚Ç¨ ${match[0].amt})`;
            } else { alertTag.classList.add('hidden'); }
        }

        function addDeadline() {
            const name = document.getElementById('deadName').value;
            const day = document.getElementById('deadDay').value;
            const amt = document.getElementById('deadAmt').value;
            if(name && day && amt) {
                deadlines.push({ name, day, amt });
                localStorage.setItem('om_deadlines_v4', JSON.stringify(deadlines));
                document.getElementById('deadName').value = "";
                document.getElementById('deadDay').value = "";
                document.getElementById('deadAmt').value = "";
                renderDeadlines();
                checkTodayDeadlines();
            }
        }

        function renderDeadlines() {
            const list = document.getElementById('deadlineList');
            list.innerHTML = deadlines.map((d, i) => `
                <div class="flex justify-between items-center bg-slate-900 p-3 rounded-xl border border-slate-800">
                    <div class="text-[10px] font-bold">
                        <span class="text-blue-400">Giorno ${d.day}</span>: ${d.name} <br>
                        <span class="text-slate-500">‚Ç¨ ${d.amt}</span>
                    </div>
                    <button onclick="removeDeadline(${i})" class="text-red-500 text-[10px] font-black uppercase">X</button>
                </div>
            `).join('');
        }

        function removeDeadline(idx) { deadlines.splice(idx,1); localStorage.setItem('om_deadlines_v4', JSON.stringify(deadlines)); renderDeadlines(); }

        function shareWhatsApp() {
            const date = document.getElementById('topDate').innerText;
            const total = document.getElementById('total_sales').value;
            const cash = document.getElementById('theoCash').innerText;
            const profit = document.getElementById('netProfit').innerText;
            const text = `*COMMANDER ELITE REPORT*\nüìÖ ${date}\nüí∞ Totale Z: ‚Ç¨ ${total}\nüíµ Cash: ${cash}\nüìà Utile: ${profit}\n------------------\n‚úÖ Bilancio Archiviato.`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }

        function saveData() {
            const key = 'om_v4_' + activeDate.toISOString().split('T')[0];
            const data = {
                total: document.getElementById('total_sales').value,
                clients: document.getElementById('n_clients').value,
                acconti: document.getElementById('acconti').value,
                digitalVals: Array.from(document.querySelectorAll('.dig-amt')).map(e => e.value),
                supAmts: Array.from(document.querySelectorAll('.sup-amt')).map(e => e.value),
                supChecks: Array.from(document.querySelectorAll('.sup-check')).map(e => e.checked)
            };
            localStorage.setItem(key, JSON.stringify(data));
            alert("SISTEMA SINCRONIZZATO");
            runLogic();
        }

        function loadDateData() {
            const key = 'om_v4_' + activeDate.toISOString().split('T')[0];
            const s = JSON.parse(localStorage.getItem(key));
            document.querySelectorAll('input[type="number"]').forEach(i => { if(!['tax_rate','fixed_costs','deadDay','deadAmt','newDigitalFee'].includes(i.id)) i.value = ""; });
            document.querySelectorAll('.sup-check').forEach(c => c.checked = false);
            if(s) {
                document.getElementById('total_sales').value = s.total;
                document.getElementById('n_clients').value = s.clients || "";
                document.getElementById('acconti').value = s.acconti || "";
                const digInputs = document.querySelectorAll('.dig-amt');
                s.digitalVals?.forEach((v, i) => { if(digInputs[i]) digInputs[i].value = v; });
                const amts = document.querySelectorAll('.sup-amt');
                const checks = document.querySelectorAll('.sup-check');
                s.supAmts.forEach((v, i) => { if(amts[i]) amts[i].value = v; });
                s.supChecks.forEach((v, i) => { if(checks[i]) checks[i].checked = v; });
            }
            runLogic();
        }

        function showTab(tab) {
            ['day', 'deadlines', 'accounting', 'config'].forEach(t => {
                document.getElementById('sec-'+t).classList.add('hidden');
                document.getElementById('btn-'+t).classList.remove('active');
            });
            document.getElementById('sec-'+tab).classList.remove('hidden');
            document.getElementById('btn-'+tab).classList.add('active');
            if(tab === 'accounting') updateAccountingTable();
        }

        function updateAccountingTable() {
            const body = document.getElementById('accountingTableBody');
            body.innerHTML = "";
            const curM = activeDate.getMonth();
            for(let i=1; i<=31; i++) {
                const dateStr = `${activeDate.getFullYear()}-${String(curM+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const data = JSON.parse(localStorage.getItem('om_v4_' + dateStr));
                if(data) {
                    let totalExp = data.supAmts.reduce((acc, v, idx) => acc + (data.supChecks[idx] ? parseFloat(v||0) : 0), 0);
                    body.innerHTML += `
                        <tr class="border-b border-slate-800">
                            <td class="p-3">${i}/${curM+1}</td>
                            <td class="p-3">‚Ç¨ ${data.total}</td>
                            <td class="p-3 text-red-500">‚Ç¨ ${totalExp.toFixed(0)}</td>
                            <td class="p-3 text-right font-bold text-blue-400">‚Ç¨ ${(data.total - totalExp).toFixed(0)}</td>
                        </tr>
                    `;
                }
            }
        }

        function addDigitalMethod() {
            const name = document.getElementById('newDigitalName').value;
            const fee = document.getElementById('newDigitalFee').value;
            if(name && fee) { digitalMethods.push({ name, fee: parseFloat(fee) }); localStorage.setItem('om_digital_v4', JSON.stringify(digitalMethods)); location.reload(); }
        }

        function addSupplier() {
            const name = document.getElementById('newSupName').value;
            if(name) { suppliers.push(name); localStorage.setItem('om_suppliers_v4', JSON.stringify(suppliers)); location.reload(); }
        }

        function updateSetupLists() {
            document.getElementById('digitalMethodsList').innerHTML = digitalMethods.map((m, i) => `
                <div class="flex justify-between items-center bg-slate-900 p-2 rounded-lg border border-slate-800 text-[10px]">
                    <span>${m.name} (${m.fee}%)</span>
                    <button onclick="removeDigital(${i})" class="text-red-500">Elimina</button>
                </div>
            `).join('');
            document.getElementById('manageSuppliers').innerHTML = suppliers.map((s, i) => `
                <div class="flex justify-between items-center bg-slate-900 p-2 rounded-lg border border-slate-800 text-[10px]">
                    <span>${s.toUpperCase()}</span>
                    <button onclick="removeSup(${i})" class="text-red-500">Elimina</button>
                </div>
            `).join('');
        }

        function removeDigital(idx) { digitalMethods.splice(idx, 1); localStorage.setItem('om_digital_v4', JSON.stringify(digitalMethods)); location.reload(); }
        function removeSup(idx) { suppliers.splice(idx, 1); localStorage.setItem('om_suppliers_v4', JSON.stringify(suppliers)); location.reload(); }
        function updateDateUI() { document.getElementById('datePicker').value = activeDate.toISOString().split('T')[0]; document.getElementById('topDate').innerText = activeDate.toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long' }); }
        function changeDate(days) { activeDate.setDate(activeDate.getDate() + days); updateDateUI(); loadDateData(); checkTodayDeadlines(); }
        function setDateFromPicker() { activeDate = new Date(document.getElementById('datePicker').value); updateDateUI(); loadDateData(); checkTodayDeadlines(); }
        function backupAndReset() { if(confirm("CANCELLARE TUTTI I DATI?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
