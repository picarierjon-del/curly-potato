<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Contabilit√† Mobile ‚Äì Modern Pro IVA</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1117; --panel:#171a22; --panel-2:#1b1f2b; --border:#23283a;
      --text:#e7eaf0; --muted:#9aa4b2; --accent:#6c7bff; --accent2:#35d9a3; --danger:#ff6b6b;
    }
    html,body{height:100%;}
    body{background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;}
    .wrap{max-width:480px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column;}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:16px;}
    .panel-2{background:var(--panel-2); border:1px solid var(--border); border-radius:16px;}
    .btn{background:var(--accent); color:white; padding:10px 14px; border-radius:12px; font-weight:700;}
    .btn-ghost{background:transparent; border:1px solid var(--border); color:#cfd5df; padding:10px 14px; border-radius:12px;}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#121625; font-size:12px;}
    .input, select, textarea{background:#0f1320; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:10px 12px; width:100%;}
    .input:focus, select:focus, textarea:focus{outline:1px solid var(--accent);}
    .kpi .title{color:var(--muted); font-size:12px;}
    .kpi .value{font-size:26px; font-weight:800; letter-spacing:-0.2px;}
    .nav{position:sticky; bottom:0; left:0; right:0; background:rgba(15,17,23,.9); backdrop-filter:blur(8px); border-top:1px solid var(--border);}
    .navbtn{flex:1; text-align:center; padding:8px 0; font-size:13px; color:#a3aab7;}
    .navbtn.active{color:#aab3ff; font-weight:700;}
    .fabbar{position:fixed; bottom:72px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:40;}
    .fab{padding:12px 14px; border-radius:999px; color:white; font-weight:800; box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .fab.in{background:#10b981;} .fab.out{background:#ef4444;}
    dialog::backdrop{background:rgba(0,0,0,.55);}
    .modal{width:min(520px,92vw); background:#0d1018; border:1px solid var(--border); border-radius:16px; color:var(--text);}
    .modal-h{padding:14px 16px; border-bottom:1px solid var(--border); font-weight:800;}
    .modal-b{padding:16px;}
    .modal-f{padding:16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;}
    .table th{color:#c4cad6; padding:10px 8px; font-weight:600; text-align:left; border-bottom:1px solid var(--border);}
    .table td{padding:10px 8px; border-bottom:1px solid #22273a;}
  </style>
</head>
<body>
<div id="app" class="wrap">

  <!-- BANNER GIORNALIERO SCADENZE -->
  <div v-if="banner.items.length" class="panel mx-4 mt-3 p-3 flex items-start gap-3">
    <div class="text-xl">üîî</div>
    <div class="flex-1">
      <div class="font-semibold">Promemoria di oggi</div>
      <div class="text-sm text-[#cbd5e1]">
        <span v-if="banner.today.length">Oggi: {{ banner.today.map(e=>e.title).join(', ') }}.</span>
        <span v-if="banner.soon.length"> In arrivo (7gg): {{ banner.soon.map(e=>`${e.title} (${e.dday}g)`).join(', ') }}.</span>
        <span v-if="banner.overdue.length" class="text-rose-300"> Scaduti: {{ banner.overdue.map(e=>e.title).join(', ') }}!</span>
      </div>
    </div>
    <button class="btn-ghost" @click="dismissBannerToday">OK</button>
  </div>

  <!-- HEADER -->
  <header class="px-4 pt-4 pb-2 flex items-center justify-between">
    <div>
      <div class="text-xs text-[#9aa4b2]">{{ headerSubtitle }}</div>
      <h1 class="text-xl font-extrabold tracking-tight">{{ headerTitle }}</h1>
    </div>
    <div class="flex gap-2">
      <button class="btn-ghost text-sm" @click="exportCSV">CSV</button>
      <button class="btn-ghost text-sm" @click="exportPDF">PDF</button>
    </div>
  </header>

  <!-- CONTENUTO -->
  <main class="flex-1 overflow-y-auto px-4 pb-28 space-y-4">

    <!-- HOME -->
    <section v-if="view==='home'">
      <!-- Pill categorie dinamiche -->
      <div class="text-xs text-[#9aa4b2] mb-1">Categorie</div>
      <div class="flex flex-wrap gap-2">
        <button class="chip"
          :class="{'border-blue-400 text-blue-300': !filters.category}"
          @click="filters.category=null">Tutte</button>
        <button v-for="c in categories" :key="c" class="chip"
          :class="{'border-blue-400 text-blue-300': filters.category===c}"
          @click="filters.category = (filters.category===c?null:c)">
          {{ c }}
        </button>
      </div>

      <!-- KPI -->
      <div class="grid grid-cols-2 gap-3 mt-3">
        <div class="panel p-4 kpi text-center">
          <div class="title">Reddito (Entrate)</div>
          <div class="value text-emerald-400">{{ fmtEUR(kpi.totEntrate) }}</div>
        </div>
        <div class="panel p-4 kpi text-center">
          <div class="title">Spese (Uscite)</div>
          <div class="value text-rose-400">{{ fmtEUR(kpi.totSpese) }}</div>
        </div>
      </div>
      <div class="panel p-4 kpi text-center">
        <div class="title">Risparmi</div>
        <div class="value text-amber-300">{{ fmtEUR(kpi.risparmi) }}</div>
      </div>

      <!-- Grafico bar E vs U -->
      <div class="panel p-3">
        <div class="text-xs text-[#9aa4b2] mb-1">Entrate vs Uscite</div>
        <canvas id="chartHome" height="160"></canvas>
      </div>

      <!-- Grafico torta ripartizione categorie -->
      <div class="panel p-3">
        <div class="text-xs text-[#9aa4b2] mb-1">Ripartizione per categoria</div>
        <canvas id="chartPie" height="180"></canvas>
      </div>

      <!-- Ultimi movimenti -->
      <div class="panel p-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs text-[#9aa4b2]">Ultimi movimenti</div>
          <button class="btn-ghost text-xs" @click="switchView('summary')">Vedi tutto ‚Üí</button>
        </div>
        <div v-for="r in lastRows" :key="r.id" class="flex items-center justify-between py-2 border-b border-[#23283a] last:border-0">
          <div>
            <div class="font-semibold text-sm">{{ r.Categoria || '‚Äî' }}</div>
            <div class="text-xs text-[#9aa4b2]">{{ r.Data }} ‚Ä¢ {{ r.Tipo }}</div>
          </div>
          <div class="text-right">
            <div :class="r.Tipo==='entrata'?'text-emerald-400':'text-rose-400'">{{ fmtEUR(r.ImportoNetto || r.Importo) }}</div>
            <div class="text-[11px] text-[#9aa4b2]">IVA: {{ fmtEUR(r.ImportoIVA || 0) }}</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIEPILOGO -->
    <section v-if="view==='summary'">
      <!-- Selettori mese/anno -->
      <div class="panel p-3">
        <div class="grid grid-cols-2 gap-2">
          <select v-model="filters.year">
            <option v-for="y in years" :key="y" :value="y">{{ y }}</option>
          </select>
          <select v-model="filters.month">
            <option v-for="(m,i) in months" :key="m" :value="i">{{ m }}</option>
          </select>
        </div>
      </div>

      <!-- KPI dettagliati -->
      <div class="grid grid-cols-2 gap-3">
        <div class="panel p-3 text-center">
          <div class="title">IVA a Debito</div>
          <div class="value text-indigo-300">{{ fmtEUR(kpi.ivaDebito) }}</div>
        </div>
        <div class="panel p-3 text-center">
          <div class="title">IVA a Credito</div>
          <div class="value text-cyan-300">{{ fmtEUR(kpi.ivaCredito) }}</div>
        </div>
      </div>
      <div class="panel p-3 text-center">
        <div class="title">IVA da Versare</div>
        <div class="value text-amber-300">{{ fmtEUR(kpi.ivaDaVersare) }}</div>
      </div>

      <!-- Grafico annuale -->
      <div class="panel p-4">
        <div class="text-xs text-[#9aa4b2] mb-1">Trend annuale</div>
        <canvas id="chartYear" height="200"></canvas>
      </div>

      <!-- Tabella completa -->
      <div class="panel p-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs text-[#9aa4b2]">Movimenti mese</div>
          <div class="text-xs text-[#9aa4b2]">{{ filteredRows.length }} righe</div>
        </div>
        <div class="overflow-x-auto">
          <table class="table w-full text-sm">
            <thead>
              <tr>
                <th>Data</th><th>Tipo</th><th>Lordo</th><th>IVA</th><th>Netto</th><th>Categoria</th><th>Conto</th><th>Note</th><th></th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="r in filteredRows" :key="r.id">
                <td>{{ r.Data }}</td>
                <td :class="r.Tipo==='entrata'?'text-emerald-300':'text-rose-300'">{{ r.Tipo }}</td>
                <td>{{ fmtEUR(r.Importo) }}</td>
                <td>{{ fmtEUR(r.ImportoIVA || 0) }} ({{ r.IVA }}%)</td>
                <td>{{ fmtEUR(r.ImportoNetto || r.Importo) }}</td>
                <td>{{ r.Categoria }}</td>
                <td>{{ r.Conto }}</td>
                <td class="truncate max-w-[120px]" :title="r.Note">{{ r.Note }}</td>
                <td class="text-right">
                  <button class="btn-ghost text-xs" @click="openEdit(r)">‚úèÔ∏è</button>
                  <button class="btn-ghost text-xs" @click="removeRow(r.id)">üóëÔ∏è</button>
                </td>
              </tr>
              <tr v-if="!filteredRows.length">
                <td colspan="9" class="text-center text-[#9aa4b2] py-4">Nessuna voce nel mese selezionato</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SCADENZE -->
    <section v-if="view==='events'">
      <div class="flex items-center justify-between">
        <div class="text-xs text-[#9aa4b2]">Scadenze & Promemoria</div>
        <button class="btn text-sm" @click="openEvent()">+ Nuova</button>
      </div>
      <div v-for="e in sortedEvents" :key="e.id" class="panel-2 p-3 mt-3 flex items-start justify-between">
        <div>
          <div class="font-semibold">{{ e.title }}</div>
          <div class="text-xs text-[#9aa4b2]">{{ e.date }} ‚Ä¢ {{ e.kind }} <span v-if="e.repeat">‚Ä¢ üîÅ {{ repeatLabel(e.repeat) }}</span></div>
          <div class="mt-1">
            <span class="chip" :class="deadlineClass(e)">{{ deadlineLabel(e) }}</span>
            <span v-if="e.done" class="chip border-green-400 text-green-300 ml-2">Completato</span>
          </div>
          <div v-if="e.fileName" class="text-xs mt-1">
            üìé <a :href="e.fileData" :download="e.fileName" class="underline text-indigo-400">{{ e.fileName }}</a>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-ghost text-xs" @click="openEvent(e)">‚úèÔ∏è</button>
          <button class="btn-ghost text-xs" @click="deleteEvent(e.id)">üóëÔ∏è</button>
        </div>
      </div>
      <div v-if="!sortedEvents.length" class="text-center text-[#9aa4b2] text-sm mt-6">Nessuna scadenza</div>
    </section>

    <!-- IMPOSTAZIONI -->
    <section v-if="view==='settings'">
      <div class="panel p-4 space-y-3">
        <label class="flex items-center gap-2">
          <input type="checkbox" v-model="settings.proactive"> <span>Modalit√† proattiva</span>
        </label>
        <div>
          <div class="text-xs text-[#9aa4b2] mb-1">Budget spese (‚Ç¨)</div>
          <input type="number" class="input" v-model.number="settings.budgetSpese">
        </div>
        <div>
          <div class="text-xs text-[#9aa4b2] mb-1">Soglia IVA (‚Ç¨)</div>
          <input type="number" class="input" v-model.number="settings.ivaThreshold">
        </div>

        <div class="flex gap-2 pt-2">
          <input type="file" accept=".csv" class="hidden" ref="csvInput" @change="importCSV">
          <button class="btn-ghost" @click="$refs.csvInput.click()">üìÇ Importa CSV</button>
          <button class="btn-ghost" @click="exportCSV">üì§ Esporta CSV</button>
          <button class="btn-ghost" @click="exportPDF">üìÑ Esporta PDF</button>
          <button class="btn bg-rose-600 hover:bg-rose-500" @click="clearAll">üßπ Svuota tutto</button>
        </div>
      </div>
    </section>
  </main>

  <!-- FAB (Entrata/Uscita) -->
  <div class="fabbar">
    <button class="fab in"  @click="openTx('entrata')">+ Entrata</button>
    <button class="fab out" @click="openTx('spesa')">- Uscita</button>
  </div>

  <!-- NAV BOTTOM -->
  <nav class="nav px-2 pt-2 pb-[calc(env(safe-area-inset-bottom)+6px)] flex gap-1">
    <div class="navbtn" :class="{active:view==='home'}" @click="switchView('home')">üè†<br><span>Home</span></div>
    <div class="navbtn" :class="{active:view==='summary'}" @click="switchView('summary')">üìä<br><span>Riepilogo</span></div>
    <div class="navbtn" :class="{active:view==='events'}" @click="switchView('events')">‚è∞<br><span>Scadenze</span></div>
    <div class="navbtn" :class="{active:view==='settings'}" @click="switchView('settings')">‚öôÔ∏è<br><span>Impostazioni</span></div>
  </nav>

  <!-- MODALE: Nuovo/Modifica movimento con IVA -->
  <dialog ref="dlgTx" class="modal">
    <div class="modal-h">{{ txDraft.id ? 'Modifica movimento' : (txDraft.Tipo==='entrata' ? 'Nuova Entrata' : 'Nuova Uscita') }}</div>
    <div class="modal-b space-y-3">
      <div class="grid grid-cols-2 gap-2">
        <input type="date" class="input" v-model="txDraft.Data">
        <select class="input" v-model="txDraft.Tipo">
          <option value="entrata">Entrata</option>
          <option value="spesa">Uscita</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div>
          <div class="text-xs text-[#9aa4b2] mb-1">Importo lordo (‚Ç¨)</div>
          <input type="number" step="0.01" class="input" v-model.number="txDraft.Importo">
        </div>
        <div>
          <div class="text-xs text-[#9aa4b2] mb-1">IVA % (rapida o personalizzata)</div>
          <div class="flex gap-2">
            <select class="input" v-model.number="presetIVA">
              <option :value="null">‚Äî</option>
              <option :value="0">0%</option>
              <option :value="4">4%</option>
              <option :value="5">5%</option>
              <option :value="10">10%</option>
              <option :value="22">22%</option>
            </select>
            <input type="number" step="0.1" class="input" v-model.number="txDraft.IVA" placeholder="IVA %">
          </div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <div class="panel-2 p-2 rounded-md text-center">
          <div class="text-[11px] text-[#9aa4b2]">Netto</div>
          <div class="font-bold">{{ fmtEUR(calcNetto(txDraft)) }}</div>
        </div>
        <div class="panel-2 p-2 rounded-md text-center">
          <div class="text-[11px] text-[#9aa4b2]">IVA</div>
          <div class="font-bold">{{ fmtEUR(calcIVA(txDraft)) }}</div>
        </div>
        <div class="panel-2 p-2 rounded-md text-center">
          <div class="text-[11px] text-[#9aa4b2]">{{ txDraft.Tipo==='entrata' ? 'IVA Debito' : 'IVA Credito' }}</div>
          <div class="font-bold">{{ fmtEUR(calcIVA(txDraft)) }}</div>
        </div>
      </div>

      <input class="input" v-model="txDraft.Categoria" list="cats" placeholder="Categoria">
      <datalist id="cats"><option v-for="c in categories" :key="c" :value="c"></option></datalist>

      <div class="grid grid-cols-2 gap-2">
        <input class="input" v-model="txDraft.Conto" placeholder="Conto (POS, Contanti, Banca...)">
        <input class="input" v-model="txDraft.Attivita" placeholder="Attivit√† (Negozio, Online...)">
      </div>

      <textarea class="input" rows="2" v-model="txDraft.Note" placeholder="Note / Descrizione"></textarea>
    </div>
    <div class="modal-f">
      <button class="btn-ghost" @click="$refs.dlgTx.close()">Annulla</button>
      <button class="btn" @click="saveTx">Salva</button>
    </div>
  </dialog>

  <!-- MODALE: Scadenza -->
  <dialog ref="dlgEvent" class="modal">
    <div class="modal-h">{{ eventDraft.id ? 'Modifica scadenza' : 'Nuova scadenza' }}</div>
    <div class="modal-b space-y-3">
      <input class="input" v-model="eventDraft.title" placeholder="Titolo (es. IVA 4¬∞ trim / Assicurazione auto)">
      <input type="date" class="input" v-model="eventDraft.date">
      <select class="input" v-model="eventDraft.kind">
        <option>Fiscale</option><option>Assicurazione</option><option>Bolletta</option><option>Compleanno</option><option>Altro</option>
      </select>
      <select class="input" v-model="eventDraft.repeat">
        <option value="">Nessuna ricorrenza</option>
        <option value="month">Mensile</option>
        <option value="quarter">Trimestrale</option>
        <option value="year">Annuale</option>
      </select>
      <label class="flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="eventDraft.done"> Completato
      </label>
      <input type="file" @change="attachFile($event)">
      <div v-if="eventDraft.fileName" class="text-xs">
        üìé <a :href="eventDraft.fileData" :download="eventDraft.fileName" class="underline text-indigo-400">{{ eventDraft.fileName }}</a>
      </div>
    </div>
    <div class="modal-f">
      <button class="btn-ghost" @click="$refs.dlgEvent.close()">Annulla</button>
      <button class="btn" @click="saveEvent">Salva</button>
    </div>
  </dialog><script>
const { createApp } = Vue

createApp({
  data() {
    return {
      view: 'home',
      months: ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'],
      filters: { category:null, month:new Date().getMonth(), year:new Date().getFullYear() },
      rows: [],
      events: [],
      settings: { proactive:true, budgetSpese:0, ivaThreshold:0 },
      txDraft: {},
      eventDraft: {},
      presetIVA: null,
      banner: { items:[], today:[], soon:[], overdue:[] },
      charts: {},
    }
  },
  computed:{
    headerTitle(){ return this.view==='home'?'Dashboard':this.view==='summary'?'Riepilogo':this.view==='events'?'Scadenze':'Impostazioni' },
    headerSubtitle(){ return `${this.months[this.filters.month]} ${this.filters.year}` },
    years(){ const y=new Date().getFullYear(); return [y-1,y,y+1]; },
    categories(){ return [...new Set(this.rows.map(r=>r.Categoria).filter(Boolean))]; },
    filteredRows(){
      return this.rows.filter(r=>{
        const d=new Date(r.Data);
        const matchMonth=(d.getMonth()===this.filters.month)&&(d.getFullYear()===this.filters.year);
        const matchCat=!this.filters.category||r.Categoria===this.filters.category;
        return matchMonth&&matchCat;
      });
    },
    lastRows(){ return this.rows.slice(-5).reverse(); },
    kpi(){
      let e=0,s=0,ivaCred=0,ivaDeb=0;
      this.filteredRows.forEach(r=>{
        const netto=this.calcNetto(r);
        if(r.Tipo==='entrata'){ e+=netto; ivaDeb+=this.calcIVA(r); }
        else { s+=netto; ivaCred+=this.calcIVA(r); }
      });
      return {
        totEntrate:e, totSpese:s, risparmi:e-s,
        ivaCredito:ivaCred, ivaDebito:ivaDeb, ivaDaVersare:ivaDeb-ivaCred
      }
    },
    sortedEvents(){
      return [...this.events].sort((a,b)=>new Date(a.date)-new Date(b.date));
    }
  },
  watch:{
    presetIVA(v){ if(v!=null) this.txDraft.IVA=v; },
    rows:{deep:true, handler(){ localStorage.setItem('rows',JSON.stringify(this.rows)); this.refreshCharts(); }},
    events:{deep:true, handler(){ localStorage.setItem('events',JSON.stringify(this.events)); this.checkBanner(); }},
    settings:{deep:true, handler(){ localStorage.setItem('settings',JSON.stringify(this.settings)); }}
  },
  mounted(){
    this.rows=JSON.parse(localStorage.getItem('rows')||'[]');
    this.events=JSON.parse(localStorage.getItem('events')||'[]');
    this.settings=Object.assign(this.settings,JSON.parse(localStorage.getItem('settings')||'{}'));
    this.refreshCharts(); this.checkBanner();
  },
  methods:{
    switchView(v){ this.view=v; setTimeout(this.refreshCharts,300); },
    fmtEUR(v){ return (v||0).toLocaleString('it-IT',{style:'currency',currency:'EUR'}); },
    calcIVA(r){ return +(r.Importo*(r.IVA||0)/100).toFixed(2); },
    calcNetto(r){ return +(r.Importo - this.calcIVA(r)).toFixed(2); },
    openTx(tipo){ this.txDraft={id:null,Tipo:tipo,Data:new Date().toISOString().slice(0,10),Importo:0,IVA:22,ImportoNetto:0,ImportoIVA:0}; this.presetIVA=null; this.$refs.dlgTx.showModal(); },
    openEdit(r){ this.txDraft=JSON.parse(JSON.stringify(r)); this.$refs.dlgTx.showModal(); },
    saveTx(){
      if(!this.txDraft.Importo) return alert('Importo mancante');
      const r={...this.txDraft};
      r.ImportoIVA=this.calcIVA(r); r.ImportoNetto=this.calcNetto(r);
      if(!r.id) r.id=Date.now(); else this.rows=this.rows.filter(x=>x.id!==r.id);
      this.rows.push(r);
      this.$refs.dlgTx.close();
    },
    removeRow(id){ if(confirm('Eliminare movimento?')) this.rows=this.rows.filter(r=>r.id!==id); },

    // === EVENTI ===
    openEvent(e=null){ this.eventDraft=e?JSON.parse(JSON.stringify(e)):{id:null,title:'',date:new Date().toISOString().slice(0,10),kind:'Altro',repeat:'',done:false,fileName:'',fileData:''}; this.$refs.dlgEvent.showModal(); },
    saveEvent(){
      const e={...this.eventDraft};
      if(!e.id) e.id=Date.now(); else this.events=this.events.filter(x=>x.id!==e.id);
      this.events.push(e); this.$refs.dlgEvent.close();
    },
    deleteEvent(id){ if(confirm('Eliminare scadenza?')) this.events=this.events.filter(e=>e.id!==id); },
    attachFile(ev){
      const file=ev.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{ this.eventDraft.fileData=reader.result; this.eventDraft.fileName=file.name; };
      reader.readAsDataURL(file);
    },
    repeatLabel(v){ return v==='month'?'Mensile':v==='quarter'?'Trimestrale':v==='year'?'Annuale':''; },
    deadlineClass(e){ const dd=this.daysDiff(e.date); if(dd<0)return'border-rose-400 text-rose-300'; if(dd<=7)return'border-amber-400 text-amber-300'; return'border-green-400 text-green-300'; },
    deadlineLabel(e){ const dd=this.daysDiff(e.date); return dd<0?`Scaduto ${Math.abs(dd)}g fa`:dd===0?'Oggi':`Tra ${dd}g`; },
    daysDiff(d){ return Math.floor((new Date(d)-new Date())/86400000); },

    // === BANNER ===
    checkBanner(){
      const today=[],soon=[],over=[];
      const now=new Date();
      this.events.forEach(e=>{
        const dd=this.daysDiff(e.date);
        if(!e.done){
          if(dd===0) today.push({...e,dday:dd});
          else if(dd>0&&dd<=7) soon.push({...e,dday:dd});
          else if(dd<0) over.push({...e,dday:dd});
        }
      });
      this.banner={items:[...today,...soon,...over],today,soon,over};
    },
    dismissBannerToday(){ this.banner={items:[],today:[],soon:[],over:[]}; },

    // === EXPORT / IMPORT ===
    exportCSV(){
      const header=Object.keys(this.rows[0]||{}).join(';');
      const rows=this.rows.map(r=>Object.values(r).join(';')).join('\n');
      const blob=new Blob([header+'\n'+rows],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='contabilita.csv'; a.click();
    },
    importCSV(ev){
      const file=ev.target.files[0]; if(!file)return;
      const reader=new FileReader();
      reader.onload=()=>{
        const lines=reader.result.split('\n').filter(l=>l.trim());
        const keys=lines[0].split(';');
        this.rows=lines.slice(1).map(l=>{
          const vals=l.split(';');
          const o={}; keys.forEach((k,i)=>o[k]=vals[i]); return o;
        });
      };
      reader.readAsText(file);
    },
    exportPDF(){
      const el=document.querySelector('main');
      html2canvas(el).then(canvas=>{
        const pdf=new jspdf.jsPDF('p','mm','a4');
        const img=canvas.toDataURL('image/png');
        const w=210; const h=canvas.height*210/canvas.width;
        pdf.addImage(img,'PNG',0,0,w,h); pdf.save('report.pdf');
      });
    },
    clearAll(){ if(confirm('Cancellare tutti i dati?')){ this.rows=[]; this.events=[]; localStorage.clear(); } },

    // === GRAFICI ===
    refreshCharts(){
      setTimeout(()=>{
        if(!this.rows.length)return;
        // Home chart
        const ctx1=document.getElementById('chartHome');
        if(ctx1){
          const e=this.filteredRows.filter(r=>r.Tipo==='entrata').reduce((a,b)=>a+this.calcNetto(b),0);
          const s=this.filteredRows.filter(r=>r.Tipo==='spesa').reduce((a,b)=>a+this.calcNetto(b),0);
          this.makeBarChart(ctx1,['Entrate','Uscite'],[e,s]);
        }
        // Pie categorie
        const ctx2=document.getElementById('chartPie');
        if(ctx2){
          const cats={};
          this.filteredRows.forEach(r=>{
            const k=r.Categoria||'Altro';
            cats[k]=(cats[k]||0)+this.calcNetto(r)*(r.Tipo==='entrata'?1:-1);
          });
          this.makePieChart(ctx2,Object.keys(cats),Object.values(cats));
        }
        // Year trend
        const ctx3=document.getElementById('chartYear');
        if(ctx3){
          const arr=Array(12).fill(0);
          this.rows.forEach(r=>{
            const d=new Date(r.Data);
            if(d.getFullYear()===this.filters.year){
              arr[d.getMonth()]+=this.calcNetto(r)*(r.Tipo==='entrata'?1:-1);
            }
          });
          this.makeLineChart(ctx3,this.months,arr);
        }
      },200);
    },
    makeBarChart(ctx,labels,data){
      if(this.charts[ctx.id]) this.charts[ctx.id].destroy();
      this.charts[ctx.id]=new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:['#10b981','#ef4444']}]},options:{plugins:{legend:{display:false}}}});
    },
    makePieChart(ctx,labels,data){
      if(this.charts[ctx.id]) this.charts[ctx.id].destroy();
      this.charts[ctx.id]=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:['#6c7bff','#35d9a3','#fbbf24','#ef4444','#14b8a6','#818cf8']}]},options:{plugins:{legend:{labels:{color:'#e5e7eb'}}}}});
    },
    makeLineChart(ctx,labels,data){
      if(this.charts[ctx.id]) this.charts[ctx.id].destroy();
      this.charts[ctx.id]=new Chart(ctx,{type:'line',data:{labels,datasets:[{data,fill:true,borderColor:'#6c7bff',backgroundColor:'rgba(108,123,255,0.25)'}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#aaa'}},y:{ticks:{color:'#aaa'}}}}});
    }
  }
}).mount('#app')
</script>
</body>
</html>
