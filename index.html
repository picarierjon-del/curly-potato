<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commander Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .page { display: none; padding-bottom: 100px; }
        .active-page { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.25rem; margin-bottom: 1rem; }
        input[type="number"], input[type="text"], input[type="password"], input[type="date"], select { 
            width: 100%; border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px; font-size: 16px; 
        }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 10px; font-weight: bold; }
        .nav-item.active { color: var(--primary); }
        #lock-screen { position: fixed; inset: 0; background: #1e293b; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        @media print { .no-print { display: none !important; } .page { display: block !important; } }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h1 class="text-3xl font-black mb-8 text-blue-400 uppercase tracking-tighter">Commander Elite</h1>
        <div class="w-64">
            <p class="text-center mb-4 text-slate-400 uppercase text-xs tracking-widest">Inserire PIN di Accesso</p>
            <input type="password" id="pin-input" class="text-center text-2xl tracking-[1em] text-slate-900 mb-4" maxlength="4" placeholder="****">
            <button onclick="checkPin()" class="w-full bg-blue-600 py-4 rounded-xl font-bold active:scale-95 transition">ACCEDI</button>
            <p id="pin-error" class="text-red-400 text-sm mt-4 text-center hidden">PIN Errato. Riprova.</p>
        </div>
    </div>

    <header class="bg-white border-b sticky top-0 z-50 p-4 no-print flex justify-between items-center">
        <h1 class="font-black text-blue-600 italic">COMMANDER<span class="text-slate-800">ELITE</span></h1>
        <button onclick="lockApp()" class="text-slate-400"><i class="fa-solid fa-lock"></i></button>
    </header>

    <main class="max-w-md mx-auto p-4">

        <section id="page-oggi" class="page active-page">
            <div class="card bg-blue-50 border-blue-100 flex items-center justify-between">
                <input type="date" id="data-lavoro" class="bg-transparent border-none font-bold text-blue-700">
                <i class="fa-solid fa-calendar-day text-blue-300"></i>
            </div>

            <div class="card">
                <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Entrate Giornaliere</h3>
                <div class="space-y-3">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Corrispettivi Totali Z</label>
                    <input type="number" id="inp-tot" placeholder="0.00" class="text-xl font-black" oninput="calcola()"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" class="val-elettr" id="inp-pos" placeholder="Bancomat" oninput="calcola()">
                        <input type="number" class="val-elettr" id="inp-sat" placeholder="Satispay" oninput="calcola()">
                        <input type="number" class="val-elettr" id="inp-del" placeholder="Delivery" oninput="calcola()">
                        <input type="number" class="val-elettr" id="inp-tap" placeholder="Tap/App" oninput="calcola()">
                    </div>
                </div>
            </div>

            <div class="card border-l-4 border-red-500">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold">Uscite Fornitori</h3>
                    <button onclick="addFornitore()" class="text-blue-600 font-bold text-xs">+ AGGIUNGI</button>
                </div>
                <div id="fornitori-list" class="space-y-3">
                    </div>
            </div>

            <div class="card bg-slate-900 text-white">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between text-slate-400"><span>Elettronici Totali:</span> <span id="res-elettr">€ 0.00</span></div>
                    <div class="flex justify-between text-slate-400"><span>Contanti Teorici:</span> <span id="res-teor">€ 0.00</span></div>
                    <div class="flex justify-between text-orange-400 font-bold border-b border-slate-700 pb-2"><span>Uscite Cash:</span> <span id="res-cash-uscita">€ 0.00</span></div>
                    <div class="flex justify-between text-xl font-black text-green-400 pt-1"><span>NETTO DA VERSARE:</span> <span id="res-netto">€ 0.00</span></div>
                </div>
                <button onclick="salvaTutto()" class="w-full mt-4 bg-blue-600 py-3 rounded-xl font-bold active:bg-blue-700">SALVA GIORNATA</button>
            </div>
        </section>

        <section id="page-riepilogo" class="page">
            <h2 class="font-bold text-xl mb-4 text-slate-800">Riepilogo Business</h2>
            
            <div class="grid grid-cols-1 gap-3 mb-6">
                <div class="card flex justify-between items-center border-l-4 border-blue-500">
                    <div><p class="text-[10px] text-slate-400 uppercase font-bold">Questa Settimana</p><p id="stat-week" class="text-xl font-black">€ 0.00</p></div>
                    <i class="fa-solid fa-chart-simple text-blue-100 text-2xl"></i>
                </div>
                <div class="card flex justify-between items-center border-l-4 border-green-500">
                    <div><p class="text-[10px] text-slate-400 uppercase font-bold">Mese Corrente</p><p id="stat-month" class="text-xl font-black">€ 0.00</p></div>
                    <i class="fa-solid fa-calendar-check text-green-100 text-2xl"></i>
                </div>
                <div class="card flex justify-between items-center border-l-4 border-orange-500">
                    <div><p class="text-[10px] text-slate-400 uppercase font-bold">Totale Annuale</p><p id="stat-year" class="text-xl font-black">€ 0.00</p></div>
                    <i class="fa-solid fa-gem text-orange-100 text-2xl"></i>
                </div>
            </div>

            <div class="card">
                <h3 class="font-bold text-sm mb-3">Ricerca Storica Giorno</h3>
                <div class="flex gap-2">
                    <input type="date" id="search-date">
                    <button onclick="cercaGiorno()" class="bg-slate-800 text-white px-4 rounded-lg"><i class="fa-solid fa-search"></i></button>
                </div>
                <div id="search-result" class="mt-4 hidden p-3 bg-slate-50 rounded-lg text-sm border border-slate-200"></div>
            </div>
        </section>

        <section id="page-stampa" class="page">
            <div class="card no-print">
                <h3 class="font-bold mb-4">Esporta Dati Ragioniere</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="p-from">
                        <input type="date" id="p-to">
                    </div>
                    <select id="p-mode">
                        <option value="tutto">Report Completo</option>
                        <option value="solo-corr">Solo Corrispettivi Z</option>
                        <option value="solo-ele">Solo Pagamenti Elettronici</option>
                    </select>
                    <button onclick="generaReportRagioniere()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold">GENERA DOCUMENTO</button>
                </div>
            </div>
            <div id="area-stampa" class="mt-4"></div>
        </section>

    </main>

    <nav class="nav-bottom no-print">
        <button onclick="showPage('oggi')" class="nav-item active" id="btn-oggi"><i class="fa-solid fa-plus-circle text-xl"></i>Oggi</button>
        <button onclick="showPage('riepilogo')" class="nav-item" id="btn-riepilogo"><i class="fa-solid fa-chart-line text-xl"></i>Riepilogo</button>
        <button onclick="showPage('stampa')" class="nav-item" id="btn-stampa"><i class="fa-solid fa-file-invoice text-xl"></i>Stampa</button>
    </nav>

    <script>
        const PIN_CORRETTO = "1234"; 
        let database = JSON.parse(localStorage.getItem('commander_elite_db') || '[]');

        function checkPin() {
            if(document.getElementById('pin-input').value === PIN_CORRETTO) {
                document.getElementById('lock-screen').style.display = 'none';
            } else {
                document.getElementById('pin-error').classList.remove('hidden');
            }
        }

        function lockApp() { location.reload(); }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active-page'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active-page');
            document.getElementById('btn-'+p).classList.add('active');
            if(p === 'riepilogo') updateAdvancedStats();
        }

        function addFornitore() {
            const container = document.getElementById('fornitori-list');
            const div = document.createElement('div');
            div.className = "space-y-2 bg-slate-50 p-3 rounded-xl border border-slate-200";
            div.innerHTML = `
                <div class="flex gap-2">
                    <input type="text" placeholder="Nome Fornitore (es. Coca Cola, Macelleria...)" class="flex-1 !p-2 text-sm font-bold">
                    <button onclick="this.parentElement.parentElement.remove(); calcola()" class="text-red-500 bg-red-50 px-3 rounded-lg">×</button>
                </div>
                <div class="flex items-center justify-between gap-4">
                    <div class="flex-1 flex items-center gap-2">
                         <span class="text-xs font-bold text-slate-400">€</span>
                         <input type="number" placeholder="0.00" class="!p-2 text-sm val-usc" oninput="calcola()">
                    </div>
                    <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border">
                        <span class="text-[10px] font-bold text-slate-500">PAGATO CONTANTI?</span>
                        <input type="checkbox" class="check-cash w-5 h-5 accent-red-500" onchange="calcola()">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function calcola() {
            const tot = parseFloat(document.getElementById('inp-tot').value) || 0;
            let ele = 0;
            document.querySelectorAll('.val-elettr').forEach(i => ele += parseFloat(i.value) || 0);
            
            let uscCash = 0;
            document.querySelectorAll('#fornitori-list > div').forEach(div => {
                const val = parseFloat(div.querySelector('.val-usc').value) || 0;
                if(div.querySelector('.check-cash').checked) {
                    uscCash += val;
                }
            });

            const teorico = tot - ele;
            const netto = teorico - uscCash;

            document.getElementById('res-elettr').innerText = `€ ${ele.toFixed(2)}`;
            document.getElementById('res-teor').innerText = `€ ${teorico.toFixed(2)}`;
            document.getElementById('res-cash-uscita').innerText = `€ ${uscCash.toFixed(2)}`;
            document.getElementById('res-netto').innerText = `€ ${netto.toFixed(2)}`;
        }

        function salvaTutto() {
            const data = document.getElementById('data-lavoro').value;
            if(!data) return alert("Inserisci una data valida");
            
            const record = {
                data,
                totale: parseFloat(document.getElementById('inp-tot').value) || 0,
                pos: parseFloat(document.getElementById('inp-pos').value) || 0,
                sat: parseFloat(document.getElementById('inp-sat').value) || 0,
                del: parseFloat(document.getElementById('inp-del').value) || 0,
                tap: parseFloat(document.getElementById('inp-tap').value) || 0,
                usc_cash: parseFloat(document.getElementById('res-cash-uscita').innerText.replace('€ ',''))
            };
            database = database.filter(r => r.data !== data);
            database.push(record);
            localStorage.setItem('commander_elite_db', JSON.stringify(database));
            alert("✅ Dati salvati con successo!");
        }

        function updateAdvancedStats() {
            const now = new Date();
            const currentMonth = now.toISOString().substring(0, 7); // YYYY-MM
            const currentYear = now.getFullYear().toString();
            
            // Calcolo Settimana (Ultimi 7 giorni)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(now.getDate() - 7);
            
            let sWeek = 0, sMonth = 0, sYear = 0;

            database.forEach(r => {
                const rDate = new Date(r.data);
                // Settimanale
                if(rDate >= oneWeekAgo && rDate <= now) sWeek += r.totale;
                // Mensile
                if(r.data.startsWith(currentMonth)) sMonth += r.totale;
                // Annuale
                if(r.data.startsWith(currentYear)) sYear += r.totale;
            });

            document.getElementById('stat-week').innerText = `€ ${sWeek.toFixed(2)}`;
            document.getElementById('stat-month').innerText = `€ ${sMonth.toFixed(2)}`;
            document.getElementById('stat-year').innerText = `€ ${sYear.toFixed(2)}`;
        }

        function cercaGiorno() {
            const d = document.getElementById('search-date').value;
            const res = database.find(r => r.data === d);
            const div = document.getElementById('search-result');
            div.classList.remove('hidden');
            if(res) {
                div.innerHTML = `
                    <div class="flex justify-between mb-2 border-b pb-1 font-bold"><span>DATA:</span> <span>${res.data}</span></div>
                    <div class="flex justify-between"><span>Totale Z:</span> <span>€ ${res.totale.toFixed(2)}</span></div>
                    <div class="flex justify-between text-blue-600"><span>Elettronico:</span> <span>€ ${(res.pos+res.sat+res.del+res.tap).toFixed(2)}</span></div>
                    <div class="flex justify-between text-red-500"><span>Uscite Cash:</span> <span>€ ${res.usc_cash.toFixed(2)}</span></div>
                `;
            } else {
                div.innerHTML = "❌ Nessun dato trovato.";
            }
        }

        function generaReportRagioniere() {
            const from = document.getElementById('p-from').value;
            const to = document.getElementById('p-to').value;
            const mode = document.getElementById('p-mode').value;
            if(!from || !to) return alert("Scegli le date");

            let filtrati = database.filter(r => r.data >= from && r.data <= to).sort((a,b) => a.data.localeCompare(b.data));
            
            // Logica richiesta: Corrispettivi mese di...
            let intestazione = `Report dal ${from} al ${to}`;
            const dateFrom = new Date(from);
            const dateTo = new Date(to);
            if(dateFrom.getDate() === 1 && (dateTo.getDate() === 30 || dateTo.getDate() === 31)) {
                const mesi = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
                intestazione = `CORRISPETTIVI MESE DI ${mesi[dateFrom.getMonth()].toUpperCase()}`;
            }

            let h = `<div class="card text-xs">`;
            h += `<h2 class="font-black text-center text-lg mb-1">COMMANDER ELITE</h2>`;
            h += `<h3 class="font-bold text-center mb-4 uppercase text-blue-600">${intestazione}</h3>`;
            h += `<table class="w-full text-left border-collapse">
                    <thead><tr class="border-b-2 border-slate-800"><th class="py-2">Data</th><th class="py-2 text-right">Importo €</th></tr></thead>
                    <tbody>`;
            
            let totaleGen = 0;
            filtrati.forEach(r => {
                let val = r.totale;
                if(mode === 'solo-ele') val = r.pos + r.sat + r.del + r.tap;
                totaleGen += val;
                h += `<tr class="border-b"><td class="py-2">${r.data}</td><td class="py-2 text-right font-bold">€ ${val.toFixed(2)}</td></tr>`;
            });
            
            h += `</tbody></table>
                  <div class="mt-4 text-right text-sm font-black uppercase">Totale Periodo: € ${totaleGen.toFixed(2)}</div>
                  <button onclick="window.print()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-6 no-print">STAMPA PER RAGIONIERE</button>
                  </div>`;
            document.getElementById('area-stampa').innerHTML = h;
        }

        document.getElementById('data-lavoro').valueAsDate = new Date();
    </script>
</body>
</html>
