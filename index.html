<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestione Finanziaria Unificata Smart 5.0 (Pro)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root { color-scheme: light dark; }
    body { font-family:'Inter',sans-serif; background-color:#f7f9fc; color:#1e293b; }
    .card { box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.06); }
    .tab-active { border-bottom:3px solid #10b981; color:#10b981; }
    .cta-button { transition:all .2s; box-shadow:0 2px 4px rgba(16,185,129,.4); }
    .bar-container { height:20px; border-radius:9999px; overflow:hidden; display:flex; }
    .bar-income{background-color:#10b981}.bar-expense{background-color:#ef4444}
    .bar-addebito{background-color:#fb923c}.bar-credito{background-color:#3b82f6}
    #quick-actions{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(to top,#fff, #fff8);padding:10px;box-shadow:0 -2px 10px rgba(0,0,0,.1);z-index:40;}
    /* Dark mode */
    .dark body, body.dark { background-color:#0f172a; color:#f1f5f9; }
    body.dark .card { background-color:#111827; color:#e5e7eb; }
    body.dark .tab-active { color:#10b981; border-bottom-color:#10b981; }
    body.dark input, body.dark select, body.dark textarea { background:#111827; color:#e5e7eb; border-color:#374151; }
    body.dark .bg-white { background-color:#111827 !important; }
    body.dark .text-gray-700 { color:#e5e7eb !important; }
    body.dark .text-gray-800 { color:#f9fafb !important; }
    body.dark .text-gray-500 { color:#9ca3af !important; }
    /* PIN Lock */
    #pin-lock-modal {
      position: fixed;
      inset: 0;
      background-color: #0f172a;
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: #f1f5f9;
      text-align: center;
    }
    .pin-input { display:flex; gap:10px; margin-top:20px; }
    .pin-input input {
      width: 40px; height: 40px; text-align: center; font-size: 1.5rem;
      border: 2px solid #374151; border-radius: 8px; background-color: #111827; color: #10b981;
      caret-color: transparent;
    }
  </style>
  <link id="dynamic-manifest" rel="manifest">
</head>
<body class="min-h-screen">

  <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
    <header class="mb-6 flex items-center justify-between">
      <div class="flex-1 text-center">
        <h1 class="text-3xl font-bold text-gray-800">Finanza Smart 5.0 Pro üöÄ</h1>
        <p class="text-center text-sm text-gray-500">Attivit√† &amp; Personale</p>
      </div>
      <button id="theme-toggle"
        class="ml-4 px-3 py-2 rounded-lg border text-sm hover:bg-gray-100 dark:hover:bg-gray-800"
        type="button">üåô Dark</button>
    </header>

    <nav id="navbar" class="flex justify-around bg-white p-2 rounded-xl shadow-lg card"></nav>
    <div id="content-area" class="mt-4"></div>

    <div id="quick-actions" class="hidden md:hidden" role="region" aria-label="Azioni rapide">
      <div class="flex space-x-3 max-w-lg mx-auto">
        <button onclick="quickRegister('true')"
          class="flex-1 bg-emerald-500 text-white p-3 rounded-xl font-bold hover:bg-emerald-600 shadow-xl transition transform hover:scale-[1.02] text-lg"
          type="button">üí∞ Registra Entrata (I)</button>
        <button onclick="quickRegister('false')"
          class="flex-1 bg-red-500 text-white p-3 rounded-xl font-bold hover:bg-red-600 shadow-xl transition transform hover:scale-[1.02] text-lg"
          type="button">üí∏ Registra Uscita (E)</button>
      </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4" role="dialog" aria-modal="true">
      <div class="bg-white p-6 rounded-xl w-full max-w-sm card">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Attenzione</h3>
        <p id="modal-message" class="text-gray-700 mb-4">Messaggio di esempio.</p>
        <div class="flex justify-end space-x-3">
          <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300" type="button">Annulla</button>
          <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 cta-button" type="button">Conferma</button>
        </div>
      </div>
    </div>

    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 bg-green-500 text-white rounded-xl shadow-lg transition-opacity duration-300 opacity-0" role="status" aria-live="polite">
      Azione completata con successo!
    </div>
  </div>

  <!-- PIN LOCK -->
  <div id="pin-lock-modal">
    <h2 class="text-3xl font-bold mb-3">Finanza Smart 5.0</h2>
    <p class="text-lg mb-6 text-gray-400">Inserisci il PIN per sbloccare</p>
    <div class="pin-input">
      <input type="password" maxlength="1" id="pin-1" class="pin-digit" pattern="[0-9]" inputmode="numeric" aria-label="PIN cifra 1"/>
      <input type="password" maxlength="1" id="pin-2" class="pin-digit" pattern="[0-9]" inputmode="numeric" aria-label="PIN cifra 2"/>
      <input type="password" maxlength="1" id="pin-3" class="pin-digit" pattern="[0-9]" inputmode="numeric" aria-label="PIN cifra 3"/>
      <input type="password" maxlength="1" id="pin-4" class="pin-digit" pattern="[0-9]" inputmode="numeric" aria-label="PIN cifra 4"/>
    </div>
    <p id="pin-error" class="text-red-500 mt-4 text-sm hidden">PIN errato. Riprova.</p>
    <p class="text-sm text-gray-500 mt-8">PIN di default: 1234</p>
  </div>

  <script>
    /* =============================
       CONFIG & COSTANTI GLOBALI
       ============================= */
    const LOCAL_STORAGE_KEY = 'smartFinApp_v50_pro';
    const SESSION_STORAGE_PIN_KEY = 'smartFinApp_unlocked';
    const IVA_RATES = [0,4,5,10,22];
    const MAX_RECENT_TRANSACTIONS = 10;
    const DEFAULT_CATEGORIES = ['Affitto','Bollette','Spesa','Marketing','Servizi','Stipendi','Carburante','Ristoranti','Abbonamenti','Altro'];

    // Icone categorie
    const CATEGORY_ICONS = {
      'Affitto':'üè†','Bollette':'üí°','Spesa':'üõí','Marketing':'üì¢','Servizi':'üõ†Ô∏è','Stipendi':'üßë‚Äçüíº',
      'Carburante':'‚õΩ','Ristoranti':'üçΩÔ∏è','Abbonamenti':'üîó','Altro':'üì¶'
    };

    // Frequenze
    const COMMON_FREQUENCIES = {
      'affitto':'monthly','stipendio':'monthly','bollette':'monthly','abbonamento':'monthly',
      'assicurazione':'annual','tasse':'quarterly','imu':'annual','mensile':'monthly',
      'trimestrale':'quarterly','annuale':'annual'
    };

    // Registro grafici per cleanup
    const charts = new Map(); // id -> Chart instance

    let appData = {
      invoices:[], expenses:[], reminders:[], contacts:[], birthdays:[], recurringExpenses:[],
      lastId:0, categories: DEFAULT_CATEGORIES.slice(),
      // PIN in chiaro NON usato pi√π; manteniamo compat migrazione
      pin: '1234',
      pinMeta: null,   // {salt, hash, iterations}
      currencySymbol:'‚Ç¨',
      monthlySavingsTarget:0
      // NOTA: transazioni ora supportano 'supplier' esplicito
    };
    let currentPage = 'activity';

    /* =============================
       UTILIT√Ä SICUREZZA / XSS / DENARO
       ============================= */
    // Escape per evitare XSS quando inseriamo stringhe in HTML
    function h(v){
      return String(v??'').replace(/[&<>"'`=\/]/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'
      }[s]));
    }

    // Valuta / centesimi
    const fmt = new Intl.NumberFormat('it-IT',{minimumFractionDigits:2, maximumFractionDigits:2});
    const sym = ()=> getCurrencySymbol();
    const toCents = v => Math.round((parseFloat(v)||0)*100);
    const fromCents = c => (c||0)/100;
    function calcGrossCents(netCents, vatRate){
      const vat = Math.round(netCents * (vatRate/100));
      return { vatCents: vat, grossCents: netCents + vat };
    }

    function getCurrencySymbol(){ return appData.currencySymbol || '‚Ç¨'; }
    function getCategoryIcon(cat){
      const key = Object.keys(CATEGORY_ICONS).find(k => k.toLowerCase() === String(cat||'Altro').toLowerCase());
      return CATEGORY_ICONS[key] || CATEGORY_ICONS['Altro'];
    }

    // Chart helpers
    function getCtx(id){
      const c = document.getElementById(id);
      if (!c) return null;
      if (charts.has(id)) { try{ charts.get(id).destroy(); }catch{} charts.delete(id); }
      return { id, ctx: c.getContext('2d') };
    }

    /* =============================
       THEME
       ============================= */
    function applySavedTheme(){
      const saved = localStorage.getItem('theme') || 'light';
      document.body.classList.toggle('dark', saved === 'dark');
      const btn = document.getElementById('theme-toggle');
      if (btn) btn.textContent = saved === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
    }
    function toggleTheme(){
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      applySavedTheme();
    }

    /* =============================
       STORAGE + MIGRAZIONE
       ============================= */
    function saveData(){
      try{ localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData)); }
      catch(e){ console.error(e); showToast('Errore salvataggio','red'); }
    }
    function getNextId(){ appData.lastId++; saveData(); return appData.lastId; }

    function loadData(){
      try{
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          appData = { ...appData, ...parsed };
          // ensure array/props
          appData.invoices ||= []; appData.expenses ||= [];
          appData.reminders ||= []; appData.contacts ||= [];
          appData.birthdays ||= []; appData.recurringExpenses ||= [];
          appData.categories ||= DEFAULT_CATEGORIES.slice();
          appData.lastId ||= 0;
          appData.currencySymbol ||= '‚Ç¨';
          appData.monthlySavingsTarget ||= 0;
        }
        // MIGRAZIONE PIN -> PBKDF2 se necessario
        if (appData.pin && !appData.pinMeta) {
          (async ()=>{
            const meta = await hashPin(appData.pin);
            appData.pinMeta = meta;
            delete appData.pin;
            saveData();
          })();
        }
      }catch(e){ console.error(e); showToast('Errore nel caricamento dati','red'); }
    }

    /* =============================
       PIN SICURO (PBKDF2 + LOCKOUT)
       ============================= */
    const PIN_KDF = { iterations: 150_000, digest: 'SHA-256' };
    const PIN_LOCK_KEY = 'smartFinApp_pinLock';
    function u8(b){ return new Uint8Array(b); }
    function hex(b){ return [...u8(b)].map(x=>x.toString(16).padStart(2,'0')).join(''); }
    function dehex(hh){ return new Uint8Array(String(hh).match(/.{1,2}/g).map(b=>parseInt(b,16))); }
    async function kdf(pass, salt, iterations=PIN_KDF.iterations){
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveBits']);
      return crypto.subtle.deriveBits({ name:'PBKDF2', hash: PIN_KDF.digest, salt, iterations }, key, 256);
    }
    async function hashPin(pin, saltHex){
      const salt = saltHex ? dehex(saltHex) : crypto.getRandomValues(new Uint8Array(16));
      const bits = await kdf(pin, salt);
      return { salt: hex(salt), hash: hex(bits), iterations: PIN_KDF.iterations };
    }
    function getPinMeta(){ return appData.pinMeta || null; }
    function setPinMeta(meta){ appData.pinMeta = meta; saveData(); }
    function getLock(){ try{return JSON.parse(localStorage.getItem(PIN_LOCK_KEY)||'{}')}catch{return{}} }
    function setLock(l){ localStorage.setItem(PIN_LOCK_KEY, JSON.stringify(l)); }

    // PIN modal listeners
    const handlePinInputListener = (e, index) => handlePinInput(e, index);
    const handlePinKeyDownListener = (e, index) => handlePinKeyDown(e, index);

    function setupPinLock(){
      const pinDigits = document.querySelectorAll('.pin-digit');
      const pinModal = document.getElementById('pin-lock-modal');
      const isUnlocked = sessionStorage.getItem(SESSION_STORAGE_PIN_KEY) === 'true';
      if (!isUnlocked) {
        pinModal.style.display = 'flex';
        pinDigits.forEach((input, index) => {
          input.value = '';
          input.removeEventListener('input', handlePinInputListener);
          input.removeEventListener('keydown', handlePinKeyDownListener);
          input.addEventListener('input', (e)=>handlePinInput(e,index));
          input.addEventListener('keydown', (e)=>handlePinKeyDown(e,index));
        });
        setTimeout(()=> document.getElementById('pin-1')?.focus(), 100);
      } else {
        pinModal.style.display = 'none';
        const initialPage = appData.invoices.length>0 || appData.expenses.length>0 ? 'report':'activity';
        renderPage(initialPage);
      }
    }
    function handlePinInput(e, index){
      const pinDigits = document.querySelectorAll('.pin-digit');
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0,1);
      if (e.target.value.length === 1 && index < pinDigits.length - 1) pinDigits[index+1].focus();
      if (Array.from(pinDigits).every(i=>i.value.length===1)) checkPin();
    }
    function handlePinKeyDown(e, index){
      const pinDigits = document.querySelectorAll('.pin-digit');
      if (e.key==='Backspace' && e.target.value==='' && index>0) pinDigits[index-1].focus();
    }
    async function checkPin(){
      const pinDigits = document.querySelectorAll('.pin-digit');
      const enteredPin = Array.from(pinDigits).map(i=>i.value).join('');
      if (enteredPin.length < 4) return;
      // lockout
      const lock = getLock();
      const now = Date.now();
      if (lock.until && now < lock.until){
        showToast(`Troppi tentativi. Riprova tra ${Math.ceil((lock.until-now)/1000)}s`,'red');
        return;
      }
      const meta = getPinMeta();
      if (!meta){ showToast('Errore PIN: non inizializzato.','red'); return; }
      const bits = await kdf(enteredPin, dehex(meta.salt), meta.iterations);
      const ok = hex(bits) === meta.hash;
      const pinError = document.getElementById('pin-error');
      if (ok){
        pinError.classList.add('hidden');
        sessionStorage.setItem(SESSION_STORAGE_PIN_KEY, 'true');
        document.getElementById('pin-lock-modal').style.display = 'none';
        lock.count = 0; lock.until = 0; setLock(lock);
        const initialPage = appData.invoices.length>0 || appData.expenses.length>0 ? 'report':'activity';
        renderPage(initialPage);
        showToast('Accesso sbloccato!');
      } else {
        pinError.classList.remove('hidden');
        pinDigits.forEach(i=>i.value='');
        document.getElementById('pin-1').focus();
        lock.count = (lock.count||0)+1;
        if (lock.count >= 5){ lock.until = Date.now() + Math.min(60000, 2000*(lock.count-4)); }
        setLock(lock);
      }
    }

    async function changePin(){
      const currentPin = document.getElementById('current-pin')?.value.trim();
      const newPin = document.getElementById('new-pin')?.value.trim();
      const meta = getPinMeta();
      if (!/^\d{4}$/.test(newPin||'')) { showToast('Il nuovo PIN deve essere 4 cifre.','red'); return; }
      if (!meta){ showToast('PIN non inizializzato.','red'); return; }
      const bits = await kdf(currentPin||'', dehex(meta.salt), meta.iterations);
      if (hex(bits)!==meta.hash){ showToast('PIN attuale errato.','red'); return; }
      const next = await hashPin(newPin, meta.salt);
      setPinMeta(next);
      document.getElementById('current-pin').value='';
      document.getElementById('new-pin').value='';
      showToast('PIN aggiornato (memorizzato in modo sicuro).');
      renderPage('settings');
    }

    /* =============================
       UI HELPERS: modal / toast
       ============================= */
    function showModal(title,message,isConfirmation,onConfirm,onCancel=null){
      const modal = document.getElementById('modal');
      const t = document.getElementById('modal-title'); const m = document.getElementById('modal-message');
      const ok = document.getElementById('modal-confirm-btn'); const cancel = document.getElementById('modal-cancel-btn');
      t.textContent = title; m.textContent = message;
      if (isConfirmation){
        ok.textContent = 'Conferma';
        ok.classList.remove('bg-gray-500','hover:bg-gray-600');
        ok.classList.add('bg-red-600','hover:bg-red-700');
        ok.onclick = ()=>{ modal.classList.add('hidden'); onConfirm&&onConfirm(); };
        cancel.classList.remove('hidden');
        cancel.onclick = ()=>{ modal.classList.add('hidden'); onCancel&&onCancel(); };
      } else {
        ok.textContent='OK';
        ok.classList.remove('bg-red-600','hover:bg-red-700');
        ok.classList.add('bg-gray-500','hover:bg-gray-600');
        ok.onclick = ()=> modal.classList.add('hidden');
        cancel.classList.add('hidden');
      }
      modal.classList.remove('hidden');
    }
    function showToast(message,type='green'){
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-xl shadow-lg transition-opacity duration-300 opacity-100 ${type==='red'?'bg-red-500':'bg-green-500'}`;
      setTimeout(()=>{ toast.classList.remove('opacity-100'); toast.classList.add('opacity-0'); }, 2500);
    }

    /* =============================
       QUICK register & hotkeys helpers
       ============================= */
    function quickRegister(isIncomeString){
      const isIncome = isIncomeString === 'true';
      document.getElementById('transaction-form-anchor')?.scrollIntoView({behavior:'smooth'});
      const isIncomeSelect = document.getElementById('isIncome');
      if (isIncomeSelect){
        isIncomeSelect.value = isIncomeString;
        isIncomeSelect.dispatchEvent(new Event('change'));
      }
      const form = document.getElementById('transaction-form');
      if (form){
        form.removeAttribute('data-transaction-id'); form.reset();
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn){
          submitBtn.textContent='Registra Movimento';
          submitBtn.classList.remove('bg-blue-500','hover:bg-blue-600');
          submitBtn.classList.add('bg-emerald-500','hover:bg-emerald-600');
        }
        document.getElementById('date').value = new Date().toISOString().slice(0,10);
        document.getElementById('net-amount').value = '0.00';
        calculateGross();
      }
      const incomeTypeSelect = document.getElementById('incomeType');
      if (incomeTypeSelect && isIncome){
        incomeTypeSelect.value='Fattura (Cliente)';
        incomeTypeSelect.dispatchEvent(new Event('change'));
      }
      showToast(isIncome?'Modulo pronto per Entrata!':'Modulo pronto per Uscita!','green');
    }

    /* =============================
       FILTRI PERIODO & SUPPORTO
       ============================= */
    function filterByPeriod(itemDateStr, filterType, filterValue){
      if (filterType==='all'||!filterValue||filterValue==='all') return true;
      const itemDate = new Date(itemDateStr); if (isNaN(itemDate)) return false;
      const y=itemDate.getFullYear(), m=itemDate.getMonth();
      if (filterType==='year'){ return y===parseInt(filterValue); }
      if (filterType==='month'){ const [fy,fm]=filterValue.split('-').map(Number); return y===fy && m===(fm-1); }
      if (filterType==='quarter'){ const [fy,fm]=filterValue.split('-').map(Number); return y===fy && Math.ceil((m+1)/3)===Math.ceil(fm/3); }
      if (filterType==='day'){ return itemDateStr===filterValue; }
      if (filterType==='week'){
        const d = new Date(filterValue);
        let dayOfWeek = d.getDay();
        const diff = d.getDate() - ((dayOfWeek + 6) % 7);
        const start = new Date(d); start.setDate(diff); start.setHours(0,0,0,0);
        const end = new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);
        return itemDate>=start && itemDate<=end;
      }
      return false;
    }

    /* =============================
       CONTATTI / CATEGORIE / FORNITORI
       ============================= */
    function addContact(name, scope, relation){
      const clean = (name||'').trim(); if (!clean) return;
      const exists = appData.contacts.find(c=> c.name.toLowerCase()===clean.toLowerCase() && c.scope===scope && c.relation===relation);
      if (!exists){ appData.contacts.push({ id:getNextId(), name:clean, scope, relation }); saveData(); }
    }
    function ensureCategory(cat){
      const c=(cat||'').trim(); if (!c) return;
      if (!appData.categories.map(s=>s.toLowerCase()).includes(c.toLowerCase())) {
        appData.categories.push(c);
        appData.categories.sort((a,b)=>a.localeCompare(b));
        saveData();
      }
    }
    function getAllTags(){
      const set = new Set();
      [...appData.invoices, ...appData.expenses].forEach(t => (t.tags||[]).forEach(tag => set.add(tag)));
      return Array.from(set).sort();
    }
    // Nuovo: elenco Fornitori (dai contatti relation='supplier')
    function getAllSuppliers(scopeFilter=null){
      return appData.contacts
        .filter(c => c.relation==='supplier' && (!scopeFilter || c.scope===scopeFilter))
        .map(c => c.name)
        .sort();
    }

    /* =============================
       PREVISIONI / MEDIA SPESE
       ============================= */
    function getAverageMonthlyExpense(category){
      const target = (category || 'Altro').toLowerCase();
      const relevant = appData.expenses.filter(e => (e.category||'Altro').toLowerCase()===target);
      const monthlyTotals = {};
      relevant.forEach(e => {
        const ym = e.date.slice(0,7);
        monthlyTotals[ym] = (monthlyTotals[ym] || 0) + (parseFloat(e.gross)||0);
      });
      const totalMonths = Object.keys(monthlyTotals).length;
      if (!totalMonths) return 0;
      const total = Object.values(monthlyTotals).reduce((s,c)=>s+c,0);
      return total/totalMonths;
    }
    function trackRecurringExpense(description, gross, date){
      const desc = String(description||'').toLowerCase();
      const keyMatch = Object.keys(COMMON_FREQUENCIES).find(k => desc.includes(k));
      const inferred = keyMatch ? COMMON_FREQUENCIES[keyMatch] : null;
      if (!inferred) return;
      const recurringKey = `${inferred}:${desc.replace(/[^a-z0-9]/g,'-').slice(0,20)}`;
      const existing = appData.recurringExpenses.find(r => r.key===recurringKey);
      const newRecord = { key:recurringKey, description, lastDate:date, lastAmount:+(parseFloat(gross)||0).toFixed(2), frequency: inferred };
      if (existing) Object.assign(existing,newRecord); else appData.recurringExpenses.push(newRecord);
    }

    /* =============================
       CALCOLI BASE
       ============================= */
    function calculateFinancialSummary(type, filterType, filterDateStr){
      let totalIncomes=0, totalExpenses=0, ivaAddebito=0, ivaCredito=0;
      const types = type==='global' ? ['activity','personal'] : [type];
      const all = [
        ...appData.invoices.map(t=>({...t,isIncome:true,key:'inv'})),
        ...appData.expenses.map(t=>({...t,isIncome:false,key:'exp'}))
      ];
      const filtered = all
        .filter(i=>types.includes(i.type))
        .filter(i=>filterByPeriod(i.date,filterType,filterDateStr));
      filtered.forEach(i=>{
        const gross = parseFloat(i.gross)||0;
        const vatAmount = parseFloat(i.vatAmount)||0;
        if (i.isIncome){ totalIncomes += gross; if (i.type==='activity') ivaAddebito += vatAmount; }
        else { totalExpenses += gross; if (i.type==='activity') ivaCredito += vatAmount; }
      });
      const netBalance = totalIncomes - totalExpenses;
      const ivaBalance = ivaAddebito - ivaCredito;
      return {
        totalIncomes, totalExpenses, netBalance,
        ivaAddebito, ivaCredito, ivaBalance,
        transactions: filtered.sort((a,b)=> new Date(b.date)-new Date(a.date))
      };
    }

    /* =============================
       FORM CALCOLO LORDO
       ============================= */
    function calculateGross(){
      const netInput = document.getElementById('net-amount');
      const vatSelect = document.getElementById('vat-rate');
      const vatAmountDisplay = document.getElementById('vat-amount-display');
      const grossAmountDisplay = document.getElementById('gross-amount-display');
      let net = parseFloat(netInput?.value)||0;
      const rate = parseFloat(vatSelect?.value)||0;
      const netC = toCents(net);
      const { vatCents, grossCents } = calcGrossCents(netC, rate);
      if (vatAmountDisplay) vatAmountDisplay.textContent = `${fmt.format(fromCents(vatCents))} ${sym()}`;
      if (grossAmountDisplay) grossAmountDisplay.textContent = `${fmt.format(fromCents(grossCents))} ${sym()}`;
    }

    /* =============================
       TRANSAZIONI (CRUD) con FORNITORE
       ============================= */
    function saveTransaction(isIncome, data){
      const list = isIncome ? appData.invoices : appData.expenses;

      // Importi sicuri
      const netCents = toCents(data.net);
      const vatRate = parseFloat(data.vatRate)||0;
      if (netCents < 0){ showToast('L\'importo Netto non pu√≤ essere negativo.','red'); return; }
      const { vatCents, grossCents } = calcGrossCents(netCents, vatRate);

      const tags = (data.tags||'').split(',').map(s=>s.trim()).filter(Boolean);

      // NEW: supplier (solo per uscite di solito, ma lo permettiamo sempre)
      const supplierName = (data.supplier||'').trim();

      const updatedItem = {
        id: data.id || getNextId(),
        type: data.dataType, // 'activity' | 'personal'
        date: data.date,
        description: data.description,     // cliente/descrizione libera
        supplier: supplierName || null,    // NUOVO campo visibile e filtrabile
        category: (data.category||'Altro').trim(),
        tags,
        net: fromCents(netCents),
        vatRate: +vatRate,
        vatAmount: fromCents(vatCents),
        gross: fromCents(grossCents),
        incomeType: data.incomeType || (isIncome && data.dataType==='activity' ? 'Fattura (Cliente)' : null)
      };

      // Tracking spese ricorrenti su personale / uscite
      if (!isIncome && data.dataType==='personal' && updatedItem.description) {
        trackRecurringExpense(updatedItem.description, updatedItem.gross, updatedItem.date);
      }

      // Contatti: cliente o fornitore (anche entrambi)
      const isFatturaOrPersonal = (isIncome && data.dataType==='activity' && data.incomeType==='Fattura (Cliente)') || data.dataType==='personal';
      if (isFatturaOrPersonal && updatedItem.description?.trim()){
        if (!data.id || (list.find(it=>it.id===data.id)?.description !== data.description)){
          addContact(updatedItem.description, data.dataType, isIncome ? 'client' : 'supplier');
        }
      }
      // NUOVO: fornitore esplicito
      if (updatedItem.supplier){
        addContact(updatedItem.supplier, data.dataType, 'supplier');
      }

      ensureCategory(updatedItem.category);

      if (isIncome && data.dataType==='activity' && data.incomeType==='Incasso/Corrispettivo'){
        updatedItem.description = updatedItem.description || "Corrispettivi/Incasso Giornaliero";
      }

      if (data.id){
        const idx = list.findIndex(i=>i.id===data.id);
        if (idx>-1){ list[idx]=updatedItem; showToast(`Transazione ID ${data.id} aggiornata!`); }
      } else { list.push(updatedItem); showToast(`"${updatedItem.description||updatedItem.supplier||'Movimento'}" registrato!`); }

      saveData(); renderPage(currentPage);
    }

    function handleTransactionSubmit(type){
      const form = document.getElementById('transaction-form');
      const data = new FormData(form);
      const isIncome = data.get('isIncome')==='true';
      const transactionId = form.getAttribute('data-transaction-id');

      const payload = {
        id: transactionId ? parseInt(transactionId) : null,
        dataType: type,
        isIncome,
        date: data.get('date'),
        description: data.get('description'),   // cliente / descrizione
        supplier: data.get('supplier') || '',   // NUOVO campo fornitore
        net: data.get('net'),
        vatRate: data.get('vatRate'),
        incomeType: data.get('incomeType'),
        category: data.get('category') || 'Altro',
        tags: data.get('tags') || ''
      };

      const isCorrisp = type==='activity' && isIncome && payload.incomeType==='Incasso/Corrispettivo';
      if (payload.net && payload.date && (isCorrisp || (payload.description && payload.description.trim()) || (!isIncome && payload.supplier.trim()))){
        const grossAmount = parseFloat(payload.net) * (1 + (parseFloat(payload.vatRate) / 100)) || 0;
        // Allerta anomalia solo nuove uscite personali
        if (!payload.id && !isIncome && type==='personal'){
          const monthlyAvg = getAverageMonthlyExpense(payload.category);
          if (monthlyAvg > 0 && grossAmount > monthlyAvg * 1.20) {
            const percentDifference = ((grossAmount / monthlyAvg) * 100).toFixed(0);
            showModal(
              'üö® Allerta Spesa Anomala',
              `Questa spesa (${fmt.format(grossAmount)}${sym()}) √® circa ${percentDifference}% superiore alla tua media mensile (${fmt.format(monthlyAvg)}${sym()}) per "${payload.category}". Continuare?`,
              true,
              () => saveTransaction(isIncome, payload),
              () => showToast('Registrazione annullata.','red')
            );
            return;
          }
        }
        saveTransaction(isIncome, payload);
        form.reset();
        form.removeAttribute('data-transaction-id');
        document.getElementById('description-label').textContent = isIncome ? 'Cliente / Descrizione' : 'Fornitore / Descrizione';
      } else {
        showToast('Compila i campi richiesti (Data, Importo, e Cliente/Fornitore).','red');
      }
    }

    function editTransaction(isIncome,id,scope){
      const list = isIncome ? appData.invoices : appData.expenses;
      const item = list.find(t=>t.id===id);
      if (!item) return showToast('Transazione non trovata.','red');
      if (currentPage !== scope) renderPage(scope);
      const form = document.getElementById('transaction-form'); if(!form) return;

      document.getElementById('transaction-form-anchor')?.scrollIntoView({behavior:'smooth'});

      form.setAttribute('data-transaction-id', item.id);
      document.getElementById('isIncome').value = isIncome ? 'true':'false';
      document.getElementById('isIncome').dispatchEvent(new Event('change'));

      document.getElementById('date').value = item.date;
      document.getElementById('description').value = item.description || '';
      document.getElementById('supplier').value = item.supplier || ''; // NUOVO campo
      document.getElementById('net-amount').value = (parseFloat(item.net)||0).toFixed(2);
      document.getElementById('vat-rate').value = item.vatRate;
      document.getElementById('category').value = item.category || 'Altro';
      document.getElementById('tags').value = (item.tags||[]).join(', ');

      if (scope==='activity' && isIncome){
        document.getElementById('incomeType').value = item.incomeType || 'Fattura (Cliente)';
        document.getElementById('incomeType').dispatchEvent(new Event('change'));
      }

      setupActivityIncomeTypeListeners(scope);
      setupContactAutocomplete(scope);
      setupSupplierAutocomplete(scope);
      setupCategoryAutocomplete();
      calculateGross();

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.textContent = `Salva Modifiche (ID ${item.id})`;
      submitBtn.classList.remove('bg-emerald-500','hover:bg-emerald-600');
      submitBtn.classList.add('bg-blue-500','hover:bg-blue-600');
      showToast(`Modulo pronto per modificare ID ${item.id}.`);
    }

    function duplicateTransaction(isIncome, id, scope){
      const list = isIncome ? appData.invoices : appData.expenses;
      const item = list.find(t => t.id === id);
      if (!item) return showToast('Transazione non trovata.','red');
      if (currentPage !== scope) renderPage(scope);
      const form = document.getElementById('transaction-form'); if (!form) return;

      document.getElementById('transaction-form-anchor')?.scrollIntoView({ behavior: 'smooth' });
      form.removeAttribute('data-transaction-id');

      document.getElementById('isIncome').value = isIncome ? 'true':'false';
      document.getElementById('isIncome').dispatchEvent(new Event('change'));
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
      document.getElementById('description').value = item.description || '';
      document.getElementById('supplier').value = item.supplier || '';
      document.getElementById('net-amount').value = (parseFloat(item.net)||0).toFixed(2);
      document.getElementById('vat-rate').value = item.vatRate;
      document.getElementById('category').value = item.category || 'Altro';
      document.getElementById('tags').value = (item.tags||[]).join(', ');

      if (scope==='activity' && isIncome){
        document.getElementById('incomeType').value = item.incomeType || 'Fattura (Cliente)';
        document.getElementById('incomeType').dispatchEvent(new Event('change'));
      }

      setupActivityIncomeTypeListeners(scope);
      setupContactAutocomplete(scope);
      setupSupplierAutocomplete(scope);
      setupCategoryAutocomplete();
      calculateGross();

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.textContent = `Registra Copia Movimento`;
      submitBtn.classList.remove('bg-blue-500','hover:bg-blue-600');
      submitBtn.classList.add('bg-emerald-500','hover:bg-emerald-600');
      showToast(`Modulo pre-compilato (Copia ID ${item.id})!`);
    }

    function deleteTransaction(isIncome,id){
      const listName = isIncome ? 'invoices':'expenses';
      const idx = appData[listName].findIndex(i=>i.id===id);
      if (idx>-1){
        showModal('Conferma Eliminazione','Eliminare definitivamente questa transazione?',true,()=>{
          appData[listName].splice(idx,1); saveData(); showToast('Transazione eliminata.','red'); renderPage(currentPage);
        });
      }
    }

    /* =============================
       REMINDERS & BIRTHDAYS (CRUD)
       ============================= */
    function saveReminder(data){
      appData.reminders ||= [];
      if (data.id){ const i=appData.reminders.findIndex(r=>r.id===data.id); if(i>-1){ appData.reminders[i]={...appData.reminders[i],...data}; } }
      else { appData.reminders.push({ id:getNextId(), ...data, paid:false }); }
      saveData(); showToast('Promemoria salvato!'); renderPage('reminders');
    }
    function toggleReminderPaid(id){
      const r=appData.reminders.find(x=>x.id===id);
      if(r){ r.paid=!r.paid; saveData(); showToast(r.paid?'Pagamento registrato!':'Pagamento annullato.'); renderPage('reminders'); }
    }
    function deleteReminder(id){
      const i=(appData.reminders||[]).findIndex(r=>r.id===id);
      if (i>-1){
        showModal('Eliminare promemoria?','Operazione irreversibile.',true,()=>{
          appData.reminders.splice(i,1); saveData(); showToast('Promemoria eliminato.','red'); renderPage('reminders');
        });
      }
    }
    function handleReminderSubmit(){
      const f=document.getElementById('reminder-form'); const d=new FormData(f);
      const payload={ type:d.get('type'), description:d.get('description'), date:d.get('date'), amount: parseFloat(d.get('amount'))||0 };
      if (payload.description && payload.date && payload.amount>0){
        saveReminder(payload); f.reset(); document.getElementById('reminder-date').value = new Date().toISOString().slice(0,10);
      } else showToast('Compila tutti i campi validi.','red');
    }

    function saveBirthday(data){
      appData.birthdays ||= [];
      const dateStr = data.date;
      const recurringDate = dateStr.slice(5);
      if (data.id){
        const i=appData.birthdays.findIndex(r=>r.id===data.id);
        if(i>-1){ appData.birthdays[i]={...appData.birthdays[i],...data, recurringDate}; }
      } else {
        appData.birthdays.push({ id:getNextId(), ...data, recurringDate });
      }
      saveData(); showToast('Compleanno salvato!'); renderPage('reminders');
    }
    function deleteBirthday(id){
      const i=(appData.birthdays||[]).findIndex(r=>r.id===id);
      if (i>-1){
        showModal('Eliminare compleanno?','Operazione irreversibile.',true,()=>{
          appData.birthdays.splice(i,1); saveData(); showToast('Compleanno eliminato.','red'); renderPage('reminders');
        });
      }
    }
    function handleBirthdaySubmit(){
      const f=document.getElementById('birthday-form'); const d=new FormData(f);
      const dateStr = d.get('date');
      const payload={ name: d.get('name').trim(), date: dateStr };
      if (payload.name && payload.date){
        saveBirthday(payload); f.reset(); document.getElementById('birthday-date').value = new Date().toISOString().slice(0,10);
      } else showToast('Compila tutti i campi validi.','red');
    }

    /* =============================
       IMPORT / EXPORT (hardening in Parte 2)
       ============================= */
    function exportDataJSON(){
      const dataStr = JSON.stringify(appData,null,2);
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`finanza_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('Backup JSON esportato!');
    }

    // CSV ‚Äútesto multi-sezione‚Äù (come prima ‚Äî migliorie in Parte 2)
    function exportCSV(){
      const tx = [...appData.invoices.map(t=>({...t,isIncome:true})), ...appData.expenses.map(t=>({...t,isIncome:false}))].sort((a,b)=> new Date(a.date)-new Date(b.date));
      const esc = (s)=> `"${String(s??'').replace(/"/g,'""')}"`;
      const summary = calculateFinancialSummary('global','all','all');
      const summaryRow = ['---RIEPILOGO---', `Saldo Netto: ${fmt.format(summary.netBalance)}${sym()}`, `Entrate Totali: ${fmt.format(summary.totalIncomes)}${sym()}`, `Uscite Totali: ${fmt.format(summary.totalExpenses)}${sym()}`].map(esc).join(',');
      const headerTx = ['ID','Tipo','Scope','Data','Descrizione','Fornitore','Categoria','Tag','AliquotaIVA','Netto','IVA','Lordo','Entrata?','Sottotipo'].join(',');
      const rowsTx = tx.map(t => [
        t.id, (t.isIncome?'Entrata':'Uscita'), t.type, t.date, t.description||'', t.supplier||'',
        t.category||'', (t.tags||[]).join('|'), t.vatRate, t.net, t.vatAmount, t.gross, t.isIncome, t.incomeType||''
      ].map(esc).join(','));
      const csvTx = [summaryRow, headerTx, ...rowsTx].join('\n');

      const headerRm = ['ID','Tipo','Descrizione','Data','Importo','Pagato?'].join(',');
      const rowsRm = (appData.reminders||[]).map(r => [r.id,r.type,r.description,r.date,r.amount,r.paid].map(esc).join(','));
      const csvRm = [headerRm, ...rowsRm].join('\n');

      const headerBd = ['ID','Nome','DataNascita','RicorrenzaMD'].join(',');
      const rowsBd = (appData.birthdays||[]).map(r => [r.id,r.name,r.date,r.recurringDate].map(esc).join(','));
      const csvBd = [headerBd, ...rowsBd].join('\n');

      const txt = `### Transazioni\n${csvTx}\n\n### Promemoria\n${csvRm}\n\n### Compleanni\n${csvBd}\n`;
      const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`finanza_export_${new Date().toISOString().slice(0,10)}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('Export CSV pronto.');
    }

    // Import con validazione migliorata (completa in Parte 2)
    function importDataFile(ev){
      const file = ev.target.files[0]; if(!file) return;
      const r = new FileReader();
      r.onload = (e)=>{
        try{
          const imported = JSON.parse(e.target.result);
          if (imported.invoices && imported.expenses && imported.reminders){
            showModal('Conferma Importazione', 'Sovrascrivere i dati attuali? (Consigliato backup prima)', true, ()=>{
              const all = [...imported.invoices, ...imported.expenses, ...imported.reminders, ...(imported.contacts||[]), ...(imported.birthdays||[])];
              const maxId = all.length>0 ? Math.max(...all.map(x=>x.id||0)) : 0;
              appData = { ...appData, ...imported, lastId: Math.max(maxId, appData.lastId) };
              appData.categories ||= DEFAULT_CATEGORIES.slice();
              appData.pinMeta ||= appData.pin ? null : appData.pinMeta;
              appData.currencySymbol ||= '‚Ç¨';
              appData.birthdays ||= [];
              appData.recurringExpenses ||= [];
              appData.monthlySavingsTarget ||= 0;
              // Fix recurringDate
              appData.birthdays = appData.birthdays.map(bd => ({ ...bd, recurringDate: (bd.date || bd.recurringDate).slice(5) }));
              saveData(); showToast('Dati importati!'); renderPage(currentPage);
            });
          } else { showToast('Backup JSON non valido.','red'); }
        } catch(err){ console.error(err); showToast('Errore lettura file JSON.','red'); }
      };
      r.readAsText(file);
    }

    /* =============================
       NAVBAR & ROUTER (render in Parte 2)
       ============================= */
    function renderNavbar(){
      const navbar=document.getElementById('navbar');
      const navItems=[
        {id:'activity',label:'Attivit√†',icon:'üíº'},
        {id:'personal',label:'Personale',icon:'üè†'},
        {id:'report',label:'Riepilogo',icon:'üìä'},
        {id:'reminders',label:'Scadenze',icon:'üîî'},
        {id:'settings',label:'Gestione Dati',icon:'‚öôÔ∏è'}
      ];
      navbar.innerHTML = navItems.map(it=>`
        <button onclick="renderPage('${it.id}')" class="p-2 text-sm font-medium rounded-lg transition hover:bg-gray-100 dark:hover:bg-gray-800 ${currentPage===it.id?'tab-active':'text-gray-500'}" type="button" aria-label="${it.label}">
          ${it.icon} <span class="hidden sm:inline">${it.label}</span>
        </button>
      `).join('');
    }

    /* =============================
       AUTOCOMPLETE (clienti/fornitori/categorie) ‚Äì UI wiring in Parte 2
       ============================= */
    function setupActivityIncomeTypeListeners(scope){
      if (scope!=='activity') return;
      const incomeTypeSelect = document.getElementById('incomeType');
      const isIncomeSelect = document.getElementById('isIncome');
      const descriptionDiv = document.getElementById('description-div');

      const updateVisibility = ()=>{
        const isIncome = isIncomeSelect.value==='true';
        const incomeType = incomeTypeSelect?.value || 'Fattura (Cliente)';
        if (isIncome && incomeType==='Incasso/Corrispettivo'){
          descriptionDiv.classList.add('hidden');
          const desc = document.getElementById('description');
          desc.removeAttribute('required');
          if (document.getElementById('transaction-form').getAttribute('data-transaction-id')===null) {
            desc.value = 'Corrispettivi/Incasso Giornaliero';
          }
          document.getElementById('description-label').textContent = 'Descrizione Incasso (Opzionale)';
        } else {
          descriptionDiv.classList.remove('hidden');
          const desc = document.getElementById('description');
          desc.setAttribute('required','required');
          if (document.getElementById('transaction-form').getAttribute('data-transaction-id')===null){ desc.value=''; }
          document.getElementById('description-label').textContent = isIncome ? 'Cliente / Descrizione' : 'Fornitore / Descrizione';
          setupContactAutocomplete(scope);
        }
      };

      incomeTypeSelect?.removeEventListener('change', updateVisibility);
      incomeTypeSelect?.addEventListener('change', updateVisibility);

      isIncomeSelect.removeEventListener('change', setupIncomeTypeControl);
      isIncomeSelect.addEventListener('change', setupIncomeTypeControl);

      function setupIncomeTypeControl() {
        const isIncome=isIncomeSelect.value==='true';
        const ctl=document.getElementById('income-type-control');
        if (scope==='activity' && ctl){ ctl.classList.toggle('hidden', !isIncome); }
        updateVisibility();
      }
      setupIncomeTypeControl();
    }

    function setupContactAutocomplete(scope){
      const isIncome = document.getElementById('isIncome').value==='true';
      const incomeType = document.getElementById('incomeType')?.value;
      const input = document.getElementById('description');
      const datalist = document.getElementById('contact-list');
      if (!input || !datalist) return;
      if (scope==='activity' && isIncome && incomeType==='Incasso/Corrispettivo'){ datalist.innerHTML=''; return; }
      const relation = isIncome ? 'client':'supplier';
      const contacts = appData.contacts
        .filter(c=> c.scope===scope && (c.relation===relation || c.relation==='both'))
        .sort((a,b)=> a.name.localeCompare(b.name));
      datalist.innerHTML = contacts.map(c=> `<option value="${h(c.name)}"></option>`).join('');
      input.setAttribute('list','contact-list');
    }

    // NUOVO: autocomplete fornitori espliciti
    function setupSupplierAutocomplete(scope){
      const input = document.getElementById('supplier');
      const datalist = document.getElementById('supplier-list');
      if (!input || !datalist) return;
      const names = getAllSuppliers(scope);
      datalist.innerHTML = names.map(n=> `<option value="${h(n)}"></option>`).join('');
      input.setAttribute('list','supplier-list');
    }

    function setupCategoryAutocomplete(){
      const dl = document.getElementById('category-list');
      if (!dl) return;
      const all = (appData.categories||DEFAULT_CATEGORIES).slice().sort((a,b)=>a.localeCompare(b));
      dl.innerHTML = all.map(c=> `<option value="${h(c)}"></option>`).join('');
    }
<script>
/* =============================
   PARTE 2 / 2 ‚Äì UI, REPORT, SETTINGS
   ============================= */

/* ---------- RENDER GENERICO ---------- */
function renderPage(page){
  currentPage = page;
  renderNavbar();
  const area = document.getElementById('content-area');
  area.innerHTML = '';
  if(page==='activity'||page==='personal') renderTransactionsPage(page);
  else if(page==='report') renderReportPage();
  else if(page==='reminders') renderRemindersPage();
  else if(page==='settings') renderSettingsPage();
}

/* ---------- PAGINA TRANSAZIONI ---------- */
function renderTransactionsPage(scope){
  const isActivity = scope==='activity';
  const listIn = appData.invoices.filter(t=>t.type===scope);
  const listOut = appData.expenses.filter(t=>t.type===scope);
  const all = [...listIn.map(t=>({...t,isIncome:true})), ...listOut.map(t=>({...t,isIncome:false}))].sort((a,b)=> new Date(b.date)-new Date(a.date));
  const area=document.getElementById('content-area');
  area.innerHTML=`
    <div class="mb-4">
      <h2 class="text-2xl font-bold mb-2">${isActivity?'üíº Attivit√†':'üè† Personale'}</h2>
      <p class="text-gray-500 text-sm mb-4">Registra movimenti e gestisci clienti / fornitori</p>
      <div id="transaction-form-anchor"></div>
      <form id="transaction-form" class="bg-white dark:bg-gray-900 p-4 rounded-xl card space-y-3" onsubmit="event.preventDefault();handleTransactionSubmit('${scope}')">
        <div class="flex gap-2">
          <select id="isIncome" name="isIncome" class="flex-1 border rounded-lg p-2">
            <option value="true">Entrata</option>
            <option value="false">Uscita</option>
          </select>
          ${isActivity?`
          <div id="income-type-control" class="flex-1">
            <select id="incomeType" name="incomeType" class="border rounded-lg p-2 w-full">
              <option>Fattura (Cliente)</option>
              <option>Incasso/Corrispettivo</option>
            </select>
          </div>`:''}
        </div>
        <input type="date" id="date" name="date" class="border rounded-lg p-2 w-full" required/>
        <div id="description-div">
          <label id="description-label" class="block text-sm mb-1">Cliente / Descrizione</label>
          <input type="text" id="description" name="description" list="contact-list" class="border rounded-lg p-2 w-full" required/>
          <datalist id="contact-list"></datalist>
        </div>
        <div>
          <label class="block text-sm mb-1">Fornitore (opzionale)</label>
          <input type="text" id="supplier" name="supplier" list="supplier-list" class="border rounded-lg p-2 w-full"/>
          <datalist id="supplier-list"></datalist>
        </div>
        <div class="flex gap-2">
          <input type="number" id="net-amount" name="net" step="0.01" class="border rounded-lg p-2 flex-1" placeholder="Netto" oninput="calculateGross()"/>
          <select id="vat-rate" name="vatRate" class="border rounded-lg p-2" onchange="calculateGross()">
            ${IVA_RATES.map(v=>`<option value="${v}">${v}%</option>`).join('')}
          </select>
        </div>
        <div class="text-sm text-gray-500">IVA: <span id="vat-amount-display">0.00</span> ${sym()} ‚Äî Lordo: <span id="gross-amount-display">0.00</span> ${sym()}</div>
        <input type="text" id="category" name="category" list="category-list" placeholder="Categoria" class="border rounded-lg p-2 w-full"/>
        <datalist id="category-list"></datalist>
        <input type="text" id="tags" name="tags" placeholder="Tag (separati da virgola)" class="border rounded-lg p-2 w-full"/>
        <button type="submit" class="w-full bg-emerald-500 text-white p-2 rounded-lg font-semibold hover:bg-emerald-600 transition cta-button">Registra Movimento</button>
      </form>
    </div>
    <div class="mt-6">
      <h3 class="font-semibold mb-2">Movimenti recenti</h3>
      <ul class="divide-y divide-gray-200 dark:divide-gray-700">
        ${all.slice(0,MAX_RECENT_TRANSACTIONS).map(t=>`
          <li class="py-2 flex justify-between items-center">
            <div><span class="mr-1">${getCategoryIcon(t.category)}</span>${h(t.description||t.supplier||'-')}<br><small class="text-gray-500">${h(t.category)} ‚Äî ${h(t.supplier||'')}</small></div>
            <div class="text-right">
              <span class="${t.isIncome?'text-emerald-600':'text-red-500'} font-semibold">${t.isIncome?'+':'-'}${fmt.format(t.gross)}${sym()}</span><br>
              <button onclick="editTransaction(${t.isIncome},${t.id},'${scope}')" class="text-xs text-blue-500">Modifica</button>
              <button onclick="duplicateTransaction(${t.isIncome},${t.id},'${scope}')" class="text-xs text-emerald-500 ml-2">Duplica</button>
              <button onclick="deleteTransaction(${t.isIncome},${t.id})" class="text-xs text-red-500 ml-2">Elimina</button>
            </div>
          </li>`).join('')}
      </ul>
    </div>`;
  setupActivityIncomeTypeListeners(scope);
  setupContactAutocomplete(scope);
  setupSupplierAutocomplete(scope);
  setupCategoryAutocomplete();
  calculateGross();
}

/* ---------- PAGINA REPORT ---------- */
function renderReportPage(){
  const area=document.getElementById('content-area');
  const suppliers=getAllSuppliers('activity').concat(getAllSuppliers('personal'));
  area.innerHTML=`
    <h2 class="text-2xl font-bold mb-4">üìä Riepilogo</h2>
    <div class="flex flex-wrap gap-2 mb-4">
      <select id="scope-select" class="border p-2 rounded">
        <option value="global">Globale</option>
        <option value="activity">Attivit√†</option>
        <option value="personal">Personale</option>
      </select>
      <select id="filter-type" class="border p-2 rounded">
        <option value="all">Tutto</option><option value="month">Mese</option>
        <option value="year">Anno</option><option value="quarter">Trimestre</option>
      </select>
      <input type="month" id="filter-date" class="border p-2 rounded"/>
      <select id="supplier-filter" class="border p-2 rounded">
        <option value="">Tutti i Fornitori</option>
        ${suppliers.map(s=>`<option>${h(s)}</option>`).join('')}
      </select>
      <button class="bg-emerald-500 text-white px-3 rounded" onclick="updateReport()">Aggiorna</button>
    </div>
    <div id="report-output"></div>
    <canvas id="trendChart" class="mt-6"></canvas>`;
  updateReport();
}
function updateReport(){
  const scope=document.getElementById('scope-select').value;
  const filterType=document.getElementById('filter-type').value;
  const filterDate=document.getElementById('filter-date').value;
  const supplier=document.getElementById('supplier-filter').value.trim();
  let summary=calculateFinancialSummary(scope,filterType,filterDate);
  if(supplier){
    summary.transactions=summary.transactions.filter(t=> (t.supplier||'').toLowerCase()===supplier.toLowerCase());
    summary.totalIncomes=summary.transactions.filter(t=>t.isIncome).reduce((s,t)=>s+t.gross,0);
    summary.totalExpenses=summary.transactions.filter(t=>!t.isIncome).reduce((s,t)=>s+t.gross,0);
    summary.netBalance=summary.totalIncomes-summary.totalExpenses;
  }
  const out=document.getElementById('report-output');
  out.innerHTML=`
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
      <div class="p-3 bg-white dark:bg-gray-900 rounded card"><div class="text-sm text-gray-500">Entrate</div><div class="text-lg font-bold text-emerald-600">${fmt.format(summary.totalIncomes)}${sym()}</div></div>
      <div class="p-3 bg-white dark:bg-gray-900 rounded card"><div class="text-sm text-gray-500">Uscite</div><div class="text-lg font-bold text-red-500">${fmt.format(summary.totalExpenses)}${sym()}</div></div>
      <div class="p-3 bg-white dark:bg-gray-900 rounded card"><div class="text-sm text-gray-500">Saldo</div><div class="text-lg font-bold">${fmt.format(summary.netBalance)}${sym()}</div></div>
    </div>
    <h3 class="mt-4 mb-2 font-semibold">Ultime transazioni</h3>
    <ul class="divide-y divide-gray-200 dark:divide-gray-700">
      ${summary.transactions.slice(0,10).map(t=>`
        <li class="py-2 flex justify-between"><span>${h(t.description||t.supplier||'-')} <small class="text-gray-500">${h(t.supplier||'')}</small></span>
        <span class="${t.isIncome?'text-emerald-500':'text-red-500'}">${t.isIncome?'+':'-'}${fmt.format(t.gross)}${sym()}</span></li>`).join('')}
    </ul>`;
  const ctx=getCtx('trendChart'); if(!ctx)return;
  const daily={}; summary.transactions.forEach(t=>{
    const k=t.date; daily[k]=(daily[k]||0)+(t.isIncome?t.gross:-t.gross);
  });
  const labels=Object.keys(daily).sort(); const data=labels.map(k=>daily[k]);
  const chart=new Chart(ctx.ctx,{type:'line',data:{labels,datasets:[{label:'Saldo Giornaliero',data,borderWidth:2}]}});
  charts.set(ctx.id,chart);
}

/* ---------- PAGINA PROMEMORIA ---------- */
function renderRemindersPage(){
  const area=document.getElementById('content-area');
  const today=new Date();
  const rems=(appData.reminders||[]).sort((a,b)=> new Date(a.date)-new Date(b.date));
  const bds=(appData.birthdays||[]).sort((a,b)=> a.recurringDate.localeCompare(b.recurringDate));
  area.innerHTML=`
    <h2 class="text-2xl font-bold mb-4">üîî Promemoria & Compleanni</h2>
    <form id="reminder-form" onsubmit="event.preventDefault();handleReminderSubmit()" class="bg-white dark:bg-gray-900 p-4 rounded-xl card mb-4">
      <div class="flex gap-2 mb-2">
        <select name="type" class="border p-2 rounded flex-1"><option>Scadenza</option><option>Pagamento</option></select>
        <input type="date" name="date" id="reminder-date" class="border p-2 rounded flex-1" required/>
      </div>
      <input type="text" name="description" placeholder="Descrizione" class="border p-2 rounded w-full mb-2" required/>
      <input type="number" name="amount" placeholder="Importo" step="0.01" class="border p-2 rounded w-full mb-2"/>
      <button class="bg-emerald-500 text-white p-2 rounded w-full">Salva Promemoria</button>
    </form>
    <h3 class="font-semibold mb-2">Promemoria</h3>
    <ul class="divide-y">${rems.map(r=>`
      <li class="py-2 flex justify-between"><div>${h(r.description)}<br><small>${r.date}</small></div>
      <div><span class="text-sm ${r.paid?'text-emerald-500':'text-red-500'}">${fmt.format(r.amount)}${sym()}</span><br>
      <button onclick="toggleReminderPaid(${r.id})" class="text-xs text-blue-500">${r.paid?'Annulla':'Pagato'}</button>
      <button onclick="deleteReminder(${r.id})" class="text-xs text-red-500 ml-2">Elimina</button></div></li>`).join('')}</ul>
    <hr class="my-4"/>
    <form id="birthday-form" onsubmit="event.preventDefault();handleBirthdaySubmit()" class="bg-white dark:bg-gray-900 p-4 rounded-xl card mb-4">
      <div class="flex gap-2 mb-2"><input type="text" name="name" placeholder="Nome" class="border p-2 rounded flex-1" required/>
      <input type="date" name="date" id="birthday-date" class="border p-2 rounded flex-1" required/></div>
      <button class="bg-emerald-500 text-white p-2 rounded w-full">Salva Compleanno</button>
    </form>
    <h3 class="font-semibold mb-2">Compleanni</h3>
    <ul class="divide-y">${bds.map(b=>`<li class="py-2 flex justify-between"><span>${h(b.name)} (${b.date})</span><button onclick="deleteBirthday(${b.id})" class="text-xs text-red-500">Elimina</button></li>`).join('')}</ul>`;
  document.getElementById('reminder-date').value=today.toISOString().slice(0,10);
  document.getElementById('birthday-date').value=today.toISOString().slice(0,10);
}

/* ---------- PAGINA SETTINGS ---------- */
function renderSettingsPage(){
  const area=document.getElementById('content-area');
  area.innerHTML=`
    <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Gestione Dati</h2>
    <div class="space-y-3">
      <button onclick="exportDataJSON()" class="w-full bg-blue-500 text-white p-2 rounded">üì§ Esporta JSON</button>
      <button onclick="exportCSV()" class="w-full bg-blue-500 text-white p-2 rounded">üìÑ Esporta CSV</button>
      <input type="file" id="import-file" class="w-full border p-2 rounded" accept="application/json" onchange="importDataFile(event)"/>
      <hr/>
      <div class="bg-white dark:bg-gray-900 p-4 rounded card">
        <h3 class="font-semibold mb-2">Pulizia dati</h3>
        <button onclick="clearMonth()" class="bg-yellow-500 text-white p-2 rounded w-full mb-2">üóìÔ∏è Pulisci mese corrente</button>
        <button onclick="clearYear()" class="bg-yellow-500 text-white p-2 rounded w-full mb-2">üìÖ Pulisci anno corrente</button>
        <button onclick="clearAllData()" class="bg-red-600 text-white p-2 rounded w-full">üßπ Pulisci tutto</button>
      </div>
      <hr/>
      <div class="bg-white dark:bg-gray-900 p-4 rounded card">
        <h3 class="font-semibold mb-2">Sicurezza PIN</h3>
        <input type="password" id="current-pin" placeholder="PIN attuale" class="border p-2 rounded w-full mb-2"/>
        <input type="password" id="new-pin" placeholder="Nuovo PIN (4 cifre)" class="border p-2 rounded w-full mb-2"/>
        <button onclick="changePin()" class="bg-emerald-500 text-white p-2 rounded w-full">üîë Cambia PIN</button>
      </div>
    </div>`;
}

/* ---------- PULIZIA DATI ---------- */
function clearMonth(){
  const now=new Date(); const ym=now.toISOString().slice(0,7);
  showModal('Conferma','Eliminare movimenti del mese corrente?',true,()=>{
    appData.invoices=appData.invoices.filter(t=>!t.date.startsWith(ym));
    appData.expenses=appData.expenses.filter(t=>!t.date.startsWith(ym));
    saveData(); showToast('Mese corrente pulito.'); renderPage('settings');
  });
}
function clearYear(){
  const y=new Date().getFullYear();
  showModal('Conferma','Eliminare movimenti dell\'anno corrente?',true,()=>{
    appData.invoices=appData.invoices.filter(t=>!t.date.startsWith(y));
    appData.expenses=appData.expenses.filter(t=>!t.date.startsWith(y));
    saveData(); showToast('Anno corrente pulito.'); renderPage('settings');
  });
}
function clearAllData(){
  showModal('Attenzione','Eliminare tutti i dati? Operazione irreversibile.',true,()=>{
    localStorage.removeItem(LOCAL_STORAGE_KEY);
    location.reload();
  });
}

/* ---------- SERVICE WORKER (PWA) ---------- */
async function installServiceWorker(){
  if(!('serviceWorker'in navigator))return;
  const code=`const CACHE='finanza-smart-v2';
    self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))));
    self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))))`;
  const blob=new Blob([code],{type:'text/javascript'}); const url=URL.createObjectURL(blob);
  try{await navigator.serviceWorker.register(url);}catch(e){console.warn('SW fail',e);}
}

/* ---------- INIZIALIZZAZIONE ---------- */
window.addEventListener('DOMContentLoaded',()=>{
  loadData();
  applySavedTheme();
  renderNavbar();
  setupPinLock();
  installServiceWorker();
});

/* ---------- HOTKEYS ---------- */
window.addEventListener('keydown',(e)=>{
  if(e.altKey&&e.key==='1')renderPage('activity');
  if(e.altKey&&e.key==='2')renderPage('personal');
  if(e.altKey&&e.key==='3')renderPage('report');
  if(e.altKey&&e.key==='4')renderPage('reminders');
  if(e.altKey&&e.key==='5')renderPage('settings');
  if(e.altKey&&e.key==='i')quickRegister('true');
  if(e.altKey&&e.key==='e')quickRegister('false');
});
document.getElementById('theme-toggle').addEventListener('click',toggleTheme);

  </script>
</body>
</html>
