<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Contabilit√† ‚Äì Vue 3 (moderna + scadenze)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- html2canvas + jsPDF per Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root { --bg:#0f1117; --panel:#171923; --panel-2:#1f2330; --muted:#9aa4b2; }
    body { background:var(--bg); color:#e6e8eb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .panel { background:var(--panel); border:1px solid #2a3142; border-radius:14px; }
    .panel-2 { background:var(--panel-2); border:1px solid #2a3142; border-radius:14px; }
    .btn { background:#5767ff; color:white; padding:10px 14px; border-radius:10px; font-weight:600; }
    .btn:hover { background:#6f7bff; }
    .btn-ghost { background:transparent; border:1px solid #2a3142; color:#cfd5df; padding:10px 14px; border-radius:10px; }
    .chip { border:1px solid #2a3142; background:#1b2130; padding:4px 10px; border-radius:999px; font-size:12px; color:#cfd5df; }
    .input, select, datalist, option, textarea {
      background:#151a27; border:1px solid #2a3142; color:#e6e8eb; padding:10px 12px; border-radius:10px; width:100%;
    }
    .input:focus, select:focus, textarea:focus { outline:1px solid #5767ff; border-color:#5767ff; }
    .kpi { display:flex; flex-direction:column; gap:8px; }
    .kpi .value { font-size:28px; font-weight:800; letter-spacing: -0.2px; }
    .kpi .sub { color:var(--muted); font-size:12px; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #2a3142; }
    .danger { background: rgba(239, 68, 68, .15); color:#fecaca; border-color:#ef4444; }
    .warn { background: rgba(245, 158, 11, .15); color:#fde68a; border-color:#f59e0b; }
    .ok { background: rgba(34, 197, 94, .15); color:#bbf7d0; border-color:#22c55e; }
    dialog::backdrop { background: rgba(0,0,0,.5); }
    .modal { width:min(780px, 95vw); background:#0f1117; border:1px solid #2a3142; border-radius:14px; }
    .modal-header { padding:16px; border-bottom:1px solid #2a3142; }
    .modal-body { padding:16px; }
    .modal-footer { padding:16px; border-top:1px solid #2a3142; display:flex; justify-content:flex-end; gap:8px; }
    .table thead th { color:#b8c0cc; font-weight:600; text-align:left; padding:10px 8px; border-bottom:1px solid #2a3142; }
    .table tbody td { padding:10px 8px; border-bottom:1px solid #23293a; }
    @media (max-width: 768px) { .grid-auto { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div id="app" class="max-w-7xl mx-auto p-4 md:p-6">

  <!-- BANNER giornaliero scadenze -->
  <div v-if="banner.items.length" class="panel p-3 mb-4 flex items-start gap-3">
    <div class="text-2xl">üîî</div>
    <div class="flex-1">
      <div class="font-semibold">Promemoria di oggi</div>
      <div class="text-sm text-[#c9d2dd]">
        <span v-if="banner.today.length">Oggi: {{ banner.today.map(e=>e.title).join(', ') }}.</span>
        <span v-if="banner.soon.length"> In arrivo entro 7 giorni: {{ banner.soon.map(e=>`${e.title} (${e.dday}g)`).join(', ') }}.</span>
        <span v-if="banner.overdue.length" class="text-rose-300"> Scaduti: {{ banner.overdue.map(e=>e.title).join(', ') }}!</span>
      </div>
    </div>
    <button class="btn-ghost" @click="dismissBannerToday">Ok</button>
  </div>

  <!-- HEADER -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div>
      <div class="text-sm text-[#9aa4b2]">Dashboard</div>
      <h1 class="text-2xl font-extrabold tracking-tight">Contabilit√† & Scadenze</h1>
    </div>
    <div class="flex flex-wrap gap-2">
      <input type="file" id="csvInput" accept=".csv" class="hidden" @change="importCSV">
      <button class="btn-ghost" @click="$refs.csvBtn.click()" ref="csvBtn">üìÇ Importa CSV</button>
      <button class="btn-ghost" @click="exportCSV">üì§ Esporta CSV</button>
      <button class="btn-ghost" @click="exportPDF">üìÑ Esporta PDF</button>
      <button class="btn" @click="openSettings">‚öôÔ∏è Impostazioni</button>
    </div>
  </div>

  <!-- ALERT proattivo (economico) -->
  <div v-if="risk.flags.length" class="panel p-3 mb-4">
    <div class="font-semibold mb-1">Attenzione</div>
    <div class="flex flex-wrap gap-2">
      <span v-for="f in risk.flags" :key="f" class="pill danger">{{ f }}</span>
    </div>
  </div>

  <!-- FILTRI -->
  <div class="panel p-3 mb-5">
    <div class="grid grid-cols-2 md:grid-cols-8 gap-2">
      <select v-model="filters.year">
        <option v-for="y in years" :key="y" :value="y">{{ y }}</option>
      </select>
      <select v-model="filters.month">
        <option v-for="(m,i) in months" :key="m" :value="i">{{ m }}</option>
      </select>
      <select v-model="filters.activity">
        <option>Tutte</option>
        <option v-for="a in activities" :key="a">{{ a }}</option>
      </select>
      <select v-model="filters.account">
        <option>Tutti</option>
        <option v-for="a in accounts" :key="a">{{ a }}</option>
      </select>
      <input type="date" v-model="filters.from" class="input" placeholder="Da">
      <input type="date" v-model="filters.to" class="input" placeholder="A">
      <div class="flex items-center gap-2">
        <span class="chip">Budget spese: ‚Ç¨{{ settings.budgetSpese }}</span>
        <span class="chip">Soglia IVA: ‚Ç¨{{ settings.ivaThreshold }}</span>
      </div>
    </div>
  </div>

  <!-- KPI moderni -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
    <div class="panel p-4">
      <div class="flex items-start justify-between">
        <div class="kpi">
          <div class="text-sm text-[#9aa4b2]">Entrate</div>
          <div class="value text-emerald-300">{{ fmtEUR(kpi.totEntrate) }}</div>
          <div class="sub">mese {{ months[filters.month] }} {{ filters.year }}</div>
        </div>
        <canvas id="sparkIn" width="160" height="60"></canvas>
      </div>
    </div>
    <div class="panel p-4">
      <div class="flex items-start justify-between">
        <div class="kpi">
          <div class="text-sm text-[#9aa4b2]">Spese</div>
          <div class="value text-rose-300">{{ fmtEUR(kpi.totSpese) }}</div>
          <div class="sub">mese {{ months[filters.month] }} {{ filters.year }}</div>
        </div>
        <canvas id="sparkOut" width="160" height="60"></canvas>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
    <div class="panel p-4">
      <div class="text-sm text-[#9aa4b2]">Profitto</div>
      <div class="value text-indigo-300">{{ fmtEUR(kpi.profitto) }}</div>
    </div>
    <div class="panel p-4">
      <div class="text-sm text-[#9aa4b2]">IVA da versare</div>
      <div class="value text-amber-300">{{ fmtEUR(kpi.ivaDaVersare) }}</div>
    </div>
    <div class="panel p-4">
      <div class="text-sm text-[#9aa4b2]">Liquidit√† (stima)</div>
      <div class="value text-cyan-300">{{ fmtEUR(kpi.liquidita) }}</div>
    </div>
  </div>

  <!-- GRAFICI principali -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
    <div class="panel p-4">
      <div class="font-semibold mb-2">Ripartizione mensile</div>
      <canvas id="donut"></canvas>
    </div>
    <div class="panel p-4">
      <div class="font-semibold mb-2">Trend (12 mesi)</div>
      <canvas id="bar"></canvas>
    </div>
  </div>

  <!-- FORM aggiunta record (LIVE) -->
  <div class="panel p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold">‚ûï Nuovo movimento</div>
      <div class="text-xs text-[#9aa4b2]">L'anteprima live √® inclusa nei KPI finch√© compili</div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-7 gap-2">
      <input type="date" v-model="draft.Data" class="input">
      <select v-model="draft.Tipo">
        <option>entrata</option><option>spesa</option>
      </select>
      <input type="number" step="0.01" v-model.number="draft.Importo" class="input" placeholder="Importo">
      <input type="number" step="1" v-model.number="draft.IVA" class="input" placeholder="IVA %">
      <input list="cats" v-model="draft.Categoria" class="input" placeholder="Categoria">
      <datalist id="cats">
        <option v-for="c in categories" :key="c" :value="c"></option>
      </datalist>
      <input list="accts" v-model="draft.Conto" class="input" placeholder="Conto">
      <datalist id="accts">
        <option v-for="a in accounts" :key="a" :value="a"></option>
      </datalist>
      <input list="acts" v-model="draft.Attivita" class="input" placeholder="Attivit√†">
      <datalist id="acts">
        <option v-for="a in activities" :key="a" :value="a"></option>
      </datalist>
    </div>
    <div class="flex gap-2 mt-3">
      <button class="btn" @click="addRow">Aggiungi</button>
      <button class="btn-ghost" @click="clearDraft">Pulisci</button>
    </div>
  </div>

  <!-- TAB Movimenti -->
  <div class="panel p-4 mb-10">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold">üìã Movimenti</div>
      <div class="text-xs text-[#9aa4b2]">{{ filteredRows.length }} righe</div>
    </div>
    <div class="overflow-x-auto">
      <table class="table w-full text-sm">
        <thead>
          <tr>
            <th>Data</th><th>Tipo</th><th>Importo</th><th>IVA</th><th>Categoria</th><th>Conto</th><th>Attivit√†</th><th class="text-right">Azioni</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="r in filteredRows" :key="r.id">
            <td>{{ r.Data }}</td>
            <td :class="r.Tipo==='spesa'?'text-rose-300':'text-emerald-300'">{{ r.Tipo }}</td>
            <td>{{ fmtEUR(r.Importo) }}</td>
            <td>{{ r.IVA }}%</td>
            <td>{{ r.Categoria }}</td>
            <td>{{ r.Conto }}</td>
            <td>{{ r.Attivita }}</td>
            <td class="text-right">
              <button class="btn-ghost" @click="openEdit(r)">‚úèÔ∏è</button>
              <button class="btn-ghost" @click="removeRow(r.id)">üóëÔ∏è</button>
            </td>
          </tr>
          <tr v-if="!filteredRows.length">
            <td colspan="8" class="text-center text-[#9aa4b2] py-4">Nessuna voce con i filtri correnti</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- SCADENZE & PROMEMORIA -->
  <div class="panel p-4 mb-4">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold">‚è∞ Scadenze & Promemoria</div>
      <button class="btn-ghost" @click="openEventModal()">‚ûï Nuova scadenza</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div v-for="e in sortedEvents" :key="e.id" class="panel-2 p-3 flex items-start justify-between">
        <div>
          <div class="font-semibold">{{ e.title }}</div>
          <div class="text-xs text-[#9aa4b2]">{{ e.kind }} ‚Ä¢ {{ e.date }}</div>
          <div class="mt-1">
            <span class="pill" :class="deadlineClass(e)">{{ deadlineLabel(e) }}</span>
            <span v-if="e.done" class="pill ok ml-2">Completato</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-ghost" @click="openEventModal(e)">‚úèÔ∏è</button>
          <button class="btn-ghost" @click="removeEvent(e.id)">üóëÔ∏è</button>
        </div>
      </div>
      <div v-if="!sortedEvents.length" class="text-[#9aa4b2] text-sm">Nessuna scadenza. Aggiungine una con ‚ÄúNuova scadenza‚Äù.</div>
    </div>
  </div>

  <!-- MODALE EDIT MOVIMENTO -->
  <dialog ref="editDlg" class="modal">
    <div class="modal-header"><div class="font-semibold">Modifica movimento</div></div>
    <div class="modal-body">
      <div class="grid grid-cols-1 md:grid-cols-7 gap-2">
        <input type="date" v-model="editRow.Data" class="input">
        <select v-model="editRow.Tipo"><option>entrata</option><option>spesa</option></select>
        <input type="number" step="0.01" v-model.number="editRow.Importo" class="input">
        <input type="number" step="1" v-model.number="editRow.IVA" class="input">
        <input list="cats" v-model="editRow.Categoria" class="input">
        <input list="accts" v-model="editRow.Conto" class="input">
        <input list="acts" v-model="editRow.Attivita" class="input">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="$refs.editDlg.close()">Annulla</button>
      <button class="btn" @click="saveEdit">Salva</button>
    </div>
  </dialog>

  <!-- MODALE EVENTO -->
  <dialog ref="eventDlg" class="modal">
    <div class="modal-header"><div class="font-semibold">{{ eventDraft.id ? 'Modifica scadenza' : 'Nuova scadenza' }}</div></div>
    <div class="modal-body">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input class="input" v-model="eventDraft.title" placeholder="Titolo (es. IVA 4¬∞ trim / Assicurazione auto / Compleanno Mario)">
        <select v-model="eventDraft.kind">
          <option>Fiscale</option><option>Assicurazione</option><option>Bolletta</option><option>Compleanno</option><option>Altro</option>
        </select>
        <input type="date" class="input" v-model="eventDraft.date">
        <label class="flex items-center gap-2 mt-1">
          <input type="checkbox" v-model="eventDraft.done"> <span>Completato</span>
        </label>
        <input class="input md:col-span-2" v-model="eventDraft.note" placeholder="Note (facoltative)">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="$refs.eventDlg.close()">Annulla</button>
      <button class="btn" @click="saveEvent">Salva</button>
    </div>
  </dialog>

  <!-- MODALE IMPOSTAZIONI -->
  <dialog ref="settingsDlg" class="modal">
    <div class="modal-header"><div class="font-semibold">Impostazioni</div></div>
    <div class="modal-body">
      <label class="flex items-center gap-2 mb-3">
        <input type="checkbox" v-model="settings.proactive"> <span>Abilita modalit√† proattiva (alert automatici)</span>
      </label>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <div class="text-sm text-[#9aa4b2] mb-1">Budget spese mensili (‚Ç¨)</div>
          <input class="input" type="number" v-model.number="settings.budgetSpese">
        </div>
        <div>
          <div class="text-sm text-[#9aa4b2] mb-1">Soglia IVA da versare (‚Ç¨)</div>
          <input class="input" type="number" v-model.number="settings.ivaThreshold">
        </div>
      </div>
      <div class="text-xs text-[#9aa4b2] mt-3">Le impostazioni sono salvate nel browser.</div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="$refs.settingsDlg.close()">Chiudi</button>
      <button class="btn" @click="saveSettings">Salva</button>
    </div>
  </dialog>

  <!-- AZIONI secondarie -->
  <div class="flex flex-wrap gap-2 mt-4">
    <button class="btn-ghost" @click="clearAll">üßπ Svuota tutto (movimenti + scadenze)</button>
  </div>

</div>

<script>
const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue;

createApp({
  setup() {
    // ---------- Costanti / Storage Keys ----------
    const TX_KEY = 'vue_sbd_tx_v1';
    const EV_KEY = 'vue_sbd_ev_v1';
    const ST_KEY = 'vue_sbd_settings_v1';
    const BN_KEY = 'vue_sbd_banner_seen_on'; // "YYYY-MM-DD"

    // ---------- Dati reattivi ----------
    const rows = ref([]);                // movimenti
    const events = ref([]);              // scadenze
    const settings = reactive({ proactive: true, budgetSpese: 5000, ivaThreshold: 2000 });
    const filters = reactive({ year: 2025, month: 7, activity: 'Tutte', account: 'Tutti', from: '', to: '' });

    // draft movimento (live)
    const draft = reactive({ Data:'', Tipo:'entrata', Importo:null, IVA:null, Categoria:'', Conto:'', Attivita:'' });

    // edit movimento
    const editRow = reactive({ id:null, Data:'', Tipo:'entrata', Importo:0, IVA:0, Categoria:'', Conto:'', Attivita:'' });

    // event draft
    const eventDraft = reactive({ id:null, title:'', kind:'Fiscale', date:'', done:false, note:'' });

    // liste filtro
    const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    const years = [2024,2025,2026];

    // derivazioni
    const activities = computed(() => uniq(rows.value.map(r=>r.Attivita)).filter(Boolean));
    const accounts = computed(() => uniq(rows.value.map(r=>r.Conto)).filter(Boolean));
    const categories = computed(() => uniq(rows.value.map(r=>r.Categoria)).filter(Boolean));

    // ---------- Utils ----------
    const fmtEUR = n => (isFinite(n)?n:0).toLocaleString('it-IT',{ style:'currency', currency:'EUR' });
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    function uniq(arr) { return [...new Set(arr)]; }
    const parseDate = s => s ? new Date(s+'T00:00:00') : null; // no TZ shift

    // ---------- Persistenza ----------
    function saveAll(){ localStorage.setItem(TX_KEY, JSON.stringify(rows.value)); localStorage.setItem(EV_KEY, JSON.stringify(events.value)); localStorage.setItem(ST_KEY, JSON.stringify(settings)); }
    function loadAll(){
      try {
        const tx = JSON.parse(localStorage.getItem(TX_KEY)||'[]');
        const ev = JSON.parse(localStorage.getItem(EV_KEY)||'[]');
        const st = JSON.parse(localStorage.getItem(ST_KEY)||'{}');
        rows.value = Array.isArray(tx) && tx.length ? tx : demoRows();
        events.value = Array.isArray(ev) ? ev : [];
        Object.assign(settings, { proactive: st.proactive ?? true, budgetSpese: st.budgetSpese ?? 5000, ivaThreshold: st.ivaThreshold ?? 2000 });
      } catch { rows.value = demoRows(); events.value = []; }
    }
    function demoRows() {
      return [
        { id:uid(), Data:'2025-08-02', Tipo:'entrata', Importo:2300, IVA:22, Categoria:'PRODOTTO X', Conto:'POS', Attivita:'Negozio 4' },
        { id:uid(), Data:'2025-08-03', Tipo:'entrata', Importo:1900, IVA:22, Categoria:'PRODOTTO Z', Conto:'Contanti', Attivita:'Negozio 1' },
        { id:uid(), Data:'2025-08-04', Tipo:'entrata', Importo:9397.85, IVA:10, Categoria:'ONLINE', Conto:'Online', Attivita:'Negozio 4' },
        { id:uid(), Data:'2025-08-05', Tipo:'entrata', Importo:7054.31, IVA:10, Categoria:'CONTANTI', Conto:'Contanti', Attivita:'Negozio 2' },
        { id:uid(), Data:'2025-08-06', Tipo:'spesa', Importo:1280, IVA:22, Categoria:'Affitto', Conto:'Unicredit', Attivita:'Negozio 4' },
        { id:uid(), Data:'2025-08-07', Tipo:'spesa', Importo:560, IVA:10, Categoria:'Utenze', Conto:'Unicredit', Attivita:'Negozio 4' },
        { id:uid(), Data:'2025-08-08', Tipo:'spesa', Importo:2300, IVA:22, Categoria:'Marketing / Pubblicit√†', Conto:'Online', Attivita:'Negozio 4' },
        { id:uid(), Data:'2025-08-09', Tipo:'spesa', Importo:190, IVA:22, Categoria:'Manutenzione', Conto:'POS', Attivita:'Negozio 1' },
      ];
    }

    // ---------- Filtri & lista reattiva ----------
    const previewDraft = computed(()=>{
      const d = draft;
      if (!d.Data || !d.Importo || isNaN(+d.Importo)) return null;
      return { id:'_preview_', ...d };
    });

    const filteredRows = computed(()=>{
      const year = +filters.year, month = +filters.month;
      const from = parseDate(filters.from), to = parseDate(filters.to);
      const att = filters.activity, acc = filters.account;

      const base = rows.value.slice();
      if (previewDraft.value) base.push(previewDraft.value); // LIVE

      return base.filter(r=>{
        const d = parseDate(r.Data);
        const okYM = d && d.getFullYear()===year && d.getMonth()===month;
        const okAtt = (att==='Tutte' || r.Attivita===att);
        const okAcc = (acc==='Tutti' || r.Conto===acc);
        const okFrom = !from || (d>=from);
        const okTo = !to || (d<=to);
        return okYM && okAtt && okAcc && okFrom && okTo;
      }).sort((a,b)=> a.Data<b.Data ? -1 : 1);
    });

    // ---------- KPI ----------
    const kpi = reactive({ totEntrate:0, totSpese:0, profitto:0, ivaDaVersare:0, liquidita:0 });

    function recompute(){
      const list = filteredRows.value;
      const entr = list.filter(r=>r.Tipo==='entrata');
      const sp = list.filter(r=>r.Tipo==='spesa');
      const sum = (arr, f) => arr.reduce((s,x)=>s+f(x),0);
      const totE = sum(entr, x=>+x.Importo||0);
      const totS = sum(sp, x=>+x.Importo||0);
      const ivaE = sum(entr, x=> (x.Importo - x.Importo/(1+(+x.IVA||0)/100)));
      const ivaS = sum(sp,   x=> (x.Importo - x.Importo/(1+(+x.IVA||0)/100)));
      kpi.totEntrate = totE;
      kpi.totSpese = totS;
      kpi.profitto = totE - totS;
      kpi.ivaDaVersare = Math.max(ivaE - ivaS, 0);
      kpi.liquidita = kpi.profitto * 0.1;
      drawCharts();
    }

    // ---------- Rischi proattivi ----------
    const risk = reactive({ flags: [] });
    function recomputeRisk(){
      risk.flags = [];
      if (!settings.proactive) return;
      if (kpi.totSpese > kpi.totEntrate) risk.flags.push('Spese superiori alle entrate');
      if (settings.budgetSpese && kpi.totSpese > settings.budgetSpese) risk.flags.push('Budget spese superato');
      if (settings.ivaThreshold && kpi.ivaDaVersare > settings.ivaThreshold) risk.flags.push('IVA oltre soglia');
    }

    // ---------- Scadenze & banner ----------
    const banner = reactive({ items:[], today:[], soon:[], overdue:[] });

    function deadlineInfo(e){
      const today = parseDate(todayStr());
      const due = parseDate(e.date);
      if (!due) return { dday:null, status:'unknown' };
      const ms = due - today;
      const days = Math.floor(ms / (24*3600*1000));
      let status = 'ok';
      if (days < 0 && !e.done) status = 'overdue';
      else if (days === 0 && !e.done) status = 'today';
      else if (days > 0 && days <= 7 && !e.done) status = 'soon';
      return { dday: days, status };
    }
    function deadlineLabel(e){
      const { dday, status } = deadlineInfo(e);
      if (status==='today') return 'Oggi';
      if (status==='overdue') return `Scaduto`;
      if (status==='soon') return `Tra ${dday} giorni`;
      return 'Programmato';
    }
    function deadlineClass(e){
      const { status } = deadlineInfo(e);
      return status==='overdue' ? 'danger' : status==='today' ? 'warn' : status==='soon' ? 'warn' : 'ok';
    }
    const sortedEvents = computed(()=>{
      return events.value.slice().sort((a,b)=> (a.date<b.date? -1:1));
    });

    function computeBanner(){
      const t = [], today=[], soon=[], overdue=[];
      const todayS = todayStr();
      for (const e of events.value) {
        if (!e.date || e.done) continue;
        const info = deadlineInfo(e);
        if (info.status==='today') { t.push(e); today.push({...e, dday:0}); }
        if (info.status==='soon')  { t.push(e); soon.push({...e, dday:info.dday}); }
        if (info.status==='overdue'){ t.push(e); overdue.push({...e, dday:info.dday}); }
      }
      const seen = localStorage.getItem(BN_KEY);
      // Mostra banner ogni giorno se ci sono elementi e se non √® gi√† stato chiuso oggi
      const show = t.length && seen !== todayS;
      banner.items = show ? t : [];
      banner.today = today; banner.soon = soon; banner.overdue = overdue;
    }
    function dismissBannerToday(){
      localStorage.setItem(BN_KEY, todayStr());
      banner.items = []; // nascondi finch√© non cambia giorno
    }
    function todayStr(){
      const d = new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    // ---------- Grafici ----------
    let donut, bar, sparkIn, sparkOut;
    function drawCharts(){
      // Donut
      const dn = document.getElementById('donut').getContext('2d');
      donut && donut.destroy();
      donut = new Chart(dn, {
        type:'doughnut',
        data:{ labels:['Entrate','Spese','Profitto'], datasets:[{ data:[kpi.totEntrate,kpi.totSpese,Math.max(kpi.profitto,0)], backgroundColor:['#3dd9a3','#ff6b6b','#8b8fff'] }] },
        options:{ cutout:'60%', plugins:{ legend:{labels:{color:'#cfd5df'}} } }
      });
      // Bar trend fittizio (12 mesi)
      const br = document.getElementById('bar').getContext('2d');
      bar && bar.destroy();
      const series = Array.from({length:12}, (_,i)=> Math.max(0, kpi.profitto) * (0.4 + i/14));
      bar = new Chart(br, {
        type:'bar',
        data:{ labels:['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'], datasets:[{ data:series, backgroundColor:'#3dd9a3' }] },
        options:{ plugins:{ legend:{display:false} }, scales:{ x:{ticks:{color:'#cfd5df'}}, y:{ticks:{color:'#cfd5df'}} } }
      });
      // Mini sparkline Entrate
      const si = document.getElementById('sparkIn').getContext('2d');
      sparkIn && sparkIn.destroy();
      sparkIn = new Chart(si, {
        type:'line',
        data:{ labels:[1,2,3,4,5,6,7], datasets:[{ data: sparkData(kpi.totEntrate), borderColor:'#3dd9a3', tension:.35, fill:false }] },
        options:{ plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
      });
      // Mini sparkline Spese
      const so = document.getElementById('sparkOut').getContext('2d');
      sparkOut && sparkOut.destroy();
      sparkOut = new Chart(so, {
        type:'line',
        data:{ labels:[1,2,3,4,5,6,7], datasets:[{ data: sparkData(kpi.totSpese), borderColor:'#ff6b6b', tension:.35, fill:false }] },
        options:{ plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
      });
    }
    function sparkData(base){
      return [0.2,0.35,0.28,0.45,0.5,0.6,0.7].map(f=> Math.max(1, base* f / 7));
    }

    // ---------- CRUD movimenti ----------
    function clearDraft(){ Object.assign(draft, { Data:'', Tipo:'entrata', Importo:null, IVA:null, Categoria:'', Conto:'', Attivita:'' }); }
    function addRow(){
      if (!draft.Data || !draft.Importo) return alert('Inserisci almeno Data e Importo');
      rows.value.push({ id:uid(), ...draft });
      clearDraft(); saveAll(); recompute();
    }
    function openEdit(r){ Object.assign(editRow, JSON.parse(JSON.stringify(r))); refs.editDlg.showModal(); }
    function saveEdit(){ 
      const idx = rows.value.findIndex(x=>x.id===editRow.id);
      if (idx>=0) rows.value[idx] = JSON.parse(JSON.stringify(editRow));
      refs.editDlg.close(); saveAll(); recompute();
    }
    function removeRow(id){
      if (!confirm('Eliminare questa voce?')) return;
      rows.value = rows.value.filter(x=>x.id!==id);
      saveAll(); recompute();
    }

    // ---------- CSV / PDF ----------
    async function importCSV(e){
      const file = e.target.files?.[0]; if (!file) return;
      const text = await file.text();
      const lines = text.trim().split('\n').slice(1);
      const parsed = lines.map(line=>{
        const [Data,Tipo,Importo,IVA,Categoria,Conto,Attivita] = line.split(',');
        return { id:uid(), Data, Tipo, Importo:+Importo, IVA:+IVA, Categoria, Conto, Attivita };
      });
      rows.value = rows.value.concat(parsed);
      saveAll(); recompute(); e.target.value = '';
    }
    function exportCSV(){
      const header = "Data,Tipo,Importo,IVA,Categoria,Conto,Attivita\n";
      const body = rows.value.map(r=>[r.Data,r.Tipo,r.Importo,r.IVA,r.Categoria,r.Conto,r.Attivita].join(',')).join('\n');
      const blob = new Blob([header+body], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'movimenti.csv'; a.click();
    }
    async function exportPDF(){
      const el = document.body; // oppure document.getElementById('app')
      const canvas = await html2canvas(el,{backgroundColor:null,scale:2});
      const img = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:'p',unit:'pt',format:'a4'});
      const w = pdf.internal.pageSize.getWidth();
      const h = canvas.height * w / canvas.width;
      let y = 20;
      if (h <= pdf.internal.pageSize.getHeight()-40) {
        pdf.addImage(img,'PNG',20,y,w-40,h,'','FAST');
      } else {
        const pageH = pdf.internal.pageSize.getHeight()-40;
        let sY = 0;
        while (sY < canvas.height) {
          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = canvas.width;
          pageCanvas.height = Math.min(pageH * (canvas.width/(w-40)), canvas.height - sY);
          const ctx = pageCanvas.getContext('2d');
          ctx.fillStyle = '#0f1117'; ctx.fillRect(0,0,pageCanvas.width,pageCanvas.height);
          ctx.drawImage(canvas, 0, sY, canvas.width, pageCanvas.height, 0, 0, pageCanvas.width, pageCanvas.height);
          const pageData = pageCanvas.toDataURL('image/png');
          pdf.addImage(pageData,'PNG',20,20,w-40,(w-40)*(pageCanvas.height/pageCanvas.width),'','FAST');
          sY += pageCanvas.height;
          if (sY < canvas.height) pdf.addPage();
        }
      }
      pdf.save('report-dashboard.pdf');
    }

    // ---------- Scadenze CRUD ----------
    function openEventModal(e=null){
      if (e) Object.assign(eventDraft, JSON.parse(JSON.stringify(e)));
      else Object.assign(eventDraft, { id:null, title:'', kind:'Fiscale', date:'', done:false, note:'' });
      refs.eventDlg.showModal();
    }
    function saveEvent(){
      if (!eventDraft.title || !eventDraft.date) return alert('Titolo e data sono obbligatori');
      if (eventDraft.id){
        const idx = events.value.findIndex(x=>x.id===eventDraft.id);
        if (idx>=0) events.value[idx] = JSON.parse(JSON.stringify(eventDraft));
      } else {
        events.value.push({ id:uid(), ...eventDraft });
      }
      refs.eventDlg.close(); saveAll(); computeBanner();
    }
    function removeEvent(id){
      if (!confirm('Eliminare questa scadenza?')) return;
      events.value = events.value.filter(x=>x.id!==id);
      saveAll(); computeBanner();
    }

    // ---------- Impostazioni ----------
    function openSettings(){ refs.settingsDlg.showModal(); }
    function saveSettings(){ saveAll(); refs.settingsDlg.close(); recomputeRisk(); }

    // ---------- Refs a dialog ----------
    const refs = {
      editDlg: ref(null),
      eventDlg: ref(null),
      settingsDlg: ref(null),
      csvBtn: ref(null),
    };

    // ---------- Watchers ----------
    watch([filteredRows, ()=>settings.proactive, ()=>settings.budgetSpese, ()=>settings.ivaThreshold], ()=>{
      recompute(); recomputeRisk();
    }, { immediate:true });

    watch([()=>filters.year, ()=>filters.month, ()=>filters.activity, ()=>filters.account, ()=>filters.from, ()=>filters.to], ()=>{
      recompute(); recomputeRisk();
    });

    watch(draft, ()=>{ // aggiornamento live preview
      recompute();
    }, { deep:true });

    watch(events, ()=>{ computeBanner(); saveAll(); }, { deep:true });

    // ---------- Lifecycle ----------
    onMounted(async ()=>{
      loadAll();
      // default filtri su mese/anno correnti se presenti nei dati
      const now = new Date();
      filters.year = now.getFullYear();
      filters.month = now.getMonth();
      await nextTick();
      recompute(); recomputeRisk(); computeBanner();
    });

    // ---------- Expose to template ----------
    return {
      // state
      rows, events, settings, filters, draft, editRow, eventDraft,
      months, years,
      activities, accounts, categories,
      kpi, risk, banner,
      // methods
      fmtEUR, addRow, clearDraft, openEdit, saveEdit, removeRow,
      importCSV, exportCSV, exportPDF,
      openEventModal, saveEvent, removeEvent,
      openSettings, saveSettings, clearAll: ()=>{
        if (!confirm('Sicuro di svuotare movimenti e scadenze?')) return;
        localStorage.removeItem('vue_sbd_tx_v1');
        localStorage.removeItem('vue_sbd_ev_v1');
        localStorage.removeItem('vue_sbd_settings_v1');
        localStorage.removeItem('vue_sbd_banner_seen_on');
        location.reload();
      },
      filteredRows, sortedEvents, deadlineLabel, deadlineClass,
      dismissBannerToday,
      // dialog refs
      ...refs
    };
  }
}).mount('#app');
</script>
</body>
</html>
