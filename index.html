<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Commander Elite Pro - Top Edition</title>
  
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Commander%20Elite%20PRO%22,%22short_name%22:%22CommanderPRO%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%230f172a%22,%22theme_color%22:%22%232563eb%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/1052/1052856.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f1f5f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    .page { display: none; padding-bottom: 120px; }
    .active-page { display: block; animation: fadeIn 0.15s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.25rem; border: 1px solid #e2e8f0; }
    input, select, textarea { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 12px; width: 100%; font-size: 16px; transition: border-color 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: #2563eb; outline: none; background-color: #f8fafc; }
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item.active { color: #2563eb; }
    #lock-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    @media print {
      .no-print { display: none !important; }
      .page { display: block !important; }
      table { width: 100% !important; border-collapse: collapse; }
      th, td { border: 1px solid #000; padding: 8px; text-align: right; }
      td:first-child, th:first-child { text-align: left; }
    }
  </style>
</head>
<body>

  <div id="lock-screen">
    <div class="text-center mb-8">
      <i class="fa-solid fa-shield-halved text-5xl text-blue-500 mb-4"></i>
      <h1 class="text-2xl font-black tracking-tighter uppercase">Commander Elite <span class="text-blue-500">PRO</span></h1>
    </div>
    <div class="w-72 bg-slate-800 p-6 rounded-3xl shadow-2xl">
      <input type="password" id="pin-input" class="text-center text-3xl tracking-[0.5em] text-slate-900 mb-4 font-bold" maxlength="4" placeholder="****">
      <button type="button" onclick="checkPin()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black uppercase transition-all shadow-lg active:scale-95">Sblocca Sistema</button>
    </div>
  </div>

  <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 p-4 no-print flex justify-between items-center">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black italic">C</div>
      <h1 class="font-black text-slate-800 uppercase tracking-tight text-lg">Commander <span class="text-blue-600">Elite</span></h1>
    </div>
    <button type="button" onclick="location.reload()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center">
      <i class="fa-solid fa-lock"></i>
    </button>
  </header>

  <main class="max-w-2xl mx-auto p-4">

    <section id="page-oggi" class="page active-page">
      <div class="card bg-gradient-to-r from-blue-600 to-blue-800 border-none">
        <label class="text-[10px] font-black text-blue-100 uppercase mb-1 block">Data Operativa</label>
        <input type="date" id="data-lavoro" class="bg-white/10 border-none text-white font-bold text-lg cursor-pointer" onchange="onChangeData()">
        <p id="badge-loaded" class="mt-2 text-[10px] font-black uppercase tracking-widest text-blue-100 hidden">Giornata caricata</p>
      </div>

      <div class="card">
        <div class="flex items-center gap-2 mb-4 border-b pb-2">
          <i class="fa-solid fa-receipt text-blue-600"></i>
          <h3 class="font-black text-slate-700 uppercase text-xs">Incassi e Corrispettivi</h3>
        </div>
        <div class="space-y-4">
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Totale Chiusura Z (Lordo)</label>
            <input type="number" id="inp-tot" placeholder="0.00" class="text-3xl font-black text-slate-800" oninput="calcola()" inputmode="decimal" step="0.01">
          </div>
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Aliquota IVA Vendite</label>
            <select id="iva-v-base" onchange="calcola()" class="font-bold bg-slate-50">
              <option value="10">IVA 10% (Ristorazione)</option>
              <option value="22">IVA 22% (Bevande/Servizi)</option>
              <option value="4">IVA 4% (Alimentari)</option>
            </select>
          </div>
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-credit-card text-slate-700"></i>
                <h4 class="font-black text-slate-700 uppercase text-[11px]">Pagamenti Elettronici</h4>
              </div>
              <button type="button" onclick="addPayRow()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-sm">+ AGGIUNGI</button>
            </div>
            <div id="pay-list" class="space-y-2"></div>
            <div class="mt-3 text-[10px] font-bold uppercase text-slate-500 flex justify-between border-t border-slate-200 pt-3">
              <span>Totale elettronico</span>
              <span id="pay-total">€ 0,00</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-l-4 border-red-500">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-2 text-red-600">
            <i class="fa-solid fa-truck-ramp-box"></i>
            <h3 class="font-black uppercase text-xs text-slate-700">Fornitori e Fatture</h3>
          </div>
          <button type="button" onclick="addFornitore()" class="bg-red-500 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-sm">+ AGGIUNGI SPESA</button>
        </div>
        <div id="fornitori-list" class="space-y-4"></div>
      </div>

      <div class="card bg-slate-900 text-white shadow-2xl">
        <div class="grid grid-cols-2 gap-6 text-xs mb-6">
          <div class="border-r border-slate-700">
            <p class="text-slate-500 font-bold uppercase mb-1">Tot. Elettronico</p>
            <p id="res-ele" class="text-xl font-bold">€ 0,00</p>
          </div>
          <div>
            <p class="text-orange-400 font-bold uppercase mb-1">IVA su Vendite</p>
            <p id="res-ivav" class="text-xl font-bold text-orange-400">€ 0,00</p>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-white/10">
          <span class="font-black text-green-400 uppercase tracking-wider">Netto Contanti</span>
          <span id="res-netto" class="text-3xl font-black text-green-400 tracking-tighter">€ 0,00</span>
        </div>
        <button type="button" onclick="salvaData(this)" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg shadow-blue-900/20 active:scale-95 transition-all">
          Archivia e Salva
        </button>
      </div>
    </section>

    <section id="page-riepilogo" class="page">
      <h2 class="font-black text-2xl text-slate-800 mb-6 flex items-center gap-2">
        <i class="fa-solid fa-chart-pie text-blue-600"></i> Analisi Business
      </h2>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="card border-t-4 border-blue-500">
          <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Ultimi 7gg</p>
          <p id="st-w" class="text-xl font-black text-slate-800">€ 0.00</p>
          <p class="text-[10px] font-bold text-slate-400 mt-1">Prec. 7gg: <span id="st-w-prev">€ 0.00</span> • Δ <span id="st-w-delta">0%</span></p>
        </div>
        <div class="card border-t-4 border-blue-500">
          <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Mese Corrente</p>
          <p id="st-m" class="text-xl font-black text-slate-800">€ 0.00</p>
          <p class="text-[10px] font-bold text-slate-400 mt-1">Media/giorno: <span id="st-avg-day">€ 0.00</span></p>
        </div>
        <div class="card col-span-2 bg-slate-800 text-white border-none flex justify-between items-center">
          <div>
            <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Saldo IVA Mese</p>
            <p id="st-iva-saldo" class="text-2xl font-black text-orange-400">€ 0.00</p>
            <p class="text-[10px] font-bold text-slate-300 mt-1">Spese/Incasso: <span id="st-spese-inc">0%</span></p>
          </div>
          <i class="fa-solid fa-piggy-bank text-4xl opacity-20"></i>
        </div>
      </div>

      <div class="card">
        <h3 class="font-black text-xs uppercase mb-4 text-slate-500 border-b pb-2">Ricerca Storica Periodo</h3>
        <div class="grid grid-cols-2 gap-2 mb-4">
          <button type="button" onclick="setQuickRange('thisWeek')" class="bg-slate-100 py-2 rounded-lg font-bold text-[10px] uppercase">Settimana</button>
          <button type="button" onclick="setQuickRange('month')" class="bg-slate-100 py-2 rounded-lg font-bold text-[10px] uppercase">Mese</button>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1 uppercase text-slate-400">Dal</label>
            <input type="date" id="s-from">
          </div>
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1 uppercase text-slate-400">Al</label>
            <input type="date" id="s-to">
          </div>
        </div>
        <button type="button" onclick="cercaPeriodo()" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-4 rounded-xl font-black uppercase text-xs transition-all">Elabora Analisi</button>
        <div id="s-res" class="mt-6 hidden"></div>
      </div>
    </section>

    <section id="page-stampa" class="page">
      <div class="card no-print border-l-4 border-slate-800">
        <div class="flex items-center gap-2 mb-4 border-b pb-2">
          <i class="fa-solid fa-shield-keyhole text-slate-800"></i>
          <h3 class="font-black text-slate-700 uppercase text-xs">Setup - Sicurezza PIN</h3>
        </div>
        <div class="space-y-3">
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1">PIN ATTUALE</label>
            <input type="password" id="pin-current" maxlength="4" inputmode="numeric" placeholder="****">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-[9px] font-bold px-1">NUOVO PIN</label>
              <input type="password" id="pin-new" maxlength="4" inputmode="numeric" placeholder="****">
            </div>
            <div class="space-y-1">
              <label class="text-[9px] font-bold px-1">CONFERMA PIN</label>
              <input type="password" id="pin-new2" maxlength="4" inputmode="numeric" placeholder="****">
            </div>
          </div>
          <button type="button" onclick="changePin()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-xl font-black uppercase text-xs transition-all">Cambia PIN</button>
        </div>
      </div>

      <div class="card no-print">
        <h3 class="font-black text-xs uppercase mb-4 text-slate-500 border-b pb-2">Export Fiscale</h3>
        <div class="grid grid-cols-2 gap-3 mb-6">
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1 uppercase text-slate-400">Data Inizio</label>
            <input type="date" id="p-from">
          </div>
          <div class="space-y-1">
            <label class="text-[9px] font-bold px-1 uppercase text-slate-400">Data Fine</label>
            <input type="date" id="p-to">
          </div>
        </div>
        <button type="button" onclick="generaReportProfessionale()" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-5 rounded-2xl font-black uppercase shadow-lg transition-all">Genera Report Ragioniere</button>
      </div>

      <div class="card no-print border-l-4 border-blue-700">
        <div class="flex items-center gap-2 mb-4 border-b pb-2">
          <i class="fa-solid fa-database text-blue-700"></i>
          <h3 class="font-black text-slate-700 uppercase text-xs">Backup & Import Dati</h3>
        </div>
        <div class="space-y-3">
          <button type="button" onclick="exportBackupFile()" class="w-full bg-blue-700 text-white py-4 rounded-xl font-black uppercase text-xs">Esporta Backup (JSON)</button>
          <input type="file" id="import-file" class="hidden" onchange="handleImportFile(this.files[0])">
          <button type="button" onclick="document.getElementById('import-file').click()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black uppercase text-xs">Importa Backup (JSON)</button>
        </div>
      </div>

      <div id="area-stampa"></div>
    </section>
  </main>

  <nav class="nav-bottom no-print">
    <button type="button" onclick="showPage('oggi')" class="nav-item active" id="btn-oggi"><i class="fa-solid fa-cash-register text-2xl mb-1"></i>Cassa</button>
    <button type="button" onclick="showPage('riepilogo')" class="nav-item" id="btn-riepilogo"><i class="fa-solid fa-chart-line text-2xl mb-1"></i>Analisi</button>
    <button type="button" onclick="showPage('stampa')" class="nav-item" id="btn-stampa"><i class="fa-solid fa-file-invoice-dollar text-2xl mb-1"></i>Fisco</button>
  </nav>

  <datalist id="dl-fornitori"></datalist>

  <script>
    // --- PERSISTENZA DOPPIA (IndexedDB + localStorage) ---
    const DB_NAME = 'CommanderEliteProDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'giornate';
    let dbIdx;

    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'data' });
          }
        };
        request.onsuccess = (e) => {
          dbIdx = e.target.result;
          resolve();
        };
        request.onerror = (e) => reject(e.target.error);
      });
    }

    async function persistDB() {
      // 1. Snapshot su localStorage (fallback rapido)
      db.sort((a, b) => (a.data || '').localeCompare(b.data || ''));
      localStorage.setItem('ce_v3_top', JSON.stringify(db));

      // 2. Persistenza primaria su IndexedDB
      const tx = dbIdx.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      // Pulisce e riscrive tutto per coerenza (o aggiorna singoli record)
      db.forEach(rec => store.put(rec));
      return new Promise((resolve) => { tx.oncomplete = resolve; });
    }

    async function loadDB() {
      // Prova IndexedDB prima
      const tx = dbIdx.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const all = await new Promise((resolve) => {
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
      });

      if (all && all.length > 0) {
        db = all;
      } else {
        // Fallback a localStorage
        db = JSON.parse(localStorage.getItem('ce_v3_top')) || [];
      }
    }

    // --- PWA OFFLINE: SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swBlob = new Blob([`
          const CACHE_NAME = 'commander-pro-v1';
          const ASSETS = ['/', window.location.href];
          self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS))));
          self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
        `], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(console.warn);
      });
    }

    // --- LOGICA CORE (Basata sul tuo codice originale) ---
    const fix = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;
    const euro = (n) => `€ ${fix(n).toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
    let db = [];

    // Caricamento Dati
    async function initApp() {
      await initDB();
      await loadDB();
      document.getElementById('data-lavoro').valueAsDate = new Date();
      onChangeData();
      hookActivityListeners();
    }

    function onChangeData() {
      const data = document.getElementById('data-lavoro').value;
      if (!data) return;
      const rec = db.find(r => r.data === data);
      
      document.getElementById('fornitori-list').innerHTML = "";
      document.getElementById('pay-list').innerHTML = "";
      document.getElementById('inp-tot').value = "";
      document.getElementById('badge-loaded').classList.add('hidden');

      if (rec) {
        document.getElementById('badge-loaded').classList.remove('hidden');
        document.getElementById('inp-tot').value = rec.lordoZ;
        document.getElementById('iva-v-base').value = rec.ivaVperc || 10;
        (rec.payDet || []).forEach(p => addPayRow(p.nome, p.valore));
        (rec.detFornitori || []).forEach(f => addFornitore(f));
      }
      calcola();
    }

    function calcola() {
      const lordoZ = fix(document.getElementById('inp-tot').value || 0);
      const ivaVperc = parseFloat(document.getElementById('iva-v-base').value);
      
      let totEle = 0;
      const payDet = [];
      document.querySelectorAll('.pay-row').forEach(r => {
        const n = r.querySelector('.pay-name').value;
        const v = fix(r.querySelector('.pay-val').value || 0);
        if (v > 0) { totEle += v; payDet.push({nome: n, valore: v}); }
      });

      const impV = fix(lordoZ / (1 + (ivaVperc / 100)));
      const ivaV = fix(lordoZ - impV);
      
      let uscCash = 0, totIvaA = 0;
      const detFornitori = [];
      document.querySelectorAll('.forn-block').forEach(b => {
        let fLordo = 0, fIva = 0;
        const righe = [];
        b.querySelectorAll('.r-item').forEach(r => {
          const v = fix(r.querySelector('.r-val').value || 0);
          const i = parseFloat(r.querySelector('.r-iva').value);
          const t = r.querySelector('.r-tipo').value;
          if (v > 0) {
            righe.push({valore: v, ivaPerc: i, tipo: t});
            if (t === 'L') { fLordo += v; fIva += fix(v - (v / (1 + (i/100)))); }
            else { const ri = fix(v * (i/100)); fIva += ri; fLordo += (v + ri); }
          }
        });
        const cash = b.querySelector('.f-cash').checked;
        if (fLordo > 0) {
          if (cash) uscCash += fLordo;
          totIvaA += fIva;
          detFornitori.push({ nome: b.querySelector('.f-name').value, lordo: fLordo, iva: fIva, cash, righe });
        }
      });

      const netto = fix((lordoZ - totEle) - uscCash);
      document.getElementById('pay-total').innerText = euro(totEle);
      document.getElementById('res-ele').innerText = euro(totEle);
      document.getElementById('res-ivav').innerText = euro(ivaV);
      document.getElementById('res-netto').innerText = euro(netto);
      return { lordoZ, ivaVperc, ivaV, impV, totEle, uscCash, totIvaA, payDet, detFornitori };
    }

    async function salvaData(btn) {
      const data = document.getElementById('data-lavoro').value;
      if (!data) return;
      const dati = calcola();
      const rec = { data, ...dati };
      db = db.filter(r => r.data !== data);
      db.push(rec);
      await persistDB();
      
      btn.innerText = "✅ SALVATO";
      setTimeout(() => btn.innerText = "ARCHIVIA E SALVA", 2000);
    }

    // Funzioni UI Utility (PIN, Navigazione, Add righe)
    function showPage(p) {
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active-page'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById('page-' + p).classList.add('active-page');
      document.getElementById('btn-' + p).classList.add('active');
    }

    function addPayRow(n="", v="") {
      const html = `<div class="grid grid-cols-12 gap-2 pay-row bg-white p-2 rounded-lg border">
        <input type="text" class="col-span-7 pay-name font-bold" value="${n || 'POS'}" oninput="calcola()">
        <input type="number" class="col-span-4 pay-val font-bold" value="${v}" oninput="calcola()" step="0.01">
        <button onclick="this.parentElement.remove();calcola()" class="col-span-1 text-red-500">✕</button>
      </div>`;
      document.getElementById('pay-list').insertAdjacentHTML('beforeend', html);
    }

    function addFornitore(pre=null) {
      const id = Date.now();
      const html = `<div class="forn-block bg-slate-50 p-3 rounded-xl border border-slate-200">
        <input type="text" class="f-name font-bold mb-2" value="${pre?pre.nome:''}" placeholder="Fornitore">
        <div class="r-cont space-y-2">
          <div class="grid grid-cols-3 gap-1 r-item">
            <input type="number" class="r-val" value="${pre?pre.righe[0].valore:''}" oninput="calcola()" placeholder="€">
            <select class="r-iva" onchange="calcola()"><option value="10">10%</option><option value="22">22%</option><option value="4">4%</option></select>
            <select class="r-tipo" onchange="calcola()"><option value="L">Lordo</option><option value="N">Netto</option></select>
          </div>
        </div>
        <div class="flex justify-between mt-2">
           <label class="text-[10px] font-bold"><input type="checkbox" class="f-cash" ${pre&&pre.cash?'checked':''} onchange="calcola()"> CONTANTI</label>
           <button onclick="this.closest('.forn-block').remove();calcola()" class="text-red-500 text-xs">Rimuovi</button>
        </div>
      </div>`;
      document.getElementById('fornitori-list').insertAdjacentHTML('beforeend', html);
    }

    // PIN SECURITY (Versione Semplificata integrata)
    function checkPin() {
      const pin = document.getElementById('pin-input').value;
      if (pin === (localStorage.getItem('ce_pin') || '1234')) {
        document.getElementById('lock-screen').style.display = 'none';
      } else { alert("PIN ERRATO"); }
    }

    function hookActivityListeners() {
      let timer;
      const reset = () => { clearTimeout(timer); timer = setTimeout(() => location.reload(), 300000); };
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(e => document.addEventListener(e, reset));
    }

    // Inizializzazione al caricamento
    window.onload = initApp;

  </script>
</body>
</html>
