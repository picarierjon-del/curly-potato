<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COMMANDER ELITE | FINANCIAL OVERLORD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@800&family=Plus+Jakarta+Sans:wght@800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; }
        .vault-card { background: linear-gradient(145deg, #0f172a, #1e293b); border: 1px solid #334155; border-radius: 24px; }
        .input-gold { background: #020617; border: 1px solid #3b82f6; color: #3b82f6; border-radius: 12px; font-family: 'JetBrains Mono'; font-weight: 800; text-align: center; }
        .input-red { background: #020617; border: 1px solid #ef4444; color: #ef4444; border-radius: 12px; font-family: 'JetBrains Mono'; font-weight: 800; text-align: center; }
        .tab-active { background: #3b82f6; color: white; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="pb-60">

    <div id="authScreen" class="fixed inset-0 z-[9999] bg-black flex items-center justify-center p-6">
        <div class="vault-card p-10 w-full max-w-sm text-center border-t-4 border-blue-500">
            <h1 class="text-3xl font-black italic mb-8">COMMANDER <span class="text-blue-500">ELITE</span></h1>
            <input type="password" id="pinInput" class="input-gold w-full text-4xl p-4 mb-6" placeholder="****" maxlength="4">
            <button onclick="checkAuth()" class="w-full bg-blue-600 p-5 rounded-xl font-black uppercase">Accedi al Sistema</button>
        </div>
    </div>

    <div id="mainUI" class="hidden">
        <header class="p-6 border-b border-slate-800 flex justify-between items-center sticky top-0 bg-[#020617]/90 backdrop-blur-md z-50">
            <div>
                <p id="topDate" class="text-blue-500 text-[10px] font-black uppercase"></p>
                <h2 class="text-xl font-black italic">FINANCIAL VAULT</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="exportBankReport()" class="bg-green-600/20 text-green-500 border border-green-600/40 text-[9px] px-3 py-2 rounded-lg font-black uppercase">Versamento Banca</button>
                <button onclick="exportAccountantReport()" class="bg-blue-600/20 text-blue-500 border border-blue-600/40 text-[9px] px-3 py-2 rounded-lg font-black uppercase">Ragioniere</button>
            </div>
        </header>

        <main class="p-4 space-y-4">
            <div class="vault-card p-6 border-l-8 border-green-500">
                <p class="text-[10px] font-black text-slate-400 uppercase italic mb-1">Cassa Fisica (Contante Netto)</p>
                <h1 id="cashVault" class="text-5xl font-black text-white italic">€ 0.00</h1>
                <div class="mt-4 pt-4 border-t border-slate-700 flex justify-between">
                    <div>
                        <p class="text-[8px] font-black text-blue-400 uppercase">Totale In Banca</p>
                        <p id="bankVault" class="text-lg font-black text-blue-400">€ 0.00</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[8px] font-black text-red-500 uppercase">Uscite Cash</p>
                        <p id="cashOutVault" class="text-lg font-black text-red-500">€ 0.00</p>
                    </div>
                </div>
            </div>

            <section class="vault-card p-6 space-y-6">
                <div class="text-center">
                    <label class="text-[10px] font-black text-slate-500 uppercase">Chiusura Fiscale Totale (Lordo Z)</label>
                    <input type="number" id="z_total" class="input-gold w-full text-5xl p-4 mt-2" placeholder="0.00" oninput="calculate()">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-blue-900/10 rounded-2xl border border-blue-900/30">
                        <label class="text-[9px] font-black text-blue-500 uppercase italic">POS / Bancomat</label>
                        <input type="number" id="p_pos" class="input-gold w-full mt-2" placeholder="0.00" oninput="calculate()">
                    </div>
                    <div class="p-4 bg-orange-900/10 rounded-2xl border border-orange-900/30">
                        <label class="text-[9px] font-black text-orange-500 uppercase italic">App (JustEat/Deliv)</label>
                        <input type="number" id="p_apps" class="input-gold w-full mt-2 italic" placeholder="0.00" oninput="calculate()">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-green-900/10 rounded-2xl border border-green-900/30">
                        <label class="text-[9px] font-black text-green-500 uppercase italic">Acconti Cash (+)</label>
                        <input type="number" id="acconti" class="input-gold w-full mt-2" placeholder="0.00" oninput="calculate()">
                    </div>
                    <div class="p-4 bg-slate-900/50 rounded-2xl border border-slate-800">
                        <label class="text-[9px] font-black text-slate-500 uppercase italic">Clienti Tot.</label>
                        <input type="number" id="n_clients" class="input-gold w-full mt-2" placeholder="0" oninput="calculate()">
                    </div>
                </div>
            </section>

            <section class="vault-card p-6">
                <h3 class="text-[10px] font-black text-red-500 uppercase mb-4 italic tracking-widest text-center">Registro Uscite Cassetto</h3>
                <div id="supplierGrid" class="grid grid-cols-2 gap-3">
                    </div>
            </section>

            <section class="vault-card p-6">
                <textarea id="dailyNote" class="w-full bg-transparent border border-slate-700 rounded-xl p-4 text-xs italic" rows="3" placeholder="Note operative, guasti o eventi..."></textarea>
            </section>
        </main>

        <div class="fixed bottom-0 left-0 right-0 p-6 bg-[#020617]/95 border-t border-slate-800 backdrop-blur-xl flex justify-between items-center z-[100]">
            <div class="space-y-1">
                <p class="text-[10px] font-black text-slate-500 uppercase italic">Contante da Versare in Banca</p>
                <div id="footerCash" class="text-4xl font-black text-white italic">€ 0.00</div>
            </div>
            <button onclick="saveData()" class="bg-blue-600 text-white font-black px-10 py-5 rounded-2xl shadow-lg shadow-blue-900/40 uppercase text-xs tracking-widest active:scale-95 transition-all">Archivia</button>
        </div>
    </div>

    <script>
        let activeDate = new Date();
        const pin = "1234";

        function checkAuth() {
            if(document.getElementById('pinInput').value === pin) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainUI').classList.remove('hidden');
                init();
            } else { alert("ACCESSO NEGATO"); }
        }

        function init() {
            updateDateUI();
            renderSuppliers();
            loadData();
        }

        function updateDateUI() {
            document.getElementById('topDate').innerText = activeDate.toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
        }

        function renderSuppliers() {
            const grid = document.getElementById('supplierGrid');
            grid.innerHTML = "";
            for(let i=1; i<=10; i++) {
                grid.innerHTML += `
                    <div class="flex gap-1 items-center bg-black/40 p-2 rounded-xl border border-red-900/20">
                        <input type="number" class="sup-amt input-red text-[10px] w-full p-2" placeholder="Euro F${i}" oninput="calculate()">
                        <input type="checkbox" class="sup-check w-5 h-5 accent-red-600" onchange="calculate()">
                    </div>`;
            }
        }

        function calculate() {
            const z = parseFloat(document.getElementById('z_total').value) || 0;
            const pos = parseFloat(document.getElementById('p_pos').value) || 0;
            const apps = parseFloat(document.getElementById('p_apps').value) || 0;
            const acconti = parseFloat(document.getElementById('acconti').value) || 0;
            
            let cashOut = 0;
            document.querySelectorAll('.sup-amt').forEach((el, i) => {
                if(document.querySelectorAll('.sup-check')[i].checked) cashOut += parseFloat(el.value) || 0;
            });

            // --- LOGICA SOVRANA ---
            // 1. Quello che va in banca automaticamente (Digitali)
            const digitalTotal = pos + apps;
            // 2. Quello che entra fisicamente (Z Lordo - quello che è già andato in banca)
            const cashGrossIn = z - digitalTotal;
            // 3. Quello che resta nel cassetto (Entrata Cash + Acconti - Fornitori)
            const netCashInVault = (cashGrossIn + acconti) - cashOut;

            document.getElementById('cashVault').innerText = `€ ${netCashInVault.toFixed(2)}`;
            document.getElementById('footerCash').innerText = `€ ${netCashInVault.toFixed(2)}`;
            document.getElementById('bankVault').innerText = `€ ${digitalTotal.toFixed(2)}`;
            document.getElementById('cashOutVault').innerText = `€ ${cashOut.toFixed(2)}`;
        }

        function saveData() {
            const key = 'cmd_elite_' + activeDate.toISOString().split('T')[0];
            const payload = {
                z: document.getElementById('z_total').value,
                pos: document.getElementById('p_pos').value,
                apps: document.getElementById('p_apps').value,
                acconti: document.getElementById('acconti').value,
                clients: document.getElementById('n_clients').value,
                note: document.getElementById('dailyNote').value,
                supAmts: Array.from(document.querySelectorAll('.sup-amt')).map(e => e.value),
                supChecks: Array.from(document.querySelectorAll('.sup-check')).map(e => e.checked)
            };
            localStorage.setItem(key, JSON.stringify(payload));
            alert("COMMANDER: GIORNATA ARCHIVIATA NEL VAULT");
        }

        function loadData() {
            const key = 'cmd_elite_' + activeDate.toISOString().split('T')[0];
            const data = JSON.parse(localStorage.getItem(key));
            if(data) {
                document.getElementById('z_total').value = data.z;
                document.getElementById('p_pos').value = data.pos;
                document.getElementById('p_apps').value = data.apps;
                document.getElementById('acconti').value = data.acconti;
                document.getElementById('n_clients').value = data.clients;
                document.getElementById('dailyNote').value = data.note;
                document.querySelectorAll('.sup-amt').forEach((e, i) => e.value = data.supAmts[i]);
                document.querySelectorAll('.sup-check').forEach((e, i) => e.checked = data.supChecks[i]);
            }
            calculate();
        }

        // --- REPORTING ---

        function exportBankReport() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const rows = []; let totalToDeposit = 0;
            
            // Analisi ultimi 7 giorni
            for(let i=0; i<7; i++) {
                let d = new Date(); d.setDate(d.getDate() - i);
                let k = 'cmd_elite_' + d.toISOString().split('T')[0];
                let s = JSON.parse(localStorage.getItem(k) || '{"z":0,"pos":0,"apps":0,"acconti":0,"supAmts":[],"supChecks":[]}');
                
                let out = 0; s.supAmts?.forEach((v, idx) => { if(s.supChecks[idx]) out += parseFloat(v)||0; });
                let netCash = (parseFloat(s.z) - (parseFloat(s.pos)||0) - (parseFloat(s.apps)||0) + (parseFloat(s.acconti)||0)) - out;
                
                if(parseFloat(s.z) > 0 || netCash !== 0) {
                    rows.push([d.toLocaleDateString('it-IT'), s.z+"€", (parseFloat(s.pos)+parseFloat(s.apps))+"€", out+"€", netCash.toFixed(2)+"€"]);
                    totalToDeposit += netCash;
                }
            }
            doc.setFontSize(18); doc.text("DISTINTA VERSAMENTO CONTANTE IN BANCA", 14, 20);
            doc.autoTable({ head: [['Data', 'Lordo Z', 'Digitali', 'Uscite Cash', 'NETTO CASSA']], body: rows, startY: 30 });
            doc.text(`TOTALE DA VERSARE: ${totalToDeposit.toFixed(2)} EUR`, 14, doc.lastAutoTable.finalY + 15);
            doc.save("Versamento_Banca_Settimanale.pdf");
        }

        function exportAccountantReport() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const rows = [];
            const m = activeDate.getMonth() + 1;
            
            for(let i=1; i<=31; i++) {
                let k = `cmd_elite_${activeDate.getFullYear()}-${String(m).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                let s = JSON.parse(localStorage.getItem(k));
                if(s) {
                    let iva = (parseFloat(s.z) * 0.10).toFixed(2); // Stima 10%
                    rows.push([`${i}/${m}`, s.z+" €", s.pos+" €", s.apps+" €", iva+" €"]);
                }
            }
            doc.setFontSize(18); doc.text(`CORRISPETTIVI MENSILI - MESE ${m}`, 14, 20);
            doc.autoTable({ head: [['Giorno', 'Lordo Z', 'POS', 'App/JustEat', 'IVA Stima']], body: rows, startY: 30 });
            doc.save(`Ragioniere_Mese_${m}.pdf`);
        }

    </script>
</body>
</html>
