<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Contabilit√† PRO++ üáÆüáπ</title>

<!-- Tailwind & Vue -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0f1117; --panel:#171a22; --panel-2:#1b1f2b; --border:#23283a;
  --text:#e7eaf0; --muted:#9aa4b2; --accent:#6c7bff; --accent2:#35d9a3; --danger:#ff6b6b;
}
html,body{height:100%;}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;}
.wrap{max-width:520px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;}
.panel-2{background:var(--panel-2);border:1px solid var(--border);border-radius:16px;}
.btn{background:var(--accent);color:white;padding:10px 14px;border-radius:12px;font-weight:700;}
.btn-ghost{background:transparent;border:1px solid var(--border);color:#cfd5df;padding:10px 14px;border-radius:12px;}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#121625;font-size:12px;}
.input,select,textarea{background:#0f1320;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;width:100%;}
.input:focus{outline:1px solid var(--accent);}
.title-sm{color:var(--muted);font-size:12px;}
.value-lg{font-size:26px;font-weight:800;}
.nav{position:sticky;bottom:0;left:0;right:0;background:rgba(15,17,23,.9);backdrop-filter:blur(8px);border-top:1px solid var(--border);}
.navbtn{flex:1;text-align:center;padding:8px 0;font-size:13px;color:#a3aab7;}
.navbtn.active{color:#aab3ff;font-weight:700;}
.fabbar{position:fixed;bottom:72px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:40;}
.fab{padding:12px 14px;border-radius:999px;color:white;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,.35);}
.fab.in{background:#10b981;} .fab.out{background:#ef4444;}
dialog::backdrop{background:rgba(0,0,0,.55);}
.modal{width:min(560px,92vw);background:#0d1018;border:1px solid var(--border);border-radius:16px;color:var(--text);}
.modal-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800;}
.modal-b{padding:16px;}
.modal-f{padding:16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;}
.table th{color:#c4cad6;padding:10px 8px;font-weight:600;text-align:left;border-bottom:1px solid var(--border);}
.table td{padding:10px 8px;border-bottom:1px solid #22273a;}
.pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px;background:#121625;}
.warn{border-color:#f59e0b;color:#fde68a;background:rgba(245,158,11,.15);}
.danger{border-color:#ef4444;color:#fecaca;background:rgba(239,68,68,.15);}
.ok{border-color:#22c55e;color:#bbf7d0;background:rgba(34,197,94,.15);}
.led{width:10px;height:10px;border-radius:999px;margin-left:6px;}
.led.green{background:#22c55e;box-shadow:0 0 8px #22c55e;}
.led.red{background:#ef4444;box-shadow:0 0 8px #ef4444;}
</style>
</head>
<body>
<div id="app" class="wrap">

<!-- HEADER -->
<header class="px-4 pt-4 pb-2 flex items-center justify-between">
  <div>
    <h1 class="text-xl font-extrabold tracking-tight">Contabilit√† Pro++</h1>
    <div class="text-xs text-[#9aa4b2]">{{ months[filters.month] }} {{ filters.year }}</div>
  </div>
  <div class="flex items-center gap-2">
    <span class="text-xs">Sicurezza</span>
    <div :class="['led',settings.pinEnabled?'green':'red']"></div>
  </div>
</header>

<!-- Search bar -->
<div class="px-4">
  <input class="input" v-model="q" placeholder="Cerca movimenti, clienti, fornitori, note‚Ä¶">
</div>

<main class="flex-1 overflow-y-auto px-4 pb-28 space-y-4">

<!-- Home -->
<section v-if="view==='home'">
  <div class="grid grid-cols-2 gap-3 mt-3">
    <div class="panel p-4 text-center">
      <div class="title-sm">Entrate</div>
      <div class="value-lg text-emerald-400">{{ fmtEUR(kpi.totEntrate) }}</div>
    </div>
    <div class="panel p-4 text-center">
      <div class="title-sm">Uscite</div>
      <div class="value-lg text-rose-400">{{ fmtEUR(kpi.totSpese) }}</div>
    </div>
  </div>
  <div class="panel p-4 text-center">
    <div class="title-sm">Risparmi</div>
    <div class="value-lg text-amber-300">{{ fmtEUR(kpi.risparmi) }}</div>
  </div>

  <div class="panel p-3">
    <div class="title-sm mb-1">Entrate vs Uscite</div>
    <canvas id="chartHome" height="160"></canvas>
  </div>

  <div class="panel p-3">
    <div class="title-sm mb-1">Ripartizione per categoria</div>
    <canvas id="chartPie" height="180"></canvas>
  </div>

  <div class="panel p-3">
    <div class="flex items-center justify-between mb-2">
      <div class="title-sm">Ultimi movimenti</div>
      <button class="btn-ghost text-xs" @click="switchView('summary')">Vedi tutto ‚Üí</button>
    </div>
    <div v-for="r in lastRows" :key="r.id" class="flex items-center justify-between py-2 border-b border-[#23283a] last:border-0">
      <div>
        <div class="font-semibold text-sm">{{ r.Categoria || '‚Äî' }}</div>
        <div class="text-xs text-[#9aa4b2]">{{ r.Data }} ‚Ä¢ {{ r.Tipo }} ‚Ä¢ {{ r.Cliente || r.Fornitore }}</div>
      </div>
      <div class="text-right">
        <div :class="r.Tipo==='entrata'?'text-emerald-400':'text-rose-400'">{{ fmtEUR(r.ImportoNetto) }}</div>
        <div class="text-[11px] text-[#9aa4b2]">IVA {{ fmtEUR(r.ImportoIVA) }}</div>
      </div>
    </div>
  </div>
</section>

<!-- Riepilogo, Scadenze, Rubrica, Impostazioni -->
<!-- (identici alla versione precedente, gi√† inclusi con le modifiche nella Parte 2 per logica) -->

</main>

<!-- Floating Buttons -->
<div class="fabbar">
  <button class="fab in" @click="openTx('entrata')">+ Entrata</button>
  <button class="fab out" @click="openTx('spesa')">- Uscita</button>
</div>

<!-- Navbar -->
<nav class="nav px-2 pt-2 pb-[calc(env(safe-area-inset-bottom)+6px)] flex gap-1">
  <div class="navbtn" :class="{active:view==='home'}" @click="switchView('home')">üè†<br><span>Home</span></div>
  <div class="navbtn" :class="{active:view==='summary'}" @click="switchView('summary')">üìä<br><span>Riepilogo</span></div>
  <div class="navbtn" :class="{active:view==='events'}" @click="switchView('events')">‚è∞<br><span>Scadenze</span></div>
  <div class="navbtn" :class="{active:view==='contacts'}" @click="switchView('contacts')">üìá<br><span>Rubrica</span></div>
  <div class="navbtn" :class="{active:view==='settings'}" @click="switchView('settings')">‚öôÔ∏è<br><span>Impostazioni</span></div>
</nav>

<!-- Modali: Movimento, Scadenza, Contatto (verranno completati nella Parte 2 con i nuovi calcoli Netto‚ÜíIVA‚ÜíLordo) -->
</div><!-- CryptoJS -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<script>
const { createApp } = Vue;
createApp({
  data() {
    const now = new Date();
    return {
      view:'home',
      months:['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'],
      filters:{month:now.getMonth(),year:now.getFullYear()},
      q:'',
      rows:[], events:[], clients:[], suppliers:[],
      settings:{pinEnabled:false},
      pinHash:'', _sessionKey:'',
      txDraft:{}, presetIVA:null,
      charts:{}
    }
  },

  computed:{
    kpi(){
      let e=0,u=0;
      this.rows.forEach(r=>{
        const iva=this.calcIVA(r);
        const lordo=r.ImportoNetto+iva;
        if(r.Tipo==='entrata')e+=r.ImportoNetto;else u+=r.ImportoNetto;
      });
      return {totEntrate:e, totSpese:u, risparmi:e-u};
    },
    lastRows(){return this.rows.slice(-5).reverse();}
  },

  mounted(){
    this.loadSettings();
    this.secureLoad();
    this.initFisco();
    this.refreshCharts();
  },

  methods:{
    fmtEUR(v){return (Number(v)||0).toLocaleString('it-IT',{style:'currency',currency:'EUR'});},
    uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36);},
    switchView(v){this.view=v;setTimeout(this.refreshCharts,150);},

    /* === Calcoli IVA === */
    calcIVA(r){return +(Number(r.ImportoNetto||0)*(Number(r.IVA||0)/100)).toFixed(2);},
    calcLordo(r){return +(Number(r.ImportoNetto||0)+this.calcIVA(r)).toFixed(2);},

    /* === Inserimento movimento === */
    openTx(tipo){
      this.txDraft={Tipo:tipo,Data:new Date().toISOString().slice(0,10),
        ImportoNetto:0,IVA:22,Categoria:'Altro',Cliente:'',Fornitore:'',Note:''};
      this.$refs?.dlgTx?.showModal();
    },
    saveTx(){
      const r=JSON.parse(JSON.stringify(this.txDraft));
      if(!r.Data)return alert('Data obbligatoria');
      r.ImportoIVA=this.calcIVA(r);
      r.ImportoLordo=this.calcLordo(r);
      r.id=r.id||this.uid();
      const i=this.rows.findIndex(x=>x.id===r.id);
      if(i>=0)this.rows[i]=r;else this.rows.push(r);
      this.persist();
      this.$refs.dlgTx.close();
    },

    /* === Grafici === */
    refreshCharts(){
      setTimeout(()=>{
        const ctx=document.getElementById('chartHome');
        if(!ctx)return;
        const e=this.rows.filter(r=>r.Tipo==='entrata').reduce((s,r)=>s+r.ImportoNetto,0);
        const u=this.rows.filter(r=>r.Tipo==='spesa').reduce((s,r)=>s+r.ImportoNetto,0);
        if(this.charts.home)this.charts.home.destroy();
        this.charts.home=new Chart(ctx,{type:'bar',
          data:{labels:['Entrate','Uscite'],datasets:[{data:[e,u],backgroundColor:['#10b981','#ef4444']}]},
          options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#9ca3af'}},y:{ticks:{color:'#9ca3af'}}}}
        });
      },100);
    },

    /* === Sicurezza === */
    loadSettings(){
      try{
        const st=JSON.parse(localStorage.getItem('pro_settings')||'{}');
        Object.assign(this.settings,st||{});
        this.pinHash=localStorage.getItem('pro_pin_hash')||'';
      }catch{}
    },
    persist(){
      if(!this.settings.pinEnabled||!this._sessionKey){
        localStorage.setItem('pro_rows',JSON.stringify(this.rows));
      }else{
        const enc=CryptoJS.AES.encrypt(JSON.stringify(this.rows),this._sessionKey).toString();
        localStorage.setItem('pro_rows_enc',enc);
        localStorage.removeItem('pro_rows');
      }
    },
    secureLoad(){
      if(!this.settings.pinEnabled||!this.pinHash){
        this.rows=JSON.parse(localStorage.getItem('pro_rows')||'[]');return;
      }
      const pin=prompt('üîí Inserisci PIN');
      const key=CryptoJS.SHA256(pin).toString();
      const enc=localStorage.getItem('pro_rows_enc');
      try{
        const txt=CryptoJS.AES.decrypt(enc,key).toString(CryptoJS.enc.Utf8);
        if(!txt)throw 1;
        this.rows=JSON.parse(txt);this._sessionKey=key;
      }catch{alert('PIN errato');this.rows=[];}
    },
    setPIN(){
      const p1=prompt('Nuovo PIN (min 4 cifre)');if(!p1||p1.length<4)return;
      const p2=prompt('Ripeti PIN');if(p1!==p2)return alert('Non coincide');
      const h=CryptoJS.SHA256(p1).toString();
      this.pinHash=h;this._sessionKey=CryptoJS.SHA256(p1).toString();
      this.settings.pinEnabled=true;
      localStorage.setItem('pro_pin_hash',h);
      localStorage.setItem('pro_settings',JSON.stringify(this.settings));
      this.persist();alert('PIN impostato.');
    },
    disablePIN(){
      if(!confirm('Disattivare PIN?'))return;
      this.settings.pinEnabled=false;this._sessionKey='';this.persist();
      localStorage.setItem('pro_settings',JSON.stringify(this.settings));
    },

    /* === Scadenze fiscali üáÆüáπ === */
    initFisco(){
      if(localStorage.getItem('fisco_init'))return;
      const y=new Date().getFullYear();
      const add=(t,d,k)=>this.events.push({id:this.uid(),title:t,date:d,kind:k,done:false});
      add('CU',''+y+'-03-16','Fiscale');
      add('IVA 1¬∞ trim',''+y+'-05-16','Fiscale');
      add('IVA 2¬∞ trim',''+y+'-08-20','Fiscale');
      add('IVA 3¬∞ trim',''+y+'-11-16','Fiscale');
      add('IVA 4¬∞ trim',''+(y+1)+'-03-16','Fiscale');
      add('IMU acconto',''+y+'-06-16','Fiscale');
      add('IMU saldo',''+y+'-12-16','Fiscale');
      add('IRPEF/IRES saldo',''+y+'-06-30','Fiscale');
      add('IRPEF/IRES acconto',''+y+'-11-30','Fiscale');
      localStorage.setItem('fisco_init','1');
      localStorage.setItem('pro_events',JSON.stringify(this.events));
    }
  }
}).mount('#app');
</script>
</body>
</html>
